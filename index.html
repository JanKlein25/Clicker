<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #ff6b6b;
      --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
    
    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    /* --- Animations --- */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }
    
    @keyframes flyUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
    }

    /* --- UI Elements --- */
    header {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      z-index: 100;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-family: 'Fredoka', sans-serif;
      font-size: 2.5rem;
      color: #fff;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .scoreboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }

    #score {
      font-family: 'Fredoka', sans-serif;
      font-size: 3.5rem;
      font-weight: 700;
      background: -webkit-linear-gradient(#fff, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    #cps {
      font-size: 1.1rem;
      opacity: 0.8;
      background: rgba(0,0,0,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      margin-top: 5px;
    }

    /* --- Game Area --- */
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 20px;
    }

    .click-zone {
      position: relative;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .click-zone:active #klein {
      transform: scale(0.92) rotate(-2deg);
    }

    #klein {
      width: 280px;
      height: 280px;
      object-fit: contain;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
      animation: float 6s ease-in-out infinite;
      transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .particle {
      position: absolute;
      font-family: 'Fredoka', sans-serif;
      font-weight: bold;
      color: #fff;
      pointer-events: none;
      animation: flyUp 0.8s ease-out forwards;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      z-index: 50;
    }

    /* --- Shop Section --- */
    .shop-container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .shop-title {
      font-family: 'Fredoka', sans-serif;
      margin-bottom: 15px;
      font-size: 1.5rem;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      padding-bottom: 40px;
    }

    .shop-item {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 15px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .shop-item:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .item-name { font-weight: 700; font-size: 1.1rem; }
    .item-count { 
      background: rgba(0,0,0,0.3); 
      padding: 2px 8px; 
      border-radius: 8px; 
      font-size: 0.9rem;
    }

    .item-cps { color: #aaa; font-size: 0.85rem; margin-bottom: 10px; }

    .buy-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      font-family: 'Fredoka', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 #d63031;
    }

    .buy-btn:active { transform: translateY(4px); box-shadow: none; }
    .buy-btn:disabled {
      background: #555;
      box-shadow: none;
      color: #888;
      cursor: not-allowed;
      transform: translateY(2px);
    }

    .reset-btn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      color: #aaa;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      cursor: pointer;
      z-index: 200;
    }

    @media (max-width: 600px) {
      #klein { width: 220px; height: 220px; }
      #score { font-size: 2.8rem; }
      h1 { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

  <header>
    <h1>KleinClicker Pro</h1>
    <div class="scoreboard">
      <div id="score">0</div>
      <div id="cps">0 / Sekunde</div>
    </div>
  </header>

  <main>
    <div class="click-zone" id="clickArea">
      <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" alt="Das Gesicht" id="klein">
    </div>
  </main>

  <div class="shop-container">
    <div class="shop-title">Upgrades</div>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

  <button class="reset-btn" onclick="resetGame()">Reset</button>

  <script>
    /* --- Settings --- */
    const SAVE_KEY = 'kleinClickerSave_v3';

    /* --- State --- */
    let state = {
      score: 0,
      upgrades: [
        { id: 'cursor',  name: 'Maus-Fan',    baseCost: 15,    cps: 1,    count: 0, icon: 'üëÜ' },
        { id: 'grandma', name: 'Nette Oma',   baseCost: 100,   cps: 8,    count: 0, icon: 'üëµ' },
        { id: 'farm',    name: 'Kleini-Farm', baseCost: 1100,  cps: 47,   count: 0, icon: 'üöú' },
        { id: 'mine',    name: 'Meme-Mine',   baseCost: 12000, cps: 260,  count: 0, icon: '‚õèÔ∏è' },
        { id: 'factory', name: 'Fabrik',      baseCost: 130000,cps: 1400, count: 0, icon: 'üè≠' }
      ]
    };

    /* --- Elements --- */
    const els = {
      score: document.getElementById('score'),
      cps: document.getElementById('cps'),
      shopGrid: document.getElementById('shopGrid'),
      clickArea: document.getElementById('clickArea'),
      klein: document.getElementById('klein')
    };

    let lastTime = 0;

    /* --- Init --- */
    function init() {
      loadGame();
      renderShopHTML();
      updateShopText(); // Einmalige Text-Aktualisierung beim Start
      
      // Starte die Loop
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);

      // Auto-Save
      setInterval(saveGame, 10000);
    }

    /* --- Game Loop --- */
    function gameLoop(currentTime) {
      try {
        // Delta Time berechnen (in Sekunden)
        const dt = (currentTime - lastTime) / 1000;
        lastTime = currentTime;

        // Sicherheit: Falls dt negativ oder unlogisch riesig ist (Tab war im Hintergrund), ignorieren
        if (dt > 0 && dt < 1) {
          const cps = calculateCPS();
          if (cps > 0) {
            state.score += cps * dt;
          }
        }

        // NUR Score und Buttons updaten (Leichtgewicht)
        updateScoreUI();
        
      } catch (e) {
        console.error("Fehler in der Loop:", e);
      }
      
      requestAnimationFrame(gameLoop);
    }

    /* --- Logic --- */
    function calculateCPS() {
      return state.upgrades.reduce((total, u) => total + (u.count * u.cps), 0);
    }

    function getCost(upgrade) {
      return Math.round(upgrade.baseCost * Math.pow(1.15, upgrade.count));
    }

    /* --- User Actions --- */
    els.clickArea.addEventListener('mousedown', (e) => handleUserClick(e.clientX, e.clientY));
    els.clickArea.addEventListener('touchstart', (e) => {
      e.preventDefault(); 
      handleUserClick(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });

    function handleUserClick(x, y) {
      state.score++;
      spawnParticle(x, y, "+1");
      
      // Klick Animation
      els.klein.style.transform = 'scale(0.95)';
      setTimeout(() => els.klein.style.transform = '', 50);
    }

    function buyUpgrade(index) {
      const u = state.upgrades[index];
      const cost = getCost(u);

      if (state.score >= cost) {
        state.score -= cost;
        u.count++;
        
        // Jetzt aktualisieren wir die Texte im Shop explizit
        updateShopText(); 
        saveGame();
        
        // Button Feedback
        const btn = document.getElementById(`btn-${index}`);
        if(btn) {
           const originalText = btn.innerHTML;
           btn.style.background = "#4cd137"; // Gr√ºn kurz aufleuchten
           setTimeout(() => {
             btn.style.background = ""; 
           }, 200);
        }
      }
    }

    /* --- UI Updates --- */
    // Diese Funktion l√§uft 60x pro Sekunde - muss schnell sein!
    function updateScoreUI() {
      // Score anzeigen
      els.score.textContent = Math.floor(state.score).toLocaleString('de-DE');
      
      // Buttons aktivieren/deaktivieren
      state.upgrades.forEach((u, index) => {
        const btn = document.getElementById(`btn-${index}`);
        if(btn) {
          const cost = getCost(u);
          btn.disabled = state.score < cost;
        }
      });
    }

    // Diese Funktion l√§uft NUR, wenn man etwas kauft oder beim Start
    function updateShopText() {
      els.cps.textContent = calculateCPS().toLocaleString('de-DE', {maximumFractionDigits: 1}) + " / Sek";
      
      state.upgrades.forEach((u, index) => {
        // Kosten und Anzahl aktualisieren
        const countEl = document.getElementById(`count-${index}`);
        const costEl = document.getElementById(`cost-${index}`);
        
        if (countEl) countEl.textContent = u.count;
        if (costEl) costEl.textContent = getCost(u).toLocaleString('de-DE');
      });
    }

    function renderShopHTML() {
      els.shopGrid.innerHTML = '';
      state.upgrades.forEach((u, index) => {
        const item = document.createElement('div');
        item.className = 'shop-item';
        item.innerHTML = `
          <div class="item-header">
            <span class="item-name">${u.icon} ${u.name}</span>
            <span class="item-count" id="count-${index}">0</span>
          </div>
          <div class="item-cps">+${u.cps} CPS</div>
          <button class="buy-btn" id="btn-${index}" onclick="buyUpgrade(${index})">
             <span id="cost-${index}">0</span> Kleinis
          </button>
        `;
        els.shopGrid.appendChild(item);
      });
    }

    function spawnParticle(x, y, text) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.textContent = text;
      const rX = (Math.random() - 0.5) * 40;
      p.style.left = `${x + rX}px`;
      p.style.top = `${y - 20}px`;
      p.style.color = `hsl(${Math.random() * 60 + 30}, 100%, 70%)`;
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }

    /* --- Save System --- */
    function saveGame() {
      const data = {
        score: state.score,
        upgrades: state.upgrades.map(u => ({ id: u.id, count: u.count }))
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }

    function loadGame() {
      const saved = localStorage.getItem(SAVE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          state.score = parsed.score || 0;
          if (parsed.upgrades) {
            parsed.upgrades.forEach(savedU => {
              const match = state.upgrades.find(u => u.id === savedU.id);
              if (match) match.count = savedU.count;
            });
          }
        } catch (e) { console.error("Savegame korrupt"); }
      }
    }

    function resetGame() {
      if(confirm("Alles l√∂schen?")) {
        localStorage.removeItem(SAVE_KEY);
        location.reload();
      }
    }

    // Los geht's
    init();

  </script>
</body>
</html>
