<!-- START OF FILE index.html -->

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker RPG</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0f0f12;
      --panel-left: #1a1a20;
      --panel-right: #121216;
      --gold: #f1c40f;
      --green: #2ecc71;
      --red: #e74c3c;
      --blue: #3498db;
      --purple: #9b59b6;
      --text-main: #ecf0f1;
      --tooltip-bg: rgba(10, 10, 15, 0.98);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: row; 
    }

    /* --- GLOBAL TOOLTIP --- */
    #global-tooltip {
      position: fixed; top: 0; left: 0; width: 320px;
      background: var(--tooltip-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
      pointer-events: none; z-index: 10000; padding: 0; display: none;
      box-shadow: 0 10px 50px rgba(0,0,0,1);
    }
    .tt-header { background: rgba(255,255,255,0.03); padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .tt-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 1.1rem; color: var(--gold); display: flex; justify-content: space-between; align-items: center; }
    .tt-price { font-size: 0.9rem; font-weight: bold; padding: 3px 8px; border-radius: 4px; background: #000; }
    .tt-price.affordable { color: var(--green); border: 1px solid rgba(46, 204, 113, 0.3); } 
    .tt-price.expensive { color: var(--red); opacity: 0.8; }
    .tt-body { padding: 12px; font-size: 0.85rem; color: #ccc; line-height: 1.4; }
    .tt-effect { color: #fff; font-weight: bold; margin-bottom: 8px; display: block; font-size: 0.95rem; border-left: 3px solid var(--gold); padding-left: 10px; }
    .tt-stats { background: rgba(0,0,0,0.4); padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.05); }
    .stat-highlight { color: var(--green); font-weight: bold; font-size: 0.95rem; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); }

    /* --- LAYOUT --- */
    .left-panel {
      flex: 1; 
      background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
      transition: background 2s ease;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      position: relative; border-right: 2px solid rgba(255,255,255,0.05);
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8); overflow: hidden;
    }
    .right-panel {
      width: 420px; background: var(--panel-right); display: flex; flex-direction: column;
      border-left: 1px solid #222; box-shadow: -10px 0 30px rgba(0,0,0,0.5); z-index: 50;
    }

    /* --- VISUAL ELEMENTS --- */
    #visual-canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 1; overflow: hidden;
    }
    .bg-icon {
        position: absolute; font-size: 1.5rem; opacity: 0.3;
        animation: floatAround linear infinite;
        text-shadow: 0 0 5px rgba(255,255,255,0.2);
    }
    @keyframes floatAround {
        0% { transform: translate(0,0) rotate(0deg); }
        25% { transform: translate(20px, -20px) rotate(10deg); }
        50% { transform: translate(0, -40px) rotate(0deg); }
        75% { transform: translate(-20px, -20px) rotate(-10deg); }
        100% { transform: translate(0,0) rotate(0deg); }
    }

    .bakery-name { 
      position: absolute; top: 30px; 
      font-family: 'Merriweather', serif; font-weight: 900; font-size: 2.2rem; 
      text-transform: uppercase; letter-spacing: 2px;
      background: linear-gradient(to bottom, #f1c40f, #d35400); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 0px rgba(0,0,0,0.5)); z-index: 20;
    }
    
    .score-container { margin-bottom: 30px; text-align: center; z-index: 20; }
    #score { font-family: 'Roboto', sans-serif; font-size: 3.2rem; font-weight: 900; text-shadow: 0 0 30px rgba(255,255,255,0.1); line-height: 1; }
    .currency-label { font-family: 'Merriweather', serif; font-size: 1.5rem; color: var(--gold); font-weight: 700; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
    #cps { font-size: 1.1rem; color: #7f8c8d; margin-top: 10px; font-weight: 500; background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); }

    #bigKlein {
      width: 280px; height: 280px; object-fit: contain; cursor: pointer;
      transition: transform 0.05s, filter 0.1s; filter: drop-shadow(0 30px 60px rgba(0,0,0,0.5)); z-index: 20;
    }
    #bigKlein:active { transform: scale(0.96); filter: brightness(0.9); }
    #bigKlein:hover { transform: scale(1.02); filter: drop-shadow(0 0 30px rgba(255,255,255,0.1)); }

    /* --- SPECIAL BUTTONS CONTAINER --- */
    .special-btn-container {
        display: flex; gap: 15px; margin-top: 30px; z-index: 25;
    }
    .special-btn {
      border: 2px solid rgba(255,255,255,0.2); color: #fff;
      padding: 12px 25px; border-radius: 50px;
      font-weight: 900; font-size: 1rem; cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0, 0.4);
      display: none; transition: all 0.2s;
      letter-spacing: 1px; text-transform: uppercase;
    }
    #casinoBtn { background: linear-gradient(45deg, #e67e22, #f39c12); box-shadow: 0 0 20px rgba(243, 156, 18, 0.4); }
    #casinoBtn:hover { transform: translateY(-3px); box-shadow: 0 0 30px rgba(243, 156, 18, 0.8); }
    
    #dungeonBtn { background: linear-gradient(45deg, #8e44ad, #9b59b6); box-shadow: 0 0 20px rgba(155, 89, 182, 0.4); }
    #dungeonBtn:hover { transform: translateY(-3px); box-shadow: 0 0 30px rgba(155, 89, 182, 0.8); }

    /* --- SHOP --- */
    .store-header { 
      background: #0a0a0d; padding: 18px; text-align: center; 
      font-family: 'Merriweather', serif; font-weight: 900; color: #57606f; 
      border-bottom: 1px solid #222; font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase; 
    }
    
    .upgrades-container { padding: 12px; background: rgba(0,0,0,0.2); display: flex; flex-wrap: wrap; gap: 8px; min-height: 80px; max-height: 220px; overflow-y: auto; border-bottom: 2px solid #000; }
    .upgrade-crate { 
      width: 60px; height: 60px; background: linear-gradient(135deg, #2d3436, #1e272e); 
      border: 1px solid #444; cursor: pointer; display: flex; align-items: center; justify-content: center; 
      font-size: 1.8rem; border-radius: 8px; transition: all 0.2s; position: relative;
    }
    .upgrade-crate:hover { border-color: var(--text-main); background: #333; z-index: 5; }

    .buildings-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 #0a0a0d; }
    .building-row { 
      height: 80px; background: linear-gradient(to right, #1a1a20, #141418); 
      border-bottom: 1px solid #000; display: flex; align-items: center; padding: 0 20px; 
      cursor: pointer; position: relative; opacity: 0.5; transition: all 0.2s; 
    }
    .building-row:hover { opacity: 1; background: #222; }
    .building-row.can-afford { opacity: 1; }
    .b-icon { font-size: 2.2rem; width: 50px; text-align: center; margin-right: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
    .b-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .b-name { font-weight: 700; font-family: 'Merriweather', serif; font-size: 1rem; color: #fff; margin-bottom: 3px; }
    .b-cps { font-size: 0.75rem; color: #636e72; }
    .b-cost { color: var(--red); font-weight: bold; font-size: 0.85rem; }
    .b-cost.affordable { color: var(--green); }
    .b-count { font-size: 1.8rem; font-weight: 900; color: rgba(255,255,255,0.05); margin-left: auto; }

    /* --- MODALS (SHARED) --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.92); z-index: 12000;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(8px);
    }
    .modal-window {
      background: #18181b; width: 95%; max-width: 700px;
      border: 1px solid #333; border-radius: 16px;
      padding: 0; text-align: center;
      box-shadow: 0 0 80px rgba(0,0,0,0.8);
      position: relative; overflow: hidden;
      animation: zoomIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      max-height: 90vh; display: flex; flex-direction: column;
    }
    @keyframes zoomIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }

    .modal-header {
      background: linear-gradient(to bottom, #2d3436, #1e272e);
      padding: 15px 20px; border-bottom: 1px solid #333;
      display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
    }
    .modal-title { font-family: 'Merriweather', serif; font-size: 1.4rem; color: var(--gold); font-weight: 900; letter-spacing: 1px; }
    .modal-balance { font-size: 1rem; color: #fff; font-weight: bold; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; border: 1px solid #444; }
    .modal-body { padding: 20px; overflow-y: auto; position: relative; flex: 1; }
    .close-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #666; font-size: 1.5rem; cursor: pointer; z-index: 100; }

    /* --- CASINO STYLES --- */
    .casino-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; background: #111; padding: 5px; border-radius: 8px; border: 1px solid #333; }
    .nav-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #666; font-weight: bold; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .nav-btn.active { background: #333; color: var(--gold); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .roulette-container { width: 100%; height: 100px; background: #000; border-radius: 8px; border: 4px solid #333; position: relative; overflow: hidden; margin-bottom: 25px; }
    .roulette-marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: var(--gold); transform: translateX(-50%); z-index: 10; box-shadow: 0 0 10px var(--gold); }
    .roulette-strip { display: flex; height: 100%; align-items: center; position: absolute; left: 50%; }
    .r-card { width: 70px; height: 70px; margin-right: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: rgba(255,255,255,0.4); font-size: 1.2rem; flex-shrink: 0; border-bottom: 4px solid rgba(0,0,0,0.3); }
    .rc-red { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
    .rc-black { background: linear-gradient(to bottom, #34495e, #2c3e50); }
    .rc-green { background: linear-gradient(to bottom, #f1c40f, #f39c12); color: #000; }
    .bet-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .bet-input { background: #111; border: 1px solid #444; color: #fff; font-size: 1.2rem; padding: 10px; width: 150px; text-align: center; font-weight: bold; border-radius: 6px; }
    .action-row { display: flex; gap: 15px; justify-content: center; }
    .bet-btn { flex: 1; padding: 20px 10px; border: none; border-radius: 10px; font-weight: 900; font-size: 1.1rem; color: #fff; cursor: pointer; border: 2px solid rgba(255,255,255,0.05); }
    .btn-red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .btn-black { background: linear-gradient(135deg, #34495e, #2c3e50); }
    .btn-green { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000; }
    .control-btn { background: #333; border: 1px solid #555; color: #ccc; padding: 0 15px; cursor: pointer; font-weight: bold; border-radius: 6px; }
    
    /* --- DUNGEON STYLES --- */
    .dungeon-layout { display: flex; flex-direction: column; gap: 20px; }
    
    .combat-zone {
        background: url('https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png') no-repeat center center;
        background-size: cover; /* Placeholder BG */
        background: radial-gradient(circle, #2c3e50 0%, #000 100%);
        border: 2px solid #444; border-radius: 12px; height: 250px; position: relative;
        display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
        overflow: hidden;
    }
    
    .fighter { text-align: center; position: relative; z-index: 5; cursor: pointer; transition: transform 0.1s; }
    .fighter:active { transform: scale(0.95); }
    .f-sprite { font-size: 4rem; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8)); transition: all 0.2s; }
    .hero-sprite { transform: scaleX(-1); } /* Face right */
    
    .hp-bar-container { width: 100px; height: 10px; background: #333; margin: 10px auto 0; border-radius: 5px; border: 1px solid #000; overflow: hidden; position: relative; }
    .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.2s; }
    .hp-text { font-size: 0.75rem; color: #fff; margin-top: 5px; font-weight: bold; text-shadow: 0 1px 2px #000; }
    
    .enemy-info { position: absolute; top: 10px; right: 20px; text-align: right; }
    .level-badge { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
    
    .dmg-popup { position: absolute; color: #fff; font-weight: 900; font-size: 1.5rem; animation: floatUpDmg 0.8s forwards; pointer-events: none; text-shadow: 0 0 5px #000; z-index: 100; }
    .dmg-hero { color: #f1c40f; } /* Yellow for player dmg */
    .dmg-enemy { color: #e74c3c; } /* Red for enemy dmg */
    @keyframes floatUpDmg { 0% { transform: translateY(0) scale(1); opacity:1; } 100% { transform: translateY(-50px) scale(1.2); opacity:0; } }
    
    .hit-flash { animation: flashRed 0.2s; }
    @keyframes flashRed { 0%{filter:brightness(1);} 50%{filter:sepia(1) hue-rotate(-50deg) saturate(5);} 100%{filter:brightness(1);} }

    .rpg-shop { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 10px; border-top: 1px solid #333; padding-top: 15px; }
    .rpg-item { 
        min-width: 140px; background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; 
        text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .rpg-item:hover { background: #333; border-color: var(--gold); }
    .rpg-item.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
    .ri-icon { font-size: 2rem; margin-bottom: 5px; }
    .ri-name { font-size: 0.85rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
    .ri-stat { color: var(--blue); font-size: 0.8rem; margin-bottom: 5px; }
    .ri-cost { color: var(--gold); font-weight: bold; font-size: 0.85rem; }

    .rpg-stats-panel {
        display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;
    }
    .stat-box { text-align: center; }
    .stat-val { color: #fff; font-weight: bold; font-size: 1.1rem; }
    .stat-lbl { color: #888; font-size: 0.75rem; text-transform: uppercase; }

    /* Particles & FX */
    .win-particle { position: absolute; width: 10px; height: 10px; pointer-events: none; animation: confetti 1s ease-out forwards; z-index: 1000; }
    @keyframes confetti { 0% {transform: translate(0,0) rotate(0deg); opacity: 1;} 100% {transform: translate(var(--tx), var(--ty)) rotate(720deg); opacity: 0;} }
    .win-pulse { animation: screenFlash 0.5s; }
    @keyframes screenFlash { 0% {background-color: rgba(255,255,255,0.2);} 100% {background-color: transparent;} }
    .falling-face { position: absolute; width: 35px; height: 35px; pointer-events: none; z-index: 15; animation: physicsFall 1.2s cubic-bezier(0.5, 0, 0.8, 0.8) forwards; }
    @keyframes physicsFall { 0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translateY(800px) rotate(360deg) scale(0.8); opacity: 0; } }
    .click-text { position: absolute; color: #fff; font-weight: 900; font-size: 1.4rem; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 100; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1); } }
    
    /* Golden Klein */
    #goldenKlein { position: absolute; width: 80px; height: 80px; z-index: 9999; cursor: pointer; display: none; filter: drop-shadow(0 0 20px gold); animation: wobble 2s infinite; }
    @keyframes wobble { 0%,100% {transform:rotate(0deg);} 25% {transform:rotate(-5deg);} 75% {transform:rotate(5deg);} }
    .buff-container { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 100; }
    .buff-icon { width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid var(--gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); animation: pulse 1s infinite alternate; }

    @media (max-width: 850px) {
      body { flex-direction: column; overflow-y: auto; height: auto; }
      .left-panel { min-height: 50vh; border-right: none; border-bottom: 2px solid #333; }
      .right-panel { width: 100%; min-height: 50vh; }
      #global-tooltip { display: none !important; }
    }
  </style>
</head>
<body>

  <div id="global-tooltip">
    <div class="tt-header">
      <div class="tt-title">
        <span id="tt-name-display">Name</span>
        <span id="tt-price-display" class="tt-price">100 Kleinis</span>
      </div>
    </div>
    <div class="tt-body">
      <span id="tt-effect-display" class="tt-effect">Verdoppelt Produktion</span>
      <div id="tt-desc-display">Beschreibung...</div>
      <div id="tt-stats-container" class="tt-stats"></div>
    </div>
  </div>

  <!-- CASINO MODAL -->
  <div id="casinoModal" class="modal-overlay">
    <div class="modal-window" id="casinoWindow">
      <button class="close-btn" onclick="closeModal('casinoModal')">√ó</button>
      <div class="modal-header">
        <div class="modal-title">üé∞ CASINO ROYALE</div>
        <div class="modal-balance"><span id="casino-balance">0</span> Kleinis</div>
      </div>
      <div class="modal-body">
        
        <div class="casino-nav">
            <button class="nav-btn active" id="btn-tab-roulette" onclick="switchCasinoTab('roulette')">Roulette</button>
            <button class="nav-btn" id="btn-tab-slots" onclick="switchCasinoTab('slots')">Slots</button>
        </div>

        <div class="bet-row">
            <input type="number" id="betAmount" class="bet-input" placeholder="Einsatz">
            <button class="control-btn" onclick="setBetMultiplier(0.5)">1/2</button>
            <button class="control-btn" onclick="setBetMultiplier(2)">x2</button>
            <button class="control-btn" style="color:var(--gold)" onclick="setBetMultiplier('max')">ALL</button>
        </div>

        <div id="view-roulette">
            <div class="roulette-container">
              <div class="roulette-marker"></div>
              <div class="roulette-strip" id="rouletteStrip"></div>
            </div>
            <div class="action-row">
              <button class="bet-btn btn-red" onclick="spin('red')">ROT<span style="font-size:0.7rem; display:block">Win x2</span></button>
              <button class="bet-btn btn-green" onclick="spin('green')">GOLD<span style="font-size:0.7rem; display:block">Win x14</span></button>
              <button class="bet-btn btn-black" onclick="spin('black')">SCHWARZ<span style="font-size:0.7rem; display:block">Win x2</span></button>
            </div>
        </div>

        <div id="view-slots" style="display:none;">
            <div class="roulette-container" style="display:flex; justify-content:center; gap:10px; padding:10px; height:auto;">
                <div class="r-card rc-black" id="reel-1" style="font-size:2.5rem">üçí</div>
                <div class="r-card rc-black" id="reel-2" style="font-size:2.5rem">üçí</div>
                <div class="r-card rc-black" id="reel-3" style="font-size:2.5rem">üçí</div>
            </div>
            <div class="action-row">
                <button class="bet-btn" style="background:#9b59b6" onclick="spinSlots()">DREHEN<span style="font-size:0.7rem; display:block">3 Gleiche = WIN</span></button>
            </div>
        </div>

      </div>
    </div>
  </div>

  <!-- DUNGEON MODAL -->
  <div id="dungeonModal" class="modal-overlay">
    <div class="modal-window">
        <button class="close-btn" onclick="closeModal('dungeonModal')">√ó</button>
        <div class="modal-header">
            <div class="modal-title">‚öîÔ∏è DER DUNGEON</div>
            <div class="modal-balance"><span id="dungeon-balance">0</span> Kleinis</div>
        </div>
        <div class="modal-body dungeon-layout">
            
            <div class="rpg-stats-panel">
                <div class="stat-box">
                    <div class="stat-val" id="hero-hp-display">100/100</div>
                    <div class="stat-lbl">Gesundheit</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="hero-dmg-display" style="color:var(--red)">10</div>
                    <div class="stat-lbl">Schaden</div>
                </div>
            </div>

            <div class="combat-zone">
                <div class="enemy-info">
                    <span class="level-badge">LVL <span id="dungeon-lvl">1</span></span>
                    <div style="font-weight:900; color:#e74c3c; margin-top:5px;" id="enemy-name">Schleim</div>
                </div>

                <div class="fighter" id="hero-fighter">
                    <div class="f-sprite hero-sprite">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="hp-bar-container"><div class="hp-fill" id="hero-hp-bar" style="background:#2ecc71"></div></div>
                </div>

                <div class="fighter" id="enemy-fighter" onclick="clickEnemy()">
                    <div class="f-sprite" id="enemy-sprite">ü¶†</div>
                    <div class="hp-bar-container"><div class="hp-fill" id="enemy-hp-bar"></div></div>
                    <div class="hp-text" id="enemy-hp-text">50/50</div>
                </div>
            </div>

            <div style="text-align:left; font-family:'Merriweather'; font-weight:bold; color:#888; margin-bottom:-10px;">Ausr√ºstungs-H√§ndler</div>
            <div class="rpg-shop" id="rpg-shop-list">
                <!-- Items populated by JS -->
            </div>

        </div>
    </div>
  </div>

  <div class="left-panel" id="clickPanel">
    <!-- VISUAL BACKGROUND AREA -->
    <div id="visual-canvas"></div>

    <div class="bakery-name">KleinClicker</div>
    <div class="score-container">
      <div id="score">0</div>
      <div class="currency-label">KLEINIS</div>
      <div id="cps">0,0 Kleinis / Sekunde</div>
    </div>
    
    <div class="special-btn-container">
        <button id="casinoBtn" class="special-btn" onclick="openModal('casinoModal')">üé∞ Casino</button>
        <button id="dungeonBtn" class="special-btn" onclick="openModal('dungeonModal')">‚öîÔ∏è Dungeon</button>
    </div>

    <div class="buff-container" id="buffArea"></div>
    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="bigKlein" alt="Klick mich!">
    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="goldenKlein" alt="GOLD">
  </div>

  <div class="right-panel">
    <div class="store-header">Upgrades</div>
    <div class="upgrades-container" id="upgradeGrid"></div>
    <div class="store-header">Markt</div>
    <div class="buildings-list" id="buildingList"></div>
  </div>

  <script>
    /* --- CONFIG & ASSETS --- */
    const SAVE_KEY = 'KleinClicker_RPG_V7'; 
    const IMG_URL = "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png";
    
    // BUILDINGS
    const BUILDINGS = [
      { id: 0, name: 'Kaputte Maus', baseCost: 15,            baseCps: 0.1,         icon: 'üëÜ' },
      { id: 1, name: 'Nette Oma',    baseCost: 100,           baseCps: 1,           icon: 'üëµ' },
      { id: 2, name: 'Kleini Feld',  baseCost: 1100,          baseCps: 8,           icon: 'üåæ' },
      { id: 3, name: 'Meme Mine',    baseCost: 12000,         baseCps: 47,          icon: '‚õèÔ∏è' },
      { id: 4, name: 'Fabrik',       baseCost: 130000,        baseCps: 260,         icon: 'üè≠' },
      { id: 5, name: 'Bank',         baseCost: 1400000,       baseCps: 1400,        icon: 'üè¶' },
      { id: 6, name: 'Tempel',       baseCost: 20000000,      baseCps: 7800,        icon: 'üèõÔ∏è' },
      { id: 7, name: 'Klon-Labor',   baseCost: 330000000,     baseCps: 45000,       icon: 'üß¨' }, 
      { id: 8, name: 'Klein-Rakete', baseCost: 5100000000,    baseCps: 280000,      icon: 'üöÄ' },
      { id: 9, name: 'Portal',       baseCost: 75000000000,   baseCps: 1600000,     icon: 'üåÄ' },
      { id: 10, name: 'Zeitmaschine',baseCost: 900000000000,  baseCps: 12000000,    icon: '‚è≥' },
      { id: 11, name: 'Klein-Versum',baseCost: 15000000000000,baseCps: 150000000,   icon: 'üåå' } 
    ];

    // UPGRADES
    const UPGRADES = [
      { id: 'u_click_1', name: 'Plastik Maus', cost: 500,    trigger: {type:'clicks', val:100}, icon:'üñ±Ô∏è', desc:'Die billigste Maus auf dem Markt.', type:'click', multi:2, text:'Klickst√§rke x2' },
      { id: 'u_click_2', name: 'Gamer Maus',   cost: 50000,  trigger: {type:'clicks', val:1000},icon:'üéÆ', desc:'Mit RGB Beleuchtung f√ºr mehr FPS.', type:'click', multi:2, text:'Klickst√§rke x2' },
      { id: 'u_b0_1',    name: 'Carpaltunnel', cost: 1000,   trigger: {type:'build', id:0, val:10}, icon:'ü©π', desc:'M√§use arbeiten trotz Schmerzen weiter.', type:'build', target:0, multi:2, text:'Maus Produktion x2' },
      { id: 'u_b0_2',    name: 'Makro',        cost: 10000,  trigger: {type:'build', id:0, val:50}, icon:'‚å®Ô∏è', desc:'Automatisierte Klick-Skripte.', type:'build', target:0, multi:2, text:'Maus Produktion x2' },
      { id: 'u_b1_1',    name: 'Nudelholz',    cost: 5000,   trigger: {type:'build', id:1, val:10}, icon:'ü•ñ', desc:'Die Omas werden aggressiver.', type:'build', target:1, multi:2, text:'Oma Produktion x2' },
      { id: 'u_b1_2',    name: 'Lesebrille',   cost: 50000,  trigger: {type:'build', id:1, val:50}, icon:'üëì', desc:'Sie sehen die Kleinis jetzt besser.', type:'build', target:1, multi:2, text:'Oma Produktion x2' },
      { id: 'u_b2_1',    name: 'D√ºnger',       cost: 150000, trigger: {type:'build', id:2, val:10}, icon:'üí©', desc:'100% biologisch abbaubar.', type:'build', target:2, multi:2, text:'Feld Produktion x2' },
      { id: 'u_b3_1',    name: 'Dynamit',      cost: 1200000, trigger: {type:'build', id:3, val:10}, icon:'üß®', desc:'Sicherheit ist zweitrangig.', type:'build', target:3, multi:2, text:'Mine Produktion x2' },
      { id: 'u_b4_1',    name: 'Roboterarm',   cost: 15000000, trigger: {type:'build', id:4, val:10}, icon:'ü§ñ', desc:'Ersetzt menschliche Fehler.', type:'build', target:4, multi:2, text:'Fabrik Produktion x2' },
      { id: 'u_b5_1',    name: 'Goldtresor',   cost: 200000000, trigger: {type:'build', id:5, val:10}, icon:'üîê', desc:'Noch sicherer als Fort Knox.', type:'build', target:5, multi:2, text:'Bank Produktion x2' },
      { id: 'u_b7_1',    name: 'Reagenzglas',  cost: 5000000000, trigger: {type:'build', id:7, val:10}, icon:'üß™', desc:'Klonfl√ºssigkeit mit Geschmack.', type:'build', target:7, multi:2, text:'Labor Produktion x2' },
      { id: 'u_b8_1',    name: 'Mars Ticket',  cost: 75000000000, trigger: {type:'build', id:8, val:10}, icon:'üéüÔ∏è', desc:'One-Way Ticket f√ºr Kleinis.', type:'build', target:8, multi:2, text:'Raketen Produktion x2' },
      { id: 'u_b9_1',    name: 'Rick\'s Gun',  cost: 1500000000000, trigger: {type:'build', id:9, val:10}, icon:'üî´', desc:'Wubba Lubba Dub Dub!', type:'build', target:9, multi:2, text:'Portal Produktion x2' },
    ];

    /* --- RPG DATA --- */
    const WEAPONS = [
        { id: 0, name: "Stock", dmg: 5, cost: 1000, icon: "ü¶Ø" },
        { id: 1, name: "Dolch", dmg: 15, cost: 5000, icon: "üó°Ô∏è" },
        { id: 2, name: "Schwert", dmg: 40, cost: 25000, icon: "‚öîÔ∏è" },
        { id: 3, name: "Axt", dmg: 120, cost: 100000, icon: "ü™ì" },
        { id: 4, name: "Laser", dmg: 500, cost: 1000000, icon: "üî´" },
        { id: 5, name: "Lichtschwert", dmg: 2500, cost: 50000000, icon: "üîØ" },
        { id: 6, name: "Mj√∂llnir", dmg: 10000, cost: 1000000000, icon: "üî®" }
    ];
    const ARMORS = [
        { id: 0, name: "Hemd", hp: 50, cost: 1000, icon: "üëï" },
        { id: 1, name: "Leder", hp: 150, cost: 5000, icon: "üß•" },
        { id: 2, name: "Kette", hp: 500, cost: 25000, icon: "üï∏Ô∏è" },
        { id: 3, name: "Platte", hp: 2000, cost: 100000, icon: "üõ°Ô∏è" },
        { id: 4, name: "Diamant", hp: 10000, cost: 5000000, icon: "üíé" },
        { id: 5, name: "Nanobots", hp: 50000, cost: 250000000, icon: "ü¶†" }
    ];
    const ENEMIES = [
        { name: "Schleim", icon: "ü¶†" }, { name: "Ratte", icon: "üêÄ" }, { name: "Goblin", icon: "üë∫" },
        { name: "Skelett", icon: "üíÄ" }, { name: "Ork", icon: "üëπ" }, { name: "Troll", icon: "üßü" },
        { name: "Drache", icon: "üê≤" }, { name: "Alien", icon: "üëΩ" }, { name: "D√§mon", icon: "üëø" }
    ];

    /* --- GAME STATE --- */
    let game = {
      score: 0, totalScore: 0, clicks: 0, 
      buildings: new Array(BUILDINGS.length).fill(0), upgrades: [],
      // RPG State
      rpg: {
          hp: 100, maxHp: 100, dmg: 5,
          weaponId: -1, armorId: -1,
          dungeonLevel: 1
      }
    };
    
    // Runtime Combat State
    let enemyState = { hp: 50, maxHp: 50, dmg: 2, name: 'Schleim', icon: 'ü¶†' };
    let combatTimer = null;
    let buffs = { frenzy: { active: false, time: 0, multi: 7 } };
    let lastTime = performance.now();
    let casinoUnlocked = false;
    let dungeonUnlocked = false;

    // Visual State
    let visualElements = [];
    const MAX_VISUALS = 25; 

    /* --- UI HANDLES --- */
    const tooltipEl = document.getElementById('global-tooltip');

    /* --- INIT --- */
    function init() {
      try {
        loadGame();
        if(game.buildings.length < BUILDINGS.length) {
            const diff = BUILDINGS.length - game.buildings.length;
            for(let i=0; i<diff; i++) game.buildings.push(0);
        }
        // Init RPG structure if missing
        if(!game.rpg) game.rpg = { hp: 100, maxHp: 100, dmg: 5, weaponId: -1, armorId: -1, dungeonLevel: 1 };
      } catch(e) { console.log("Resetting save"); localStorage.removeItem(SAVE_KEY); }
      
      buildBuildingUI();
      renderUpgrades();
      initVisuals();
      initRPG();
      requestAnimationFrame(gameLoop);
      setInterval(slowLoop, 1000); 
      scheduleGolden();
      
      document.addEventListener('mousemove', (e) => {
        if (tooltipEl.style.display === 'block') {
          let top = e.clientY + 10; let left = e.clientX - 330;
          if(left < 10) left = e.clientX + 10;
          if(top + tooltipEl.offsetHeight > window.innerHeight) top = window.innerHeight - tooltipEl.offsetHeight - 10;
          tooltipEl.style.top = top + 'px'; tooltipEl.style.left = left + 'px';
        }
      });
    }

    function gameLoop(now) {
      let dt = (now - lastTime) / 1000;
      if(dt > 1) dt = 1; lastTime = now;
      updateBuffs(dt);
      
      const cps = calculateTotalCPS();
      if(cps > 0) addScore(cps * dt);

      document.getElementById('score').textContent = formatNum(Math.floor(game.score));
      document.getElementById('cps').textContent = formatNum(cps, 1) + " / Sek";
      
      updateDynamicBackground();
      checkUnlocks();
      updateBuildingStates();
      
      // RPG Regen
      if(document.getElementById('dungeonModal').style.display !== 'flex') {
          if(game.rpg.hp < game.rpg.maxHp) {
              game.rpg.hp = Math.min(game.rpg.maxHp, game.rpg.hp + (game.rpg.maxHp * 0.05 * dt)); // 5% heal/sec outside
          }
      }

      requestAnimationFrame(gameLoop);
    }
    function slowLoop() { saveGame(); renderUpgrades(); }

    function checkUnlocks() {
        if(!casinoUnlocked && game.totalScore >= 1000) { casinoUnlocked = true; document.getElementById('casinoBtn').style.display = 'block'; }
        else if(casinoUnlocked) document.getElementById('casinoBtn').style.display = 'block';

        if(!dungeonUnlocked && game.totalScore >= 5000) { dungeonUnlocked = true; document.getElementById('dungeonBtn').style.display = 'block'; }
        else if(dungeonUnlocked) document.getElementById('dungeonBtn').style.display = 'block';
    }

    /* --- VISUALS --- */
    function initVisuals() {
        const container = document.getElementById('visual-canvas');
        container.innerHTML = '';
        visualElements = [];
        let totalCreated = 0;
        for(let i=BUILDINGS.length-1; i>=0; i--) {
            if(game.buildings[i] > 0) {
                let count = Math.min(Math.ceil(Math.log2(game.buildings[i] + 1)), 5);
                for(let k=0; k<count; k++) {
                    if(totalCreated < MAX_VISUALS) { spawnVisualIcon(BUILDINGS[i].icon); totalCreated++; }
                }
            }
        }
    }

    function spawnVisualIcon(iconChar) {
        const container = document.getElementById('visual-canvas');
        const el = document.createElement('div');
        el.className = 'bg-icon';
        el.textContent = iconChar;
        el.style.left = Math.random() * 90 + '%';
        el.style.top = Math.random() * 90 + '%';
        el.style.fontSize = (1 + Math.random()) + 'rem';
        el.style.animationDuration = (10 + Math.random() * 20) + 's';
        container.appendChild(el);
        visualElements.push(el);
    }

    function updateDynamicBackground() {
        const panel = document.getElementById('clickPanel');
        let s = game.totalScore;
        if(s < 10000) { }
        else if(s < 1000000) { panel.style.background = `radial-gradient(circle at center, #8e44ad 0%, #000000 100%)`; } 
        else if(s < 1000000000) { panel.style.background = `radial-gradient(circle at center, #d35400 0%, #2d3436 100%)`; } 
        else if(s < 1000000000000) { panel.style.background = `radial-gradient(circle at center, #f1c40f 0%, #2c3e50 100%)`; } 
        else { panel.style.background = `radial-gradient(circle at center, #16a085 0%, #000 100%)`; }
    }

    /* --- MATH --- */
    function addScore(amount) { game.score += amount; game.totalScore += amount; }
    function getBuildingMultiplier(index) {
      let m = 1;
      UPGRADES.forEach(u => { if(u.type === 'build' && u.target === index && game.upgrades.includes(u.id)) m *= u.multi; });
      if(buffs.frenzy.active) m *= buffs.frenzy.multi;
      return m;
    }
    function getBuildingCPS(index) { return BUILDINGS[index].baseCps * getBuildingMultiplier(index); }
    function calculateTotalCPS() { let cps = 0; game.buildings.forEach((count, i) => cps += count * getBuildingCPS(i)); return cps; }
    function getClickPower() {
      let power = 1 + (calculateTotalCPS() * 0.02);
      UPGRADES.forEach(u => { if(u.type === 'click' && game.upgrades.includes(u.id)) power *= u.multi; });
      if(buffs.frenzy.active) power *= buffs.frenzy.multi;
      return power;
    }

    /* --- CLICK INTERACTION --- */
    const bigKlein = document.getElementById('bigKlein');
    bigKlein.addEventListener('mousedown', (e) => handleInteraction(e.clientX, e.clientY));
    bigKlein.addEventListener('touchstart', (e) => { e.preventDefault(); for(let i=0; i<e.touches.length; i++) handleInteraction(e.touches[i].clientX, e.touches[i].clientY); });
    function handleInteraction(x, y) {
      const power = getClickPower(); addScore(power); game.clicks++;
      spawnFloatingText(x, y, `+${formatNum(power)}`, '#fff'); spawnFallingFace(x, y);
      bigKlein.style.transform = "scale(0.94)"; setTimeout(()=> bigKlein.style.transform = "scale(1)", 50);
    }
    function spawnFloatingText(x, y, text, color) {
      const el = document.createElement('div'); el.className = 'click-text'; el.textContent = text;
      el.style.left = (x-20+Math.random()*40)+'px'; el.style.top = y+'px'; 
      if(color) el.style.color = color;
      document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
    }
    function spawnFallingFace(x, y) {
      const img = document.createElement('img'); img.src = IMG_URL; img.className = 'falling-face';
      img.style.left = (x-17)+'px'; img.style.top = (y-17)+'px'; document.getElementById('clickPanel').appendChild(img); setTimeout(()=>img.remove(), 1200);
    }

    /* --- MODAL SYSTEM --- */
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'casinoModal') updateCasinoUI();
        if(id === 'dungeonModal') {
            updateDungeonUI();
            if(game.rpg.hp <= 0) game.rpg.hp = game.rpg.maxHp; // Mercy heal on enter if dead
            spawnEnemy();
            startCombat();
        }
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        if(id === 'dungeonModal') stopCombat();
    }

    /* --- RPG SYSTEM --- */
    function initRPG() {
        // Recalculate stats based on items
        let w = WEAPONS[game.rpg.weaponId];
        let a = ARMORS[game.rpg.armorId];
        game.rpg.dmg = 5 + (w ? w.dmg : 0);
        game.rpg.maxHp = 100 + (a ? a.hp : 0);
        if(game.rpg.hp > game.rpg.maxHp) game.rpg.hp = game.rpg.maxHp;
        
        renderRPGShop();
    }

    function renderRPGShop() {
        const list = document.getElementById('rpg-shop-list');
        list.innerHTML = '';
        
        // Weapons
        WEAPONS.forEach((w, i) => {
            const el = document.createElement('div');
            el.className = 'rpg-item';
            if(game.rpg.weaponId >= i) el.classList.add('locked'); // Already bought better or same
            el.innerHTML = `<div class="ri-icon">${w.icon}</div><div class="ri-name">${w.name}</div><div class="ri-stat">+${formatNum(w.dmg)} DMG</div><div class="ri-cost">${formatNum(w.cost)}</div>`;
            if(game.rpg.weaponId < i) el.onclick = () => buyWeapon(i);
            list.appendChild(el);
        });

        // Armor
        ARMORS.forEach((a, i) => {
            const el = document.createElement('div');
            el.className = 'rpg-item';
            if(game.rpg.armorId >= i) el.classList.add('locked');
            el.innerHTML = `<div class="ri-icon">${a.icon}</div><div class="ri-name">${a.name}</div><div class="ri-stat">+${formatNum(a.hp)} HP</div><div class="ri-cost">${formatNum(a.cost)}</div>`;
            if(game.rpg.armorId < i) el.onclick = () => buyArmor(i);
            list.appendChild(el);
        });
    }

    function buyWeapon(id) {
        const item = WEAPONS[id];
        if(game.rpg.weaponId < id && game.score >= item.cost) {
            game.score -= item.cost;
            game.rpg.weaponId = id;
            initRPG();
            updateDungeonUI();
        }
    }
    function buyArmor(id) {
        const item = ARMORS[id];
        if(game.rpg.armorId < id && game.score >= item.cost) {
            game.score -= item.cost;
            game.rpg.armorId = id;
            // Heal fully on upgrade
            game.rpg.hp = 100 + item.hp;
            initRPG();
            updateDungeonUI();
        }
    }

    function updateDungeonUI() {
        document.getElementById('dungeon-balance').textContent = formatNum(Math.floor(game.score));
        document.getElementById('hero-hp-display').textContent = `${Math.ceil(game.rpg.hp)}/${game.rpg.maxHp}`;
        document.getElementById('hero-dmg-display').textContent = formatNum(game.rpg.dmg);
        document.getElementById('dungeon-lvl').textContent = game.rpg.dungeonLevel;
        
        // Bars
        const heroPct = Math.max(0, (game.rpg.hp / game.rpg.maxHp) * 100);
        document.getElementById('hero-hp-bar').style.width = heroPct + "%";
        
        const enemyPct = Math.max(0, (enemyState.hp / enemyState.maxHp) * 100);
        document.getElementById('enemy-hp-bar').style.width = enemyPct + "%";
        document.getElementById('enemy-hp-text').textContent = `${formatNum(Math.ceil(enemyState.hp))}`;
    }

    function spawnEnemy() {
        const lvl = game.rpg.dungeonLevel;
        const type = ENEMIES[(lvl - 1) % ENEMIES.length];
        
        // Scaling Math
        const hpScale = 50 * Math.pow(1.5, lvl - 1);
        const dmgScale = 2 * Math.pow(1.3, lvl - 1);

        enemyState.name = type.name;
        enemyState.icon = type.icon;
        enemyState.maxHp = hpScale;
        enemyState.hp = hpScale;
        enemyState.dmg = dmgScale;

        document.getElementById('enemy-name').textContent = enemyState.name;
        document.getElementById('enemy-sprite').textContent = enemyState.icon;
        updateDungeonUI();
    }

    function startCombat() {
        if(combatTimer) clearInterval(combatTimer);
        combatTimer = setInterval(combatTick, 1000);
    }
    function stopCombat() {
        if(combatTimer) clearInterval(combatTimer);
        combatTimer = null;
    }

    function combatTick() {
        if(game.rpg.hp <= 0) return;

        // Enemy hits player
        const enemyDmg = enemyState.dmg;
        game.rpg.hp -= enemyDmg;
        showDmgNumber(enemyDmg, 'hero');
        document.getElementById('hero-fighter').classList.add('hit-flash');
        setTimeout(()=>document.getElementById('hero-fighter').classList.remove('hit-flash'), 200);

        if(game.rpg.hp <= 0) {
            game.rpg.hp = 0;
            // Player dies, push back level
            if(game.rpg.dungeonLevel > 1) game.rpg.dungeonLevel--;
            spawnEnemy(); // Respawn weaker
            // Soft revive
            setTimeout(()=> { game.rpg.hp = game.rpg.maxHp * 0.5; updateDungeonUI(); }, 2000);
        }

        // Hero auto hits enemy
        hitEnemy(game.rpg.dmg);
        
        updateDungeonUI();
    }

    function clickEnemy() {
        if(game.rpg.hp > 0) {
            hitEnemy(game.rpg.dmg); // Manual click does full damage
            // Visual bounce
            const s = document.getElementById('enemy-sprite');
            s.style.transform = "scale(0.8)"; setTimeout(()=>s.style.transform="scale(1)", 100);
        }
    }

    function hitEnemy(dmg) {
        enemyState.hp -= dmg;
        showDmgNumber(dmg, 'enemy');
        document.getElementById('enemy-fighter').classList.add('hit-flash');
        setTimeout(()=>document.getElementById('enemy-fighter').classList.remove('hit-flash'), 200);

        if(enemyState.hp <= 0) {
            // Victory
            const loot = 100 * Math.pow(1.6, game.rpg.dungeonLevel);
            addScore(loot);
            spawnFloatingText(window.innerWidth/2, window.innerHeight/2, `LOOT: +${formatNum(loot)}`, '#f1c40f');
            game.rpg.dungeonLevel++;
            game.rpg.hp = Math.min(game.rpg.maxHp, game.rpg.hp + (game.rpg.maxHp * 0.2)); // Heal 20% on kill
            spawnEnemy();
        }
        updateDungeonUI();
    }

    function showDmgNumber(val, target) {
        const parent = target === 'hero' ? document.getElementById('hero-fighter') : document.getElementById('enemy-fighter');
        const el = document.createElement('div');
        el.className = `dmg-popup dmg-${target}`;
        el.textContent = formatNum(Math.floor(val));
        el.style.left = '40%'; el.style.top = '20%';
        parent.appendChild(el);
        setTimeout(()=>el.remove(), 800);
    }

    /* --- CASINO LOGIC --- */
    let isSpinning = false;
    function updateCasinoUI() { document.getElementById('casino-balance').textContent = formatNum(Math.floor(game.score)); }
    function switchCasinoTab(mode) {
        if(isSpinning) return;
        document.getElementById('view-roulette').style.display = mode === 'roulette' ? 'block' : 'none';
        document.getElementById('view-slots').style.display = mode === 'slots' ? 'block' : 'none';
        document.getElementById('btn-tab-roulette').className = mode === 'roulette' ? 'nav-btn active' : 'nav-btn';
        document.getElementById('btn-tab-slots').className = mode === 'slots' ? 'nav-btn active' : 'nav-btn';
    }
    function setBetMultiplier(multi) {
      const input = document.getElementById('betAmount');
      if(multi === 'max') input.value = Math.floor(game.score);
      else {
        let val = parseInt(input.value) || 0;
        if(val === 0) val = 100;
        input.value = Math.floor(val * multi);
      }
    }
    function getBet() {
        const betInput = document.getElementById('betAmount');
        let bet = parseInt(betInput.value);
        if(isNaN(bet) || bet <= 0) { alert("Bitte Einsatz eingeben!"); return null; }
        if(bet > game.score) { bet = Math.floor(game.score); betInput.value = bet; }
        if(bet <= 0) return null;
        return bet;
    }
    
    // Simple Roulette
    function spin(choice) {
      if(isSpinning) return;
      const bet = getBet(); if(!bet) return;
      game.score -= bet; updateCasinoUI(); isSpinning = true;

      const r = Math.random();
      let result = 'black';
      if(r < 0.05) result = 'green';
      else if(r < 0.525) result = 'red';
      
      const strip = document.getElementById('rouletteStrip');
      strip.innerHTML = '';
      for(let i=0; i<40; i++) {
         let c = Math.random() < 0.5 ? 'red' : 'black';
         if(i===30) c = result;
         const d = document.createElement('div'); d.className = `r-card rc-${c}`; d.innerText = c==='green'?'G':(Math.random()*10).toFixed(0);
         strip.appendChild(d);
      }
      
      strip.style.transition = 'none'; strip.style.transform = 'translateX(0)';
      strip.offsetHeight; 
      strip.style.transition = 'transform 3s ease-out';
      strip.style.transform = 'translateX(-2200px)'; // rough approx
      
      setTimeout(() => {
          isSpinning = false;
          let multi = 0;
          if(choice === result) multi = (result==='green' ? 14 : 2);
          if(multi > 0) { addScore(bet*multi); alert(`GEWONNEN! +${formatNum(bet*multi)}`); }
          updateCasinoUI();
      }, 3100);
    }

    // Simple Slots
    const SLOT_SYMBOLS = ['üçí', 'üçã', 'üçá', 'üíé', '7Ô∏è‚É£'];
    function spinSlots() {
        if(isSpinning) return;
        const bet = getBet(); if(!bet) return;
        game.score -= bet; updateCasinoUI(); isSpinning = true;
        
        const els = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
        let res = [];
        els.forEach((el, i) => {
            let interval = setInterval(() => { el.innerText = SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)]; }, 100);
            setTimeout(() => {
                clearInterval(interval);
                let sym = SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)];
                // Cheat a bit for better feels? Nah pure random
                res[i] = sym; el.innerText = sym;
                if(i===2) finishSlot(res, bet);
            }, 1000 + i*500);
        });
    }
    function finishSlot(res, bet) {
        isSpinning = false;
        if(res[0] === res[1] && res[1] === res[2]) {
            let multi = 5;
            if(res[0] === 'üíé') multi = 50;
            addScore(bet*multi); alert(`JACKPOT! +${formatNum(bet*multi)}`);
        }
        updateCasinoUI();
    }

    /* --- FORMATTER --- */
    function formatNum(num, decimals=0) {
      if(num < 1000000) return num.toLocaleString('de-DE', { maximumFractionDigits: decimals });
      if(num < 1000000000) return (num/1000000).toLocaleString('de-DE', { maximumFractionDigits: 2 }) + " Mio";
      if(num < 1000000000000) return (num/1000000000).toLocaleString('de-DE', { maximumFractionDigits: 2 }) + " Mrd";
      return (num/1000000000000).toLocaleString('de-DE', { maximumFractionDigits: 2 }) + " Bio"; 
    }

    /* --- SHOP CORE --- */
    function getBuildingCost(i) { return Math.floor(BUILDINGS[i].baseCost * Math.pow(1.15, game.buildings[i])); }
    function buyBuilding(i) {
      const cost = getBuildingCost(i);
      if(game.score >= cost) { 
          game.score -= cost; game.buildings[i]++; updateSingleBuildingUI(i); renderUpgrades();
          if(visualElements.length < MAX_VISUALS) spawnVisualIcon(BUILDINGS[i].icon);
      }
    }
    function buildBuildingUI() {
      const list = document.getElementById('buildingList'); list.innerHTML = '';
      BUILDINGS.forEach((b, i) => {
        const el = document.createElement('div'); el.className = 'building-row'; el.id = `build-row-${i}`; el.onclick = () => buyBuilding(i);
        el.innerHTML = `<div class="b-icon">${b.icon}</div><div class="b-info"><div class="b-name">${b.name}</div><div class="b-cps">Prod: ${formatNum(b.baseCps, 1)}/s</div><div class="b-cost" id="cost-${i}">0</div></div><div class="b-count" id="count-${i}">0</div>`;
        list.appendChild(el); updateSingleBuildingUI(i);
      });
    }
    function updateSingleBuildingUI(i) {
      document.getElementById(`count-${i}`).textContent = game.buildings[i];
      document.getElementById(`cost-${i}`).textContent = formatNum(getBuildingCost(i)) + " Kleinis";
    }
    function updateBuildingStates() {
      BUILDINGS.forEach((b, i) => {
        const row = document.getElementById(`build-row-${i}`); const costEl = document.getElementById(`cost-${i}`);
        if(game.score >= getBuildingCost(i)) { row.classList.add('can-afford'); costEl.classList.add('affordable'); }
        else { row.classList.remove('can-afford'); costEl.classList.remove('affordable'); }
      });
    }

    /* --- UPGRADES --- */
    function buyUpgrade(uId) {
      const u = UPGRADES.find(x => x.id === uId);
      if(game.score >= u.cost) { game.score -= u.cost; game.upgrades.push(uId); renderUpgrades(); tooltipEl.style.display='none'; }
    }
    function renderUpgrades() {
      const container = document.getElementById('upgradeGrid'); container.innerHTML = '';
      UPGRADES.filter(u => !game.upgrades.includes(u.id) && 
        ((u.trigger.type === 'clicks' && game.clicks >= u.trigger.val) || (u.trigger.type === 'build' && game.buildings[u.trigger.id] >= u.trigger.val))
      ).forEach(u => {
        const div = document.createElement('div'); div.className = 'upgrade-crate'; div.innerHTML = u.icon;
        div.onmouseenter = () => {
             document.getElementById('tt-name-display').innerText = u.name;
             document.getElementById('tt-desc-display').innerText = u.desc;
             document.getElementById('tt-effect-display').innerText = u.text;
             document.getElementById('tt-price-display').innerText = formatNum(u.cost);
             tooltipEl.style.display='block';
        };
        div.onmouseleave = () => tooltipEl.style.display='none';
        if(game.score >= u.cost) div.onclick = () => buyUpgrade(u.id); 
        else div.style.opacity = 0.5;
        container.appendChild(div);
      });
    }

    /* --- GOLDEN --- */
    function updateBuffs(dt) { if(buffs.frenzy.active) { buffs.frenzy.time -= dt; if(buffs.frenzy.time <= 0) { buffs.frenzy.active = false; renderBuffs(); } } }
    function renderBuffs() { document.getElementById('buffArea').innerHTML = buffs.frenzy.active ? `<div class="buff-icon">üî•</div>` : ''; }
    function scheduleGolden() { setTimeout(spawnGolden, (Math.random() * 600000) + 300000); }
    function spawnGolden() {
      const g = document.getElementById('goldenKlein');
      g.style.left = Math.random() * (window.innerWidth-100) + 'px'; g.style.top = Math.random() * (window.innerHeight-100) + 'px'; g.style.display = 'block';
      setTimeout(() => { if(g.style.display === 'block') { g.style.display = 'none'; scheduleGolden(); } }, 10000);
    }
    document.getElementById('goldenKlein').onmousedown = function(e) { e.stopPropagation(); this.style.display = 'none'; buffs.frenzy.active = true; buffs.frenzy.time = 30; renderBuffs(); scheduleGolden(); };

    /* --- SAVE/LOAD --- */
    function saveGame() {
      const data = { score: game.score, totalScore: game.totalScore, clicks: game.clicks, buildings: game.buildings, upgrades: game.upgrades, rpg: game.rpg };
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }
    function loadGame() {
      const saved = JSON.parse(localStorage.getItem(SAVE_KEY));
      if(saved) {
        game.score = saved.score || 0; game.totalScore = saved.totalScore || 0; game.clicks = saved.clicks || 0;
        if(saved.buildings) game.buildings = saved.buildings;
        game.upgrades = saved.upgrades || []; 
        game.rpg = saved.rpg || game.rpg;
      }
    }
    init();
  </script>
</body>
</html>
