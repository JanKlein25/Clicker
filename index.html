<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KleinClicker: Reforged</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
    rel="stylesheet">

  <!-- FIREBASE SDK (Kept from original) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-deep: #050505;
      --bg-panel: #141414;
      --bg-item: #1f1f1f;
      --accent-gold: #ffc107;
      --accent-blue: #3498db;
      --accent-red: #e74c3c;
      --accent-green: #2ecc71;
      --accent-purple: #9b59b6;
      --text-main: #ecf0f1;
      --text-dim: #95a5a6;

      --shadow-card: 0 4px 6px rgba(0, 0, 0, 0.3);
      --glow-gold: 0 0 15px rgba(255, 193, 7, 0.3);

      --font-display: 'Merriweather', serif;
      --font-ui: 'Roboto', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background-color: var(--bg-deep);
      color: var(--text-main);
      font-family: var(--font-ui);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 400px;
    }

    /* --- UI COMPONENTS --- */
    button {
      cursor: pointer;
      border: none;
      outline: none;
      font-family: var(--font-ui);
      transition: all 0.1s;
    }

    button:active {
      transform: scale(0.96);
    }

    .panel {
      position: relative;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* LEFT PANEL (GAMEPLAY) */
    .game-stage {
      background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .header-stats {
      position: absolute;
      top: 20px;
      text-align: center;
      z-index: 10;
      width: 100%;
      pointer-events: none;
    }

    .currency-display {
      font-family: var(--font-display);
      font-size: 3.5rem;
      font-weight: 900;
      text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }

    .currency-sub {
      color: var(--accent-gold);
      font-weight: 700;
      letter-spacing: 2px;
      font-size: 1.2rem;
      text-transform: uppercase;
    }

    .cps-badge {
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 5px 15px;
      border-radius: 20px;
      display: inline-block;
      backdrop-filter: blur(5px);
      font-size: 0.9rem;
      color: #ddd;
    }

    /* MAIN CLICKER */
    .click-target-container {
      position: relative;
      width: 300px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    #main-clicker {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
      transition: transform 0.05s, filter 0.2s;
      cursor: pointer;
    }

    #main-clicker:hover {
      filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2)) brightness(1.1);
      transform: scale(1.02);
    }

    #main-clicker:active {
      transform: scale(0.95) rotate(-2deg);
    }

    /* RIGHT PANEL (UI) */
    .ui-panel {
      background: var(--bg-panel);
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
    }

    .tabs {
      display: flex;
      background: #000;
      border-bottom: 1px solid #333;
    }

    .tab-btn {
      flex: 1;
      padding: 15px;
      background: transparent;
      color: var(--text-dim);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.8rem;
      border-bottom: 3px solid transparent;
    }

    .tab-btn.active {
      color: var(--text-main);
      border-bottom-color: var(--accent-gold);
      background: rgba(255, 255, 255, 0.05);
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      scrollbar-width: thin;
      scrollbar-color: #444 #111;
    }

    .section-title {
      font-family: var(--font-display);
      font-size: 0.9rem;
      color: #666;
      margin: 15px 0 5px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding-left: 5px;
      border-bottom: 1px solid #333;
    }

    /* CARDS (Buildings/Upgrades) */
    .card {
      background: var(--bg-item);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: #555;
      background: #2a2a2a;
    }

    .card:active {
      transform: scale(0.98);
    }

    .card.locked {
      opacity: 0.5;
      filter: grayscale(1);
      pointer-events: none;
    }

    .card.affordable {
      border-left: 3px solid var(--accent-green);
    }

    .card-icon {
      font-size: 2rem;
      width: 50px;
      text-align: center;
      margin-right: 15px;
    }

    .card-info {
      flex: 1;
    }

    .card-name {
      font-weight: 700;
      font-size: 1rem;
      color: #fff;
    }

    .card-cost {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--accent-red);
    }

    .affordable .card-cost {
      color: var(--accent-green);
    }

    .card-count {
      font-size: 1.5rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      position: absolute;
      right: 10px;
      bottom: -5px;
      pointer-events: none;
    }

    .upgrade-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .upgrade-item {
      width: 50px;
      height: 50px;
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      position: relative;
    }

    .upgrade-item:hover {
      border-color: var(--accent-gold);
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.2);
    }

    /* PARTICLES */
    #particle-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      font-weight: 900;
      pointer-events: none;
      will-change: transform, opacity;
    }

    .floating-text {
      color: #fff;
      font-size: 1.2rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    .falling-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .modal-overlay.open {
      display: flex;
      opacity: 1;
    }

    .modal-window {
      background: #18181b;
      border: 1px solid #333;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 85vh;
    }

    .modal-overlay.open .modal-window {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px;
      background: linear-gradient(to right, #222, #111);
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: var(--font-display);
      font-weight: 900;
      color: var(--accent-gold);
      font-size: 1.4rem;
    }

    .close-btn {
      background: none;
      color: #666;
      font-size: 1.5rem;
      padding: 0 10px;
    }

    .close-btn:hover {
      color: #fff;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    /* CASINO SPECIFIC */
    .roulette-track {
      height: 80px;
      background: #000;
      border: 2px solid #333;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
      border-radius: 4px;
    }

    .roulette-marker {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-gold);
      transform: translateX(-50%);
      z-index: 10;
      box-shadow: 0 0 10px var(--accent-gold);
    }

    .roulette-strip {
      display: flex;
      height: 100%;
      position: absolute;
      left: 50%;
      will-change: transform;
    }

    .r-card {
      width: 70px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      border-right: 1px solid rgba(0, 0, 0, 0.5);
    }

    .rc-red {
      background: #c0392b;
    }

    .rc-black {
      background: #2c3e50;
    }

    .rc-green {
      background: #f1c40f;
      color: #000;
    }

    /* PRESTIGE TREE */
    .skill-tree {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 15px;
    }

    .skill-node {
      aspect-ratio: 1;
      background: #222;
      border: 2px solid #444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
    }

    .skill-node.purchased {
      border-color: var(--accent-blue);
      background: rgba(52, 152, 219, 0.2);
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.4);
    }

    .skill-node:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 8px;
      border-radius: 4px;
      width: 150px;
      text-align: center;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 100;
      border: 1px solid #444;
    }

    /* MEDIA QUERIES */
    @media (max-width: 800px) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }

      .panel {
        height: 100%;
      }

      .ui-panel {
        border-left: none;
        border-top: 1px solid #333;
      }
    }

    /* UTILS */
    .hidden {
      display: none !important;
    }

    .btn-action {
      width: 100%;
      padding: 15px;
      background: var(--accent-blue);
      color: #fff;
      font-weight: 900;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }

    .btn-action:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

  <!-- LEFT PANEL: GAMEPLAY -->
  <div class="panel game-stage">
    <div id="visual-canvas" style="position: absolute; inset:0; pointer-events:none; opacity:0.3;"></div>

    <div class="header-stats">
      <div id="score" class="currency-display">0</div>
      <div class="currency-sub">Kleinis</div>
      <div id="cps" class="cps-badge">0.0 / sek</div>
    </div>

    <div class="click-target-container">
      <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="main-clicker"
        draggable="false">
    </div>

    <!-- Floating Buttons -->
    <div style="position: absolute; bottom: 20px; display: flex; gap: 10px;">
      <button onclick="Game.ui.openModal('prestige')"
        style="background: var(--accent-blue); padding: 10px 20px; border-radius: 30px; font-weight: bold; color: white; box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);">üöÄ
        Zeitreise</button>
      <button onclick="Game.ui.openModal('casino')"
        style="background: var(--accent-gold); padding: 10px 20px; border-radius: 30px; font-weight: bold; color: black; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);">üé∞
        Casino</button>
      <button onclick="Game.ui.openModal('skins')"
        style="background: var(--accent-purple); padding: 10px 20px; border-radius: 30px; font-weight: bold; color: white;">üéí
        Skins</button>
    </div>

    <div id="particle-layer"></div>
  </div>

  <!-- RIGHT PANEL: UI -->
  <div class="panel ui-panel">
    <div class="tabs">
      <button class="tab-btn active" onclick="Game.ui.switchTab('buildings')">Geb√§ude</button>
      <button class="tab-btn" onclick="Game.ui.switchTab('upgrades')">Upgrades</button>
      <button class="tab-btn" onclick="Game.ui.openModal('leaderboard')">Rangliste</button>
    </div>

    <div id="tab-buildings" class="scroll-area">
      <div id="click-upgrade-container"></div>
      <div class="section-title">Immobilien & Assets</div>
      <div id="buildings-list"></div>
    </div>

    <div id="tab-upgrades" class="scroll-area hidden">
      <div class="section-title">Verf√ºgbare Verbesserungen</div>
      <div id="upgrades-list" class="upgrade-grid"></div>
    </div>
  </div>

  <!-- MODALS -->

  <!-- CASINO -->
  <div id="modal-casino" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <div class="modal-title">üé∞ High Stakes</div>
        <button class="close-btn" onclick="Game.ui.closeModals()">√ó</button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div
          style="background: #111; padding: 10px; border-radius: 8px; margin-bottom: 15px; color: var(--accent-gold);">
          Guthaben: <span id="casino-balance">0</span>
        </div>
        <div class="roulette-track">
          <div class="roulette-marker"></div>
          <div class="roulette-strip" id="roulette-strip"></div>
        </div>

        <input type="number" id="bet-input" placeholder="Einsatz"
          style="background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:5px; width:100px; text-align:center; font-size:1.1rem;">
        <div style="margin: 15px 0; display:flex; gap:10px; justify-content:center;">
          <button class="btn-action" style="background: #c0392b; flex:1;" onclick="Game.casino.spin('red')">ROT
            (x2)</button>
          <button class="btn-action" style="background: #2c3e50; flex:1;" onclick="Game.casino.spin('black')">SCHWARZ
            (x2)</button>
          <button class="btn-action" style="background: #f1c40f; color:#000; flex:1;"
            onclick="Game.casino.spin('green')">GOLD (x14)</button>
        </div>
        <div style="font-size:0.8rem; color:#666;">Warnung: Hausvorteil ist mathematisch unvermeidbar.</div>
      </div>
    </div>
  </div>

  <!-- PRESTIGE -->
  <div id="modal-prestige" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <div class="modal-title">üåå Zeitreise & Prestige</div>
        <button class="close-btn" onclick="Game.ui.closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 20px;">
          <p style="color:#aaa;">Reset your progress to gain <b>Prestige Tokens</b>.</p>
          <h2 id="prestige-gain" style="color: var(--accent-blue); font-size: 2rem; margin: 10px 0;">+0 Tokens</h2>
          <button id="btn-do-prestige" class="btn-action" onclick="Game.prestige.ascend()">RESET DURCHF√úHREN</button>
        </div>

        <div class="section-title">Time Capsule (Skill Tree)</div>
        <div class="skill-tree" id="skill-tree-container">
          <!-- Skills injected via JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- SKINS -->
  <div id="modal-skins" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <div class="modal-title">üéí Inventar</div>
        <button class="close-btn" onclick="Game.ui.closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="skins-grid" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="modal-leaderboard" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <div class="modal-title">üèÜ Top Spieler</div>
        <button class="close-btn" onclick="Game.ui.closeModals()">√ó</button>
      </div>
      <div class="modal-body" id="lb-content">
        Lade Daten...
      </div>
    </div>
  </div>

  <script>
    /**
     * KLEINCLICKER REFORGED
     * Architecture: Singleton Classes for Engine, UI, Audio, and Systems.
     */

    const CONFIG = {
      SAVE_KEY: 'KleinClicker_Precision_V6', // Keeping compatibility
      BUILDINGS: [
        { id: 0, name: 'Maxis Zeigefinger', baseCost: 15, baseCps: 0.1, icon: 'üëÜ' },
        { id: 1, name: 'Magdas Oma', baseCost: 100, baseCps: 1, icon: 'üëµ' },
        { id: 2, name: 'Cedrics Acker', baseCost: 1100, baseCps: 8, icon: 'üåæ' },
        { id: 3, name: 'Maltes Meme Mine', baseCost: 12000, baseCps: 47, icon: '‚õèÔ∏è' },
        { id: 4, name: 'Jans Strandkorbfabrik', baseCost: 130000, baseCps: 260, icon: 'üè≠' },
        { id: 5, name: 'Tills Tresor', baseCost: 1400000, baseCps: 1400, icon: 'üè¶' },
        { id: 6, name: 'Nicos Sekten-Tempel', baseCost: 20000000, baseCps: 7800, icon: 'üèõÔ∏è' },
        { id: 7, name: 'Maxis Klon-Labor', baseCost: 330000000, baseCps: 45000, icon: 'üß¨' },
        { id: 8, name: 'Magdas Mars-Rakete', baseCost: 5100000000, baseCps: 280000, icon: 'üöÄ' },
        { id: 9, name: 'Cedrics Dimensionstor', baseCost: 75000000000, baseCps: 1600000, icon: 'üåÄ' },
        { id: 10, name: 'Maltes Zeitmaschine', baseCost: 900000000000, baseCps: 12000000, icon: '‚è≥' },
        { id: 11, name: 'Franjas feuchtes Universum', baseCost: 15000000000000, baseCps: 150000000, icon: 'üåå' }
      ],
      UPGRADES: [
        { id: 'u_click_1', name: 'Plastik Maus', cost: 500, type: 'click', multi: 2, icon: 'üñ±Ô∏è' },
        { id: 'u_b0_1', name: 'Carpaltunnel', cost: 1000, type: 'build', target: 0, multi: 2, icon: 'ü©π' },
        { id: 'u_b1_1', name: 'Nudelholz', cost: 5000, type: 'build', target: 1, multi: 2, icon: 'ü•ñ' },
        { id: 'u_b2_1', name: 'D√ºnger', cost: 150000, type: 'build', target: 2, multi: 2, icon: 'üí©' },
        // Simplified list for brevity, logic handles arbitrary upgrades
      ],
      PRESTIGE_SKILLS: [
        { id: 'p_keep_10', name: 'Immobilienmakler', desc: 'Behalte 10% deiner Geb√§ude nach Reset', cost: 1 },
        { id: 'p_passive_5', name: 'Zinseszins', desc: '+5% CPS permanent', cost: 2 },
        { id: 'p_crit_chance', name: 'Gl√ºckstreffer', desc: '1% Chance auf x10 Klick-Wert', cost: 5 }
      ],
      SKINS: [
        { id: 'default', name: 'Original Klein', url: "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png", filter: '' },
        { id: 'gold', name: 'Golden God', url: "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png", filter: 'hue-rotate(45deg) saturate(3) brightness(1.2)' },
        { id: 'dark', name: 'Dark Mode', url: "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png", filter: 'invert(1) hue-rotate(180deg)' }
      ]
    };

    /* --- AUDIO SYSTEM (Web Audio API) --- */
    class AudioSynth {
      constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.enabled = true;
      }

      playTone(freq, type, duration) {
        if (!this.enabled || this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
      }

      click() { this.playTone(600 + Math.random() * 200, 'sine', 0.1); }
      buy() { this.playTone(400, 'square', 0.15); this.playTone(600, 'square', 0.15); }
      win() { this.playTone(800, 'triangle', 0.3); this.playTone(1200, 'triangle', 0.5); }
    }

    /* --- PARTICLE SYSTEM (Object Pooling) --- */
    class ParticleSystem {
      constructor() {
        this.pool = [];
        this.active = [];
        this.container = document.getElementById('particle-layer');
        this.maxParticles = 50;

        // Init pool
        for (let i = 0; i < this.maxParticles; i++) {
          const el = document.createElement('div');
          el.className = 'particle';
          el.style.display = 'none';
          this.container.appendChild(el);
          this.pool.push(el);
        }
      }

      spawnText(x, y, text, color = '#fff') {
        if (this.pool.length === 0) return; // Drop particle if busy
        const el = this.pool.pop();

        el.textContent = text;
        el.className = 'particle floating-text';
        el.style.color = color;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.display = 'block';
        el.style.transform = 'translate(-50%, -50%) scale(1)';
        el.style.opacity = '1';

        // Simple physics animation via JS loop for better control than pure CSS
        const p = { el, x, y, vy: -2 - Math.random(), life: 1.0 };
        this.active.push(p);
      }

      update(dt) {
        for (let i = this.active.length - 1; i >= 0; i--) {
          const p = this.active[i];
          p.life -= dt;
          p.y += p.vy;
          p.el.style.top = p.y + 'px';
          p.el.style.opacity = p.life;

          if (p.life <= 0) {
            p.el.style.display = 'none';
            this.pool.push(p.el);
            this.active.splice(i, 1);
          }
        }
      }
    }

    /* --- GAME LOGIC --- */
    class GameEngine {
      constructor() {
        this.state = {
          score: 0,
          totalScore: 0,
          clicks: 0,
          clickLevel: 1,
          buildings: new Array(CONFIG.BUILDINGS.length).fill(0),
          upgrades: [],
          prestige: { tokens: 0, level: 0, skills: [] },
          skin: 'default',
          playerName: 'Spieler' + Math.floor(Math.random() * 9999)
        };

        this.audio = new AudioSynth();
        this.particles = new ParticleSystem();
        this.lastTime = 0;
        this.accumulatedTime = 0;
      }

      init() {
        this.load();
        this.ui = new UIManager(this);
        this.casino = new CasinoManager(this);
        this.prestige = new PrestigeManager(this);

        this.ui.init();
        this.setupInputs();

        requestAnimationFrame((t) => this.loop(t));
        setInterval(() => this.save(), 5000); // Auto-save

        // Initialize Firebase
        try {
          const app = firebase.initializeApp({
            databaseURL: "https://kleinclicker-default-rtdb.europe-west1.firebasedatabase.app",
          });
          this.db = firebase.database();
        } catch (e) { console.warn("Firebase Error", e); }
      }

      load() {
        const raw = localStorage.getItem(CONFIG.SAVE_KEY);
        if (raw) {
          try {
            const data = JSON.parse(raw);
            // Migration logic: old save had buildings as array of nums.
            this.state.score = data.score || 0;
            this.state.totalScore = data.totalScore || 0;
            this.state.buildings = data.buildings || this.state.buildings;
            this.state.upgrades = data.upgrades || [];
            this.state.clickLevel = data.clickLevel || 1;
            if (data.prestige) {
              // Convert old simple number prestige to new object if needed
              if (typeof data.prestige === 'number') {
                this.state.prestige = { tokens: data.prestige, level: data.prestige, skills: [] };
              } else {
                this.state.prestige = data.prestige;
              }
            }
            this.state.skin = data.equippedSkin || 'default';
            this.state.playerName = data.playerName || this.state.playerName;
          } catch (e) { console.error("Save Corrupt", e); }
        }
      }

      save() {
        // Add simple hash for "security"
        const data = JSON.stringify(this.state);
        localStorage.setItem(CONFIG.SAVE_KEY, data);

        // Sync Leaderboard
        if (this.db && this.state.totalScore > 1000) {
          this.db.ref('leaderboard/' + this.state.playerName).set({
            name: this.state.playerName,
            score: Math.floor(this.state.totalScore),
            prestige: this.state.prestige.level
          });
        }
      }

      setupInputs() {
        const target = document.getElementById('main-clicker');

        // Handle mouse/touch
        const clickHandler = (e) => {
          e.preventDefault();
          // Multi-touch support
          const touches = e.changedTouches || [e];
          for (let t of touches) {
            this.handleClick(t.clientX, t.clientY);
          }
        };

        target.addEventListener('mousedown', clickHandler);
        target.addEventListener('touchstart', clickHandler, { passive: false });
      }

      getClickPower() {
        let base = 1 + (this.state.clickLevel * 2);
        let cpsPerc = this.getCPS() * 0.05; // 5% of CPS adds to click
        let power = base + cpsPerc;

        // Multipliers
        this.state.upgrades.forEach(uid => {
          const u = CONFIG.UPGRADES.find(x => x.id === uid);
          if (u && u.type === 'click') power *= u.multi;
        });

        // Prestige Multiplier (10% per level)
        power *= (1 + this.state.prestige.level * 0.1);

        // Skill Tree
        if (this.state.prestige.skills.includes('p_passive_5')) power *= 1.05;

        return power;
      }

      getCPS() {
        let cps = 0;
        this.state.buildings.forEach((count, i) => {
          let bBase = CONFIG.BUILDINGS[i].baseCps;
          // Apply upgrades
          CONFIG.UPGRADES.forEach(u => {
            if (u.type === 'build' && u.target === i && this.state.upgrades.includes(u.id)) {
              bBase *= u.multi;
            }
          });
          cps += count * bBase;
        });

        // Prestige Multiplier
        cps *= (1 + this.state.prestige.level * 0.1);

        // Skill Tree
        if (this.state.prestige.skills.includes('p_passive_5')) cps *= 1.05;

        return cps;
      }

      handleClick(x, y) {
        const power = this.getClickPower();

        // Crit Logic
        let isCrit = false;
        if (this.state.prestige.skills.includes('p_crit_chance') && Math.random() < 0.01) {
          isCrit = true;
        }

        const finalAmt = isCrit ? power * 10 : power;

        this.addCurrency(finalAmt);
        this.state.clicks++;
        this.audio.click();

        this.particles.spawnText(x, y, `+${this.formatNumber(finalAmt)}`, isCrit ? '#e74c3c' : '#fff');
      }

      addCurrency(amt) {
        this.state.score += amt;
        this.state.totalScore += amt;
      }

      loop(timestamp) {
        if (!this.lastTime) this.lastTime = timestamp;
        const dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;

        // Passive Generation
        if (dt > 0 && dt < 2) { // Prevent huge jumps on tab switch
          const eps = this.getCPS() * dt;
          if (eps > 0) this.addCurrency(eps);
        }

        // UI Updates
        this.particles.update(dt);
        this.ui.update(dt);

        requestAnimationFrame((t) => this.loop(t));
      }

      formatNumber(num) {
        if (num < 1000) return Math.floor(num);
        if (num < 1000000) return (num / 1000).toFixed(2) + 'k';
        if (num < 1000000000) return (num / 1000000).toFixed(2) + 'M';
        return (num / 1000000000).toFixed(2) + 'B';
      }
    }

    /* --- UI MANAGER --- */
    class UIManager {
      constructor(game) {
        this.game = game;
        this.elScore = document.getElementById('score');
        this.elCPS = document.getElementById('cps');
        this.buildingList = document.getElementById('buildings-list');
        this.modalOverlay = null;
      }

      init() {
        // Generate Building DOM once
        CONFIG.BUILDINGS.forEach((b, i) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.id = `b-card-${i}`;
          div.onclick = () => this.buyBuilding(i);
          div.innerHTML = `
                        <div class="card-icon">${b.icon}</div>
                        <div class="card-info">
                            <div class="card-name">${b.name}</div>
                            <div class="card-cost" id="b-cost-${i}">Loading...</div>
                        </div>
                        <div class="card-count" id="b-count-${i}">0</div>
                    `;
          this.buildingList.appendChild(div);
        });

        // Generate Click Upgrade UI
        const uContainer = document.getElementById('click-upgrade-container');
        const cDiv = document.createElement('div');
        cDiv.className = 'card';
        cDiv.style.background = 'linear-gradient(45deg, #222, #333)';
        cDiv.onclick = () => this.buyClickLevel();
        cDiv.innerHTML = `
                    <div class="card-icon">üñ±Ô∏è</div>
                    <div class="card-info">
                        <div class="card-name">Maus Training</div>
                        <div class="card-cost" id="click-up-cost">Cost: 100</div>
                    </div>
                    <div class="card-count" id="click-level-display">Lvl 1</div>
                `;
        uContainer.appendChild(cDiv);

        this.renderUpgrades();
        this.updateSkin();
      }

      update(dt) {
        // Throttled UI updates can go here if needed, but modern browsers handle textContent well
        this.elScore.textContent = this.game.formatNumber(this.game.state.score);
        this.elCPS.textContent = this.game.formatNumber(this.game.getCPS()) + ' / sek';

        // Update Buildings State
        CONFIG.BUILDINGS.forEach((b, i) => {
          const cost = Math.floor(b.baseCost * Math.pow(1.15, this.game.state.buildings[i]));
          document.getElementById(`b-count-${i}`).textContent = this.game.state.buildings[i];
          document.getElementById(`b-cost-${i}`).textContent = this.game.formatNumber(cost);

          const card = document.getElementById(`b-card-${i}`);
          if (this.game.state.score >= cost) card.classList.add('affordable');
          else card.classList.remove('affordable');
        });

        // Update Click Upgrade
        const clickCost = Math.floor(500 * Math.pow(2.5, this.game.state.clickLevel));
        document.getElementById('click-up-cost').textContent = this.game.formatNumber(clickCost);
        document.getElementById('click-level-display').textContent = 'Lvl ' + this.game.state.clickLevel;
      }

      buyBuilding(id) {
        const count = this.game.state.buildings[id];
        const cost = Math.floor(CONFIG.BUILDINGS[id].baseCost * Math.pow(1.15, count));
        if (this.game.state.score >= cost) {
          this.game.state.score -= cost;
          this.game.state.buildings[id]++;
          this.game.audio.buy();
          this.renderUpgrades(); // Check if new upgrades unlocked
        }
      }

      buyClickLevel() {
        const cost = Math.floor(500 * Math.pow(2.5, this.game.state.clickLevel));
        if (this.game.state.score >= cost) {
          this.game.state.score -= cost;
          this.game.state.clickLevel++;
          this.game.audio.buy();
        }
      }

      renderUpgrades() {
        const list = document.getElementById('upgrades-list');
        list.innerHTML = '';

        CONFIG.UPGRADES.forEach(u => {
          if (this.game.state.upgrades.includes(u.id)) return; // Already bought

          // Simple unlock check: Show if we have 50% of the cost earned ever
          if (this.game.state.totalScore < u.cost * 0.5) return;

          const el = document.createElement('div');
          el.className = 'upgrade-item';
          el.textContent = u.icon;
          if (this.game.state.score < u.cost) el.style.opacity = '0.5';

          el.onclick = () => {
            if (this.game.state.score >= u.cost) {
              this.game.state.score -= u.cost;
              this.game.state.upgrades.push(u.id);
              this.game.audio.buy();
              this.renderUpgrades();
            }
          };
          list.appendChild(el);
        });
      }

      switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.scroll-area').forEach(d => d.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
      }

      openModal(id) {
        const modal = document.getElementById(`modal-${id}`);
        if (modal) {
          modal.classList.add('open');
          if (id === 'prestige') this.game.prestige.render();
          if (id === 'leaderboard') this.loadLeaderboard();
          if (id === 'skins') this.renderSkins();
          if (id === 'casino') document.getElementById('casino-balance').textContent = this.game.formatNumber(this.game.state.score);
        }
      }

      closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
      }

      loadLeaderboard() {
        const div = document.getElementById('lb-content');
        if (!this.game.db) { div.innerHTML = 'Datenbank nicht verbunden.'; return; }

        this.game.db.ref('leaderboard').orderByChild('score').limitToLast(10).once('value', s => {
          let html = '<table style="width:100%; text-align:left;"><tr><th>Name</th><th>Score</th></tr>';
          const arr = [];
          s.forEach(c => arr.push(c.val()));
          arr.reverse().forEach(p => {
            html += `<tr><td style="padding:5px; border-bottom:1px solid #333;">${p.name}</td><td style="color:var(--accent-green);">${this.game.formatNumber(p.score)}</td></tr>`;
          });
          html += '</table>';
          div.innerHTML = html;
        });
      }

      renderSkins() {
        const grid = document.getElementById('skins-grid');
        grid.innerHTML = '';
        CONFIG.SKINS.forEach(s => {
          const d = document.createElement('div');
          d.style.cssText = "width:80px; height:80px; background:#222; border:2px solid #444; border-radius:8px; cursor:pointer; display:flex; justify-content:center; align-items:center;";
          if (this.game.state.skin === s.id) d.style.borderColor = 'var(--accent-gold)';

          d.innerHTML = `<img src="${s.url}" style="width:60px; filter:${s.filter}">`;
          d.onclick = () => {
            this.game.state.skin = s.id;
            this.updateSkin();
            this.renderSkins();
          };
          grid.appendChild(d);
        });
      }

      updateSkin() {
        const s = CONFIG.SKINS.find(x => x.id === this.game.state.skin) || CONFIG.SKINS[0];
        const img = document.getElementById('main-clicker');
        img.src = s.url;
        img.style.filter = `drop-shadow(0 10px 20px rgba(0,0,0,0.5)) ${s.filter}`;
      }
    }

    /* --- CASINO MANAGER (Anti-Scum) --- */
    class CasinoManager {
      constructor(game) {
        this.game = game;
        this.spinning = false;
      }

      spin(color) {
        if (this.spinning) return;
        const betInput = document.getElementById('bet-input');
        let bet = parseInt(betInput.value);

        if (isNaN(bet) || bet <= 0) return;
        if (bet > this.game.state.score) bet = Math.floor(this.game.state.score);
        if (bet <= 0) return;

        // 1. DEDUCT IMMEDIATELY
        this.game.state.score -= bet;
        this.game.save(); // Lock in the bet
        this.updateBalance();

        this.spinning = true;

        // 2. DETERMINE RESULT
        const r = Math.random();
        let resultColor = 'black';
        if (r < 0.05) resultColor = 'green';
        else if (r < 0.525) resultColor = 'red';

        // 3. ANIMATE
        this.animateStrip(resultColor, () => {
          // 4. PAYOUT LOGIC (After animation)
          let multi = 0;
          if (color === resultColor) {
            multi = (color === 'green') ? 14 : 2;
            this.game.audio.win();
          }

          if (multi > 0) {
            this.game.addCurrency(bet * multi);
            alert(`GEWONNEN! +${this.game.formatNumber(bet * multi)}`);
          }

          this.game.save();
          this.updateBalance();
          this.spinning = false;
        });
      }

      updateBalance() {
        document.getElementById('casino-balance').textContent = this.game.formatNumber(this.game.state.score);
      }

      animateStrip(winner, callback) {
        const strip = document.getElementById('roulette-strip');
        strip.innerHTML = '';
        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0)';

        // Build a strip of 50 items
        const cards = [];
        for (let i = 0; i < 50; i++) {
          const c = Math.random();
          let type = c < 0.05 ? 'green' : (c < 0.525 ? 'red' : 'black');
          // Force index 40 to be winner
          if (i === 40) type = winner;

          const el = document.createElement('div');
          el.className = `r-card rc-${type}`;
          el.textContent = type === 'green' ? 'üíé' : (Math.floor(Math.random() * 14) + 1);
          strip.appendChild(el);
        }

        // Trigger reflow
        strip.offsetHeight;

        // Calc offset (Card width 70px)
        // We want index 40 centered. 
        // Track width ~500px (depends on screen). Center is ~250px.
        // 40 * 70 = 2800px.
        const offset = 2800 - (strip.parentElement.offsetWidth / 2) + 35;
        const rand = Math.floor(Math.random() * 20) - 10; // Jitter

        strip.style.transition = 'transform 4s cubic-bezier(0.1, 0.8, 0.1, 1)';
        strip.style.transform = `translateX(-${offset + rand}px)`;

        setTimeout(callback, 4100);
      }
    }

    /* --- PRESTIGE MANAGER --- */
    class PrestigeManager {
      constructor(game) {
        this.game = game;
      }

      calculateGain() {
        if (this.game.state.totalScore < 1000000) return 0;
        return Math.floor(Math.cbrt(this.game.state.totalScore / 1000000));
      }

      render() {
        const gain = this.calculateGain();
        const current = this.game.state.prestige.level;
        const diff = gain - current;

        const btn = document.getElementById('btn-do-prestige');
        const label = document.getElementById('prestige-gain');

        if (diff > 0) {
          label.textContent = `+${diff} Level & Tokens`;
          btn.disabled = false;
          btn.style.opacity = '1';
        } else {
          label.textContent = "Ben√∂tigt mehr Score";
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }

        // Render Skill Tree
        const tree = document.getElementById('skill-tree-container');
        tree.innerHTML = '';
        CONFIG.PRESTIGE_SKILLS.forEach(skill => {
          const el = document.createElement('div');
          const owned = this.game.state.prestige.skills.includes(skill.id);
          el.className = `skill-node ${owned ? 'purchased' : ''}`;
          el.innerHTML = owned ? '‚úì' : skill.cost;
          el.setAttribute('data-tooltip', `${skill.name}: ${skill.desc}`);

          el.onclick = () => {
            if (!owned && this.game.state.prestige.tokens >= skill.cost) {
              this.game.state.prestige.tokens -= skill.cost;
              this.game.state.prestige.skills.push(skill.id);
              this.game.save();
              this.render();
            }
          };
          tree.appendChild(el);
        });
      }

      ascend() {
        const gain = this.calculateGain() - this.game.state.prestige.level;
        if (gain <= 0) return;

        // 1. Update Prestige Data
        this.game.state.prestige.level += gain;
        this.game.state.prestige.tokens += gain;

        // 2. Hard Reset Game Logic (Keep Buildings based on skill)
        this.game.state.score = 0;
        this.game.state.clicks = 0;
        this.game.state.clickLevel = 1;
        this.game.state.upgrades = [];

        const keepBuildings = this.game.state.prestige.skills.includes('p_keep_10');
        if (keepBuildings) {
          this.game.state.buildings = this.game.state.buildings.map(n => Math.floor(n * 0.1));
        } else {
          this.game.state.buildings.fill(0);
        }

        this.game.save();
        location.reload();
      }
    }

    // --- BOOTSTRAP ---
    const Game = new GameEngine();
    window.Game = Game; // Expose for debugging/buttons
    window.onload = () => Game.init();

  </script>
</body>

</html>