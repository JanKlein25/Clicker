<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker Legacy</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-pattern: #1e1e24;
      --panel-left: #2b2b36;
      --panel-right: #26262e;
      --header-bg: #15151a;
      --gold: #f1c40f;
      --text-main: #ecf0f1;
      --text-dim: #95a5a6;
      --border-color: #000;
      --highlight: #3498db;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #000;
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- BACKGROUND PARTICLES --- */
    #bgCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
      pointer-events: none;
      opacity: 0.3;
    }

    /* --- TOP BAR (NEWS TICKER) --- */
    #topBar {
      height: 40px;
      background: #000;
      border-bottom: 2px solid #333;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .news-content {
      white-space: nowrap;
      position: absolute;
      animation: ticker 15s linear infinite;
      font-family: 'Merriweather', serif;
      font-size: 0.9rem;
      color: #bdc3c7;
    }
    
    @keyframes ticker {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100%); }
    }

    /* --- MAIN LAYOUT --- */
    #gameContainer {
      display: flex;
      flex: 1;
      z-index: 10;
      height: calc(100vh - 40px);
    }

    /* --- LEFT PANEL (CLICKING) --- */
    .left-panel {
      flex: 1;
      background: radial-gradient(circle at center, #353b48 0%, #1e1e24 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      border-right: 4px solid #000;
      box-shadow: inset -10px 0 20px rgba(0,0,0,0.5);
    }

    .bakery-name {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Merriweather', serif;
      font-weight: 900;
      font-size: 1.8rem;
      text-shadow: 0 2px 0 #000;
      background: rgba(0,0,0,0.3);
      padding: 5px 0;
    }

    .score-container {
      margin-bottom: 20px;
      text-align: center;
      z-index: 20;
    }

    #score {
      font-family: 'Merriweather', serif;
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255,255,255,0.2);
    }
    
    #cps {
      font-size: 1.1rem;
      color: var(--text-dim);
    }

    #bigKlein {
      width: 280px;
      height: 280px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.05s;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
      z-index: 20;
    }
    #bigKlein:active { transform: scale(0.95); }
    #bigKlein:hover { filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }

    /* --- RIGHT PANEL (STORE) --- */
    .right-panel {
      width: 350px;
      background: var(--panel-right);
      display: flex;
      flex-direction: column;
      border-left: 1px solid #444;
    }

    @media (max-width: 800px) {
      /* Mobile Layout Switch */
      #gameContainer { flex-direction: column; overflow-y: auto; }
      .left-panel { min-height: 50vh; border-right: none; border-bottom: 4px solid #000; }
      .right-panel { width: 100%; height: auto; }
      #bgCanvas { display: none; } /* Performance on mobile */
    }

    /* Store Header */
    .store-header {
      background: #000;
      padding: 10px;
      text-align: center;
      font-family: 'Merriweather', serif;
      font-weight: bold;
      color: var(--gold);
      border-bottom: 1px solid #444;
    }

    /* Upgrades Grid */
    .upgrades-container {
      padding: 10px;
      background: rgba(0,0,0,0.2);
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      min-height: 60px;
      border-bottom: 2px solid #000;
    }
    
    .upgrade-crate {
      width: 48px;
      height: 48px;
      background: #333;
      border: 1px solid #555;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.1s;
    }
    .upgrade-crate:hover { border-color: #fff; background: #444; }
    .upgrade-crate:active { transform: scale(0.95); }
    
    /* Tooltip */
    .upgrade-crate .tooltip {
      visibility: hidden;
      width: 200px;
      background-color: #111;
      color: #fff;
      text-align: left;
      border: 2px solid #fff;
      padding: 10px;
      border-radius: 4px;
      position: absolute;
      z-index: 1000;
      top: 100%;
      right: 0;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      font-size: 0.8rem;
    }
    .upgrade-crate:hover .tooltip { visibility: visible; opacity: 1; }

    /* Buildings List */
    .buildings-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #555 #222;
    }

    .building-row {
      height: 64px;
      background: linear-gradient(to bottom, #444, #333);
      border-bottom: 1px solid #000;
      display: flex;
      align-items: center;
      padding: 0 10px;
      cursor: pointer;
      position: relative;
      opacity: 0.7;
      transition: all 0.2s;
    }
    .building-row:hover { opacity: 1; background: linear-gradient(to bottom, #555, #444); }
    .building-row.locked { display: none; }
    .building-row.can-afford { opacity: 1; }
    .building-row.too-expensive { opacity: 0.6; filter: grayscale(0.5); }

    .b-icon { font-size: 2rem; width: 50px; text-align: center; margin-right: 10px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
    .b-info { flex: 1; display: flex; flex-direction: column; }
    .b-name { font-weight: bold; font-family: 'Merriweather', serif; font-size: 1.1rem; text-shadow: 1px 1px 0 #000; }
    .b-cost { color: #2ecc71; font-weight: bold; font-size: 0.9rem; }
    .b-cost.red { color: #e74c3c; }
    .b-count { font-size: 2rem; font-weight: bold; color: rgba(0,0,0,0.3); padding-right: 10px; }

    /* --- VISUAL EFFECTS --- */
    .click-fx {
      position: absolute;
      color: #fff;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 1s ease-out forwards;
      z-index: 100;
      text-shadow: 0 0 3px #000;
      font-family: 'Merriweather', serif;
    }
    
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-50px); }
    }

    /* --- BUFF BAR --- */
    .buff-container {
      position: absolute;
      top: 50%;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 50;
    }
    .buff-icon {
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.5);
      border: 2px solid var(--gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold);
      font-size: 1.2rem;
      position: relative;
    }
    .buff-timer {
      position: absolute;
      bottom: -15px;
      font-size: 0.7rem;
      background: #000;
      padding: 1px 4px;
      border-radius: 4px;
    }

    /* --- GOLDEN COOKIE --- */
    #goldenKlein {
      position: absolute;
      width: 90px;
      height: 90px;
      z-index: 2000;
      cursor: pointer;
      display: none;
      animation: pulse 1s infinite;
      filter: drop-shadow(0 0 15px gold);
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  </style>
</head>
<body>

  <!-- Background for falling heads -->
  <canvas id="bgCanvas"></canvas>

  <div id="topBar">
    <div class="news-content" id="newsTicker">Willkommen bei KleinClicker Legacy! Klick auf das Gesicht!</div>
  </div>

  <div id="gameContainer">
    <!-- Left: Interaction -->
    <div class="left-panel">
      <div class="bakery-name">Dein Klein-Imperium</div>
      
      <div class="score-container">
        <div id="score">0</div>
        <div id="cps">pro Sekunde: 0.0</div>
      </div>

      <div class="buff-container" id="buffArea"></div>
      
      <!-- Der "Cookie" -->
      <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="bigKlein" alt="Klick mich!">
      
      <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="goldenKlein" alt="GOLD">
    </div>

    <!-- Right: Shop -->
    <div class="right-panel">
      <div class="store-header">UPGRADES</div>
      <div class="upgrades-container" id="upgradeGrid">
        <!-- Gef√ºllt via JS -->
      </div>

      <div class="store-header">GEB√ÑUDE</div>
      <div class="buildings-list" id="buildingList">
        <!-- Gef√ºllt via JS -->
      </div>
    </div>
  </div>

  <script>
    /* --- CONFIG & DATA --- */
    const GAME_VERSION = 1.0;
    const SAVE_KEY = 'KleinClickerLegacySave';

    // Buildings: Classic Curve
    const BUILDINGS = [
      { id: 0, name: 'Maus',        baseCost: 15,      baseCps: 0.1,    icon: 'üëÜ', desc: 'Klickt automatisch f√ºr dich.' },
      { id: 1, name: 'Oma',         baseCost: 100,     baseCps: 1,      icon: 'üëµ', desc: 'Eine nette Oma backt Kleinis.' },
      { id: 2, name: 'Plantage',    baseCost: 1100,    baseCps: 8,      icon: 'üå≥', desc: 'Baut Kleinis in der Erde an.' },
      { id: 3, name: 'Mine',        baseCost: 12000,   baseCps: 47,     icon: '‚õèÔ∏è', desc: 'Sch√ºrft Kleinis aus dem Gestein.' },
      { id: 4, name: 'Fabrik',      baseCost: 130000,  baseCps: 260,    icon: 'üè≠', desc: 'Massenproduktion!' },
      { id: 5, name: 'Bank',        baseCost: 1400000, baseCps: 1400,   icon: 'üè¶', desc: 'Generiert Kleinis aus Zinsen.' },
      { id: 6, name: 'Tempel',      baseCost: 20000000,baseCps: 7800,   icon: 'üèõÔ∏è', desc: 'Bete zu den Klein-G√∂ttern.' }
    ];

    // Upgrades: Unlock conditions
    const UPGRADES = [
      { id: 'u_click1', name: 'Plastik-Maus', cost: 500,    triggerType: 'clicks', triggerVal: 100,  icon: 'üñ±Ô∏è', desc: 'Klicks sind doppelt so effektiv.', type: 'click', multi: 2 },
      { id: 'u_click2', name: 'Eisen-Maus',   cost: 50000,  triggerType: 'clicks', triggerVal: 1000, icon: '‚öíÔ∏è', desc: 'Klicks sind doppelt so effektiv.', type: 'click', multi: 2 },
      { id: 'u_b0_1',   name: 'Carpaltunnel', cost: 1000,   triggerType: 'build',  triggerId: 0, triggerVal: 10, icon: 'üëÜ', desc: 'M√§use sind doppelt so effizient.', type: 'build', target: 0, multi: 2 },
      { id: 'u_b1_1',   name: 'Nudelholz',    cost: 5000,   triggerType: 'build',  triggerId: 1, triggerVal: 10, icon: 'üëµ', desc: 'Omas sind doppelt so effizient.', type: 'build', target: 1, multi: 2 },
      { id: 'u_b1_2',   name: 'Bingo',        cost: 20000,  triggerType: 'build',  triggerId: 1, triggerVal: 50, icon: 'üé±', desc: 'Omas x2.', type: 'build', target: 1, multi: 2 },
      { id: 'u_b2_1',   name: 'D√ºnger',       cost: 55000,  triggerType: 'build',  triggerId: 2, triggerVal: 10, icon: 'üí©', desc: 'Plantagen x2.', type: 'build', target: 2, multi: 2 },
      { id: 'u_b3_1',   name: 'Sicherheitslicht', cost: 600000, triggerType: 'build', triggerId: 3, triggerVal: 10, icon: 'üî¶', desc: 'Minen x2.', type: 'build', target: 3, multi: 2 }
    ];

    const NEWS_TICKER_MSGS = [
      "Klein wird in den Nachrichten erw√§hnt!",
      "Omas beschweren sich √ºber Klick-Finger.",
      "Wissenschaftler entdecken neues Klein-Partikel.",
      "B√∂rse st√ºrzt ab, investiere in Kleinis!",
      "Janklein25 approved this game.",
      "Cookie Clicker ruft an, sie wollen ihre Mechanik zur√ºck."
    ];

    /* --- GAME STATE --- */
    let game = {
      score: 0,
      totalScore: 0,
      clicks: 0,
      buildings: new Array(BUILDINGS.length).fill(0),
      upgrades: [], // IDs of bought upgrades
      startTime: Date.now()
    };

    let buffs = {
      frenzy: { active: false, time: 0, multi: 7 }, // x7 CPS
      clickFrenzy: { active: false, time: 0, multi: 777 } // x777 Click Power
    };

    /* --- ENGINE VARS --- */
    let lastTime = performance.now();
    let goldenTimer = 0;
    
    // DOM Cache
    const elScore = document.getElementById('score');
    const elCps = document.getElementById('cps');
    const elTicker = document.getElementById('newsTicker');
    const elUpgradeGrid = document.getElementById('upgradeGrid');
    const elBuildList = document.getElementById('buildingList');
    const elBuffArea = document.getElementById('buffArea');

    /* --- INITIALIZATION --- */
    function init() {
      loadGame();
      buildUI();
      scheduleGolden();
      requestAnimationFrame(gameLoop);
      setInterval(slowLoop, 1000); // Save & Ticker
      initBackground();
    }

    /* --- MAIN LOOP --- */
    function gameLoop(now) {
      let dt = (now - lastTime) / 1000;
      if (dt > 1) dt = 1;
      lastTime = now;

      // Handle Buffs
      updateBuffs(dt);

      // Calc CPS
      const rawCps = calculateCPS();
      const buffMult = getBuffMult();
      const finalCps = rawCps * buffMult;

      if (finalCps > 0) {
        addScore(finalCps * dt);
      }

      // Render
      elScore.textContent = formatNum(Math.floor(game.score));
      elCps.textContent = "pro Sekunde: " + formatNum(finalCps, 1);
      document.title = formatNum(Math.floor(game.score)) + " Kleinis";

      // Update Building buttons (Enable/Disable visuals)
      updateBuildingButtons();

      requestAnimationFrame(gameLoop);
    }

    function slowLoop() {
      saveGame();
      
      // Rotate News
      if(Math.random() > 0.7) {
        const msg = NEWS_TICKER_MSGS[Math.floor(Math.random() * NEWS_TICKER_MSGS.length)];
        elTicker.textContent = msg;
      }
      
      // Update Upgrades (Check Unlocks)
      renderUpgrades();
    }

    /* --- LOGIC --- */
    function calculateCPS() {
      let cps = 0;
      BUILDINGS.forEach((b, i) => {
        let bCps = b.baseCps;
        const count = game.buildings[i];
        
        // Apply Building Upgrades
        UPGRADES.forEach(u => {
          if (game.upgrades.includes(u.id) && u.type === 'build' && u.target === i) {
            bCps *= u.multi;
          }
        });
        
        cps += bCps * count;
      });
      return cps;
    }

    function calculateClickPower() {
      let power = 1;
      // Base: 1 + 1% of CPS
      const rawCps = calculateCPS();
      power += rawCps * 0.01;
      
      // Click Upgrades
      UPGRADES.forEach(u => {
        if (game.upgrades.includes(u.id) && u.type === 'click') {
          power *= u.multi;
        }
      });
      
      // Buffs
      if (buffs.clickFrenzy.active) power *= 777;
      if (buffs.frenzy.active) power *= 7; // Frenzy affects clicks too in some versions, lets say yes

      return power;
    }

    function getBuffMult() {
      let m = 1;
      if (buffs.frenzy.active) m *= 7;
      return m;
    }

    function updateBuffs(dt) {
      // Frenzy
      if(buffs.frenzy.active) {
        buffs.frenzy.time -= dt;
        if(buffs.frenzy.time <= 0) {
          buffs.frenzy.active = false;
          renderBuffs();
        } else {
            // Update Timer Text
            const el = document.getElementById('buff-timer-frenzy');
            if(el) el.textContent = Math.ceil(buffs.frenzy.time) + "s";
        }
      }
      // Click Frenzy
      if(buffs.clickFrenzy.active) {
        buffs.clickFrenzy.time -= dt;
        if(buffs.clickFrenzy.time <= 0) {
          buffs.clickFrenzy.active = false;
          renderBuffs();
        } else {
             const el = document.getElementById('buff-timer-click');
             if(el) el.textContent = Math.ceil(buffs.clickFrenzy.time) + "s";
        }
      }
    }

    function addScore(amt) {
      game.score += amt;
      game.totalScore += amt;
    }

    /* --- INTERACTION --- */
    document.getElementById('bigKlein').addEventListener('mousedown', (e) => {
      const power = calculateClickPower();
      addScore(power);
      game.clicks++;
      
      createParticles(e.clientX, e.clientY, `+${formatNum(power)}`);
      
      // Tiny chance for manual update of upgrades on click
      if(game.clicks % 10 === 0) renderUpgrades();
    });

    /* --- STORE SYSTEM --- */
    function getCost(bIndex) {
      const b = BUILDINGS[bIndex];
      return Math.floor(b.baseCost * Math.pow(1.15, game.buildings[bIndex]));
    }

    function buyBuilding(index) {
      const cost = getCost(index);
      if (game.score >= cost) {
        game.score -= cost;
        game.buildings[index]++;
        
        // Update DOM
        const row = document.getElementById(`row-${index}`);
        row.querySelector('.b-count').textContent = game.buildings[index];
        row.querySelector('.b-cost').textContent = formatNum(getCost(index));
        
        // Trigger Upgrade Check
        renderUpgrades();
      }
    }

    function buyUpgrade(uId) {
      const u = UPGRADES.find(x => x.id === uId);
      if (game.score >= u.cost) {
        game.score -= u.cost;
        game.upgrades.push(uId);
        renderUpgrades(); // Remove from grid
      }
    }

    /* --- UI BUILDING --- */
    function buildUI() {
      // Build Building List
      elBuildList.innerHTML = '';
      BUILDINGS.forEach((b, i) => {
        const div = document.createElement('div');
        div.className = 'building-row';
        div.id = `row-${i}`;
        div.innerHTML = `
          <div class="b-icon">${b.icon}</div>
          <div class="b-info">
            <div class="b-name">${b.name}</div>
            <div class="b-cost">üç™ ${formatNum(getCost(i))}</div>
          </div>
          <div class="b-count">${game.buildings[i]}</div>
        `;
        div.onclick = () => buyBuilding(i);
        elBuildList.appendChild(div);
      });
      renderUpgrades();
    }

    function updateBuildingButtons() {
      BUILDINGS.forEach((b, i) => {
        const row = document.getElementById(`row-${i}`);
        const cost = getCost(i);
        
        // Unlocking logic (like cookie clicker: only show if you have ~50% of cost of previous)
        // Simple version: Always show, just dim
        if(game.score >= cost) {
          row.classList.add('can-afford');
          row.classList.remove('too-expensive');
          row.querySelector('.b-cost').classList.remove('red');
        } else {
          row.classList.remove('can-afford');
          row.classList.add('too-expensive');
          row.querySelector('.b-cost').classList.add('red');
        }
      });
    }

    function renderUpgrades() {
      elUpgradeGrid.innerHTML = '';
      
      const available = UPGRADES.filter(u => {
        if (game.upgrades.includes(u.id)) return false; // Already bought
        
        // Check Unlock Condition
        if (u.triggerType === 'clicks' && game.clicks >= u.triggerVal) return true;
        if (u.triggerType === 'build' && game.buildings[u.triggerId] >= u.triggerVal) return true;
        
        return false;
      });

      available.forEach(u => {
        const div = document.createElement('div');
        div.className = 'upgrade-crate';
        div.innerHTML = `
          ${u.icon}
          <div class="tooltip">
            <strong>${u.name}</strong><br>
            <span style="font-size:0.7rem; color:#aaa">${u.desc}</span><br>
            <span style="color:${game.score >= u.cost ? '#2ecc71' : '#e74c3c'}">
              ${formatNum(u.cost)}
            </span>
          </div>
        `;
        div.onclick = () => buyUpgrade(u.id);
        
        if (game.score < u.cost) {
            div.style.opacity = "0.5";
            div.style.filter = "grayscale(1)";
        }

        elUpgradeGrid.appendChild(div);
      });
    }

    function renderBuffs() {
      elBuffArea.innerHTML = '';
      if(buffs.frenzy.active) {
        elBuffArea.innerHTML += `
          <div class="buff-icon" style="border-color:#f1c40f">
            üî• <div class="buff-timer" id="buff-timer-frenzy"></div>
          </div>`;
      }
      if(buffs.clickFrenzy.active) {
        elBuffArea.innerHTML += `
          <div class="buff-icon" style="border-color:#3498db">
            üëÜ <div class="buff-timer" id="buff-timer-click"></div>
          </div>`;
      }
    }

    /* --- GOLDEN COOKIE MECHANIC --- */
    function scheduleGolden() {
      // Random time between 2 and 5 minutes (simplified for demo: 30s - 90s)
      const time = (Math.random() * 60000) + 30000;
      goldenTimer = setTimeout(spawnGolden, time);
    }

    function spawnGolden() {
      const g = document.getElementById('goldenKlein');
      const x = Math.random() * (window.innerWidth - 100);
      const y = Math.random() * (window.innerHeight - 100);
      g.style.left = x + 'px';
      g.style.top = y + 'px';
      g.style.display = 'block';
      
      // Auto disappear
      setTimeout(() => {
        if(g.style.display === 'block') {
          g.style.display = 'none';
          scheduleGolden();
        }
      }, 10000);
    }

    document.getElementById('goldenKlein').onmousedown = function() {
      this.style.display = 'none';
      clearTimeout(goldenTimer);
      
      // Effect: 50% Lucky (Points), 50% Frenzy (x7)
      const r = Math.random();
      if(r > 0.5) {
        // Frenzy
        buffs.frenzy.active = true;
        buffs.frenzy.time = 30; // 30s
        renderBuffs();
        showNews("FRENZY! x7 Produktion f√ºr 30 Sekunden!");
      } else {
        // Lucky (15 mins of production)
        const bonus = Math.max(100, calculateCPS() * 60 * 15);
        addScore(bonus);
        createParticles(parseInt(this.style.left), parseInt(this.style.top), "LUCKY!");
        showNews("LUCKY! Ein riesiger Haufen Kleinis gefunden.");
      }

      scheduleGolden();
    };

    function showNews(txt) {
      elTicker.textContent = txt;
    }

    /* --- HELPERS --- */
    function formatNum(n, d=0) {
      if(n >= 1e6) return (n/1e6).toFixed(3) + " Millionen";
      if(n >= 1e3) return (n/1e3).toFixed(d) + "k"; // 1.234 statt 1,234 (eng)
      return n.toLocaleString();
    }

    function createParticles(x, y, text) {
      const el = document.createElement('div');
      el.className = 'click-fx';
      el.textContent = text;
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    /* --- BACKGROUND ANIMATION --- */
    function initBackground() {
      const cvs = document.getElementById('bgCanvas');
      const ctx = cvs.getContext('2d');
      let heads = [];
      const img = new Image();
      img.src = "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png";

      function resize() {
        cvs.width = window.innerWidth;
        cvs.height = window.innerHeight;
      }
      window.onresize = resize;
      resize();

      class Head {
        constructor() {
          this.x = Math.random() * cvs.width;
          this.y = -50;
          this.size = 20 + Math.random() * 30;
          this.speed = 1 + Math.random() * 2;
          this.rot = Math.random() * 360;
          this.rotSpd = (Math.random()-0.5) * 2;
        }
        update() {
          this.y += this.speed;
          this.rot += this.rotSpd;
        }
        draw() {
          ctx.save();
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rot * Math.PI/180);
          if(img.complete) ctx.drawImage(img, -this.size/2, -this.size/2, this.size, this.size);
          ctx.restore();
        }
      }

      function loop() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        // Spawn rate based on CPS (max limit)
        const cps = calculateCPS();
        const chance = Math.min(0.5, 0.01 + (cps / 1000)); 
        if(Math.random() < chance) heads.push(new Head());

        for(let i=0; i<heads.length; i++) {
          heads[i].update();
          heads[i].draw();
          if(heads[i].y > cvs.height + 50) {
            heads.splice(i, 1);
            i--;
          }
        }
        requestAnimationFrame(loop);
      }
      loop();
    }

    /* --- SAVE SYSTEM --- */
    function saveGame() {
      localStorage.setItem(SAVE_KEY, JSON.stringify(game));
    }
    function loadGame() {
      const d = localStorage.getItem(SAVE_KEY);
      if(d) {
        try {
            const parsed = JSON.parse(d);
            // Deep merge logic simplified
            game.score = parsed.score || 0;
            game.totalScore = parsed.totalScore || 0;
            game.clicks = parsed.clicks || 0;
            game.upgrades = parsed.upgrades || [];
            if(parsed.buildings) {
                parsed.buildings.forEach((c, i) => { if(i < game.buildings.length) game.buildings[i] = c; });
            }
        } catch(e) {}
      }
    }
    
    init();
  </script>
</body>
</html>
