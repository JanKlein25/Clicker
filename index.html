<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker - Pro Casino Fixed</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
    rel="stylesheet">
  <!-- FIREBASE SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-dark: #0f0f12;
      --panel-left: #1a1a20;
      --panel-right: #121216;
      --gold: #f1c40f;
      --green: #2ecc71;
      --red: #e74c3c;
      --text-main: #ecf0f1;
      --tooltip-bg: rgba(10, 10, 15, 0.98);
      --purple: #9b59b6;
      --blue: #3498db;
      /* Rarity Colors */
      --rarity-common: #b0c3d9;
      --rarity-rare: #4b69ff;
      --rarity-epic: #8847ff;
      --rarity-legendary: #d32ce6;
      --rarity-mythic: #eb4b4b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
      -webkit-user-select: none;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: row;
    }

    /* --- GLOBAL TOOLTIP --- */
    #global-tooltip {
      position: fixed;
      top: 0;
      left: 0;
      width: 320px;
      background: var(--tooltip-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      pointer-events: none;
      z-index: 10000;
      padding: 0;
      display: none;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 1);
    }

    .tt-header {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tt-title {
      font-family: 'Merriweather', serif;
      font-weight: 900;
      font-size: 1.1rem;
      color: var(--gold);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tt-price {
      font-size: 0.9rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
      background: #000;
    }

    .tt-price.affordable {
      color: var(--green);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .tt-price.expensive {
      color: var(--red);
      opacity: 0.8;
    }

    .tt-body {
      padding: 12px;
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
    }

    .tt-effect {
      color: #fff;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
      font-size: 0.95rem;
      border-left: 3px solid var(--gold);
      padding-left: 10px;
    }

    .tt-stats {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-highlight {
      color: var(--green);
      font-weight: bold;
      font-size: 0.95rem;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- LAYOUT --- */
    .left-panel {
      flex: 1;
      background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
      transition: background 2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      border-right: 2px solid rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }

    .right-panel {
      width: 420px;
      background: var(--panel-right);
      display: flex;
      flex-direction: column;
      border-left: 1px solid #222;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
      z-index: 50;
    }

    /* --- VISUAL ELEMENTS (Background Icons) --- */
    #visual-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .bg-icon {
      position: absolute;
      font-size: 1.5rem;
      opacity: 0.3;
      animation: floatAround linear infinite;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }

    @keyframes floatAround {
      0% {
        transform: translate(0, 0) rotate(0deg);
      }

      25% {
        transform: translate(20px, -20px) rotate(10deg);
      }

      50% {
        transform: translate(0, -40px) rotate(0deg);
      }

      75% {
        transform: translate(-20px, -20px) rotate(-10deg);
      }

      100% {
        transform: translate(0, 0) rotate(0deg);
      }
    }

    .bakery-name {
      position: absolute;
      top: 30px;
      font-family: 'Merriweather', serif;
      font-weight: 900;
      font-size: 2.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(to bottom, #f1c40f, #d35400);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 0px rgba(0, 0, 0, 0.5));
      z-index: 20;
    }

    .score-container {
      margin-bottom: 50px;
      text-align: center;
      z-index: 20;
    }

    #score {
      font-family: 'Roboto', sans-serif;
      font-size: 3.2rem;
      font-weight: 900;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      line-height: 1;
    }

    .currency-label {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 700;
      margin-top: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #cps {
      font-size: 1.1rem;
      color: #7f8c8d;
      margin-top: 10px;
      font-weight: 500;
      background: rgba(0, 0, 0, 0.4);
      padding: 5px 20px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    #bigKlein {
      width: 300px;
      height: 300px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.05s, filter 0.1s;
      filter: drop-shadow(0 30px 60px rgba(0, 0, 0, 0.5));
      z-index: 20;
    }

    #bigKlein:active {
      transform: scale(0.96);
      filter: brightness(0.9);
    }

    #bigKlein:hover {
      transform: scale(1.02);
      filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.1));
    }

    /* --- CASINO BUTTON --- */
    #casinoBtn {
      margin-top: 30px;
      background: linear-gradient(45deg, #e67e22, #f39c12);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 12px 30px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
      display: none;
      z-index: 25;
      transition: all 0.2s;
      letter-spacing: 1px;
    }

    #casinoBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(243, 156, 18, 0.8);
    }

    /* --- CLICK UPGRADE SECTION --- */
    .click-booster {
      padding: 15px;
      background: linear-gradient(135deg, #18181b, #0f0f12);
      border-bottom: 2px solid #000;
    }

    .cb-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .cb-info {
      flex: 1;
    }

    .cb-title {
      color: var(--gold);
      font-family: 'Merriweather', serif;
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .cb-stat {
      color: #ccc;
      font-size: 0.8rem;
    }

    .cb-btn {
      background: linear-gradient(to bottom, #2ecc71, #27ae60);
      border: 1px solid #2ecc71;
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      text-align: right;
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
      transition: transform 0.1s;
      min-width: 100px;
    }

    .cb-btn:hover {
      filter: brightness(1.1);
    }

    .cb-btn:active {
      transform: scale(0.95);
    }

    .cb-btn.locked {
      background: #333;
      border-color: #444;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }

    .cb-cost {
      font-size: 0.8rem;
      display: block;
      opacity: 0.9;
    }

    /* --- SHOP --- */
    .store-header {
      background: #0a0a0d;
      padding: 18px;
      text-align: center;
      font-family: 'Merriweather', serif;
      font-weight: 900;
      color: #57606f;
      border-bottom: 1px solid #222;
      font-size: 0.9rem;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .upgrades-container {
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 80px;
      max-height: 220px;
      overflow-y: auto;
      border-bottom: 2px solid #000;
    }

    .upgrade-crate {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #2d3436, #1e272e);
      border: 1px solid #444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      border-radius: 8px;
      transition: all 0.2s;
      position: relative;
    }

    .upgrade-crate:hover {
      border-color: var(--text-main);
      background: #333;
      z-index: 5;
    }

    .buildings-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #444 #0a0a0d;
    }

    .building-row {
      height: 80px;
      background: linear-gradient(to right, #1a1a20, #141418);
      border-bottom: 1px solid #000;
      display: flex;
      align-items: center;
      padding: 0 20px;
      cursor: pointer;
      position: relative;
      opacity: 0.5;
      transition: all 0.2s;
    }

    .building-row:hover {
      opacity: 1;
      background: #222;
    }

    .building-row.can-afford {
      opacity: 1;
    }

    .b-icon {
      font-size: 2.2rem;
      width: 50px;
      text-align: center;
      margin-right: 15px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
    }

    .b-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .b-name {
      font-weight: 700;
      font-family: 'Merriweather', serif;
      font-size: 1rem;
      color: #fff;
      margin-bottom: 3px;
    }

    .b-cps {
      font-size: 0.75rem;
      color: #636e72;
    }

    .b-cost {
      color: var(--red);
      font-weight: bold;
      font-size: 0.85rem;
    }

    .b-cost.affordable {
      color: var(--green);
    }

    .b-count {
      font-size: 1.8rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      margin-left: auto;
    }

    /* --- CASINO MODAL --- */
    #casinoModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .casino-window {
      background: #18181b;
      width: 95%;
      max-width: 800px; /* Wider for Pro Slots */
      border: 1px solid #333;
      border-radius: 16px;
      padding: 0;
      text-align: center;
      box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
      position: relative;
      overflow: hidden;
      animation: zoomIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .cw-header {
      background: linear-gradient(to bottom, #2d3436, #1e272e);
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cw-title {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 900;
      letter-spacing: 1px;
    }

    .cw-balance {
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.4);
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid #444;
    }

    .cw-body {
      padding: 20px;
      position: relative;
    }

    .casino-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      background: #111;
      padding: 5px;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .nav-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: #666;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .nav-btn.active {
      background: #333;
      color: var(--gold);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .nav-btn:hover:not(.active) {
      color: #fff;
    }

    /* --- PRO SLOTS STYLES --- */
    .pro-slot-screen {
      background: #000;
      border: 5px solid #d35400;
      border-radius: 10px;
      padding: 10px;
      position: relative;
      margin-bottom: 20px;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.9), 0 0 20px rgba(211, 84, 0, 0.3);
      overflow: hidden;
    }

    .pro-slot-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
      background: #111;
      padding: 2px;
      position: relative;
      z-index: 2;
    }

    .pro-reel {
      height: 240px; /* 3 rows of 80px */
      background: linear-gradient(to bottom, #1a1a20, #0f0f12);
      border: 1px solid #333;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .reel-strip {
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      transform: translateY(-80px); /* Start hidden above */
    }

    .slot-symbol {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      text-shadow: 0 2px 5px rgba(0,0,0,0.5);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    /* Animation Classes */
    .spin-blur {
      filter: blur(4px);
      animation: slotScroll 0.2s linear infinite;
    }
    
    @keyframes slotScroll {
        0% { transform: translateY(-80px); }
        100% { transform: translateY(0px); }
    }

    .bounce-stop {
      animation: reelBounce 0.4s ease-out;
    }

    @keyframes reelBounce {
      0% { transform: translateY(20px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    .payline-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .slot-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      background: #222;
      padding: 10px;
      border-radius: 8px;
      border-top: 2px solid #444;
    }

    .slot-btn-circle {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-weight: 900;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 0 rgba(0,0,0,0.5);
      transition: all 0.1s;
    }

    .btn-spin-main {
      background: radial-gradient(circle, #2ecc71, #27ae60);
      color: #fff;
      font-size: 1rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .btn-spin-main:active { transform: translateY(4px); box-shadow: none; }
    .btn-spin-main:disabled { filter: grayscale(1); cursor: not-allowed; }

    .toggle-btn {
      background: #444;
      color: #aaa;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      border: 1px solid #555;
      cursor: pointer;
    }
    .toggle-btn.active {
      background: #d35400;
      color: #fff;
      border-color: #e67e22;
      box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
    }

    .win-display-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(0,0,0,0.9);
        border: 2px solid var(--gold);
        padding: 20px 40px;
        z-index: 20;
        border-radius: 10px;
        text-align: center;
        pointer-events: none;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .win-display-box.show { transform: translate(-50%, -50%) scale(1); }
    .win-val { color: var(--gold); font-size: 2rem; font-weight: 900; display:block; }
    .win-label { color: #fff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; }

    /* --- OLD STYLES REMAINING --- */
    .bet-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .bet-input {
      background: #111;
      border: 1px solid #444;
      color: #fff;
      font-size: 1.2rem;
      padding: 10px;
      width: 150px;
      text-align: center;
      font-weight: bold;
      border-radius: 6px;
    }

    .control-btn {
      background: #333;
      border: 1px solid #555;
      color: #ccc;
      padding: 0 15px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 6px;
    }

    .control-btn:hover {
      background: #444;
      color: #fff;
    }

    .action-row {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .bet-btn {
      flex: 1;
      padding: 20px 10px;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      font-size: 1.1rem;
      color: #fff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      border: 2px solid rgba(255, 255, 255, 0.05);
      transition: transform 0.1s;
    }

    .bet-btn:active {
      transform: scale(0.95);
    }

    .bet-btn:disabled {
      filter: grayscale(1);
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-red {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .btn-black {
      background: linear-gradient(135deg, #34495e, #2c3e50);
    }

    .btn-green {
      background: linear-gradient(135deg, #f1c40f, #f39c12);
      color: #000;
    }

    .sub-text {
      font-size: 0.7rem;
      opacity: 0.8;
      font-weight: normal;
    }

    .history-bar {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .hist-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.3);
    }

    .hist-red {
      background: var(--red);
    }

    .hist-black {
      background: #34495e;
    }

    .hist-green {
      background: var(--gold);
      box-shadow: 0 0 10px var(--gold);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Particles & FX */
    .win-particle {
      position: absolute;
      width: 10px;
      height: 10px;
      pointer-events: none;
      animation: confetti 1s ease-out forwards;
      z-index: 1000;
    }

    @keyframes confetti {
      0% {
        transform: translate(0, 0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translate(var(--tx), var(--ty)) rotate(720deg);
        opacity: 0;
      }
    }

    .win-pulse {
      animation: screenFlash 0.5s;
    }

    @keyframes screenFlash {
      0% {
        background-color: rgba(255, 255, 255, 0.2);
      }

      100% {
        background-color: transparent;
      }
    }

    .falling-face {
      position: absolute;
      width: 35px;
      height: 35px;
      pointer-events: none;
      z-index: 15;
      animation: physicsFall 1.2s cubic-bezier(0.5, 0, 0.8, 0.8) forwards;
    }

    @keyframes physicsFall {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(800px) rotate(360deg) scale(0.8);
        opacity: 0;
      }
    }

    .click-text {
      position: absolute;
      color: #fff;
      font-weight: 900;
      font-size: 1.4rem;
      pointer-events: none;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 100;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translateY(-80px) scale(1);
      }
    }

    /* Golden Klein */
    #goldenKlein {
      position: absolute;
      width: 80px;
      height: 80px;
      z-index: 9999;
      cursor: pointer;
      display: none;
      filter: drop-shadow(0 0 20px gold);
      animation: wobble 2s infinite;
    }

    @keyframes wobble {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-5deg);
      }

      75% {
        transform: rotate(5deg);
      }
    }

    .buff-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .buff-icon {
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--gold);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
      animation: pulse 1s infinite alternate;
    }

    /* --- PRESTIGE NEUE STYLES --- */
    #prestigeBtn {
      margin-top: 15px;
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(52, 152, 219, 0.6);
      z-index: 25;
      animation: pulseBlue 2s infinite;
    }

    #prestigeModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 13000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    @keyframes pulseBlue {
      0% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(52, 152, 219, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
      }
    }

    /* --- SKINS & INVENTORY STYLES (NEW) --- */
    #skinsBtn {
      margin-top: 15px;
      background: linear-gradient(45deg, #1abc9c, #16a085);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(26, 188, 156, 0.4);
      transition: all 0.2s;
      letter-spacing: 1px;
      z-index: 25;
      display: none;
      /* Visible after first prestige or unlock */
    }

    #skinsBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(26, 188, 156, 0.8);
    }

    #skinModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 14000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .skin-window {
      background: #18181b;
      width: 95%;
      max-width: 700px;
      border: 1px solid #444;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 90vh;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
    }

    .skin-header {
      background: linear-gradient(to right, #2c3e50, #000);
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .case-area {
      padding: 20px;
      background: #111;
      border-bottom: 2px solid #222;
      text-align: center;
    }

    .case-spinner {
      height: 120px;
      background: #000;
      border: 4px solid #333;
      margin: 20px auto;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 20px #000;
      width: 100%;
    }

    .case-strip {
      display: flex;
      height: 100%;
      align-items: center;
      position: absolute;
      left: 50%;
    }

    .case-item {
      width: 90px;
      height: 90px;
      margin-right: 4px;
      border-radius: 6px;
      background: #222;
      border-bottom: 3px solid rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      position: relative;
    }

    .case-item img {
      width: 70px;
      height: 70px;
      object-fit: contain;
      filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.5));
    }

    /* Rarity Borders */
    .rarity-common {
      border: 2px solid var(--rarity-common);
      box-shadow: 0 0 5px var(--rarity-common);
    }

    .rarity-rare {
      border: 2px solid var(--rarity-rare);
      box-shadow: 0 0 10px var(--rarity-rare);
    }

    .rarity-epic {
      border: 2px solid var(--rarity-epic);
      box-shadow: 0 0 15px var(--rarity-epic);
    }

    .rarity-legendary {
      border: 2px solid var(--rarity-legendary);
      box-shadow: 0 0 20px var(--rarity-legendary);
    }

    .open-case-btn {
      background: linear-gradient(45deg, #f1c40f, #d35400);
      border: none;
      padding: 12px 30px;
      font-weight: 900;
      color: #fff;
      border-radius: 4px;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 0 #b33900;
      transition: transform 0.1s;
    }

    .open-case-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #b33900;
    }

    .open-case-btn:disabled {
      filter: grayscale(1);
      cursor: not-allowed;
    }

    .inventory-grid {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      overflow-y: auto;
      background: #18181b;
    }

    .inv-slot {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.2s;
    }

    .inv-slot:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #666;
    }

    .inv-slot.equipped {
      border: 2px solid var(--green);
      background: rgba(46, 204, 113, 0.1);
    }

    .inv-slot img {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .count-badge {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 0.7rem;
      color: #aaa;
    }

    /* LEADERBOARD MODAL */
    #leaderboardModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .lb-window {
      background: #18181b;
      width: 95%;
      max-width: 500px;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }

    .lb-header {
      background: linear-gradient(to bottom, #2d3436, #1e272e);
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px 16px 0 0;
    }

    .lb-title {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 900;
      letter-spacing: 1px;
    }

    .lb-list {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    .lb-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-family: 'Roboto', sans-serif;
    }

    .lb-entry:last-child {
      border-bottom: none;
    }

    .lb-rank {
      width: 30px;
      font-weight: bold;
      color: #666;
    }

    .lb-rank.top-1 {
      color: var(--gold);
      font-size: 1.2rem;
    }

    .lb-rank.top-2 {
      color: #bdc3c7;
      font-size: 1.1rem;
    }

    .lb-rank.top-3 {
      color: #cd7f32;
      font-size: 1.1rem;
    }

    .lb-name {
      flex: 1;
      font-weight: bold;
      color: #fff;
    }

    .lb-score {
      color: var(--green);
      font-weight: bold;
    }

    .lb-footer {
      padding: 15px;
      border-top: 1px solid #333;
      text-align: center;
      color: #666;
      font-size: 0.8rem;
    }

    #leaderboardBtn {
      margin-top: 15px;
      background: linear-gradient(45deg, #8e44ad, #9b59b6);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(142, 68, 173, 0.4);
      transition: all 0.2s;
      letter-spacing: 1px;
      z-index: 25;
    }

    #leaderboardBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(142, 68, 173, 0.8);
    }
    
    /* ROULETTE STYLES */
    .roulette-container {
      width: 100%;
      height: 100px;
      background: #000;
      border-radius: 8px;
      border: 4px solid #333;
      position: relative;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: inset 0 0 30px #000;
    }

    .roulette-marker {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--gold);
      transform: translateX(-50%);
      z-index: 10;
      box-shadow: 0 0 10px var(--gold);
    }

    .roulette-strip {
      display: flex;
      height: 100%;
      align-items: center;
      position: absolute;
      left: 50%;
    }

    .r-card {
      width: 70px;
      height: 70px;
      margin-right: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.4);
      font-size: 1.2rem;
      flex-shrink: 0;
      border-bottom: 4px solid rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .rc-red {
      background: linear-gradient(to bottom, #e74c3c, #c0392b);
    }

    .rc-black {
      background: linear-gradient(to bottom, #34495e, #2c3e50);
    }

    .rc-green {
      background: linear-gradient(to bottom, #f1c40f, #f39c12);
      color: #000;
      box-shadow: 0 0 15px var(--gold);
      z-index: 2;
    }

    .rc-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    @media (max-width: 850px) {
      body {
        flex-direction: column;
        overflow-y: auto;
        height: auto;
      }

      .left-panel {
        min-height: 50vh;
        border-right: none;
        border-bottom: 2px solid #333;
      }

      .right-panel {
        width: 100%;
        min-height: 50vh;
      }

      #global-tooltip {
        display: none !important;
      }
    }
  </style>

</head>

<body>

  <div id="global-tooltip">
    <div class="tt-header">
      <div class="tt-title">
        <span id="tt-name-display">Name</span>
        <span id="tt-price-display" class="tt-price">100 Kleinis</span>
      </div>
    </div>
    <div class="tt-body">
      <span id="tt-effect-display" class="tt-effect">Verdoppelt Produktion</span>
      <div id="tt-desc-display">Beschreibung...</div>
      <div id="tt-stats-container" class="tt-stats"></div>
    </div>
  </div>

  <!-- SKIN / INVENTORY MODAL (NEU) -->
  <div id="skinModal">
    <div class="skin-window">
      <div class="skin-header">
        <div style="font-weight:900; color:var(--text-main);">üéí INVENTAR & KISTEN</div>
        <button class="close-btn" onclick="closeSkins()" style="position:static;">√ó</button>
      </div>

      <!-- CASE OPENING SECTION -->
      <div class="case-area">
        <div style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">
          Du hast <span id="case-count" style="color:var(--gold); font-weight:bold; font-size:1.2rem;">0</span> Kisten
        </div>

        <div class="case-spinner">
          <div class="roulette-marker"></div>
          <div class="case-strip" id="caseStrip"></div>
        </div>

        <button class="open-case-btn" id="btnOpenCase" onclick="openCase()">KISTE √ñFFNEN</button>

        <div style="margin-top:10px; font-size:0.75rem; color:#555;">
          Erhalte 1 Kiste pro Prestige-Level!
        </div>
      </div>

      <!-- INVENTORY GRID -->
      <div class="inventory-grid" id="inventoryGrid">
        <!-- Skins filled by JS -->
      </div>
    </div>
  </div>

  <!-- PRESTIGE MODAL (NEU) -->
  <div id="prestigeModal">
    <div class="lb-window" style="border-color: #3498db; box-shadow: 0 0 80px rgba(52, 152, 219, 0.4);">
      <button class="close-btn" onclick="closePrestige()">√ó</button>
      <div class="lb-header" style="background: linear-gradient(to bottom, #2980b9, #2c3e50);">
        <div class="lb-title" style="color:#fff;">üöÄ ZEITREISE</div>
      </div>
      <div class="lb-list" style="text-align:center; padding:30px;">
        <div style="color:#e74c3c; font-weight:bold; font-size:1.2rem; margin-bottom:20px;">
          WARNUNG: HARD RESET
        </div>
        <div style="color:#ccc; margin-bottom:20px;">
          Du setzt alle Geb√§ude, Upgrades und dein aktuelles Geld zur√ºck.<br>
          Du beh√§ltst deine Statistiken, Skins, Erfolge und Leaderboard-Platzierung.
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
          <div>Aktueller Prestige-Level: <span id="modal-current-prestige"
              style="color:#3498db; font-weight:bold;">0</span></div>
          <div style="font-size:1.5rem; margin:10px 0;">‚¨áÔ∏è</div>
          <div>M√∂gliches Neues Level: <span id="modal-new-prestige"
              style="color:#2ecc71; font-weight:bold; font-size:1.3rem;">0</span></div>
          <div style="color:#2ecc71; font-size:0.9rem; margin-top:5px;">
            (+<span id="modal-gain-prestige">0</span> Level dazu)
          </div>
          <div style="color:var(--gold); font-weight:bold; margin-top:10px;">
            üéÅ +<span id="modal-gain-cases">0</span> Kisten
          </div>
        </div>

        <button onclick="doPrestige()" id="confirmPrestigeBtn" style="
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: 2px solid rgba(255,255,255,0.2);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: 900;
        font-size: 1.1rem;
        cursor: pointer;
        width: 100%;
        box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        ">
          RESET DURCHF√úHREN
        </button>

      </div>
    </div>
  </div>

  <div id="casinoModal">
    <div class="casino-window" id="casinoWindow">
      <button class="close-btn" onclick="closeCasino()">√ó</button>
      <div class="cw-header">
        <div class="cw-title">üé∞ CASINO PRO</div>
        <div class="cw-balance"><span id="casino-balance">0</span> Kleinis</div>
      </div>
      <div class="cw-body">

        <div class="casino-nav">
          <button class="nav-btn active" id="btn-tab-roulette" onclick="switchCasinoTab('roulette')">Roulette</button>
          <button class="nav-btn" id="btn-tab-slots" onclick="switchCasinoTab('slots')">Video Slots (5x3)</button>
        </div>

        <div class="bet-row">
          <input type="number" id="betAmount" class="bet-input" placeholder="Einsatz">
          <button class="control-btn" onclick="setBetMultiplier(0.5)">1/2</button>
          <button class="control-btn" onclick="setBetMultiplier(2)">x2</button>
          <button class="control-btn" style="color:var(--gold)" onclick="setBetMultiplier('max')">ALL</button>
        </div>

        <!-- ROULETTE VIEW -->
        <div id="view-roulette">
          <div class="roulette-container">
            <div class="roulette-marker"></div>
            <div class="roulette-strip" id="rouletteStrip"></div>
          </div>
          <div class="action-row">
            <button class="bet-btn btn-red" onclick="spin('red')">ROT<span class="sub-text">Win x2</span></button>
            <button class="bet-btn btn-green" onclick="spin('green')">GOLD<span class="sub-text">Win x14</span></button>
            <button class="bet-btn btn-black" onclick="spin('black')">SCHWARZ<span class="sub-text">Win
                x2</span></button>
          </div>
          <div class="history-bar">
            <span style="font-size:0.8rem; color:#666; margin-right:5px;">HISTORY:</span>
            <div id="history-container" style="display:flex; gap:5px;"></div>
          </div>
        </div>

        <!-- PRO SLOTS VIEW -->
        <div id="view-slots" style="display:none;">
          <div class="pro-slot-screen">
            <!-- WIN OVERLAY -->
            <div id="winDisplay" class="win-display-box">
               <span class="win-label">BIG WIN</span>
               <span class="win-val" id="winAmountDisplay">0</span>
            </div>
            
            <svg id="paylineSvg" class="payline-overlay" viewBox="0 0 500 240" preserveAspectRatio="none">
               <!-- Paylines drawn here by JS -->
            </svg>
            
            <div class="pro-slot-grid" id="slotGrid">
              <!-- Reels generated by JS -->
            </div>
          </div>
          
          <div class="slot-controls">
             <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="toggle-btn" id="btnTurbo" onclick="toggleTurbo()">‚ö° TURBO</button>
                <button class="toggle-btn" id="btnAuto" onclick="toggleAuto()">üîÑ AUTO</button>
             </div>
             
             <div style="flex:1; text-align:left; padding-left:15px; font-size:0.8rem; color:#888;">
                <div>SYMBOLS:</div>
                <div>üëë Wild ‚Ä¢ üíé High ‚Ä¢ üîî ‚Ä¢ üçâ ‚Ä¢ üçá ‚Ä¢ üçã ‚Ä¢ üçí</div>
             </div>
             
             <button class="slot-btn-circle btn-spin-main" id="btnSpinSlots" onclick="spinProSlots()">
                SPIN
             </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD MODAL -->
  <div id="leaderboardModal">
    <div class="lb-window">
      <button class="close-btn" onclick="closeLeaderboard()">√ó</button>
      <div class="lb-header">
        <div class="lb-title">üèÜ TOP SPIELER</div>
      </div>
      <div class="lb-list" id="lb-list">
        <div style="text-align:center; padding:20px; color:#666;">Lade Daten...</div>
      </div>
      <div class="lb-footer">
        Dein Name: <span id="my-player-name" style="color:#fff; font-weight:bold;">Unbekannt</span>
      </div>
    </div>
  </div>

  <div class="left-panel" id="clickPanel">
    <!-- VISUAL BACKGROUND AREA -->
    <div id="visual-canvas"></div>

    <div class="bakery-name">KleinClicker</div>
    <div class="score-container">
      <div id="score">0</div>
      <div class="currency-label">KLEINIS</div>
      <div id="cps">0,0 Kleinis / Sekunde</div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button id="casinoBtn" onclick="openCasino()">üé∞ OPEN CASINO</button>
      <button id="skinsBtn" onclick="openSkins()">üéí SKINS</button>
    </div>
    <button id="leaderboardBtn" onclick="openLeaderboard()">üèÜ LEADERBOARD</button>

    <!-- PRESTIGE BUTTON (NEU) -->
    <button id="prestigeBtn" onclick="openPrestige()" style="display:none;">
      üöÄ AUFSTEIGEN
      <div style="font-size:0.7rem; font-weight:normal;">Prestige verf√ºgbar</div>
    </button>

    <div class="buff-container" id="buffArea"></div>
    <!-- MAIN IMAGE -->
    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="bigKlein"
      alt="Klick mich!">

    <!-- PRESTIGE BADGE -->
    <div id="prestige-badge"
      style="display:none; margin-top:25px; width: 80%; max-width:300px; color:#3498db; background:rgba(0,0,0,0.6); padding:10px; border-radius:12px; border:1px solid #3498db; text-align:center; z-index: 20;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span style="font-weight:bold;">‚≠ê Rang <span id="prestige-level-display">0</span></span>
        <span style="font-size:0.8rem; color:#2ecc71;">+<span id="prestige-bonus-display">0</span>% Bonus</span>
      </div>

      <!-- Fortschrittsbalken Container -->
      <div
        style="width:100%; height:8px; background:#222; border-radius:4px; overflow:hidden; border:1px solid rgba(52, 152, 219, 0.3);">
        <div id="prestige-progress-bar"
          style="width:0%; height:100%; background:linear-gradient(90deg, #3498db, #2980b9); transition: width 0.5s;">
        </div>
      </div>

      <div style="font-size:0.7rem; color:#ccc; margin-top:5px;">
        N√§chster Rang in: <span id="prestige-next-req" style="color:#fff; font-weight:bold;">0</span>
      </div>
    </div>

    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="goldenKlein" alt="GOLD">
  </div>

  <div class="right-panel">
    <div class="store-header">Upgrades</div>
    <div class="upgrades-container" id="upgradeGrid"></div>

    <!-- NEW CLICKER UPGRADE SECTION -->
    <div class="store-header">Clicker Zentrale 3.0</div>
    <div class="click-booster" id="clickBooster">
      <div class="cb-card">
        <div class="cb-info">
          <div class="cb-title">Maus Training</div>
          <div class="cb-stat" style="font-size:0.75rem;">
            Effekt: <span id="click-effect-desc" style="color:#2ecc71"></span>
          </div>
          <div class="cb-stat">Kraft: <span id="click-dmg-display" style="color:var(--gold); font-weight:bold;">1</span>
          </div>
        </div>
        <button class="cb-btn" id="btn-buy-click" onclick="buyClickStats()">
          <div style="font-size:0.7rem; text-transform:uppercase;">Level Up</div>
          <span id="click-cost-display" class="cb-cost">100</span>
        </button>
      </div>
    </div>

    <div class="store-header">Markt</div>
    <div class="buildings-list" id="buildingList"></div>
  </div>

  <script>
    /* --- CONFIG & ASSETS --- */
    const SAVE_KEY = 'KleinClicker_Precision_V14'; 
    const DEFAULT_IMG = "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png";

    // SKINS DATA
    const SKINS = [
      { id: 'default', name: 'Original Klein', rarity: 'common', url: DEFAULT_IMG, filter: '' },
      { id: 'friend1', name: 'Original Cedric', rarity: 'rare', url: "https://github.com/JanKlein25/Clicker/blob/main/Cedrics%20Gesicht.png?raw=true", filter: '' },
      { id: 'friend2', name: 'Original Malte', rarity: 'epic', url: "https://github.com/JanKlein25/Clicker/blob/main/Malte%20Gesicht.png?raw=true", filter: '' },
      { id: 'friend3', name: 'Peter Beispiel', rarity: 'legendary', url: "https://example.com/peter_beispiel.png", filter: '' },
    ];

    // BUILDINGS (UPDATED with new endgame buildings)
    const BUILDINGS = [
      { id: 0, name: 'Maxis Zeigefinger', baseCost: 15, baseCps: 0.1, icon: 'üëÜ' },
      { id: 1, name: 'Magdas Oma', baseCost: 100, baseCps: 1, icon: 'üëµ' },
      { id: 2, name: 'Cedrics Acker', baseCost: 1100, baseCps: 8, icon: 'üåæ' },
      { id: 3, name: 'Maltes Meme Mine', baseCost: 12000, baseCps: 47, icon: '‚õèÔ∏è' },
      { id: 4, name: 'Jans Strandkorbfabrik', baseCost: 130000, baseCps: 260, icon: 'üè≠' },
      { id: 5, name: 'Tills Tresor', baseCost: 1400000, baseCps: 1400, icon: 'üè¶' },
      { id: 6, name: 'Nicos Sekten-Tempel', baseCost: 20000000, baseCps: 7800, icon: 'üèõÔ∏è' },
      { id: 7, name: 'Maxis Klon-Labor', baseCost: 330000000, baseCps: 45000, icon: 'üß¨' },
      { id: 8, name: 'Magdas Mars-Rakete', baseCost: 5100000000, baseCps: 280000, icon: 'üöÄ' },
      { id: 9, name: 'Cedrics Dimensionstor', baseCost: 75000000000, baseCps: 1600000, icon: 'üåÄ' },
      { id: 10, name: 'Maltes Zeitmaschine', baseCost: 900000000000, baseCps: 12000000, icon: '‚è≥' },
      { id: 11, name: 'Franjas feuchtes Universum', baseCost: 15000000000000, baseCps: 150000000, icon: 'üåå' },
      // NEW BUILDINGS
      { id: 12, name: 'Quanten-Backofen', baseCost: 350000000000000, baseCps: 2500000000, icon: '‚öõÔ∏è' },
      { id: 13, name: 'Dunkle Materie Pumpe', baseCost: 6000000000000000, baseCps: 35000000000, icon: '‚ö´' },
      { id: 14, name: 'Cedrics Multiversum', baseCost: 120000000000000000, baseCps: 500000000000, icon: 'ü™ê' },
      { id: 15, name: 'Maltes Realit√§ts-Glitch', baseCost: 2500000000000000000, baseCps: 8000000000000, icon: 'üëæ' },
      { id: 16, name: 'Jans Admin-Konsole', baseCost: 55000000000000000000, baseCps: 150000000000000, icon: 'üíª' },
      { id: 17, name: 'Nicos Unendlichkeit', baseCost: 1300000000000000000000, baseCps: 2500000000000000, icon: '‚ôæÔ∏è' },
      { id: 18, name: 'Singularit√§ts-Antrieb', baseCost: 35000000000000000000000, baseCps: 60000000000000000, icon: 'üîÜ' },
      { id: 19, name: 'Der Ur-Klein', baseCost: 900000000000000000000000, baseCps: 1200000000000000000, icon: 'üë∂' },
      { id: 20, name: 'Sauerteig-Galaxie', baseCost: 25000000000000000000000000, baseCps: 30000000000000000000, icon: 'üåå' },
      { id: 21, name: 'Simulation Ende', baseCost: 800000000000000000000000000, baseCps: 900000000000000000000, icon: 'üèÅ' }
    ];

    // UPGRADES
    const UPGRADES = [
      { id: 'u_click_1', name: 'Plastik Maus', cost: 500, trigger: { type: 'clicks', val: 100 }, icon: 'üñ±Ô∏è', desc: 'Die billigste Maus auf dem Markt.', type: 'click', multi: 2, text: 'Klickst√§rke x2' },
      { id: 'u_click_2', name: 'Gamer Maus', cost: 50000, trigger: { type: 'clicks', val: 1000 }, icon: 'üéÆ', desc: 'Mit RGB Beleuchtung f√ºr mehr FPS.', type: 'click', multi: 2, text: 'Klickst√§rke x2' },

      { id: 'u_b0_1', name: 'Carpaltunnel', cost: 1000, trigger: { type: 'build', id: 0, val: 10 }, icon: 'ü©π', desc: 'M√§use arbeiten trotz Schmerzen weiter.', type: 'build', target: 0, multi: 2, text: 'Maus Produktion x2' },
      { id: 'u_b0_2', name: 'Makro', cost: 10000, trigger: { type: 'build', id: 0, val: 50 }, icon: '‚å®Ô∏è', desc: 'Automatisierte Klick-Skripte.', type: 'build', target: 0, multi: 2, text: 'Maus Produktion x2' },

      { id: 'u_b1_1', name: 'Nudelholz', cost: 5000, trigger: { type: 'build', id: 1, val: 10 }, icon: 'ü•ñ', desc: 'Die Omas werden aggressiver.', type: 'build', target: 1, multi: 2, text: 'Oma Produktion x2' },
      { id: 'u_b1_2', name: 'Lesebrille', cost: 50000, trigger: { type: 'build', id: 1, val: 50 }, icon: 'üëì', desc: 'Sie sehen die Kleinis jetzt besser.', type: 'build', target: 1, multi: 2, text: 'Oma Produktion x2' },
      // ... further upgrades implied
    ];

    /* --- GAME STATE --- */
    let game = {
      score: 0, totalScore: 0, clicks: 0, clickLevel: 1,
      buildings: new Array(BUILDINGS.length).fill(0), upgrades: [],
      casinoHistory: [],
      playerName: "Spieler" + Math.floor(Math.random() * 1000),
      prestige: 0,
      cases: 0,
      skinsOwned: ['default'],
      equippedSkin: 'default'
    };
    let buffs = { frenzy: { active: false, time: 0, multi: 7 } };

    let clickHistory = [];
    let lastTime = performance.now();
    let casinoUnlocked = false;

    let visualElements = [];
    const MAX_VISUALS = 30;

    /* --- FIREBASE CONFIG --- */
    const firebaseConfig = {
      apiKey: "AIzaSyA9UzTCyFOxOr6EiGATnkXA_QMQZRcqX0I",
      authDomain: "kleinclicker.firebaseapp.com",
      databaseURL: "https://kleinclicker-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kleinclicker",
      storageBucket: "kleinclicker.firebasestorage.app",
      messagingSenderId: "109832699128",
      appId: "1:109832699128:web:636e6c1687927447d6cf0d",
      measurementId: "G-JBPB52ZK4J"
    };

    let db;
    let dbRef;

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      dbRef = db.ref('leaderboard');
      console.log("Firebase initialized");
    } catch (e) {
      console.warn("Firebase not configured yet. Leaderboard will be offline.");
    }

    /* --- UI --- */
    const tooltipEl = document.getElementById('global-tooltip');
    const ttName = document.getElementById('tt-name-display');
    const ttPrice = document.getElementById('tt-price-display');
    const ttEffect = document.getElementById('tt-effect-display');
    const ttDesc = document.getElementById('tt-desc-display');
    const ttStats = document.getElementById('tt-stats-container');

    /* --- INIT --- */
    function init() {
      try {
        loadGame();
        // Check array lengths in case of new update
        if (game.buildings.length < BUILDINGS.length) {
          const diff = BUILDINGS.length - game.buildings.length;
          for (let i = 0; i < diff; i++) game.buildings.push(0);
        }
      } catch (e) { console.log("Resetting save"); localStorage.removeItem(SAVE_KEY); }

      equipSkin(game.equippedSkin, true);
      buildBuildingUI();
      renderUpgrades();
      renderHistory();
      initVisuals();
      initProSlots(); // Init the new slots
      requestAnimationFrame(gameLoop);
      setInterval(slowLoop, 1000);
      scheduleGolden();

      if (game.playerName.startsWith("Spieler")) {
        const newName = prompt("Wie m√∂chtest du auf dem Leaderboard hei√üen?", game.playerName);
        if (newName && newName.trim() !== "") {
          game.playerName = newName.trim().substring(0, 15);
          saveGame();
        }
      }
      document.getElementById('my-player-name').textContent = game.playerName;

      document.addEventListener('mousemove', (e) => {
        if (tooltipEl.style.display === 'block') {
          let top = e.clientY + 10; let left = e.clientX - 330;
          if (left < 10) left = e.clientX + 10;
          if (top + tooltipEl.offsetHeight > window.innerHeight) top = window.innerHeight - tooltipEl.offsetHeight - 10;
          tooltipEl.style.top = top + 'px'; tooltipEl.style.left = left + 'px';
        }
      });
    }

    function gameLoop(now) {
      let dt = (now - lastTime) / 1000;
      if (dt > 1) dt = 1; lastTime = now;
      updateBuffs(dt);

      const passiveCps = calculateTotalCPS();
      clickHistory = clickHistory.filter(c => now - c.time < 1000);
      const activeClickCPS = clickHistory.reduce((sum, c) => sum + c.val, 0);

      if (passiveCps > 0) addScore(passiveCps * dt);

      const displayCps = passiveCps + activeClickCPS;

      document.getElementById('score').textContent = formatNum(Math.floor(game.score));
      document.getElementById('cps').textContent = formatNum(displayCps, 1) + " Kleinis / Sekunde";

      updateDynamicBackground();
      updateClickUI();

      if (!casinoUnlocked && game.totalScore >= 1000) {
        casinoUnlocked = true;
        document.getElementById('casinoBtn').style.display = 'block';
        document.getElementById('skinsBtn').style.display = 'block';
      }
      else if (casinoUnlocked) {
        document.getElementById('casinoBtn').style.display = 'block';
        document.getElementById('skinsBtn').style.display = 'block';
      }

      updateBuildingStates();
      checkPrestigeUnlock();
      
      // Auto Spin Logic
      if(slotState.auto && !slotState.spinning && currentCasinoMode === 'slots' && document.getElementById('casinoModal').style.display === 'flex') {
         spinProSlots();
      }

      requestAnimationFrame(gameLoop);
    }

    function slowLoop() {
      saveGame();
      renderUpgrades();
      BUILDINGS.forEach((_, i) => updateSingleBuildingUI(i));

      if (dbRef) {
        dbRef.child(game.playerName).set({
          name: game.playerName,
          score: Math.floor(game.totalScore),
          prestige: game.prestige || 0,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).catch(err => console.log("Sync error", err));
      }
    }

    /* --- VISUALS & BACKGROUND --- */
    function initVisuals() {
      const container = document.getElementById('visual-canvas');
      container.innerHTML = '';
      visualElements = [];
      let totalCreated = 0;
      for (let i = BUILDINGS.length - 1; i >= 0; i--) {
        if (game.buildings[i] > 0) {
          let count = Math.min(Math.ceil(Math.log2(game.buildings[i] + 1)), 5);
          for (let k = 0; k < count; k++) {
            if (totalCreated < MAX_VISUALS) {
              spawnVisualIcon(BUILDINGS[i].icon);
              totalCreated++;
            }
          }
        }
      }
    }

    function spawnVisualIcon(iconChar) {
      const container = document.getElementById('visual-canvas');
      const el = document.createElement('div');
      el.className = 'bg-icon';
      el.textContent = iconChar;
      el.style.left = Math.random() * 90 + '%';
      el.style.top = Math.random() * 90 + '%';
      el.style.fontSize = (1 + Math.random()) + 'rem';
      el.style.animationDuration = (10 + Math.random() * 20) + 's';
      container.appendChild(el);
      visualElements.push(el);
    }

    function updateDynamicBackground() {
      const panel = document.getElementById('clickPanel');
      let s = game.totalScore;
      if (s < 10000) { }
      else if (s < 1000000) { panel.style.background = `radial-gradient(circle at center, #8e44ad 0%, #000000 100%)`; }
      else if (s < 1000000000) { panel.style.background = `radial-gradient(circle at center, #d35400 0%, #2d3436 100%)`; }
      else if (s < 1000000000000) { panel.style.background = `radial-gradient(circle at center, #f1c40f 0%, #2c3e50 100%)`; }
      else { panel.style.background = `radial-gradient(circle at center, #16a085 0%, #000 100%)`; }
    }

    /* --- MATH & CLICK UPGRADES --- */
    function addScore(amount) { game.score += amount; game.totalScore += amount; }

    function getPrestigeMultiplier() {
      return 1 + (game.prestige * 0.02);
    }

    function getBuildingMultiplier(index) {
      let m = 1;
      UPGRADES.forEach(u => { if (u.type === 'build' && u.target === index && game.upgrades.includes(u.id)) m *= u.multi; });
      if (buffs.frenzy.active) m *= buffs.frenzy.multi;
      return m * getPrestigeMultiplier();
    }

    function getBuildingCPS(index) { return BUILDINGS[index].baseCps * getBuildingMultiplier(index); }
    function calculateTotalCPS() { let cps = 0; game.buildings.forEach((count, i) => cps += count * getBuildingCPS(i)); return cps; }

    function getClickPower(lvl = game.clickLevel) {
      let baseDamage = 1 + ((lvl - 1) * 5);
      let cpsPercentage = 0.05 + (lvl * 0.01); 
      let cpsPower = calculateTotalCPS() * cpsPercentage;
      let power = baseDamage + cpsPower;

      UPGRADES.forEach(u => { if (u.type === 'click' && game.upgrades.includes(u.id)) power *= u.multi; });
      if (buffs.frenzy.active) power *= buffs.frenzy.multi;

      return power * getPrestigeMultiplier();
    }

    function getClickLevelCost() {
      return Math.floor(500 * Math.pow(1.8, game.clickLevel));
    }

    function buyClickStats() {
      const cost = getClickLevelCost();
      if (game.score >= cost) {
        game.score -= cost;
        game.clickLevel++;
        updateClickUI();

        const btn = document.getElementById('btn-buy-click');
        btn.style.transform = "scale(1.1)";
        setTimeout(() => btn.style.transform = "scale(1)", 100);
      }
    }

    function updateClickUI() {
      const cost = getClickLevelCost();
      const currentPower = getClickPower(game.clickLevel);
      const nextPower = getClickPower(game.clickLevel + 1);

      const currentPercent = Math.round((0.05 + (game.clickLevel * 0.01)) * 100);
      const nextPercent = Math.round((0.05 + ((game.clickLevel + 1) * 0.01)) * 100);

      document.getElementById('click-effect-desc').innerHTML = `${currentPercent}% CPS <span style="font-size:0.8em; color:#777">‚ûú</span> ${nextPercent}% CPS`;

      document.getElementById('click-dmg-display').innerHTML = `${formatNum(currentPower, 1)} <span style="font-size:0.8em; color:#7f8c8d">‚ûú</span> <span style="color:#2ecc71">${formatNum(nextPower, 1)}</span>`;
      document.getElementById('click-cost-display').textContent = formatNum(cost);

      const btn = document.getElementById('btn-buy-click');
      if (game.score >= cost) btn.classList.remove('locked');
      else btn.classList.add('locked');
    }

    /* --- CASINO LOGIC --- */
    let isSpinning = false;
    let currentCasinoMode = 'roulette';

    function openCasino() {
      document.getElementById('casinoModal').style.display = 'flex';
      updateCasinoUI();
      // Reset Roulette
      generateStrip(50, null);
      const s = document.getElementById('rouletteStrip');
      s.style.transition = 'none'; s.style.transform = 'translateX(0px)';
      // Ensure Slot is reset visually
      slotState.auto = false;
      document.getElementById('btnAuto').classList.remove('active');
    }
    function closeCasino() { 
        document.getElementById('casinoModal').style.display = 'none';
        slotState.auto = false; // Stop auto on close
    }
    function updateCasinoUI() { document.getElementById('casino-balance').textContent = formatNum(Math.floor(game.score)); }

    function switchCasinoTab(mode) {
      // If slots are spinning, don't switch violently, but okay for now
      currentCasinoMode = mode;
      document.getElementById('view-roulette').style.display = mode === 'roulette' ? 'block' : 'none';
      document.getElementById('view-slots').style.display = mode === 'slots' ? 'block' : 'none';

      document.getElementById('btn-tab-roulette').className = mode === 'roulette' ? 'nav-btn active' : 'nav-btn';
      document.getElementById('btn-tab-slots').className = mode === 'slots' ? 'nav-btn active' : 'nav-btn';
    }

    function setBetMultiplier(multi) {
      const input = document.getElementById('betAmount');
      if (multi === 'max') input.value = Math.floor(game.score);
      else {
        let val = parseInt(input.value) || 0;
        if (val === 0) val = 100;
        input.value = Math.floor(val * multi);
      }
    }

    /* --- ROULETTE ENGINE --- */
    function generateStrip(count, winningColor) {
      const strip = document.getElementById('rouletteStrip');
      strip.innerHTML = '';
      for (let i = 0; i < count; i++) {
        let type = 'black';
        const r = Math.random();
        if (winningColor && i === 60) type = winningColor;
        else {
          if (r < 0.06) type = 'green';
          else if (r < 0.53) type = 'red';
          else type = 'black';
        }
        const el = document.createElement('div');
        el.className = `r-card rc-${type}`;
        if (type === 'green') el.innerHTML = `<img src="${DEFAULT_IMG}" class="rc-logo">`;
        else el.textContent = Math.floor(Math.random() * 7) + (type === 'black' ? 8 : 1);
        strip.appendChild(el);
      }
    }

    function spin(choice) {
      if (isSpinning) return;
      const bet = getBet();
      if (!bet) return;

      game.score -= bet;
      updateCasinoUI();
      isSpinning = true;
      disableButtons(true);

      const r = Math.random();
      let result = 'black';
      if (r < 0.05) result = 'green';
      else if (r < 0.525) result = 'red';

      generateStrip(80, result);

      const strip = document.getElementById('rouletteStrip');
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';
      strip.offsetHeight;

      const cardSize = 74;
      const targetIndex = 60;
      const centerOfTarget = (targetIndex * cardSize) + 35;
      const jitter = Math.floor(Math.random() * 50) - 25;
      const totalTranslate = centerOfTarget + jitter;

      strip.style.transition = 'transform 4.5s cubic-bezier(0.15, 0.85, 0.15, 1)';
      strip.style.transform = `translateX(-${totalTranslate}px)`;

      const marker = document.querySelector('.roulette-marker');
      marker.style.animation = "shake 0.1s infinite";
      setTimeout(() => marker.style.animation = "none", 4500);

      setTimeout(() => { finishSpin(choice, result, bet); }, 4500);
    }

    function finishSpin(choice, result, bet) {
      isSpinning = false;
      disableButtons(false);
      game.casinoHistory.unshift(result);
      if (game.casinoHistory.length > 10) game.casinoHistory.pop();
      renderHistory();

      let multiplier = 0;
      if (choice === result) {
        if (result === 'green') multiplier = 14;
        else multiplier = 2;
      }

      if (multiplier > 0) triggerWin(bet * multiplier);
      updateCasinoUI();
      saveGame();
    }

    /* --- PRO SLOTS ENGINE (5x3) --- */
    const SLOT_SYMBOLS = ['üçí', 'üçã', 'üçá', 'üçâ', 'üîî', 'üíé', 'üëë'];
    // Wild: üëë
    // High: üíé, üîî
    
    let slotState = {
        grid: [], // 5 arrays of 3 symbols
        turbo: false,
        auto: false,
        spinning: false
    };
    
    function initProSlots() {
        const gridEl = document.getElementById('slotGrid');
        gridEl.innerHTML = '';
        slotState.grid = [];
        for(let i=0; i<5; i++) {
            let col = [];
            let reelEl = document.createElement('div');
            reelEl.className = 'pro-reel';
            let strip = document.createElement('div');
            strip.className = 'reel-strip';
            strip.id = `pro-reel-${i}`;
            
            // Random start symbols
            for(let j=0; j<3; j++) {
                let sym = SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)];
                col.push(sym);
                let div = document.createElement('div');
                div.className = 'slot-symbol';
                div.textContent = sym;
                strip.appendChild(div);
            }
            reelEl.appendChild(strip);
            gridEl.appendChild(reelEl);
            slotState.grid.push(col);
        }
    }
    
    function toggleTurbo() {
        slotState.turbo = !slotState.turbo;
        const btn = document.getElementById('btnTurbo');
        if(slotState.turbo) btn.classList.add('active'); else btn.classList.remove('active');
    }
    
    function toggleAuto() {
        slotState.auto = !slotState.auto;
        const btn = document.getElementById('btnAuto');
        if(slotState.auto) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function spinProSlots() {
      if (slotState.spinning) return;
      
      // Clear previous win lines and boxes
      document.getElementById('paylineSvg').innerHTML = '';
      document.getElementById('winDisplay').classList.remove('show');
      
      const bet = getBet();
      if (!bet) {
          slotState.auto = false; // Stop auto if no money
          document.getElementById('btnAuto').classList.remove('active');
          return;
      }

      game.score -= bet;
      updateCasinoUI();
      slotState.spinning = true;
      disableButtons(true);
      document.getElementById('btnSpinSlots').disabled = true;

      // 1. Determine Results BEFORE Animation
      let finalGrid = [];
      for(let i=0; i<5; i++) {
          let col = [];
          for(let r=0; r<3; r++) {
              // Weighted Random
              let rnd = Math.random();
              let sym = 'üçí';
              if(rnd < 0.05) sym = 'üëë'; // Wild
              else if(rnd < 0.15) sym = 'üíé';
              else if(rnd < 0.3) sym = 'üîî';
              else if(rnd < 0.5) sym = 'üçâ';
              else if(rnd < 0.7) sym = 'üçá';
              else if(rnd < 0.85) sym = 'üçã';
              col.push(sym);
          }
          finalGrid.push(col);
      }
      
      // 2. Animate Reels
      for(let i=0; i<5; i++) {
          const strip = document.getElementById(`pro-reel-${i}`);
          strip.classList.add('spin-blur');
          
          // Slight delay between reels
          let delay = slotState.turbo ? 100 + (i*50) : 300 + (i * 200);
          
          setTimeout(() => {
              stopReel(i, finalGrid[i]);
              if(i === 4) {
                 // All stopped
                 setTimeout(() => checkSlotWins(finalGrid, bet), 300);
              }
          }, delay);
      }
    }
    
    function stopReel(colIndex, symbols) {
        const strip = document.getElementById(`pro-reel-${colIndex}`);
        strip.classList.remove('spin-blur');
        strip.classList.add('bounce-stop');
        
        // Update HTML
        strip.innerHTML = '';
        symbols.forEach(s => {
            let div = document.createElement('div');
            div.className = 'slot-symbol';
            div.textContent = s;
            strip.appendChild(div);
        });
        
        // Reset bounce anim
        setTimeout(() => strip.classList.remove('bounce-stop'), 400);
    }
    
    function checkSlotWins(grid, bet) {
        slotState.spinning = false;
        disableButtons(false);
        document.getElementById('btnSpinSlots').disabled = false;
        
        // Paylines Definitions (Coordinates [col, row])
        const paylines = [
            [[0,1], [1,1], [2,1], [3,1], [4,1]], // Middle
            [[0,0], [1,0], [2,0], [3,0], [4,0]], // Top
            [[0,2], [1,2], [2,2], [3,2], [4,2]], // Bottom
            [[0,0], [1,1], [2,2], [3,1], [4,0]], // V
            [[0,2], [1,1], [2,0], [3,1], [4,2]]  // Inverted V
        ];
        
        let totalWin = 0;
        let winningLines = [];
        
        paylines.forEach((line, index) => {
            // Determine the "target symbol" for this line (first non-wild)
            let firstNonWild = null;
            for(let i=0; i<5; i++) {
              let s = grid[line[i][0]][line[i][1]];
              if(s !== 'üëë') { firstNonWild = s; break; }
            }
            // If all are wilds, treat as highest symbol
            let targetSymbol = firstNonWild || 'üíé';

            let matchCount = 0;
            for(let i=0; i<5; i++) {
                let sym = grid[line[i][0]][line[i][1]];
                if(sym === targetSymbol || sym === 'üëë') matchCount++;
                else break; // Line broken
            }
            
            if(matchCount >= 3) {
                // Determine value
                let s = targetSymbol;
                
                // Base Multipliers
                let base = 0;
                if(s === 'üçí') base = 3;
                else if(s === 'üçã') base = 5;
                else if(s === 'üçá') base = 8;
                else if(s === 'üçâ') base = 12;
                else if(s === 'üîî') base = 25;
                else if(s === 'üíé') base = 50;
                
                // Exponential growth for 4 or 5 matches
                if(matchCount === 4) base *= 5;
                if(matchCount === 5) base *= 20;
                
                totalWin += bet * base;
                
                // Calculate colors for line
                let colors = ['#e74c3c', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6'];
                drawPayline(line.slice(0, matchCount), colors[index % colors.length]);
            }
        });
        
        if(totalWin > 0) {
            triggerWin(totalWin);
            
            // Show Win Box
            const box = document.getElementById('winDisplay');
            document.getElementById('winAmountDisplay').textContent = formatNum(totalWin);
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 1500);
        }
        
        updateCasinoUI();
        saveGame();
    }
    
    function drawPayline(coords, color) {
        // SVG Coord mapping (500x240)
        // Col centers: 50, 150, 250... (20% steps)
        // Row centers: 40, 120, 200 (33.3% steps of 240)
        
        const svg = document.getElementById('paylineSvg');
        let points = "";
        
        coords.forEach((c, i) => {
            let x = (c[0] * 100) + 50;
            let y = (c[1] * 80) + 40;
            points += `${x},${y} `;
        });
        
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        poly.setAttribute("points", points);
        poly.setAttribute("fill", "none");
        poly.setAttribute("stroke", color);
        poly.setAttribute("stroke-width", "8");
        poly.setAttribute("stroke-linecap", "round");
        poly.setAttribute("stroke-linejoin", "round");
        poly.style.filter = "drop-shadow(0 0 5px " + color + ")";
        
        svg.appendChild(poly);
    }

    /* --- SHARED CASINO FUNCS --- */
    function getBet() {
      const betInput = document.getElementById('betAmount');
      let bet = parseInt(betInput.value);
      if (isNaN(bet) || bet <= 0) { alert("Bitte Einsatz eingeben!"); return null; }
      if (bet > game.score) { bet = Math.floor(game.score); betInput.value = bet; }
      if (bet <= 0) return null;
      return bet;
    }

    function triggerWin(amount) {
      addScore(amount);
      spawnConfetti();
      document.getElementById('casinoWindow').classList.add('win-pulse');
      setTimeout(() => document.getElementById('casinoWindow').classList.remove('win-pulse'), 500);
    }

    function renderHistory() {
      const con = document.getElementById('history-container'); con.innerHTML = '';
      game.casinoHistory.forEach(h => {
        const d = document.createElement('div'); d.className = `hist-dot hist-${h}`; con.appendChild(d);
      });
    }

    function disableButtons(disable) {
      document.querySelectorAll('.bet-btn, .control-btn, .close-btn, .nav-btn, .open-case-btn').forEach(b => b.disabled = disable);
    }
    function spawnConfetti() {
      const win = document.getElementById('casinoWindow');
      for (let i = 0; i < 30; i++) {
        const p = document.createElement('div'); p.className = 'win-particle';
        p.style.backgroundColor = ['#f1c40f', '#e74c3c', '#2ecc71', '#3498db'][Math.floor(Math.random() * 4)];
        p.style.left = '50%'; p.style.top = '50%';
        p.style.setProperty('--tx', (Math.random() * 400 - 200) + 'px');
        p.style.setProperty('--ty', (Math.random() * 400 - 200) + 'px');
        win.appendChild(p); setTimeout(() => p.remove(), 1000);
      }
    }

    /* --- SKINS SYSTEM (NEW) --- */
    function openSkins() {
      document.getElementById('skinModal').style.display = 'flex';
      renderInventory();
      document.getElementById('case-count').textContent = game.cases;

      // Reset Strip Visual
      const strip = document.getElementById('caseStrip');
      strip.innerHTML = '';
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';

      // Populate placeholder strip
      for (let i = 0; i < 5; i++) {
        const ph = SKINS.find(s => s.id === 'default');
        const el = document.createElement('div');
        el.className = `case-item rarity-${ph.rarity}`;
        el.innerHTML = `<img src="${ph.url}" style="filter:${ph.filter}">`;
        strip.appendChild(el);
      }
    }

    function closeSkins() {
      document.getElementById('skinModal').style.display = 'none';
    }

    function renderInventory() {
      const grid = document.getElementById('inventoryGrid');
      grid.innerHTML = '';

      let inventoryCount = {};
      game.skinsOwned.forEach(id => {
        inventoryCount[id] = (inventoryCount[id] || 0) + 1;
      });

      Object.keys(inventoryCount).forEach(skinId => {
        const skin = SKINS.find(s => s.id === skinId);
        if (!skin) return;

        const el = document.createElement('div');
        el.className = 'inv-slot rarity-' + skin.rarity;
        if (game.equippedSkin === skinId) el.classList.add('equipped');

        el.innerHTML = `
          <img src="${skin.url}" style="filter:${skin.filter}">
          ${inventoryCount[skinId] > 1 ? `<div class="count-badge">x${inventoryCount[skinId]}</div>` : ''}
        `;
        el.onclick = () => equipSkin(skinId);
        grid.appendChild(el);
      });
    }

    function equipSkin(id, mute = false) {
      const skin = SKINS.find(s => s.id === id);
      if (skin && game.skinsOwned.includes(id)) {
        game.equippedSkin = id;

        const big = document.getElementById('bigKlein');
        big.src = skin.url;
        big.style.filter = `drop-shadow(0 30px 60px rgba(0,0,0,0.5)) ${skin.filter}`;

        if (document.getElementById('skinModal').style.display === 'flex') {
          renderInventory();
        }
        if (!mute) saveGame();
      }
    }

    function openCase() {
      if (game.cases <= 0 || isSpinning) return;
      game.cases--;
      document.getElementById('case-count').textContent = game.cases;

      isSpinning = true;
      disableButtons(true);

      const roll = Math.random();
      let wonSkin = SKINS.find(s => s.id === 'default');

      const nonDefaultSkins = SKINS.filter(s => s.id !== 'default');

      if (roll < 0.1 && nonDefaultSkins.length > 0) {
        wonSkin = nonDefaultSkins[Math.floor(Math.random() * nonDefaultSkins.length)];
      }

      generateCaseStrip(60, wonSkin);

      const strip = document.getElementById('caseStrip');
      strip.offsetHeight;

      const itemWidth = 94;
      const targetIndex = 45;

      const positionOfWinner = (targetIndex * itemWidth) + 45;
      const jitter = Math.floor(Math.random() * 40) - 20;
      const totalTranslate = positionOfWinner + jitter;

      strip.style.transition = 'transform 5s cubic-bezier(0.12, 0.8, 0.1, 1)';
      strip.style.transform = `translateX(-${totalTranslate}px)`;

      setTimeout(() => {
        isSpinning = false;
        disableButtons(false);

        if (!game.skinsOwned.includes(wonSkin.id)) {
          game.skinsOwned.push(wonSkin.id);
          alert(`GEZOGEN: NEUER SKIN! ${wonSkin.name}`);
        } else {
          alert(`GEZOGEN: ${wonSkin.name} (Du besitzt diesen Skin bereits)`);
        }
        renderInventory();
        saveGame();
      }, 5000);
    }

    function generateCaseStrip(count, winner) {
      const strip = document.getElementById('caseStrip');
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';
      strip.innerHTML = '';

      for (let i = 0; i < count; i++) {
        let item;
        if (i === 45) {
          item = winner;
        } else if (i === 44 || i === 46) {
          item = SKINS.find(s => s.id === 'default') || SKINS[0];
        } else {
          item = SKINS[Math.floor(Math.random() * SKINS.length)];
        }

        const el = document.createElement('div');
        el.className = `case-item rarity-${item.rarity}`;
        el.innerHTML = `<img src="${item.url}" style="filter:${item.filter}">`;
        strip.appendChild(el);
      }
    }

    /* --- INTERACTIONS --- */
    const bigKlein = document.getElementById('bigKlein');
    bigKlein.addEventListener('mousedown', (e) => handleInteraction(e.clientX, e.clientY));
    bigKlein.addEventListener('touchstart', (e) => { e.preventDefault(); for (let i = 0; i < e.touches.length; i++) handleInteraction(e.touches[i].clientX, e.touches[i].clientY); });
    function handleInteraction(x, y) {
      const power = getClickPower(); addScore(power); game.clicks++;

      clickHistory.push({ time: performance.now(), val: power });

      spawnFloatingText(x, y, `+${formatNum(power)} Kleini${power != 1 ? 's' : ''}`); spawnFallingFace(x, y);

      bigKlein.style.transform = "scale(0.94)"; setTimeout(() => bigKlein.style.transform = "scale(1)", 50);
    }
    function spawnFloatingText(x, y, text) {
      const el = document.createElement('div'); el.className = 'click-text'; el.textContent = text;
      el.style.left = (x - 20 + Math.random() * 40) + 'px'; el.style.top = y + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 800);
    }
    function spawnFallingFace(x, y) {
      const currentSkin = SKINS.find(s => s.id === game.equippedSkin) || SKINS[0];
      const img = document.createElement('img');
      img.src = currentSkin.url;
      img.className = 'falling-face';
      img.style.filter = currentSkin.filter;
      img.style.left = (x - 17) + 'px'; img.style.top = (y - 17) + 'px'; document.getElementById('clickPanel').appendChild(img); setTimeout(() => img.remove(), 1200);
    }

    // UPDATED FORMAT NUM (Handles up to Sextillions)
    function formatNum(num, decimals = 0) {
      if (num < 1000000) return num.toLocaleString('de-DE', { maximumFractionDigits: decimals });

      const units = [
        { val: 1e36, suffix: " Sext" },   
        { val: 1e33, suffix: " Quintd" }, 
        { val: 1e30, suffix: " Quint" },  
        { val: 1e27, suffix: " Quard" },  
        { val: 1e24, suffix: " Quad" },   
        { val: 1e21, suffix: " Trd" },    
        { val: 1e18, suffix: " Trio" },   
        { val: 1e15, suffix: " Brd" },    
        { val: 1e12, suffix: " Bio" },    
        { val: 1e9,  suffix: " Mrd" },    
        { val: 1e6,  suffix: " Mio" }     
      ];

      for (const unit of units) {
        if (num >= unit.val) {
          return (num / unit.val).toLocaleString('de-DE', { maximumFractionDigits: 2 }) + unit.suffix;
        }
      }
      return num.toExponential(2);
    }

    /* --- SHOP --- */
    function getBuildingCost(i) { return Math.floor(BUILDINGS[i].baseCost * Math.pow(1.15, game.buildings[i])); }
    function buyBuilding(i) {
      const cost = getBuildingCost(i);
      if (game.score >= cost) {
        game.score -= cost;
        game.buildings[i]++;
        updateSingleBuildingUI(i);
        renderUpgrades();
        if (visualElements.length < MAX_VISUALS) spawnVisualIcon(BUILDINGS[i].icon);
      }
    }
    function buildBuildingUI() {
      const list = document.getElementById('buildingList'); list.innerHTML = '';
      BUILDINGS.forEach((b, i) => {
        const el = document.createElement('div'); el.className = 'building-row'; el.id = `build-row-${i}`; el.onclick = () => buyBuilding(i);
        el.innerHTML = `<div class="b-icon">${b.icon}</div><div class="b-info"><div class="b-name">${b.name}</div><div class="b-cps" id="b-cps-${i}">Prod: ...</div><div class="b-cost"><span id="cost-${i}">0 Kleinis</span> <span id="gain-${i}" style="color:#2ecc71; font-size:0.8rem; margin-left:6px; font-weight:normal;"></span></div></div><div class="b-count" id="count-${i}">0</div>`;
        list.appendChild(el); updateSingleBuildingUI(i);
      });
    }
    function updateSingleBuildingUI(i) {
      document.getElementById(`count-${i}`).textContent = game.buildings[i];
      document.getElementById(`cost-${i}`).textContent = formatNum(getBuildingCost(i)) + " Kleinis";

      const realCps = getBuildingCPS(i);
      document.getElementById(`b-cps-${i}`).textContent = `Prod: ${formatNum(realCps, 1)}/s`;
      document.getElementById(`gain-${i}`).textContent = `(+${formatNum(realCps, 1)} CPS)`;
    }
    function updateBuildingStates() {
      BUILDINGS.forEach((b, i) => {
        const row = document.getElementById(`build-row-${i}`);
        const costDiv = row.querySelector('.b-cost');

        if (game.score >= getBuildingCost(i)) {
          row.classList.add('can-afford');
          costDiv.classList.add('affordable');
        } else {
          row.classList.remove('can-afford');
          costDiv.classList.remove('affordable');
        }
      });
    }

    /* --- UPGRADES --- */
    function buyUpgrade(uId) {
      const u = UPGRADES.find(x => x.id === uId);
      if (game.score >= u.cost) { game.score -= u.cost; game.upgrades.push(uId); renderUpgrades(); hideTooltip(); }
    }
    function showTooltip(u) {
      ttName.textContent = u.name; ttPrice.textContent = formatNum(u.cost) + " Kleinis";
      ttPrice.className = game.score >= u.cost ? 'tt-price affordable' : 'tt-price expensive';
      ttEffect.textContent = "Effekt: " + u.text; ttDesc.textContent = u.desc;
      let statsHTML = '';
      if (u.type === 'build') {
        const bIdx = u.target; const count = game.buildings[bIdx];
        const currentMulti = getBuildingMultiplier(bIdx);
        const base = BUILDINGS[bIdx].baseCps;
        const currentSingleCPS = base * currentMulti;
        const newSingleCPS = currentSingleCPS * u.multi;
        const totalGain = (newSingleCPS - currentSingleCPS) * count;
        statsHTML = `<div class="stat-line"><span>Einzeln:</span><span>${formatNum(currentSingleCPS, 1)} ‚ûú <span style="color:#2ecc71">${formatNum(newSingleCPS, 1)}</span></span></div><div class="stat-highlight">+${formatNum(totalGain, 1)} CPS Gesamt</div>`;
      } else { statsHTML = `<div class="stat-highlight">Klickst√§rke wird verdoppelt!</div>`; }
      ttStats.innerHTML = statsHTML; tooltipEl.style.display = 'block';
    }
    function hideTooltip() { tooltipEl.style.display = 'none'; }
    function renderUpgrades() {
      const container = document.getElementById('upgradeGrid'); container.innerHTML = '';
      const available = UPGRADES.filter(u => {
        if (game.upgrades.includes(u.id)) return false;
        if (u.trigger.type === 'clicks' && game.clicks >= u.trigger.val) return true;
        if (u.trigger.type === 'build' && game.buildings[u.trigger.id] >= u.trigger.val) return true;
        return false;
      });
      available.forEach(u => {
        const div = document.createElement('div'); div.className = 'upgrade-crate'; div.innerHTML = u.icon;
        div.onmouseenter = () => showTooltip(u); div.onmouseleave = () => hideTooltip();
        if (game.score >= u.cost) { div.onclick = () => buyUpgrade(u.id); }
        else { div.style.opacity = 0.5; div.style.filter = "grayscale(1)"; }
        container.appendChild(div);
      });
    }

    /* --- GOLDEN --- */
    function updateBuffs(dt) { if (buffs.frenzy.active) { buffs.frenzy.time -= dt; if (buffs.frenzy.time <= 0) { buffs.frenzy.active = false; renderBuffs(); } } }
    function renderBuffs() { document.getElementById('buffArea').innerHTML = buffs.frenzy.active ? `<div class="buff-icon">üî•</div>` : ''; }
    function scheduleGolden() { const delay = (Math.random() * 600000) + 600000; setTimeout(spawnGolden, delay); }
    function spawnGolden() {
      const g = document.getElementById('goldenKlein');
      const maxX = document.getElementById('clickPanel').offsetWidth - 80; const maxY = document.getElementById('clickPanel').offsetHeight - 80;
      g.style.left = Math.random() * maxX + 'px'; g.style.top = Math.random() * maxY + 'px'; g.style.display = 'block';
      setTimeout(() => { if (g.style.display === 'block') { g.style.display = 'none'; scheduleGolden(); } }, 10000);
    }
    document.getElementById('goldenKlein').onmousedown = function (e) {
      e.stopPropagation(); this.style.display = 'none'; buffs.frenzy.active = true; buffs.frenzy.time = 30; renderBuffs();
      spawnFloatingText(parseInt(this.style.left), parseInt(this.style.top), "FRENZY! (x7 CPS)"); scheduleGolden();
    };

    /* --- SAVE --- */
    function saveGame() {
      const data = {
        score: game.score,
        totalScore: game.totalScore,
        clicks: game.clicks,
        clickLevel: game.clickLevel,
        buildings: game.buildings,
        upgrades: game.upgrades,
        casinoHistory: game.casinoHistory,
        playerName: game.playerName,
        prestige: game.prestige || 0,
        cases: game.cases,
        skinsOwned: game.skinsOwned,
        equippedSkin: game.equippedSkin
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }
    function loadGame() {
      const saved = JSON.parse(localStorage.getItem(SAVE_KEY));
      if (saved) {
        game.score = saved.score || 0;
        game.totalScore = saved.totalScore || 0;
        game.clicks = saved.clicks || 0;
        game.clickLevel = saved.clickLevel || 1;
        if (saved.buildings) game.buildings = saved.buildings;
        game.upgrades = saved.upgrades || [];
        game.casinoHistory = saved.casinoHistory || [];
        if (saved.playerName) game.playerName = saved.playerName;
        game.prestige = saved.prestige || 0;
        game.cases = saved.cases || 0;
        game.skinsOwned = saved.skinsOwned || ['default'];
        game.equippedSkin = saved.equippedSkin || 'default';
      }
    }

    /* --- PRESTIGE LOGIK --- */
    function calculatePotentialPrestige() {
      if (game.totalScore < 100000000) return 0;
      return Math.floor(Math.pow(game.totalScore / 100000000, 0.25));
    }

    function openPrestige() {
      const current = game.prestige;
      const potentialTotal = calculatePotentialPrestige();
      const gain = potentialTotal - current;

      if (gain <= 0 && current === 0) return;

      document.getElementById('modal-current-prestige').textContent = formatNum(current);
      document.getElementById('modal-new-prestige').textContent = formatNum(potentialTotal);
      document.getElementById('modal-gain-prestige').textContent = formatNum(gain);
      document.getElementById('modal-gain-cases').textContent = formatNum(gain);

      const btn = document.getElementById('confirmPrestigeBtn');
      if (gain > 0) {
        btn.disabled = false;
        btn.innerHTML = `RESET & +${formatNum(gain)} LEVEL`;
        btn.style.opacity = "1";
      } else {
        btn.disabled = true;
        btn.innerHTML = "Du brauchst mehr Score!";
        btn.style.opacity = "0.5";
      }

      document.getElementById('prestigeModal').style.display = 'flex';
    }

    function closePrestige() {
      document.getElementById('prestigeModal').style.display = 'none';
    }

    function doPrestige() {
      const potentialTotal = calculatePotentialPrestige();
      if (potentialTotal <= game.prestige) return;

      const gain = potentialTotal - game.prestige;

      game.prestige = potentialTotal;
      game.cases += gain;

      game.score = 0;
      game.clicks = 0;
      game.clickLevel = 1;
      game.buildings = new Array(BUILDINGS.length).fill(0);
      game.upgrades = [];

      saveGame();
      location.reload();
    }

    function checkPrestigeUnlock() {
      const potential = calculatePotentialPrestige();
      const gain = potential - game.prestige;
      const btn = document.getElementById('prestigeBtn');

      if (gain > 0) {
        btn.style.display = 'block';
        btn.classList.add('win-pulse');
        btn.innerHTML = `üöÄ AUFSTEIGEN (+${gain} Level)`;
      } else {
        btn.style.display = 'none';
      }

      const badge = document.getElementById('prestige-badge');
      if (game.prestige > 0 || game.totalScore > 10000000) {
        badge.style.display = 'block';
        const currentProgressRank = Math.max(game.prestige, potential);
        const nextTargetRank = currentProgressRank + 1;

        const scoreNeededForNext = Math.pow(nextTargetRank, 4) * 100000000;
        const scoreForCurrent = Math.pow(currentProgressRank, 4) * 100000000;

        const remaining = scoreNeededForNext - game.totalScore;
        const totalDistance = scoreNeededForNext - scoreForCurrent;
        const coveredDistance = game.totalScore - scoreForCurrent;
        let percent = (coveredDistance / totalDistance) * 100;
        if (percent < 0) percent = 0;
        if (percent > 100) percent = 100;

        document.getElementById('prestige-level-display').textContent = formatNum(game.prestige);
        document.getElementById('prestige-bonus-display').textContent = formatNum(game.prestige * 2);
        document.getElementById('prestige-progress-bar').style.width = percent + "%";

        if (remaining > 0) {
          document.getElementById('prestige-next-req').textContent = formatNum(remaining) + " Kleinis";
        } else {
          document.getElementById('prestige-next-req').textContent = "Bereit zum Aufstieg!";
        }
      }
    }

    /* --- LEADERBOARD LOGIC --- */
    function openLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'flex';
      fetchLeaderboard();
    }

    function closeLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'none';
    }

    function fetchLeaderboard() {
      const list = document.getElementById('lb-list');
      if (!dbRef) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Firebase nicht konfiguriert!<br><span style="font-size:0.8rem; color:#aaa;">√ñffne index.html und f√ºge deine Keys ein.</span></div>';
        return;
      }

      list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Lade...</div>';

      dbRef.orderByChild('prestige').limitToLast(20).once('value').then(snapshot => {
        const scores = [];
        snapshot.forEach(child => {
          scores.push(child.val());
        });
        renderLeaderboard(scores.reverse());
      }).catch(err => {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Fehler beim Laden :(</div>';
      });
    }

    function renderLeaderboard(scores) {
      const list = document.getElementById('lb-list');
      list.innerHTML = '';

      if (scores.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px;">Noch keine Spieler. Sei der Erste!</div>';
        return;
      }

      scores.forEach((s, index) => {
        const rank = index + 1;
        let rankClass = 'lb-rank';
        if (rank === 1) rankClass += ' top-1';
        if (rank === 2) rankClass += ' top-2';
        if (rank === 3) rankClass += ' top-3';

        const el = document.createElement('div');
        el.className = 'lb-entry';
        el.innerHTML = `
          <div class="${rankClass}">#${rank}</div>
          <div class="lb-name">${s.name}</div>
          <div class="lb-score">Lvl ${formatNum(s.prestige || 0)}</div>
        `;
        list.appendChild(el);
      });
    }
    init();
  </script>

</body>

</html>
