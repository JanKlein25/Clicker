<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker - Casino </title>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
    rel="stylesheet">
  <!-- FIREBASE SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-dark: #0f0f12;
      --panel-left: #1a1a20;
      --panel-right: #121216;
      --gold: #f1c40f;
      --green: #2ecc71;
      --red: #e74c3c;
      --text-main: #ecf0f1;
      --tooltip-bg: rgba(10, 10, 15, 0.98);
      --purple: #9b59b6;
      --blue: #3498db;
      /* Rarity Colors */
      --rarity-common: #b0c3d9;
      --rarity-rare: #4b69ff;
      --rarity-epic: #8847ff;
      --rarity-legendary: #d32ce6;
      --rarity-blackmarket: #8a0303;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
      -webkit-user-select: none;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: row;
    }

    /* --- GLOBAL TOOLTIP --- */
    #global-tooltip {
      position: fixed;
      top: 0;
      left: 0;
      width: 320px;
      background: var(--tooltip-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      pointer-events: none;
      z-index: 10000;
      padding: 0;
      display: none;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 1);
    }

    .tt-header {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tt-title {
      font-family: 'Merriweather', serif;
      font-weight: 900;
      font-size: 1.1rem;
      color: var(--gold);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tt-price {
      font-size: 0.9rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
      background: #000;
    }

    .tt-price.affordable {
      color: var(--green);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .tt-price.expensive {
      color: var(--red);
      opacity: 0.8;
    }

    .tt-body {
      padding: 12px;
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
    }

    .tt-effect {
      color: #fff;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
      font-size: 0.95rem;
      border-left: 3px solid var(--gold);
      padding-left: 10px;
    }

    .tt-stats {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-highlight {
      color: var(--green);
      font-weight: bold;
      font-size: 0.95rem;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- LAYOUT --- */
    .left-panel {
      flex: 1;
      background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
      transition: background 2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      border-right: 2px solid rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }

    .right-panel {
      width: 420px;
      background: var(--panel-right);
      display: flex;
      flex-direction: column;
      border-left: 1px solid #222;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
      z-index: 50;
    }

    /* --- VISUAL ELEMENTS (Background Icons) --- */
    #visual-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .bg-icon {
      position: absolute;
      font-size: 1.5rem;
      opacity: 0.3;
      animation: floatAround linear infinite;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }

    @keyframes floatAround {
      0% {
        transform: translate(0, 0) rotate(0deg);
      }

      25% {
        transform: translate(20px, -20px) rotate(10deg);
      }

      50% {
        transform: translate(0, -40px) rotate(0deg);
      }

      75% {
        transform: translate(-20px, -20px) rotate(-10deg);
      }

      100% {
        transform: translate(0, 0) rotate(0deg);
      }
    }

    .bakery-name {
      position: absolute;
      top: 30px;
      font-family: 'Merriweather', serif;
      font-weight: 900;
      font-size: 2.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(to bottom, #f1c40f, #d35400);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 0px rgba(0, 0, 0, 0.5));
      z-index: 20;
    }

    .score-container {
      margin-bottom: 50px;
      text-align: center;
      z-index: 20;
    }

    #score {
      font-family: 'Roboto', sans-serif;
      font-size: 3.2rem;
      font-weight: 900;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      line-height: 1;
      /* NEU: Macht alle Zahlen gleich breit, verhindert Wackeln */
      font-variant-numeric: tabular-nums;
    }

    .currency-label {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 700;
      margin-top: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #cps {
      font-size: 1.1rem;
      color: #7f8c8d;
      margin-top: 10px;
      font-weight: 500;
      background: rgba(0, 0, 0, 0.4);
      padding: 5px 20px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      
      /* NEU: Verhindert Wackeln der Zahlen im Kästchen */
      font-variant-numeric: tabular-nums;
      
      /* NEU: Gibt dem Kästchen eine feste Mindestbreite, damit der Rand nicht zuckt */
      display: inline-block;
      min-width: 280px; 
    }

    #bigKlein {
      width: 300px;
      height: 300px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.05s, filter 0.1s;
      filter: drop-shadow(0 30px 60px rgba(0, 0, 0, 0.5));
      z-index: 20;
    }

    #bigKlein:active {
      transform: scale(0.96);
      filter: brightness(0.9);
    }

    #bigKlein:hover {
      transform: scale(1.02);
      filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.1));
    }

    /* --- CASINO BUTTON --- */
    #casinoBtn {
      margin-top: 30px;
      background: linear-gradient(45deg, #e67e22, #f39c12);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 12px 30px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
      display: none;
      z-index: 25;
      transition: all 0.2s;
      letter-spacing: 1px;
    }

    #casinoBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(243, 156, 18, 0.8);
    }

    /* --- SKINS BUTTON (UPDATE: Gleicher Style wie Casino) --- */
    #skinsBtn {
      margin-top: 30px; /* Synchronisiert mit Casino */
      background: linear-gradient(45deg, #1abc9c, #16a085);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 12px 30px; /* Synchronisiert mit Casino */
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.2rem; /* Synchronisiert mit Casino */
      cursor: pointer;
      box-shadow: 0 0 20px rgba(26, 188, 156, 0.4);
      transition: all 0.2s;
      letter-spacing: 1px;
      z-index: 25;
      display: none;
    }

    #skinsBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(26, 188, 156, 0.8);
    }

    /* --- CLICK UPGRADE SECTION --- */
    .click-booster {
      padding: 15px;
      background: linear-gradient(135deg, #18181b, #0f0f12);
      border-bottom: 2px solid #000;
    }

    .cb-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .cb-info {
      flex: 1;
    }

    .cb-title {
      color: var(--gold);
      font-family: 'Merriweather', serif;
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .cb-stat {
      color: #ccc;
      font-size: 0.8rem;
    }

    .cb-btn {
      background: linear-gradient(to bottom, #2ecc71, #27ae60);
      border: 1px solid #2ecc71;
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      text-align: right;
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
      transition: transform 0.1s;
      min-width: 100px;
    }

    .cb-btn:hover {
      filter: brightness(1.1);
    }

    .cb-btn:active {
      transform: scale(0.95);
    }

    .cb-btn.locked {
      background: #333;
      border-color: #444;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }

    .cb-cost {
      font-size: 0.8rem;
      display: block;
      opacity: 0.9;
    }

    /* --- SHOP --- */
    .store-header {
      background: #0a0a0d;
      padding: 18px;
      text-align: center;
      font-family: 'Merriweather', serif;
      font-weight: 900;
      color: #57606f;
      border-bottom: 1px solid #222;
      font-size: 0.9rem;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .upgrades-container {
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 80px;
      max-height: 220px;
      overflow-y: auto;
      border-bottom: 2px solid #000;
    }

    .upgrade-crate {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #2d3436, #1e272e);
      border: 1px solid #444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      border-radius: 8px;
      transition: all 0.2s;
      position: relative;
    }

    .upgrade-crate:hover {
      border-color: var(--text-main);
      background: #333;
      z-index: 5;
    }

    .buildings-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #444 #0a0a0d;
    }

    .building-row {
      height: 80px;
      background: linear-gradient(to right, #1a1a20, #141418);
      border-bottom: 1px solid #000;
      display: flex;
      align-items: center;
      padding: 0 20px;
      cursor: pointer;
      position: relative;
      opacity: 0.5;
      transition: all 0.2s;
    }

    .building-row:hover {
      opacity: 1;
      background: #222;
    }

    .building-row.can-afford {
      opacity: 1;
    }

    .b-icon {
      font-size: 2.2rem;
      width: 50px;
      text-align: center;
      margin-right: 15px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
    }

    .b-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .b-name {
      font-weight: 700;
      font-family: 'Merriweather', serif;
      font-size: 1rem;
      color: #fff;
      margin-bottom: 3px;
    }

    .b-cps {
      font-size: 0.75rem;
      color: #636e72;
    }

    .b-cost {
      color: var(--red);
      font-weight: bold;
      font-size: 0.85rem;
    }

    .b-cost.affordable {
      color: var(--green);
    }

    .b-count {
      font-size: 1.8rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      margin-left: auto;
    }

    /* --- CASINO MODAL --- */
    #casinoModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .casino-window {
      background: #18181b;
      width: 95%;
      max-width: 800px;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 0;
      text-align: center;
      box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
      position: relative;
      overflow: hidden;
      animation: zoomIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .cw-header {
      background: linear-gradient(to bottom, #2d3436, #1e272e);
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cw-title {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 900;
      letter-spacing: 1px;
    }

    .cw-balance {
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.4);
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid #444;
    }

    .cw-body {
      padding: 20px;
      position: relative;
    }

    .casino-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      background: #111;
      padding: 5px;
      border-radius: 8px;
      border: 1px solid #333;
      flex-wrap: wrap; /* Damit Buttons auf kleinen Screens umbrechen */
    }

    .nav-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: #666;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      min-width: 80px;
    }

    .nav-btn.active {
      background: #333;
      color: var(--gold);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .nav-btn:hover:not(.active) {
      color: #fff;
    }

    /* --- PRO SLOTS STYLES (FIXED) --- */
    .pro-slot-screen {
      background: #000;
      border: 5px solid #d35400;
      border-radius: 10px;
      padding: 10px;
      position: relative;
      margin-bottom: 20px;
      box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.9), 0 0 20px rgba(211, 84, 0, 0.3);
      overflow: hidden;
      /* Ensures content stays inside */
    }

    .pro-slot-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      /* Slightly wider gap for visuals */
      background: #111;
      padding: 2px;
      position: relative;
      z-index: 2;
    }

    .pro-reel {
      height: 240px;
      /* Exactly 3x 80px */
      background: linear-gradient(to bottom, #1a1a20, #0f0f12);
      border: 1px solid #333;
      border-radius: 4px;
      overflow: hidden;
      /* Crucial: Hides the long strip */
      position: relative;
    }

    .reel-strip {
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      /* Logic: We animate 'transform' to scroll the strip up */
    }

    .slot-symbol {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      /* Ensures box sizing */
      box-sizing: border-box;
    }

    /* SLOT HELP OVERLAY */
    #slot-help-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 50;
      color: #fff;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }

    .help-title {
      color: var(--gold);
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .help-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      font-size: 0.8rem;
      text-align: left;
      width: 100%;
      max-width: 400px;
    }

    .help-item strong {
      display: block;
      color: #ddd;
      margin-bottom: 3px;
    }

    .payline-mini {
      display: inline-block;
      width: 30px;
      height: 20px;
      background: #333;
      margin-right: 5px;
      border: 1px solid #555;
    }

    .payline-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .slot-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      background: #222;
      padding: 10px;
      border-radius: 8px;
      border-top: 2px solid #444;
    }

    .slot-btn-circle {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-weight: 900;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 0 rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
    }

    .btn-spin-main {
      background: radial-gradient(circle, #2ecc71, #27ae60);
      color: #fff;
      font-size: 1rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .btn-spin-main:active {
      transform: translateY(4px);
      box-shadow: none;
    }

    .btn-spin-main:disabled {
      filter: grayscale(1);
      cursor: not-allowed;
    }

    .toggle-btn {
      background: #444;
      color: #aaa;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      border: 1px solid #555;
      cursor: pointer;
    }

    .toggle-btn.active {
      background: #d35400;
      color: #fff;
      border-color: #e67e22;
      box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
    }

    .win-display-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid var(--gold);
      padding: 20px 40px;
      z-index: 20;
      border-radius: 10px;
      text-align: center;
      pointer-events: none;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .win-display-box.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .win-val {
      color: var(--gold);
      font-size: 2rem;
      font-weight: 900;
      display: block;
    }

    .win-label {
      color: #fff;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* --- OLD STYLES REMAINING --- */
    .bet-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .bet-input {
      background: #111;
      border: 1px solid #444;
      color: #fff;
      font-size: 1.2rem;
      padding: 10px;
      width: 150px;
      text-align: center;
      font-weight: bold;
      border-radius: 6px;
    }

    .control-btn {
      background: #333;
      border: 1px solid #555;
      color: #ccc;
      padding: 0 15px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 6px;
    }

    .control-btn:hover {
      background: #444;
      color: #fff;
    }

    .action-row {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .bet-btn {
      flex: 1;
      padding: 20px 10px;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      font-size: 1.1rem;
      color: #fff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      border: 2px solid rgba(255, 255, 255, 0.05);
      transition: transform 0.1s;
    }

    .bet-btn:active {
      transform: scale(0.95);
    }

    .bet-btn:disabled {
      filter: grayscale(1);
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-red {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .btn-black {
      background: linear-gradient(135deg, #34495e, #2c3e50);
    }

    .btn-green {
      background: linear-gradient(135deg, #f1c40f, #f39c12);
      color: #000;
    }

    .sub-text {
      font-size: 0.7rem;
      opacity: 0.8;
      font-weight: normal;
    }

    .history-bar {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .hist-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.3);
    }

    .hist-red {
      background: var(--red);
    }

    .hist-black {
      background: #34495e;
    }

    .hist-green {
      background: var(--gold);
      box-shadow: 0 0 10px var(--gold);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Particles & FX */
    .win-particle {
      position: absolute;
      width: 10px;
      height: 10px;
      pointer-events: none;
      animation: confetti 1s ease-out forwards;
      z-index: 1000;
    }

    @keyframes confetti {
      0% {
        transform: translate(0, 0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translate(var(--tx), var(--ty)) rotate(720deg);
        opacity: 0;
      }
    }

    .win-pulse {
      animation: screenFlash 0.5s;
    }

    @keyframes screenFlash {
      0% {
        background-color: rgba(255, 255, 255, 0.2);
      }

      100% {
        background-color: transparent;
      }
    }

    .falling-face {
      position: absolute;
      width: 35px;
      height: 35px;
      pointer-events: none;
      z-index: 15;
      animation: physicsFall 1.2s cubic-bezier(0.5, 0, 0.8, 0.8) forwards;
    }

    @keyframes physicsFall {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(800px) rotate(360deg) scale(0.8);
        opacity: 0;
      }
    }

    .click-text {
      position: absolute;
      color: #fff;
      font-weight: 900;
      font-size: 1.4rem;
      pointer-events: none;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 100;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translateY(-80px) scale(1);
      }
    }

    /* Golden Klein */
    #goldenKlein {
      position: absolute;
      width: 80px;
      height: 80px;
      z-index: 9999;
      cursor: pointer;
      display: none;
      filter: drop-shadow(0 0 20px gold);
      animation: wobble 2s infinite;
    }

    @keyframes wobble {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-5deg);
      }

      75% {
        transform: rotate(5deg);
      }
    }

    .buff-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .buff-icon {
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--gold);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
      animation: pulse 1s infinite alternate;
    }

    /* --- PRESTIGE NEUE STYLES --- */
    #prestigeBtn {
      margin-top: 15px;
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(52, 152, 219, 0.6);
      z-index: 25;
      animation: pulseBlue 2s infinite;
    }

    #prestigeModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 13000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    @keyframes pulseBlue {
      0% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(52, 152, 219, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
      }
    }

    /* --- SKINS & INVENTORY STYLES (NEW) --- */
    
    #skinModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 14000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .skin-window {
      background: #18181b;
      width: 95%;
      max-width: 700px;
      border: 1px solid #444;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 90vh;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
    }

    .skin-header {
      background: linear-gradient(to right, #2c3e50, #000);
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .case-area {
      padding: 20px;
      background: #111;
      border-bottom: 2px solid #222;
      text-align: center;
    }

    .case-spinner {
      height: 120px;
      background: #000;
      border: 4px solid #333;
      margin: 20px auto;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 20px #000;
      width: 100%;
    }

    .case-strip {
      display: flex;
      height: 100%;
      align-items: center;
      position: absolute;
      left: 50%;
    }

    .case-item {
      width: 90px;
      height: 90px;
      margin-right: 4px;
      border-radius: 6px;
      background: #222;
      border-bottom: 3px solid rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      position: relative;
    }

    .case-item img {
      width: 70px;
      height: 70px;
      object-fit: contain;
      filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.5));
    }

    /* Rarity Borders */
    .rarity-common {
      border: 2px solid var(--rarity-common);
      box-shadow: 0 0 5px var(--rarity-common);
    }

    .rarity-rare {
      border: 2px solid var(--rarity-rare);
      box-shadow: 0 0 10px var(--rarity-rare);
    }

    .rarity-epic {
      border: 2px solid var(--rarity-epic);
      box-shadow: 0 0 15px var(--rarity-epic);
    }

    .rarity-legendary {
      border: 2px solid var(--rarity-legendary);
      box-shadow: 0 0 20px var(--rarity-legendary);
    }

    .rarity-blackmarket {
  border: 2px solid var(--rarity-blackmarket);
  box-shadow: 0 0 25px var(--rarity-blackmarket);
  animation: pulseRed 2s infinite; /* Optional: Roter Pulse Effekt */
}

@keyframes pulseRed {
  0% { box-shadow: 0 0 10px var(--rarity-blackmarket); }
  50% { box-shadow: 0 0 30px var(--rarity-blackmarket); }
  100% { box-shadow: 0 0 10px var(--rarity-blackmarket); }
}

    .open-case-btn {
      background: linear-gradient(45deg, #f1c40f, #d35400);
      border: none;
      padding: 12px 30px;
      font-weight: 900;
      color: #fff;
      border-radius: 4px;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 0 #b33900;
      transition: transform 0.1s;
    }

    .open-case-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #b33900;
    }

    .open-case-btn:disabled {
      filter: grayscale(1);
      cursor: not-allowed;
    }

    .inventory-grid {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      overflow-y: auto;
      background: #18181b;
    }

    .inv-slot {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.2s;
    }

    .inv-slot:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #666;
    }

    .inv-slot.equipped {
      border: 2px solid var(--green);
      background: rgba(46, 204, 113, 0.1);
    }

    .inv-slot img {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .count-badge {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 0.7rem;
      color: #aaa;
    }

    /* LEADERBOARD MODAL */
    #leaderboardModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .lb-window {
      background: #18181b;
      width: 95%;
      max-width: 500px;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      max-height: 80vh;
      position: relative; 
    }

    .lb-header {
      background: linear-gradient(to bottom, #2d3436, #1e272e);
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px 16px 0 0;
    }

    .lb-title {
      font-family: 'Merriweather', serif;
      font-size: 1.5rem;
      color: var(--gold);
      font-weight: 900;
      letter-spacing: 1px;
    }

    .lb-list {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    .lb-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-family: 'Roboto', sans-serif;
    }

    .lb-entry:last-child {
      border-bottom: none;
    }

    .lb-rank {
      width: 30px;
      font-weight: bold;
      color: #666;
    }

    .lb-rank.top-1 {
      color: var(--gold);
      font-size: 1.2rem;
    }

    .lb-rank.top-2 {
      color: #bdc3c7;
      font-size: 1.1rem;
    }

    .lb-rank.top-3 {
      color: #cd7f32;
      font-size: 1.1rem;
    }

    .lb-name {
      flex: 1;
      font-weight: bold;
      color: #fff;
    }

    .lb-score {
      color: var(--green);
      font-weight: bold;
    }

    .lb-footer {
      padding: 15px;
      border-top: 1px solid #333;
      text-align: center;
      color: #666;
      font-size: 0.8rem;
    }

    #leaderboardBtn {
      margin-top: 15px;
      background: linear-gradient(45deg, #8e44ad, #9b59b6);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(142, 68, 173, 0.4);
      transition: all 0.2s;
      letter-spacing: 1px;
      z-index: 25;
    }

    #leaderboardBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(142, 68, 173, 0.8);
    }

    /* ROULETTE STYLES */
    .roulette-container {
      width: 100%;
      height: 100px;
      background: #000;
      border-radius: 8px;
      border: 4px solid #333;
      position: relative;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: inset 0 0 30px #000;
    }

    .roulette-marker {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--gold);
      transform: translateX(-50%);
      z-index: 10;
      box-shadow: 0 0 10px var(--gold);
    }

    .roulette-strip {
      display: flex;
      height: 100%;
      align-items: center;
      position: absolute;
      left: 50%;
    }

    .r-card {
      width: 70px;
      height: 70px;
      margin-right: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.4);
      font-size: 1.2rem;
      flex-shrink: 0;
      border-bottom: 4px solid rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .rc-red {
      background: linear-gradient(to bottom, #e74c3c, #c0392b);
    }

    .rc-black {
      background: linear-gradient(to bottom, #34495e, #2c3e50);
    }

    .rc-green {
      background: linear-gradient(to bottom, #f1c40f, #f39c12);
      color: #000;
      box-shadow: 0 0 15px var(--gold);
      z-index: 2;
    }

    .rc-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    /* --- CASE INFO STYLES --- */
    .case-info-box {
      margin-top: 15px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      width: 90%;           /* Geändert von 80% auf 90% */
      max-width: 100%;      /* Geändert von 300px auf 100% für mehr Platz */
      margin-left: auto;
      margin-right: auto;
    }

    .ci-title {
      color: #aaa;
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .ci-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ci-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      padding: 3px 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }

    .rarity-text-common {
      color: var(--rarity-common);
    }

    .rarity-text-rare {
      color: var(--rarity-rare);
    }

    .rarity-text-epic {
      color: var(--rarity-epic);
    }

    .rarity-text-legendary {
      color: var(--rarity-legendary);
    }

    .rarity-text-blackmarket {
  color: var(--rarity-blackmarket);
}

    /* --- UPGRADER STYLES --- */
    .upgrader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: #111;
      border-radius: 12px;
      border: 1px solid #333;
    }

    .upgrade-circle-wrap {
      position: relative;
      width: 220px;
      height: 220px;
      margin-bottom: 20px;
    }

    .upgrade-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      /* Der Trick für das Diagramm: */
      background: conic-gradient(var(--green) 0deg, var(--green) var(--deg), #222 var(--deg), #222 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      transition: transform 3s cubic-bezier(0.1, 0.9, 0.2, 1);
      position: relative;
    }

    /* --- ÄNDERUNG: Absolute Positionierung für den Innenteil --- */
    .upgrade-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 85%;
      height: 85%;
      background: #18181b;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .upgrade-pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 1.5rem;
      z-index: 10;
      text-shadow: 0 2px 4px #000;
    }

    .chance-label {
      color: #888;
      text-transform: uppercase;
      font-size: 0.8rem;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .upgrader-controls {
      width: 100%;
      max-width: 300px;
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }

    .uc-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      text-align: left;
    }

    .uc-group label {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* --- CSGO CASE ITEMS DESIGN (NEU) --- */
    .mc-item {
      width: 100px; /* Breite einer Kachel */
      height: 100px;
      margin-right: 6px; /* Abstand zwischen Kacheln */
      background: linear-gradient(to bottom, #1a1a1d, #141416);
      border: 1px solid #333;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      flex-shrink: 0; /* Wichtig: Verhindert Schrumpfen */
      box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    /* Der dicke Multiplikator Text */
    .mc-multi {
      font-size: 2rem;
      font-weight: 900;
      color: #fff;
      z-index: 2;
      text-shadow: 0 4px 10px rgba(0,0,0,0.8);
    }

    /* Der Name darunter (z.B. JACKPOT) */
    .mc-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      font-weight: bold;
      margin-top: 5px;
      color: rgba(255,255,255,0.6);
      z-index: 2;
      letter-spacing: 1px;
    }

    /* Farbiger Balken unten */
    .mc-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: var(--glow-color); /* Wird per JS gesetzt */
      box-shadow: 0 -2px 15px var(--glow-color);
    }

    /* Seltenheits-Farben definieren wir hier vor */
    .rarity-trash { --glow-color: #555; }       /* Grau */
    .rarity-loss  { --glow-color: #3498db; }    /* Blau */
    .rarity-win   { --glow-color: #9b59b6; }    /* Lila */
    .rarity-big   { --glow-color: #e91e63; }    /* Pink */
    .rarity-jack  { --glow-color: #f1c40f; border: 1px solid #f1c40f; } /* Gold */

    /* CRASH GAME STYLES */
    .crash-container {
      position: relative;
      width: 100%;
      height: 350px;
      background: #0f0f12;
      border: 2px solid #333;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
    }

    #crashCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .crash-info {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
      z-index: 10;
    }

    #crash-current-multi {
      font-size: 5rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 4px 10px rgba(0,0,0,0.8);
      font-family: 'Roboto', sans-serif;
    }

    #crash-status-text {
      font-size: 1.2rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 10px;
    }

    .crash-history-bar {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: flex-end;
      pointer-events: none;
    }

    .crash-hist-badge {
      background: rgba(0,0,0,0.6);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      border: 1px solid #333;
    }
    .crash-hist-win { color: #2ecc71; border-color: #2ecc71; }
    .crash-hist-loss { color: #e74c3c; border-color: #e74c3c; }

    /* Animation für den Crash */
    .crashed-anim {
      animation: shakeCrash 0.5s cubic-bezier(.36,.07,.19,.97) both;
      color: #e74c3c !important;
    }

    @keyframes shakeCrash {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    
    /* --- MINES STYLES --- */
    .mines-tile {
      background: #2d3436;
      border-radius: 8px;
      aspect-ratio: 1/1; /* Quadratisch */
      cursor: pointer;
      border-bottom: 4px solid #1e272e;
      transition: transform 0.1s, background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .mines-tile:active {
      transform: translateY(2px);
      border-bottom-width: 2px;
    }

    .mines-tile.revealed-gem {
      background: #0f0f12; /* Dunkel */
      border: 2px solid var(--green);
      box-shadow: inset 0 0 15px rgba(46, 204, 113, 0.2);
      cursor: default;
    }

    .mines-tile.revealed-mine {
      background: #0f0f12;
      border: 2px solid var(--red);
      box-shadow: inset 0 0 15px rgba(231, 76, 60, 0.4);
      animation: shakeCrash 0.4s;
    }

    .mines-tile.disabled {
      pointer-events: none;
      opacity: 0.7;
    }

    .mines-tile img {
      width: 60%;
      height: 60%;
      object-fit: contain;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
    }

    /* BLACKJACK STYLES */
    .bj-table {
  /* Neuer, tieferer Grünton für den Filz */
  background: radial-gradient(circle at 50% 50%, #1e8449 0%, #115c2d 100%); 
  /* Edlerer, dunklerer Holzrand mit leichtem Glanz */
  border: 10px solid #5a3c2c; 
  border-radius: 20px; /* Weniger runde Ecken, moderner */
  padding: 30px; /* Mehr Innenabstand */
  margin-bottom: 30px;
  min-height: 350px; /* Etwas höher */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  /* Stärkerer Innenschatten für mehr Tiefe */
  box-shadow: inset 0 0 80px rgba(0,0,0,0.7), 0 15px 30px rgba(0,0,0,0.4); 
  position: relative;
  transition: all 0.3s ease; /* Sanfte Übergänge für Animationen */
}

    .bj-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
    }

    .bj-hand {
      display: flex;
      justify-content: center;
      height: 90px;
      perspective: 1000px;
    }

    /* CSS CARDS */
    .bj-card {
  width: 70px; /* Etwas breiter */
  height: 100px; /* Etwas höher */
  background: #fff;
  border-radius: 8px; /* Etwas runder */
  margin: 0 3px; /* Engere Anordnung */
  position: relative;
  /* Stärkerer Schatten, leicht nach unten versetzt */
  box-shadow: 0 5px 15px rgba(0,0,0,0.4), 0 0 5px rgba(0,0,0,0.2); 
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 5px;
  font-family: 'Roboto', sans-serif; /* Modernere Schriftart */
  font-weight: 700; /* Dicker */
  font-size: 1.2rem; /* Etwas größer */
  transition: transform 0.3s ease, margin 0.3s ease, box-shadow 0.2s ease;
  animation: dealCard 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) backwards; /* Fluffigere Animation */
}

/* Anpassung der Rot/Schwarz-Farben */
.bj-card.red { color: #e74c3c; } /* Standard Rot */
.bj-card.black { color: #2c3e50; } /* Standard Schwarz (dunkelblau) */

/* Spezifische Farben für die Symbole, falls die Kartensymbole nicht direkt gerendert werden */
.bj-card .bj-card-top, .bj-card .bj-card-bot {
    font-size: 0.9em; /* Kleiner als die Hauptzahl */
}
.bj-card .bj-card-mid {
    font-size: 2.2rem; /* Größer für das Hauptsymbol */
    line-height: 1; /* Anpassung der Zeilenhöhe */
}

/* Effekt für die verdeckte Karte */
.bj-card-hidden {
  background: linear-gradient(135deg, #34495e, #2c3e50); /* Dunkleres Blau/Grau */
  border: 2px solid #fff;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5); /* Innenschatten */
}

    @keyframes dealCard {
      from { transform: translateY(-100px) rotate(20deg); opacity: 0; }
      to { transform: translateY(0) rotate(0); opacity: 1; }
    }

    .bj-card.red { color: #e74c3c; }
    .bj-card.black { color: #2c3e50; }

    .bj-card-top { align-self: flex-start; line-height: 1; }
    .bj-card-mid { align-self: center; font-size: 1.8rem; }
    .bj-card-bot { align-self: flex-end; transform: rotate(180deg); line-height: 1; }

    .bj-card-hidden {
      background: repeating-linear-gradient(
        45deg,
        #c0392b,
        #c0392b 10px,
        #e74c3c 10px,
        #e74c3c 20px
      );
      border: 2px solid #fff;
    }

    .bj-row {
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 2;
  position: relative; /* Für Überlappung der Karten */
}

.bj-hand {
  display: flex;
  justify-content: center;
  height: 100px; /* Angepasst an neue Kartenhöhe */
  perspective: 1000px;
  /* Leichte Überlappung der Karten */
  margin: 0 -15px; 
}

.bj-hand .bj-card:not(:first-child) {
    margin-left: -20px; /* Lässt Karten leicht überlappen */
}

.bj-score-bubble {
  background: rgba(0,0,0,0.8); /* Dunklerer Hintergrund */
  color: var(--gold); /* Goldene Schrift für Highscore-Gefühl */
  padding: 5px 15px; /* Mehr Polsterung */
  border-radius: 20px; /* Stärker abgerundet */
  font-size: 1.1rem; /* Größere Schrift */
  font-weight: bold;
  margin-bottom: 10px; /* Mehr Abstand */
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  min-width: 60px; /* Mindestbreite */
  text-align: center;
}

/* Text "DEALER" und "DU" */
.bj-row > div:last-child {
  font-size: 0.9rem;
  color: #a0a0a0; /* Helleres Grau */
  font-weight: 500;
  letter-spacing: 0.5px;
  margin-top: 10px;
}
.bj-row > div:first-child { /* Für Spieler-Label */
    margin-bottom: 10px;
}

    .bj-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8); /* Startet etwas kleiner */
  
  /* Design */
  background: rgba(0, 0, 0, 0.9);
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 20px 40px;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
  
  color: #fff;
  font-weight: 900;
  font-size: 2.2rem;
  text-transform: uppercase;
  text-align: center;
  white-space: nowrap;
  z-index: 100;
  pointer-events: none;

  /* Unsichtbar als Standard */
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Diese Klasse macht den Text sichtbar */
.bj-message.show {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1); /* Ploppt auf Normalgröße */
}

.bj-controls {
    margin-top: 20px; /* Mehr Abstand zum Tisch */
    padding: 15px;
    background: #1e1e22; /* Dunklerer Hintergrund für Controls */
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border: 1px solid #333;
}

.bj-controls .bet-btn, .bj-controls .control-btn {
    padding: 18px 10px; /* Mehr Polsterung */
    border-radius: 8px; /* Weniger rund */
    font-size: 1.1rem;
    font-weight: 700;
    transition: all 0.2s ease;
    box-shadow: 0 4px 0 rgba(0,0,0,0.2); /* 3D-Effekt */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.bj-controls .bet-btn:active, .bj-controls .control-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 rgba(0,0,0,0.2);
}

/* Farbliche Anpassungen für die Aktionen-Buttons */
#bj-actions .control-btn[onclick*="hit"] {
    background: linear-gradient(45deg, #3498db, #2980b9); /* Blau */
}
#bj-actions .control-btn[onclick*="stand"] {
    background: linear-gradient(45deg, #e74c3c, #c0392b); /* Rot */
}
#bj-actions .control-btn[onclick*="double"] {
    background: linear-gradient(45deg, #f1c40f, #f39c12); /* Gold */
    color: #000; /* Schwarzer Text auf Gold */
    text-shadow: none;
}

    @media (max-width: 850px) {
      body {
        flex-direction: column;
        overflow-y: auto;
        height: auto;
      }

      .left-panel {
        min-height: 50vh;
        border-right: none;
        border-bottom: 2px solid #333;
      }

      .right-panel {
        width: 100%;
        min-height: 50vh;
      }

      #global-tooltip {
        display: none !important;
      }
    }

    /* --- CRAZY WHEEL PRO STYLES --- */

/* --- CRAZY WHEEL "REALISTIC" STYLES --- */

/* Container & Top Slot (Bleiben vom Pro-Style) */
.crazy-container {
  background: radial-gradient(circle at center, #36164d 0%, #1a0b2e 80%, #000 100%);
  padding: 30px 10px;
  border-radius: 20px;
  border: 4px solid #f1c40f;
  box-shadow: inset 0 0 100px rgba(0,0,0,0.8), 0 0 30px rgba(142, 68, 173, 0.3);
  text-align: center;
  position: relative;
  overflow: hidden;
  margin-bottom: 20px;
}

.crazy-top-slot {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin: 0 auto 25px auto;
  background: #000;
  padding: 15px 30px;
  border: 4px solid #444;
  border-bottom: 4px solid #222;
  border-radius: 12px;
  width: fit-content;
  box-shadow: 0 10px 20px rgba(0,0,0,0.6);
  position: relative;
}

.crazy-top-slot::after {
  content: '';
  position: absolute;
  top: -6px; left: -6px; right: -6px; bottom: -6px;
  border: 2px solid #f1c40f;
  border-radius: 14px;
  z-index: 0;
  pointer-events: none;
  box-shadow: 0 0 15px rgba(241, 196, 15, 0.2);
}

.ct-slot-box {
  width: 70px;
  height: 70px;
  background: linear-gradient(145deg, #222, #111);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  border-radius: 8px;
  color: #fff;
  border: 1px solid #333;
  box-shadow: inset 0 0 15px #000;
  z-index: 1;
  font-weight: 900;
}

.ct-slot-x { color: #666; font-weight: 900; font-size: 1.5rem; z-index: 1; text-shadow: 0 2px 0 #000; }

/* --- HIER BEGINNT DAS NEUE RAD (KORRIGIERT) --- */
.wheel-wrapper {
  position: relative;
  width: 360px;
  height: 360px;
  margin: 0 auto;
  border-radius: 50%;
  padding: 10px;
  background: #222;
  box-shadow: 
    0 0 0 2px #555, 
    inset 0 0 15px #000, 
    0 20px 50px rgba(0,0,0,0.8);
  /* Metall-Look Hintergrund */
  background: conic-gradient(#444 0deg, #999 45deg, #444 90deg, #999 135deg, #444 180deg, #999 225deg, #444 270deg, #999 315deg, #444 360deg);
}

.crazy-wheel {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  overflow: hidden;
  border: 4px solid #b8860b; /* Goldener Innenrand */
  box-sizing: border-box;
  transition: transform 5s cubic-bezier(0.15, 0.85, 0.15, 1);
  transform: translateZ(0); /* Performance Boost */
}

/* Speichen (Linien) - EXAKT ZENTRIERT */
.wheel-separator {
  position: absolute;
  top: 0; 
  left: 50%;
  width: 2px; /* Liniendicke */
  height: 50%; 
  background: rgba(0,0,0,0.5); /* Etwas dunkler für besseren Kontrast */
  transform-origin: bottom center; 
  z-index: 5;
  margin-left: -1px; /* WICHTIG: Hälfte der Breite nach links, damit es mittig sitzt */
}

/* Zahlen / Text-Container - EXAKT ZENTRIERT */
.wheel-text {
  position: absolute;
  top: 0; 
  left: 50%;
  width: 40px; 
  height: 50%; 
  margin-left: -20px; /* WICHTIG: Hälfte der Breite nach links */
  transform-origin: bottom center; 
  
  display: flex;
  justify-content: flex-start;
  align-items: center;
  flex-direction: column;
  
  padding-top: 15px; /* Text etwas weiter reinziehen */
  
  font-family: 'Roboto', sans-serif;
  font-weight: 900;
  font-size: 0.85rem;
  text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  z-index: 6;
  pointer-events: none;
}

/* Spezielle Styles für die Bonus-Texte */
.wt-coin { font-size: 0.55rem; line-height:1; }
.wt-pachinko { font-size: 0.5rem; line-height:1; }
.wt-cash { font-size: 0.55rem; line-height:1; }
.wt-crazy { font-size: 0.5rem; line-height:1; text-shadow: 0 0 4px #c0392b; }

/* Pointer (Der Pfeil oben) */
.wheel-pointer {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 3rem;
  color: #e74c3c;
  z-index: 30;
  filter: drop-shadow(0 4px 5px rgba(0,0,0,0.5));
  -webkit-text-stroke: 1px #ffd700;
}

/* Die Nabe in der Mitte (Verdeckt die Spitzen) */
.crazy-wheel::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 60px; height: 60px;
  background: radial-gradient(circle, #f1c40f 20%, #b8860b 100%);
  border: 4px solid #fff;
  border-radius: 50%;
  box-shadow: 0 0 15px rgba(0,0,0,0.8);
  z-index: 20;
}

/* Das Logo/Emoji in der Mitte */
.wheel-center-logo {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 21;
  font-size: 1.8rem;
  pointer-events: none;
}

/* BETTING GRID - Viel sauberer */
.ct-betting-grid {
  margin-top: 25px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 0 10px;
}

.ct-bet-group {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.ct-bet-btn {
  flex: 1;
  padding: 12px 5px;
  border: none;
  border-radius: 10px; /* Modernere Ecken */
  font-weight: 900;
  font-family: 'Roboto', sans-serif;
  cursor: pointer;
  color: #fff;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: all 0.1s;
  /* 3D Effekt unten */
  box-shadow: 0 6px 0 rgba(0,0,0,0.3); 
  text-transform: uppercase;
  border: 1px solid rgba(255,255,255,0.1);
  min-height: 75px;
}

.ct-bet-btn:active {
  transform: translateY(4px);
  box-shadow: 0 2px 0 rgba(0,0,0,0.3);
}

.ct-bet-btn:hover {
  filter: brightness(1.15);
}

/* Wetteinsatz Badge im Button */
.ct-bet-val { 
  font-size: 0.7rem; 
  background: rgba(0,0,0,0.6); 
  padding: 3px 8px; 
  border-radius: 12px; 
  margin-top: 6px; 
  color: #eee;
  min-width: 40px;
  border: 1px solid rgba(255,255,255,0.1);
}

/* Button Farben - Edler */
.btn-1 { background: linear-gradient(to bottom, #3498db, #2980b9); border-bottom: 4px solid #1c6ea4; }
.btn-2 { background: linear-gradient(to bottom, #f1c40f, #f39c12); border-bottom: 4px solid #d68910; color: #000; text-shadow: none; }
.btn-5 { background: linear-gradient(to bottom, #e91e63, #c2185b); border-bottom: 4px solid #880e4f; }
.btn-10 { background: linear-gradient(to bottom, #9b59b6, #8e44ad); border-bottom: 4px solid #6c3483; }

/* Bonus Buttons */
.btn-coin { 
  background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); 
  border-bottom: 4px solid #1f2d3a; 
  font-size: 0.8rem;
}
.btn-pachinko { 
  background: linear-gradient(135deg, #da22ff 0%, #9733ee 100%); 
  border-bottom: 4px solid #6a1b9a;
  font-size: 0.8rem;
}
.btn-cash { 
  background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); 
  border-bottom: 4px solid #2e7d32;
  font-size: 0.8rem;
  color: #000;
}
.btn-crazy { 
  background: repeating-linear-gradient(
    45deg,
    #ff0000,
    #ff0000 10px,
    #cc0000 10px,
    #cc0000 20px
  );
  border: 2px solid #fff;
  border-bottom: 4px solid #800000;
  font-size: 0.9rem;
  text-shadow: 0 2px 4px #000;
}

/* SPIN ACTION BAR */
#btn-crazy-spin {
  background: linear-gradient(45deg, #2ecc71, #27ae60);
  border: none;
  box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
  font-size: 1.2rem;
  padding: 20px;
  border-radius: 12px;
  margin-right: 10px;
}
#btn-crazy-spin:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 30px rgba(46, 204, 113, 0.6);
}

/* Active Slot Animation Highlight */
.active-slot-boost { 
  animation: slotPulse 1s infinite alternate;
  border-color: #fff !important;
  box-shadow: 0 0 20px #fff;
}

@keyframes slotPulse {
  from { transform: scale(1); filter: brightness(1); }
  to { transform: scale(1.05); filter: brightness(1.3); }
}

/* OVERLAY */
.ct-bonus-overlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  backdrop-filter: blur(5px);
}
.ct-bonus-content { 
  text-align: center; 
  animation: popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
#ct-bonus-title { 
  font-size: 2.5rem; 
  color: #f1c40f; 
  font-weight: 900;
  text-transform: uppercase; 
  margin-bottom: 20px; 
  text-shadow: 0 0 20px #f1c40f;
}
    
 /* --- FIX FÜR MACBOOK / LAPTOP DISPLAYS (NEU & VERBESSERT) --- */
    @media screen and (max-width: 1600px) {
      /* 1. Linkes Panel: Abstände verringern */
      .bakery-name {
        font-size: 1.5rem; /* Titel kleiner */
        top: 15px;         /* Ganz nach oben */
      }

      #top-player-display {
        top: 55px;         /* Direkt unter den Titel */
        font-size: 0.9rem;
      }

      .score-container {
        margin-top: 90px;  /* Weniger Abstand nach oben */
        margin-bottom: 15px;
      }

      #score {
        font-size: 2.2rem; /* Zahl kleiner */
      }

      .currency-label {
        font-size: 1.1rem;
        margin-top: 0;
      }

      #cps {
        font-size: 0.9rem;
        padding: 4px 15px;
        min-width: 200px;
        margin-top: 5px;
      }

      /* 2. Hauptbild deutlich kleiner machen */
      #bigKlein {
        width: 180px;
        height: 180px;
        margin: 10px 0; /* Weniger Platz drumherum */
      }
      
      /* 3. Buttons kompakter machen */
      #casinoBtn, #skinsBtn, #leaderboardBtn, #lotteryBtn, #prestigeBtn {
        padding: 6px 15px;
        font-size: 0.85rem;
        margin-top: 6px;
      }

      /* 4. Rechtes Panel (Shop) schmaler & kleiner machen */
      .right-panel {
        width: 340px; /* Schmaler */
      }

      .store-header {
        padding: 10px;
        font-size: 0.8rem;
      }

      /* Upgrade Kisten kleiner */
      .upgrades-container {
        max-height: 120px;
        min-height: 60px;
        padding: 8px;
      }
      
      .upgrade-crate {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
      }

      /* Gebäude-Liste niedriger machen */
      .building-row {
        height: 60px; /* Deutlich flacher */
        padding: 0 10px;
      }

      .b-icon {
        font-size: 1.6rem;
        width: 40px;
        margin-right: 10px;
      }

      .b-name { font-size: 0.85rem; }
      .b-cps { font-size: 0.65rem; }
      .b-cost { font-size: 0.75rem; }
      .b-count { font-size: 1.3rem; }
      
      /* Click Booster kleiner */
      .click-booster { padding: 8px; }
      .cb-card { padding: 8px; }
      .cb-title { font-size: 0.85rem; }
      .cb-btn { padding: 4px 10px; min-width: 80px; }
    }
    
  #top-player-display {
  position: absolute;
  top: 85px; /* Etwas unter dem Titel */
  width: 100%;
  text-align: center;
  font-family: 'Roboto', sans-serif;
  font-size: 1.1rem;
  color: var(--gold);
  font-weight: 900;
  text-shadow: 0 2px 5px rgba(0,0,0,0.8);
  z-index: 20;
  pointer-events: none; /* Klicks gehen durch */
  letter-spacing: 1px;
  animation: pulseGold 3s infinite ease-in-out;
}

@keyframes pulseGold {
  0% { opacity: 0.7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); text-shadow: 0 0 15px var(--gold); }
  100% { opacity: 0.7; transform: scale(1); }
}

    /* --- CASE CONTENT PREVIEW --- */
.case-contents-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  margin-top: 5px;
}

.cc-icon {
      width: 80px;          /* Geändert von 45px */
      height: 80px;         /* Geändert von 45px */
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: help;
      transition: transform 0.1s;
    }

    .cc-icon:hover {
      transform: scale(1.1);
      z-index: 10;
    }

    .cc-icon img {
      width: 70px;          /* Geändert von 35px */
      height: 70px;         /* Geändert von 35px */
      object-fit: contain;
    }

/* Mini-Tooltip beim Drüberfahren */
.cc-icon:hover::after {
  content: attr(data-name);
  position: absolute;
  bottom: 110%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  border: 1px solid #444;
  pointer-events: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
  /* --- NEU: Style für die Ergebnisanzeige --- */
.ct-result-popup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: rgba(0, 0, 0, 0.95);
  border: 3px solid #f1c40f;
  padding: 20px 40px;
  border-radius: 15px;
  text-align: center;
  z-index: 100;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
  pointer-events: none;
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.ct-result-popup.show {
  transform: translate(-50%, -50%) scale(1);
}

.ct-res-icon { font-size: 3rem; margin-bottom: 5px; display: block; }
.ct-res-text { font-size: 1.5rem; font-weight: 900; color: #fff; text-transform: uppercase; }
.ct-res-win { font-size: 1.2rem; font-weight: bold; color: #2ecc71; margin-top: 5px; }
.ct-res-loss { font-size: 1rem; color: #aaa; margin-top: 5px; }
  
  /* CRAZY TIME HELP STYLES */
#ct-help-overlay {
  position: fixed;
  top: 0; 
  left: 0; 
  width: 100vw; 
  height: 100vh; 
  background: rgba(0,0,0,0.92); 
  
  /* HIER IST DIE ÄNDERUNG: */
  z-index: 200000 !important; /* Extrem hoch und mit Ausrufezeichen erzwungen */
  
  display: flex; 
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
}

/* Damit die Box auf kleinen Screens nicht zu riesig wird */
.ct-help-box {
  background: #18181b;
  width: 95%;
  max-width: 550px; /* Etwas breiter */
  max-height: 85vh; /* Damit man scrollen kann, wenn es zu hoch ist */
  border: 2px solid var(--gold);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 0 80px rgba(0,0,0,1);
  animation: popIn 0.3s ease-out; /* Schöne Einblend-Animation */
}

.ct-help-header {
  padding: 15px;
  background: linear-gradient(to right, #2c3e50, #000);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: 'Merriweather', serif;
  font-weight: 900;
  color: var(--gold);
  border-bottom: 1px solid #333;
}

.ct-help-body {
  padding: 15px;
  overflow-y: auto;
  text-align: left;
}

.ct-help-section {
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
  color: #ccc;
  font-size: 0.9rem;
  line-height: 1.4;
}

.ct-help-section h3 { color: #fff; margin-bottom: 5px; }

.ct-help-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.ct-help-item {
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid transparent;
}

.ct-help-item.bonus { border: 1px solid rgba(255,255,255,0.2); }

.ct-help-icon { font-size: 1.8rem; width: 40px; text-align: center; }
.ct-help-desc { font-size: 0.75rem; color: #aaa; }
.ct-help-desc strong { color: #fff; display: block; font-size: 0.85rem; }
  
  /* --- CRAZY TIME HELP OVERLAY STYLES (Hatte gefehlt) --- */
#ct-help-overlay {
  position: fixed; /* WICHTIG: Fixed, damit es über allem schwebt */
  top: 0; 
  left: 0; 
  width: 100vw; /* Volle Breite */
  height: 100vh; /* Volle Höhe */
  background: rgba(0,0,0,0.92); /* Dunkler Hintergrund */
  z-index: 99999; /* Muss der höchste Wert sein */
  display: flex; /* Zentriert die Box */
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
}

.ct-help-box {
  background: #18181b;
  width: 95%;
  max-width: 550px; 
  max-height: 85vh; /* Damit man scrollen kann, falls der Bildschirm klein ist */
  border: 2px solid var(--gold);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 0 80px rgba(0,0,0,1);
  animation: popIn 0.3s ease-out;
}

@keyframes popIn {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
  
  /* --- NEUER SPIN BUTTON STYLE --- */
#btn-crazy-spin {
  /* Größe & Layout */
  width: 100%;
  padding: 15px 0; /* Oben/Unten Polster */
  margin-right: 10px;
  display: flex;
  flex-direction: column; /* Text untereinander */
  align-items: center;
  justify-content: center;
  
  /* Farben & 3D Look */
  background: linear-gradient(to bottom, #2ecc71, #27ae60); /* Verlauf */
  border: none;
  border-radius: 12px;
  border-bottom: 6px solid #1e8449; /* Der 3D-Schatten unten */
  box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
  
  /* Text Styles */
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.1s ease; /* Schnelle Animation */
  cursor: pointer;
  position: relative;
  overflow: visible; /* Wichtig für den 3D Effekt */
}

/* Der Titel "DREHEN" */
.spin-title {
  font-size: 1.4rem;
  font-weight: 900;
  text-shadow: 0 2px 2px rgba(0,0,0,0.3);
  margin-bottom: 2px;
}

/* Die Info "Einsatz: 0" */
.spin-info {
  font-size: 0.85rem;
  font-weight: 500;
  opacity: 0.9;
  background: rgba(0,0,0,0.2); /* Dunklerer Hintergrund für die Zahl */
  padding: 2px 10px;
  border-radius: 20px;
}

/* Hover Effekt (Heller werden) */
#btn-crazy-spin:hover {
  filter: brightness(1.1);
  transform: translateY(-2px); /* Schwebt leicht hoch */
  box-shadow: 0 6px 20px rgba(46, 204, 113, 0.6);
}

/* Klick Effekt (Eindrücken) */
#btn-crazy-spin:active {
  border-bottom-width: 2px; /* Rand wird dünner -> sieht gedrückt aus */
  transform: translateY(4px); /* Bewegt sich nach unten */
  box-shadow: 0 0 5px rgba(46, 204, 113, 0.4);
}

/* Deaktivierter Zustand (wenn es dreht) */
#btn-crazy-spin:disabled {
  background: #555;
  border-bottom-color: #333;
  color: #aaa;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
  
  /* --- CASINO WÄHRUNG SWITCH --- */
.currency-switch-container {
  display: flex; 
  gap: 10px; 
  align-items: center;
  background: rgba(0,0,0,0.3);
  padding: 5px;
  border-radius: 8px;
  border: 1px solid #333;
  margin: 0 15px; /* Abstand */
}

.curr-btn {
  background: transparent;
  border: none;
  color: #666;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 900;
  font-size: 0.9rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* Kleinis Aktiv */
.curr-btn.active#btn-curr-kleinis {
  background: #34495e;
  color: #fff;
  box-shadow: 0 0 10px rgba(255,255,255,0.1);
}

/* Bierchen Aktiv */
.curr-btn.active#btn-curr-beers {
  background: linear-gradient(to bottom, #f1c40f, #d35400);
  color: #fff;
  box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
  text-shadow: 0 1px 2px #000;
}
  
  /* --- BIERCHEN WALLET AUF HAUPTSEITE --- */
.beer-wallet {
  /* --- GRÖSSE & POSITON --- */
  width: fit-content;      /* Nur so breit wie der Inhalt (macht es klein) */
  margin: 10px auto 0 auto;/* Zentriert es und macht Abstand nach oben */
  padding: 6px 15px;       /* Etwas weniger Polsterung als vorher */
  
  /* --- DESIGN (Gold & Glow bleiben erhalten) --- */
  background: rgba(0, 0, 0, 0.6);
  border: 2px solid #f1c40f; 
  border-radius: 50px;     /* Schöne runde "Pillen"-Form */
  box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
  
  /* --- INHALT --- */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  transition: transform 0.2s;
}

.beer-wallet:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(241, 196, 15, 0.4);
}

.beer-wallet-icon {
  width: 22px; /* Etwas kleineres Icon */
  height: 22px;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

#main-beer-display {
  font-family: 'Roboto', sans-serif;
  font-size: 1.1rem; /* Schriftgröße passend, nicht zu riesig */
  font-weight: 900;
  color: #fff;
  font-variant-numeric: tabular-nums; 
}
  
  /* --- NOTFALL-FIX FÜR KLEINE LAPTOPS --- */
    @media screen and (max-width: 1600px) {
      
      /* 1. Titel ganz klein und nach oben */
      .bakery-name {
        font-size: 1.2rem !important;
        top: 5px !important;
      }

      /* 2. Top-Player Anzeige direkt darunter */
      #top-player-display {
        top: 35px !important;
        font-size: 0.8rem !important;
      }

      /* 3. Score-Bereich nach oben ziehen und verkleinern */
      .score-container {
        margin-top: 60px !important; /* Zieht alles hoch unter den Titel */
        margin-bottom: 5px !important;
      }

      #score {
        font-size: 2rem !important; /* Zahl deutlich kleiner */
      }

      .currency-label {
        font-size: 0.9rem !important;
        margin-top: 0 !important;
      }

      /* CPS Anzeige kompakt */
      #cps {
        margin-top: 2px !important;
        font-size: 0.8rem !important;
        padding: 2px 10px !important;
        min-width: auto !important; /* Breite automatisch anpassen */
      }

      /* Bierchen Wallet kleiner */
      .beer-wallet {
        margin-top: 5px !important;
        padding: 2px 10px !important;
      }
      .beer-wallet-icon { width: 16px !important; height: 16px !important; }
      #main-beer-display { font-size: 0.9rem !important; }

      /* 4. ALLE Buttons kleiner machen */
      #casinoBtn, #skinsBtn, #leaderboardBtn, #lotteryBtn, #prestigeBtn, .nav-btn {
        padding: 5px 12px !important;
        font-size: 0.8rem !important;
        margin-top: 4px !important;
        min-height: 0 !important; /* Verhindert Mindesthöhe */
      }
      
      /* 5. Das Gesicht (Hauptbild) massiv verkleinern */
      #bigKlein {
        width: 130px !important;  /* Viel kleiner */
        height: 130px !important;
        margin-top: 10px !important;
      }

      /* 6. Rechte Seite (Shop) kompakter machen */
      .store-header {
        padding: 5px !important;
        font-size: 0.75rem !important;
        min-height: 0 !important;
      }
      
      .click-booster { padding: 5px !important; }
      .cb-card { padding: 5px !important; }
      
      /* Upgrade Boxen kleiner */
      .upgrades-container {
        min-height: 50px !important;
        max-height: 100px !important;
        padding: 5px !important;
      }
      .upgrade-crate {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.2rem !important;
      }

      /* Gebäude Liste */
      .building-row {
        height: 50px !important; /* Sehr flach */
        padding: 0 5px !important;
      }
      .b-icon { font-size: 1.4rem !important; width: 30px !important; margin-right: 5px !important; }
      .b-name { font-size: 0.8rem !important; margin-bottom: 0 !important; }
      .b-cps { font-size: 0.6rem !important; }
      .b-cost { font-size: 0.7rem !important; }
      .b-count { font-size: 1.1rem !important; }
    }
  
  </style>

</head>

<body>

  <div id="global-tooltip">
    <div class="tt-header">
      <div class="tt-title">
        <span id="tt-name-display">Name</span>
        <span id="tt-price-display" class="tt-price">100 Kleinis</span>
      </div>
    </div>
    <div class="tt-body">
      <span id="tt-effect-display" class="tt-effect">Verdoppelt Produktion</span>
      <div id="tt-desc-display">Beschreibung...</div>
      <div id="tt-stats-container" class="tt-stats"></div>
    </div>
  </div>

  <!-- SKIN / INVENTORY MODAL (KORRIGIERT) -->
  <div id="skinModal">
    <div class="skin-window">
      <div class="skin-header">
        <div style="font-weight:900; color:var(--text-main);">🎒 INVENTAR & KISTEN</div>
        <button class="close-btn" onclick="closeSkins()" style="position:static;">×</button>
      </div>

      <!-- CASE OPENING SECTION -->
      <div class="case-area">
        <div style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">
          Du hast <span id="case-count" style="color:var(--gold); font-weight:bold; font-size:1.2rem;">0</span> Kisten
        </div>

        <div class="case-spinner">
          <div class="roulette-marker"></div>
          <div class="case-strip" id="caseStrip"></div>
        </div>

        <button class="open-case-btn" id="btnOpenCase" onclick="openCase()">KISTE ÖFFNEN</button>

        <!-- CASE INFO BOX -->
        <div class="case-info-box">
          <div class="ci-title">ℹ️ Drop-Chancen</div>
          <div id="case-odds-list" class="ci-list">
            <!-- Wird per JS gefüllt -->
          </div>

          <!-- INHALT ANZEIGE -->
          <div class="ci-title" style="margin-top:15px; border-top:1px solid #444; padding-top:8px;">📦 Kisten-Inhalt</div>
          <div id="case-contents-grid" class="case-contents-grid"></div>
        </div>

        <div style="margin-top:10px; font-size:0.75rem; color:#555;">
          Erhalte 1 Kiste pro Prestige-Level!
        </div>
      </div>

      <!-- INVENTORY GRID (Muss INNERHALB von skin-window sein!) -->
      <div class="inventory-grid" id="inventoryGrid">
        <!-- Skins filled by JS -->
      </div>
    </div>
  </div>

  <!-- PRESTIGE MODAL (NEU) -->
  <div id="prestigeModal">
    <div class="lb-window" style="border-color: #3498db; box-shadow: 0 0 80px rgba(52, 152, 219, 0.4);">
      <button class="close-btn" onclick="closePrestige()">×</button>
      <div class="lb-header" style="background: linear-gradient(to bottom, #2980b9, #2c3e50);">
        <div class="lb-title" style="color:#fff;">🚀 ZEITREISE</div>
      </div>
      <div class="lb-list" style="text-align:center; padding:30px;">
        <div style="color:#e74c3c; font-weight:bold; font-size:1.2rem; margin-bottom:20px;">
          WARNUNG: HARD RESET
        </div>
        <div style="color:#ccc; margin-bottom:20px;">
          Du setzt alle Gebäude, Upgrades und dein aktuelles Geld zurück.<br>
          Du behältst deine Statistiken, Skins, Erfolge und Leaderboard-Platzierung.
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
          <div>Aktueller Prestige-Level: <span id="modal-current-prestige"
              style="color:#3498db; font-weight:bold;">0</span></div>
          <div style="font-size:1.5rem; margin:10px 0;">⬇️</div>
          <div>Mögliches Neues Level: <span id="modal-new-prestige"
              style="color:#2ecc71; font-weight:bold; font-size:1.3rem;">0</span></div>
          <div style="color:#2ecc71; font-size:0.9rem; margin-top:5px;">
            (+<span id="modal-gain-prestige">0</span> Level dazu)
          </div>
          <div style="color:var(--gold); font-weight:bold; margin-top:10px;">
            🎁 +<span id="modal-gain-cases">0</span> Kisten
          </div>
        </div>

        <button onclick="doPrestige()" id="confirmPrestigeBtn" style="
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: 2px solid rgba(255,255,255,0.2);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: 900;
        font-size: 1.1rem;
        cursor: pointer;
        width: 100%;
        box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        ">
          RESET DURCHFÜHREN
        </button>

      </div>
    </div>
  </div>

  <!-- BIERCHEN INFO MODAL -->
<div id="beerModal" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.92);
    z-index: 15000;
    display: none;
    align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
">
  <div class="lb-window" style="border-color: #f1c40f; box-shadow: 0 0 80px rgba(241, 196, 15, 0.4);">
    <button class="close-btn" onclick="closeBeerModal()">×</button>
    
    <div class="lb-header" style="background: linear-gradient(to right, #d35400, #f1c40f);">
      <div class="lb-title" style="color:#fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5);">🍺 BIERCHEN DEPOT</div>
    </div>

    <div class="lb-list" style="text-align:center; padding:30px; display:flex; flex-direction:column; align-items:center; gap:15px;">
      
      <!-- Großes Bild -->
      <img src="https://github.com/JanKlein25/Clicker/blob/main/Adobe%20Express%20-%20file%20(9).png?raw=true" 
           style="width: 120px; filter: drop-shadow(0 0 20px rgba(241, 196, 15, 0.6)); animation: floatAround 4s infinite ease-in-out;">

      <div style="font-size:1.5rem; font-weight:900; color:#fff;">
        Guthaben: <span id="modal-beer-amount" style="color:#f1c40f;">0</span>
      </div>

      <div style="width:100%; border-top:1px solid #444; margin:10px 0;"></div>

      <!-- Info 1: Prestige -->
      <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; width:100%;">
        <div style="color:#aaa; font-size:0.8rem; text-transform:uppercase;">Prestige Bonus</div>
        <div style="color:#fff; font-weight:bold;">+25 Bierchen <span style="font-weight:normal; color:#888;">pro Level</span></div>
      </div>

      <!-- Info 2: Täglicher Bonus & Timer -->
      <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; width:100%;">
        <div style="color:#aaa; font-size:0.8rem; text-transform:uppercase;">Täglicher Login</div>
        <div style="color:#fff; font-weight:bold; margin-bottom:5px;">+50 Bierchen <span style="font-weight:normal; color:#888;">alle 24h</span></div>
        
        <div style="margin-top:5px; font-size:0.9rem;">
          Nächster Bonus in:<br>
          <span id="beer-timer-display" style="font-size:1.3rem; font-weight:900; color:#f1c40f; font-variant-numeric: tabular-nums;">Lade...</span>
        </div>
      </div>

    </div>
  </div>
</div>
  
  <div id="casinoModal">
    <div class="casino-window" id="casinoWindow">
      <button class="close-btn" onclick="closeCasino()">×</button>
      <!-- NEUER HEADER START -->
<div class="cw-header">
  <div class="cw-title">🎰 CASINO PRO</div>
  
  <!-- DER NEUE SWITCH FÜR BIERCHEN -->
  <div class="currency-switch-container">
    <button id="btn-curr-kleinis" class="curr-btn active" onclick="setCasinoCurrency('kleinis')">
      Kleinis
    </button>
    <button id="btn-curr-beers" class="curr-btn" onclick="setCasinoCurrency('beers')">
      🍺 Bierchen
    </button>
  </div>

  <div class="cw-balance">
    <!-- Platzhalter für das Bier-Icon -->
    <img id="balance-icon" src="" style="width:24px; vertical-align:middle; display:none; margin-right:5px;">
    <span id="casino-balance">0</span> 
  </div>
</div>
<!-- NEUER HEADER ENDE -->
      <div class="cw-body">

        <div class="casino-nav">
          <button class="nav-btn active" id="btn-tab-roulette" onclick="switchCasinoTab('roulette')">Roulette</button>
          <button class="nav-btn" id="btn-tab-slots" onclick="switchCasinoTab('slots')">Slots (5x3)</button>
          <button class="nav-btn" id="btn-tab-upgrader" onclick="switchCasinoTab('upgrader')">Upgrader</button>
          <button class="nav-btn" id="btn-tab-moneycase" onclick="switchCasinoTab('moneycase')">Kleini Case</button>
          <button class="nav-btn" id="btn-tab-crash" onclick="switchCasinoTab('crash')">Crash 🚀</button>
          <button class="nav-btn" id="btn-tab-mines" onclick="switchCasinoTab('mines')">Mines 💣</button>
          <button class="nav-btn" id="btn-tab-crazy" onclick="switchCasinoTab('crazy')">Crazy 🤪</button>
          <!-- NEU: BLACKJACK BUTTON -->
          <button class="nav-btn" id="btn-tab-blackjack" onclick="switchCasinoTab('blackjack')">Blackjack ♠️</button>
        </div>

        <div class="bet-row">
          <input type="number" id="betAmount" class="bet-input" placeholder="Einsatz">
          <button class="control-btn" onclick="setBetMultiplier(0.5)">1/2</button>
          <button class="control-btn" onclick="setBetMultiplier(2)">x2</button>
          <button class="control-btn" style="color:var(--gold)" onclick="setBetMultiplier('max')">ALL</button>
        </div>

        <!-- ROULETTE VIEW -->
        <div id="view-roulette">
          <div class="roulette-container">
            <div class="roulette-marker"></div>
            <div class="roulette-strip" id="rouletteStrip"></div>
          </div>
          <div class="action-row">
            <button class="bet-btn btn-red" onclick="spin('red')">ROT<span class="sub-text">Win x2</span></button>
            <button class="bet-btn btn-green" onclick="spin('green')">GOLD<span class="sub-text">Win x14</span></button>
            <button class="bet-btn btn-black" onclick="spin('black')">SCHWARZ<span class="sub-text">Win
                x2</span></button>
          </div>
          <div class="history-bar">
            <span style="font-size:0.8rem; color:#666; margin-right:5px;">HISTORY:</span>
            <div id="history-container" style="display:flex; gap:5px;"></div>
          </div>
        </div>

        <!-- PRO SLOTS VIEW -->
        <div id="view-slots" style="display:none;">
          <div class="pro-slot-screen">
            <!-- HELP OVERLAY -->
            <div id="slot-help-overlay">
              <div class="help-title"
                style="border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; width:100%;">🎰 Real
                Slots: Paytable</div>

              <div
                style="text-align: left; max-width: 500px; font-size: 0.85rem; line-height: 1.5; color: #ccc; overflow-y: auto; max-height: 60vh; padding-right: 5px;">

                <!-- ZIEL & LINIEN -->
                <div style="margin-bottom: 12px;">
                  <strong style="color:var(--gold); font-size:0.95rem;">Das Haus gewinnt (fast) immer.</strong><br>
                  Sammle mindestens <strong>3 gleiche Symbole</strong> auf einer Linie.<br>
                </div>

                <!-- SYMBOLE -->
                <div style="margin-bottom: 12px; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px;">
                  <strong style="color:var(--gold); font-size:0.95rem;">Die Werte (Basis x3 Treffer)</strong>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px; font-size:0.8rem;">

                    <div
                      style="grid-column: span 2; border-bottom:1px solid #333; padding-bottom:4px; margin-bottom:4px;">
                      👑 <strong>WILD</strong>: <span style="color:#2ecc71">1.5% Chance</span> (Joker)
                    </div>

                    <div>💎 <strong>Diamant</strong><br><span style="color:var(--gold)">x100 (Jackpot)</span></div>
                    <div>7️⃣ <strong>Seven</strong><br><span style="color:#ffcc00;">x40 (Mega Win)</span></div>

                    <div>🎰 <strong>Bar</strong><br><span style="color:#aaa;">x15</span></div>
                    <div>🔔 <strong>Glocke</strong><br><span style="color:#aaa;">x10</span></div>

                    <div>🍀 <strong>Klee</strong><br><span style="color:#aaa;">x6</span></div>
                    <div>🍉/🍇 <strong>Obst</strong><br><span style="color:#888;">x2.5 - x4</span></div>

                    <div style="color:#fff;">🍊 <strong>Orange</strong><br><strong>x1.5</strong> (Gewinn)</div>
                    <div style="color:#ccc;">🍋 <strong>Zitrone</strong><br><strong>x1.0</strong> (Geld zurück)</div>
                    <div style="color:#e74c3c;">🍒 <strong>Kirsche</strong><br><strong>x0.5</strong> (Verlust)</div>
                  </div>
                </div>

                <!-- BERECHNUNG -->
                <div style="margin-bottom: 12px;">
                  <strong style="color:var(--gold); font-size:0.95rem;">Längere Reihen Boni</strong><br>
                  • 3er Reihe: Basis-Wert (siehe oben)<br>
                  • 4er Reihe: Gewinn <span style="color:var(--green)">x2.5</span><br>
                  • 5er Reihe: Gewinn <span style="color:var(--gold)">x10</span>
                </div>

              </div>

              <button class="toggle-btn active"
                style="margin-top:15px; width:100%; font-weight:bold; font-size:1rem; padding:12px;"
                onclick="toggleSlotHelp()">ALLES KLAR, VIEL GLÜCK</button>
            </div>

            <!-- WIN OVERLAY -->
            <div id="winDisplay" class="win-display-box">
              <span class="win-label">BIG WIN</span>
              <span class="win-val" id="winAmountDisplay">0</span>
            </div>

            <svg id="paylineSvg" class="payline-overlay" viewBox="0 0 500 240" preserveAspectRatio="none">
              <!-- Paylines drawn here by JS -->
            </svg>

            <div class="pro-slot-grid" id="slotGrid">
              <!-- Reels generated by JS -->
            </div>
          </div>

          <div class="slot-controls">
            <div style="display:flex; flex-direction:column; gap:5px;">
              <button class="toggle-btn" id="btnTurbo" onclick="toggleTurbo()">⚡ TURBO</button>
              <button class="toggle-btn" id="btnAuto" onclick="toggleAuto()">🔄 AUTO</button>
            </div>

            <div style="flex:1; text-align:left; padding-left:15px; font-size:0.8rem; color:#888;">
              <button class="toggle-btn" onclick="toggleSlotHelp()">❓ HILFE</button>
            </div>

            <button class="slot-btn-circle btn-spin-main" id="btnSpinSlots" onclick="spinProSlots()">
              SPIN
            </button>
          </div>
        </div>

        <!-- UPGRADER VIEW -->
        <div id="view-upgrader" style="display:none;">

          <div class="upgrader-container">
            <!-- Der Kreis / Die Grafik -->
            <div class="upgrade-circle-wrap">
              <!-- ÄNDERUNG: Kreis ist jetzt leer -->
              <div class="upgrade-circle" id="upgradeCircle"></div>

              <!-- ÄNDERUNG: Innerer Inhalt steht jetzt außerhalb des rotierenden Kreises -->
              <div class="upgrade-inner">
                <span class="chance-label">Chance</span>
                <span id="upgrader-chance-display" style="font-size:1.8rem; color:#fff; font-weight:900;">47.50%</span>
              </div>

              <!-- Ein kleiner Pfeil oben -->
              <div class="upgrade-pointer">▼</div>
            </div>

            <!-- Kontrollen für Multiplikator -->
            <div class="upgrader-controls">
              <div class="uc-group">
                <label>Multiplikator (x)</label>
                <div style="display:flex; gap:5px;">
                  <input type="number" id="upgraderMulti" class="bet-input" value="2.00" step="0.1" min="2"
                    oninput="updateUpgraderCalc()">
                </div>
              </div>
            </div>

            <!-- Info Text -->
            <div style="margin: 15px 0; font-size: 0.9rem; color: #888;">
              Gewinn: <span id="upgrader-win-preview" style="color:var(--green); font-weight:bold;">0</span> Kleinis
            </div>

            <button class="slot-btn-circle btn-spin-main" id="btnUpgrade" onclick="startUpgrade()"
              style="width:100%; border-radius:10px; height:60px;">
              UPGRADE
            </button>
          </div>
        </div>

        <!-- CSGO STYLE MONEY CASE (NEU) -->
        <div id="view-case-money" style="display:none;">
          <div class="upgrader-container" style="border-color: #f1c40f;">
            
            <div style="margin-bottom:15px; text-align:center;">
              <h3 style="color:#f1c40f; margin-bottom:5px; text-transform:uppercase; letter-spacing:2px;">💰 Kleini Case 💰</h3>
              <div style="font-size:0.8rem; color:#aaa;">Kaufe einen Schlüssel (Einsatz) & gewinne Multiplikatoren!</div>
            </div>

            <!-- Die Case Animation -->
            <div class="case-spinner" style="border-color:#f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.15); height:140px;">
              <!-- Der Strich in der Mitte -->
              <div class="roulette-marker" style="background:#f1c40f; box-shadow:0 0 15px #f1c40f; width:4px;"></div>
              <div class="case-strip" id="moneyCaseStrip" style="height:100%;"></div>
            </div>

            <!-- Info und Button -->
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-top:20px; width:100%;">
              
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.75rem; color:#ccc; margin-bottom:15px; text-align:left;">
                <div>💀 <span style="color:#7f8c8d">0x (Niete):</span> 45%</div>
                <div>🔻 <span style="color:#3498db">0.5x (Rückgeld):</span> 30%</div>
                <div>✅ <span style="color:#9b59b6">2x (Gewinn):</span> 15%</div>
                <div>🔥 <span style="color:#e91e63">10x (Super):</span> 8%</div>
                <div>👑 <span style="color:#f1c40f">100x (JACKPOT):</span> 2%</div>
              </div>

              <div style="font-size:0.9rem; margin-bottom:10px; color:#fff;">
                Preis für Schlüssel: <span id="key-price-display" style="color:#f1c40f; font-weight:bold;">0</span> Kleinis
              </div>

              <button class="open-case-btn" onclick="openMoneyCase()" 
                      style="width:100%; background: linear-gradient(45deg, #f39c12, #d35400); box-shadow: 0 4px 0 #a04000;">
                KISTE ÖFFNEN
              </button>
            </div>

          </div>
        </div>

        <!-- CRASH GAME VIEW -->
        <div id="view-crash" style="display:none;">
          <div class="crash-container">
            <canvas id="crashCanvas" width="700" height="350"></canvas>
            
            <!-- Overlay Text -->
            <div class="crash-info">
              <div id="crash-current-multi">1.00x</div>
              <div id="crash-status-text">Warte auf Start...</div>
            </div>

            <!-- History -->
            <div class="crash-history-bar" id="crashHistory">
              <!-- Wird per JS gefüllt -->
            </div>
          </div>

          <div class="action-row" style="margin-top:20px;">
            <button class="bet-btn" id="btnCrashAction" 
              onmousedown="crashAction()" 
              ontouchstart="crashAction()"
              style="background: linear-gradient(45deg, #8e44ad, #9b59b6); width: 100%; user-select: none; -webkit-user-select: none;">
          STARTEN
        </button>
          </div>
        </div>
        
        <!-- MINES GAME VIEW -->
        <div id="view-mines" style="display:none;">
          <div class="mines-container" style="display: flex; gap: 20px; align-items: flex-start;">
            
            <!-- Sidebar Controls -->
            <div class="mines-sidebar" style="width: 150px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333;">
              <label style="color: #aaa; font-size: 0.8rem;">Anzahl Minen</label>
              <input type="number" id="minesCountInput" class="bet-input" value="3" min="1" max="24" style="width: 100%; margin-bottom: 15px;">
              
              <!-- NEU: Aktueller Multiplikator Anzeige -->
              <div style="font-size: 0.9rem; color: #fff; margin-bottom: 5px;">Aktueller Multi:</div>
              <div id="mines-current-multi" style="color: #3498db; font-weight: bold; font-size: 1.4rem; margin-bottom: 10px;">1.00x</div>
              
              <div style="font-size: 0.9rem; color: #888; margin-bottom: 5px;">Nächster Multi:</div>
              <div id="mines-next-multi" style="color: var(--gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; opacity: 0.8;">1.13x</div>

              <button id="btnMinesAction" class="bet-btn" onclick="minesAction()" 
                style="width: 100%; background: linear-gradient(45deg, #2ecc71, #27ae60); font-size: 1rem;">
                SPIELEN
              </button>
            </div>

            <!-- The Grid -->
            <div class="mines-grid-wrapper" style="flex: 1; background: #0f0f12; padding: 20px; border-radius: 8px; position: relative;">
              <div id="mines-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                <!-- Tiles generated by JS -->
              </div>
              
              <!-- Overlay wenn Spiel aus ist -->
              <div id="mines-overlay" style="display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10;">
                <h2 id="mines-result-text" style="color: #fff; text-shadow: 0 0 10px #000; font-size: 2rem;">GAME OVER</h2>
              </div>
            </div>

          </div>
        </div>
        
        <!-- BLACKJACK VIEW -->
<div id="view-blackjack" style="display:none;">
  <div class="bj-table">
    
    <!-- Dealer Bereich (Label nach OBEN verschoben) -->
    <div class="bj-row">
      <div style="font-size:0.9rem; color:#888; font-weight:bold; margin-bottom:5px; letter-spacing:1px;">DEALER</div>
      <div class="bj-score-bubble" id="dealer-score">0</div>
      <div class="bj-hand" id="dealer-hand"></div>
    </div>

    <!-- Mitte (Status) -->
    <div id="bj-message" class="bj-message">Blackjack zahlt 3:2</div>

    <!-- Spieler Bereich (Label nach UNTEN verschoben) -->
    <div class="bj-row">
      <div class="bj-hand" id="player-hand"></div>
      <div class="bj-score-bubble" id="player-score">0</div>
      <div style="font-size:0.9rem; color:#888; font-weight:bold; margin-top:5px; letter-spacing:1px;">DU</div>
    </div>

  </div>

  <!-- Controls -->
  <div class="bj-controls" id="bj-controls-area">
    <button class="bet-btn" id="btn-bj-start" onclick="startBlackjack()" style="background: linear-gradient(45deg, #2ecc71, #27ae60); width:100%;">
      AUSTEILEN
    </button>

    <div id="bj-actions" style="display:none; gap:10px; width:100%; justify-content:center;">
      <button class="control-btn" onclick="bjAction('hit')" style="background:#3498db; color:white; padding:15px; flex:1;">KARTE (Hit)</button>
      <button class="control-btn" onclick="bjAction('stand')" style="background:#e74c3c; color:white; padding:15px; flex:1;">HALTEN (Stand)</button>
      <button class="control-btn" onclick="bjAction('double')" style="background:#f1c40f; color:black; padding:15px; flex:1;">DOPPELN (x2)</button>
    </div>
  </div>
</div>

        <!-- CRAZY WHEEL VIEW -->
<div id="view-crazy" style="display:none;">

  <div class="crazy-container">
    
    <!-- Top Slot (Der Multiplikator vor dem Dreh) -->
    <div class="crazy-top-slot">
      <div id="ct-slot-target" class="ct-slot-box">🎲</div>
      <div class="ct-slot-x">X</div>
      <div id="ct-slot-multi" class="ct-slot-box">???</div>
    </div>

    <!-- Das Rad -->
    <div class="wheel-wrapper">
      <div class="wheel-pointer">⬇</div>
      <div id="crazy-wheel" class="crazy-wheel"></div>
    </div>

    <!-- Info Overlay für Bonus Games -->
    <div id="ct-bonus-overlay" class="ct-bonus-overlay">
      <div class="ct-bonus-content">
        <h2 id="ct-bonus-title">BONUS!</h2>
        <div id="ct-bonus-anim">...</div>
        <div id="ct-bonus-result" style="font-size:2rem; margin-top:10px; color:#fff;"></div>
      </div>
    </div>
  </div>

  <!-- Betting Grid -->
  <div class="ct-betting-grid">
    <div class="ct-bet-group numbers">
      <button class="ct-bet-btn btn-1" onclick="ctBet(1)">1 <span class="ct-bet-val" id="ct-bet-1">0</span></button>
      <button class="ct-bet-btn btn-2" onclick="ctBet(2)">2 <span class="ct-bet-val" id="ct-bet-2">0</span></button>
      <button class="ct-bet-btn btn-5" onclick="ctBet(5)">5 <span class="ct-bet-val" id="ct-bet-5">0</span></button>
      <button class="ct-bet-btn btn-10" onclick="ctBet(10)">10 <span class="ct-bet-val" id="ct-bet-10">0</span></button>
    </div>
    <div class="ct-bet-group bonuses">
      <button class="ct-bet-btn btn-coin" onclick="ctBet('coin')">🪙 Coin Flip <span class="ct-bet-val" id="ct-bet-coin">0</span></button>
      <button class="ct-bet-btn btn-pachinko" onclick="ctBet('pachinko')">🟣 Pachinko <span class="ct-bet-val" id="ct-bet-pachinko">0</span></button>
      <button class="ct-bet-btn btn-cash" onclick="ctBet('cash')">🎯 Cash Hunt <span class="ct-bet-val" id="ct-bet-cash">0</span></button>
      <button class="ct-bet-btn btn-crazy" onclick="ctBet('crazy')">🤪 CRAZY <span class="ct-bet-val" id="ct-bet-crazy">0</span></button>
    </div>
  </div>

  <div class="action-row" style="margin-top:15px;">
  <!-- ... dein Drehen Button ... -->
  <button class="bet-btn" onclick="spinCrazyWheel()" id="btn-crazy-spin">
  <span class="spin-title">DREHEN</span>
  <span class="spin-info">Einsatz: <span id="ct-total-bet">0</span></span>
</button>
  
  <!-- NEU: HILFE BUTTON -->
  <button class="control-btn" onclick="toggleCtHelp()" style="background:#2980b9; color:#fff; font-weight:bold; width:auto; margin-left:5px;">❓</button>
  
  <!-- ... dein Mülleimer Button ... -->
  <button class="control-btn" onclick="ctClearBets()" style="background:#444; width:auto; margin-left:5px;">🗑️</button>
</div>
</div>
        
      </div>
    </div>
  </div>

  <!-- LEADERBOARD MODAL -->
  <div id="leaderboardModal">
    <div class="lb-window">
      <button class="close-btn" onclick="closeLeaderboard()">×</button>
      <div class="lb-header">
        <div class="lb-title">🏆 TOP SPIELER</div>
      </div>
      <div class="lb-list" id="lb-list">
        <div style="text-align:center; padding:20px; color:#666;">Lade Daten...</div>
      </div>
      <div class="lb-footer">
        Dein Name: <span id="my-player-name" style="color:#fff; font-weight:bold;">Unbekannt</span>
      </div>
    </div>
  </div>

  <div class="left-panel" id="clickPanel">
    <!-- VISUAL BACKGROUND AREA -->
    <div id="visual-canvas"></div>

    <div class="bakery-name">KleinClicker</div>
    <div id="top-player-display">👑 Platz 1: Laden...</div>
    <div class="score-container">
      <div id="score">0</div>
      <div class="currency-label">KLEINIS</div>
      <div id="cps">0,0 Kleinis / Sekunde</div>
        <div class="beer-wallet" onclick="openBeerModal()">
          <img src="https://github.com/JanKlein25/Clicker/blob/main/Adobe%20Express%20-%20file%20(9).png?raw=true" class="beer-wallet-icon">
          <span id="main-beer-display">0</span>
        </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button id="casinoBtn" onclick="openCasino()">🎰 GLÜCKSBUDE</button>
      <button id="skinsBtn" onclick="openSkins()">🎒 SKINS</button>
    </div>
    <button id="leaderboardBtn" onclick="openLeaderboard()">🏆 LEADERBOARD</button>
    <button id="lotteryBtn" onclick="openLottery()" style="
      margin-top: 10px;
      background: linear-gradient(45deg, #d35400, #e67e22);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(211, 84, 0, 0.4);
      z-index: 25;
    ">🎰 JACKPOT</button>
    <!-- PRESTIGE BUTTON (NEU) -->
    <button id="prestigeBtn" onclick="openPrestige()" style="display:none;">
      🚀 AUFSTEIGEN
      <div style="font-size:0.7rem; font-weight:normal;">Prestige verfügbar</div>
    </button>

    <div class="buff-container" id="buffArea"></div>
    <!-- MAIN IMAGE -->
    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" 
     id="bigKlein" 
     alt="Klick mich!" 
     draggable="false" 
     ondragstart="return false;" 
     style="-webkit-user-drag: none; user-select: none;">

    <!-- PRESTIGE BADGE -->
    <div id="prestige-badge"
      style="display:none; margin-top:25px; width: 80%; max-width:300px; color:#3498db; background:rgba(0,0,0,0.6); padding:10px; border-radius:12px; border:1px solid #3498db; text-align:center; z-index: 20;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span style="font-weight:bold;">⭐ Rang <span id="prestige-level-display">0</span></span>
        <span style="font-size:0.8rem; color:#2ecc71;">+<span id="prestige-bonus-display">0</span>% Bonus</span>
      </div>

      <!-- Fortschrittsbalken Container -->
      <div
        style="width:100%; height:8px; background:#222; border-radius:4px; overflow:hidden; border:1px solid rgba(52, 152, 219, 0.3);">
        <div id="prestige-progress-bar"
          style="width:0%; height:100%; background:linear-gradient(90deg, #3498db, #2980b9); transition: width 0.5s;">
        </div>
      </div>

      <div style="font-size:0.7rem; color:#ccc; margin-top:5px;">
        Nächster Rang in: <span id="prestige-next-req" style="color:#fff; font-weight:bold;">0</span>
      </div>
    </div>

    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="goldenKlein" alt="GOLD">
  </div>

  <div class="right-panel">
    <div class="store-header">Upgrades</div>
    <div class="upgrades-container" id="upgradeGrid"></div>

    <!-- NEW CLICKER UPGRADE SECTION -->
    <div class="store-header">Clicker Zentrale 3.0</div>
    <div class="click-booster" id="clickBooster">
      <div class="cb-card">
        <div class="cb-info">
          <div class="cb-title">Maus Training</div>
          <div class="cb-stat" style="font-size:0.75rem;">
            Effekt: <span id="click-effect-desc" style="color:#2ecc71"></span>
          </div>
          <div class="cb-stat">Kraft: <span id="click-dmg-display" style="color:var(--gold); font-weight:bold;">1</span>
          </div>
        </div>
        <button class="cb-btn" id="btn-buy-click" onclick="buyClickStats()">
          <div style="font-size:0.7rem; text-transform:uppercase;">Level Up</div>
          <span id="click-cost-display" class="cb-cost">100</span>
        </button>
      </div>
    </div>

    <div class="store-header">Markt</div>
    <div class="buildings-list" id="buildingList"></div>
  </div>

  <!-- LOTTERY MODAL -->
<div id="lotteryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:17000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
  <div class="lb-window" style="width:95%; max-width:500px; border-color:#e67e22; display:flex; flex-direction:column;">
    <button class="close-btn" onclick="closeLottery()">×</button>
    
    <div class="lb-header" style="background:linear-gradient(to right, #d35400, #e67e22);">
      <div class="lb-title">🎰 TÄGLICHER BIER-POT</div>
    </div>

    <div style="padding:20px; text-align:center; background:#111; display:flex; flex-direction:column; align-items:center;">
      
      <!-- Der Countdown -->
      <div style="font-size:0.9rem; color:#aaa; margin-bottom:5px;">Nächste Ziehung: 20:00 Uhr</div>
      <div id="lottery-timer" style="font-size:1.5rem; font-weight:bold; color:#fff; font-family:monospace;">--:--:--</div>

      <!-- Das Glücksrad (Canvas) -->
      <div style="position:relative; margin:20px 0; width:250px; height:250px;">
        <canvas id="lotteryCanvas" width="250" height="250" style="border-radius:50%; box-shadow:0 0 20px rgba(230, 126, 34, 0.2);"></canvas>
        <div style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); font-size:2rem; color:#fff; text-shadow:0 2px 2px #000;">⬇</div>
      </div>

      <!-- Der Pot Wert -->
      <div style="background:rgba(255,255,255,0.05); padding:10px 20px; border-radius:10px; margin-bottom:15px; width:100%;">
        <div style="font-size:0.8rem; color:#aaa;">IM POT</div>
        <div style="font-size:2rem; color:#f1c40f; font-weight:900;">🍺 <span id="lottery-pot-display">0</span></div>
      </div>

      <!-- Liste der Teilnehmer -->
      <div id="lottery-list" style="width:100%; max-height:100px; overflow-y:auto; background:#1a1a1a; border:1px solid #333; border-radius:6px; margin-bottom:15px; padding:5px;">
        <!-- Wird per JS gefüllt -->
      </div>

      <!-- Einsatz Controls -->
      <div id="lottery-controls" style="display:flex; gap:10px; width:100%;">
        <input type="number" id="lotteryInput" placeholder="Menge" style="flex:1; padding:10px; background:#222; border:1px solid #444; color:#fff; border-radius:6px; font-weight:bold;">
        <button onclick="enterLottery()" style="background:#e67e22; border:none; padding:10px 20px; color:#fff; font-weight:bold; border-radius:6px; cursor:pointer;">REINSETZEN</button>
      </div>

      <div id="lottery-winner-msg" style="display:none; margin-top:15px; color:#2ecc71; font-weight:bold; border:1px solid #2ecc71; padding:10px; border-radius:6px; background:rgba(46, 204, 113, 0.1);">
        Letzter Gewinner:<br><span id="last-winner-name" style="color:#fff;">Niemand</span> (+<span id="last-winner-amt">0</span>)
      </div>

    </div>
  </div>
</div>
  
  <script>
    /* --- CONFIG & ASSETS --- */
    const SAVE_KEY = 'KleinClicker_Precision_V20';
    const DEFAULT_IMG = "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png";

    // SKINS DATA
    const SKINS = [
      { id: 'default', name: 'Original Klein', rarity: 'common', url: DEFAULT_IMG, filter: '' },
      { id: 'friend1', name: 'Seltener Cedric', rarity: 'rare', url: "https://github.com/JanKlein25/Clicker/blob/main/Cedrics%20Gesicht.png?raw=true", filter: '' },
      { id: 'friend2', name: 'Epischer Malte', rarity: 'epic', url: "https://github.com/JanKlein25/Clicker/blob/main/Malte%20Gesicht.png?raw=true", filter: '' },
      { id: 'friend3', name: '"OH BACKEE.."', rarity: 'epic', url: "https://github.com/JanKlein25/Clicker/blob/main/Malte%20Zahn.png?raw=true", filter: '' },
      { id: 'legendary1', name: 'Legendärer Till', rarity: 'legendary', url: "https://github.com/JanKlein25/Clicker/blob/main/Tills%20Gesicht.png?raw=true", filter: '' },
      { id: 'legendary2', name: 'Legendärer Malte', rarity: 'legendary', url: "https://github.com/JanKlein25/Clicker/blob/main/Malte%202%20Gesicht.png?raw=true", filter: '' },  
      { id: 'legendary3', name: 'Legendärer Maxi', rarity: 'legendary', url: "https://github.com/JanKlein25/Clicker/blob/main/Maxi%20Bier%20Legend%C3%A4r.png?raw=true", filter: '' },
      { id: 'Schwarzmarkt', name: 'Sir Smokes-a-Lot Maxi', rarity: 'blackmarket', url: "https://github.com/JanKlein25/Clicker/blob/main/Maxi%20Weed%20(2).png?raw=true", filter: '' },
    ];

    // CHANCEN KONFIGURATION (Mythic entfernt, Legendary auf 3% erhöht)
    const CASE_ODDS = {
  common: 0.40,    // Reduziert von 0.70 auf 0.69, um Platz zu machen
  rare: 0.30,
  epic: 0.15,
  legendary: 0.1,
  blackmarket: 0.05, // <--- NEU: 1% Chance
  mythic: 0
};

    // BUILDINGS (UPDATED with new endgame buildings)
    const BUILDINGS = [
      { id: 0, name: 'Maxis Zeigefinger', baseCost: 15, baseCps: 0.1, icon: '👆' },
      { id: 1, name: 'Magdas Oma', baseCost: 100, baseCps: 1, icon: '👵' },
      { id: 2, name: 'Cedrics Acker', baseCost: 1100, baseCps: 8, icon: '🌾' },
      { id: 3, name: 'Maltes Meme Mine', baseCost: 12000, baseCps: 47, icon: '⛏️' },
      { id: 4, name: 'Jans Strandkorbfabrik', baseCost: 130000, baseCps: 260, icon: '🏭' },
      { id: 5, name: 'Tills Tresor', baseCost: 1400000, baseCps: 1400, icon: '🏦' },
      { id: 6, name: 'Nicos Sekt-Tempel', baseCost: 20000000, baseCps: 7800, icon: '🏛️' },
      { id: 7, name: 'Maxis Klon-Labor', baseCost: 330000000, baseCps: 45000, icon: '🧬' },
      { id: 8, name: 'Magdas Mars-Rakete', baseCost: 5100000000, baseCps: 280000, icon: '🚀' },
      { id: 9, name: 'Cedrics Dimensionstor', baseCost: 75000000000, baseCps: 1600000, icon: '🌀' },
      { id: 10, name: 'Maltes Zeitmaschine', baseCost: 900000000000, baseCps: 12000000, icon: '⏳' },
      { id: 11, name: 'Franjas feuchtes Universum', baseCost: 15000000000000, baseCps: 150000000, icon: '🌌' },
      // NEW BUILDINGS
      { id: 12, name: 'Quanten-Backofen', baseCost: 350000000000000, baseCps: 2500000000, icon: '⚛️' },
      { id: 13, name: 'Dunkle Materie Pumpe', baseCost: 6000000000000000, baseCps: 35000000000, icon: '⚫' },
      { id: 14, name: 'Cedrics Multiversum', baseCost: 120000000000000000, baseCps: 500000000000, icon: '🪐' },
      { id: 15, name: 'Maltes Realitäts-Glitch', baseCost: 2500000000000000000, baseCps: 8000000000000, icon: '👾' },
      { id: 16, name: 'Jans Admin-Konsole', baseCost: 55000000000000000000, baseCps: 150000000000000, icon: '💻' },
      { id: 17, name: 'Tills Unendlichkeit', baseCost: 1300000000000000000000, baseCps: 2500000000000000, icon: '♾️' },
      { id: 18, name: 'Singularitäts-Antrieb', baseCost: 35000000000000000000000, baseCps: 60000000000000000, icon: '🔆' },
      { id: 19, name: 'Der Ur-Patrick', baseCost: 900000000000000000000000, baseCps: 1200000000000000000, icon: '👶' },
      { id: 20, name: 'Sauerteig-Galaxie', baseCost: 25000000000000000000000000, baseCps: 30000000000000000000, icon: '🌌' },
      { id: 21, name: 'Vegan Pussy', baseCost: 800000000000000000000000000, baseCps: 900000000000000000000, icon: '🏁' }
    ];

    // UPGRADES
    const UPGRADES = [
      { id: 'u_click_1', name: 'Plastik Maus', cost: 500, trigger: { type: 'clicks', val: 100 }, icon: '🖱️', desc: 'Die billigste Maus auf dem Markt.', type: 'click', multi: 2, text: 'Klickstärke x2' },
      { id: 'u_click_2', name: 'Gamer Maus', cost: 50000, trigger: { type: 'clicks', val: 1000 }, icon: '🎮', desc: 'Mit RGB Beleuchtung für mehr FPS.', type: 'click', multi: 2, text: 'Klickstärke x2' },

      { id: 'u_b0_1', name: 'Carpaltunnel', cost: 1000, trigger: { type: 'build', id: 0, val: 10 }, icon: '🩹', desc: 'Mäuse arbeiten trotz Schmerzen weiter.', type: 'build', target: 0, multi: 2, text: 'Maus Produktion x2' },
      { id: 'u_b0_2', name: 'Makro', cost: 10000, trigger: { type: 'build', id: 0, val: 50 }, icon: '⌨️', desc: 'Automatisierte Klick-Skripte.', type: 'build', target: 0, multi: 2, text: 'Maus Produktion x2' },

      { id: 'u_b1_1', name: 'Nudelholz', cost: 5000, trigger: { type: 'build', id: 1, val: 10 }, icon: '🥖', desc: 'Die Omas werden aggressiver.', type: 'build', target: 1, multi: 2, text: 'Oma Produktion x2' },
      { id: 'u_b1_2', name: 'Lesebrille', cost: 50000, trigger: { type: 'build', id: 1, val: 50 }, icon: '👓', desc: 'Sie sehen die Kleinis jetzt besser.', type: 'build', target: 1, multi: 2, text: 'Oma Produktion x2' },
      // ... further upgrades implied
    ];

   /* --- GAME STATE --- */
    let game = {
      score: 0, 
      totalScore: 0, 
      clicks: 0, 
      clickLevel: 1,
      buildings: new Array(BUILDINGS.length).fill(0), 
      upgrades: [],
      casinoHistory: [],
      playerName: "Spieler" + Math.floor(Math.random() * 1000),
      prestige: 0,
      cases: 0,
      skinsOwned: ['default'],
      equippedSkin: 'default',
      lastLogin: Date.now(),
      
      // --- NEU: DIE BIERCHEN ---
      beers: 0,            
      lastDailyBonus: 0,  

      hasClaimedRetroBeers: false,
    };

    // HIER IST DER FIX: Variablen direkt am Anfang definieren!
    let casinoCurrency = 'kleinis'; // Damit das Casino beim Start Bescheid weiß
    const BEER_ICON_SRC = "https://github.com/JanKlein25/Clicker/blob/main/Adobe%20Express%20-%20file%20(9).png?raw=true"; // Korrekter Variablen-Name!
    
    let buffs = { frenzy: { active: false, time: 0, multi: 7 } };

    let clickHistory = [];
    // --- NEU: AUTO-CLICKER ZÄHLER ---
    let clickCountSec = 0;
    
    // Setzt den Zähler jede Sekunde auf 0 zurück
    setInterval(() => {
      clickCountSec = 0;
    }, 1000);
    // --------------------------------
    let lastTime = performance.now();
    let casinoUnlocked = false;

    let visualElements = [];
    const MAX_VISUALS = 30;

    /* --- FIREBASE CONFIG --- */
    const firebaseConfig = {
      apiKey: "AIzaSyA9UzTCyFOxOr6EiGATnkXA_QMQZRcqX0I",
      authDomain: "kleinclicker.firebaseapp.com",
      databaseURL: "https://kleinclicker-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kleinclicker",
      storageBucket: "kleinclicker.firebasestorage.app",
      messagingSenderId: "109832699128",
      appId: "1:109832699128:web:636e6c1687927447d6cf0d",
      measurementId: "G-JBPB52ZK4J"
    };

    let db;
    let dbRef;

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      dbRef = db.ref('leaderboard');
      console.log("Firebase initialized");
    } catch (e) {
      console.warn("Firebase not configured yet. Leaderboard will be offline.");
    }

    /* --- UI --- */
    const tooltipEl = document.getElementById('global-tooltip');
    const ttName = document.getElementById('tt-name-display');
    const ttPrice = document.getElementById('tt-price-display');
    const ttEffect = document.getElementById('tt-effect-display');
    const ttDesc = document.getElementById('tt-desc-display');
    const ttStats = document.getElementById('tt-stats-container');

    /* --- OFFLINE EARNINGS LOGIC (MIT CHEAT SCHUTZ) --- */
    function processOfflineEarnings() {
      // Wenn kein Login-Datum da ist, abbrechen
      if (!game.lastLogin) return;

      const now = Date.now();
      // Unterschied in Sekunden
      // WICHTIG: "let" statt "const", damit wir es ändern können
      let secondsOffline = (now - game.lastLogin) / 1000;

      // Nur berechnen, wenn man länger als 10 Sekunden weg war
      if (secondsOffline > 10) {
        
        // --- CHEAT SCHUTZ START ---
        // Maximal 24 Stunden (86400 Sekunden) erlauben
        // Wenn jemand die Uhr 10 Jahre vorstellt, kriegt er trotzdem nur 24h Geld.
        if (secondsOffline > 86400) {
          secondsOffline = 86400;
        }
        // --- CHEAT SCHUTZ ENDE ---

        const currentCPS = calculateTotalCPS();
        
        // Offline Einnahmen berechnen (Zeit * Produktion)
        const offlineEarnings = currentCPS * secondsOffline;

        if (offlineEarnings > 0) {
          addScore(offlineEarnings);
          
          // Zeit schön formatieren für die Anzeige
          let timeString = "";
          // Wenn wir gecapped haben (mehr als 24h weg), zeigen wir "24+ Stunden" an
          if (secondsOffline >= 86400) {
            timeString = "über 24 Stunden";
          } else if (secondsOffline < 60) {
            timeString = Math.floor(secondsOffline) + " Sekunden";
          } else if (secondsOffline < 3600) {
            timeString = Math.floor(secondsOffline / 60) + " Minuten";
          } else {
            timeString = (secondsOffline / 3600).toFixed(1) + " Stunden";
          }

          // Alert anzeigen
          alert(
            `Yo Chef! 👋\n` +
            `Während du ${timeString} weg warst, haben wir den Laden geschmissen.\n\n` +
            `Hier sind deine Einnahmen: +${formatNum(offlineEarnings)} Kleinis!`
          );
        }
      }
    }

    /* --- INIT --- */
    function init() {
      try {
        loadGame();
        // Check array lengths in case of new update
        if (game.buildings.length < BUILDINGS.length) {
          const diff = BUILDINGS.length - game.buildings.length;
          for (let i = 0; i < diff; i++) game.buildings.push(0);
        }

        // --- HIER DIE OFFLINE BERECHNUNG AUFRUFEN ---
        processOfflineEarnings(); 

      } catch (e) { console.log("Resetting save"); localStorage.removeItem(SAVE_KEY); }

      equipSkin(game.equippedSkin, true);
      buildBuildingUI();
      renderUpgrades();
      renderHistory();
      initVisuals();
      initProSlots(); // Init the new slots
      requestAnimationFrame(gameLoop);
      setInterval(slowLoop, 1000);
      scheduleGolden();

      checkDailyBonus(); 

      // Preisanzeige für Money Case initialisieren
      document.getElementById('betAmount').addEventListener('input', updateMoneyCaseUI);

      if (game.playerName.startsWith("Spieler")) {
        const newName = prompt("Wie möchtest du auf dem Leaderboard heißen?", game.playerName);
        if (newName && newName.trim() !== "") {
          game.playerName = newName.trim().substring(0, 15);
          saveGame();
        }
      }
      document.getElementById('my-player-name').textContent = game.playerName;

      document.addEventListener('mousemove', (e) => {
        if (tooltipEl.style.display === 'block') {
          let top = e.clientY + 10; let left = e.clientX - 330;
          if (left < 10) left = e.clientX + 10;
          if (top + tooltipEl.offsetHeight > window.innerHeight) top = window.innerHeight - tooltipEl.offsetHeight - 10;
          tooltipEl.style.top = top + 'px'; tooltipEl.style.left = left + 'px';
        }
      });

      checkLotteryWins();
      
    }

    function gameLoop(now) {
      let dt = (now - lastTime) / 1000;
      if (dt > 1) dt = 1; lastTime = now;
      updateBuffs(dt);

      const passiveCps = calculateTotalCPS();
      clickHistory = clickHistory.filter(c => now - c.time < 1000);
      const activeClickCPS = clickHistory.reduce((sum, c) => sum + c.val, 0);

      if (passiveCps > 0) addScore(passiveCps * dt);

      const displayCps = passiveCps + activeClickCPS;

      document.getElementById('score').textContent = formatNum(Math.floor(game.score));
      document.getElementById('cps').textContent = formatNum(displayCps, 1) + " Kleinis / Sekunde";
      document.getElementById('main-beer-display').textContent = formatNum(Math.floor(game.beers || 0));

      updateDynamicBackground();
      updateClickUI();

      if (!casinoUnlocked && game.totalScore >= 1000) {
        casinoUnlocked = true;
        document.getElementById('casinoBtn').style.display = 'block';
        document.getElementById('skinsBtn').style.display = 'block';
      }
      else if (casinoUnlocked) {
        document.getElementById('casinoBtn').style.display = 'block';
        document.getElementById('skinsBtn').style.display = 'block';
      }

      updateBuildingStates();
      checkPrestigeUnlock();

      // Auto Spin Logic
      if (slotState.auto && !slotState.spinning && currentCasinoMode === 'slots' && document.getElementById('casinoModal').style.display === 'flex') {
        spinProSlots();
      }

      requestAnimationFrame(gameLoop);
    }

    function slowLoop() {
      saveGame();
      renderUpgrades();
      BUILDINGS.forEach((_, i) => updateSingleBuildingUI(i));

      if (dbRef) {
        dbRef.child(game.playerName).set({
          name: game.playerName,
          score: Math.floor(game.totalScore),
          prestige: game.prestige || 0,
          beers: Math.floor(game.beers || 0),
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).catch(err => console.log("Sync error", err));
      }
    }

    /* --- VISUALS & BACKGROUND --- */
    function initVisuals() {
      const container = document.getElementById('visual-canvas');
      container.innerHTML = '';
      visualElements = [];
      let totalCreated = 0;
      for (let i = BUILDINGS.length - 1; i >= 0; i--) {
        if (game.buildings[i] > 0) {
          let count = Math.min(Math.ceil(Math.log2(game.buildings[i] + 1)), 5);
          for (let k = 0; k < count; k++) {
            if (totalCreated < MAX_VISUALS) {
              spawnVisualIcon(BUILDINGS[i].icon);
              totalCreated++;
            }
          }
        }
      }
    }

    function spawnVisualIcon(iconChar) {
      const container = document.getElementById('visual-canvas');
      const el = document.createElement('div');
      el.className = 'bg-icon';
      el.textContent = iconChar;
      el.style.left = Math.random() * 90 + '%';
      el.style.top = Math.random() * 90 + '%';
      el.style.fontSize = (1 + Math.random()) + 'rem';
      el.style.animationDuration = (10 + Math.random() * 20) + 's';
      container.appendChild(el);
      visualElements.push(el);
    }

    function updateDynamicBackground() {
      const panel = document.getElementById('clickPanel');
      let s = game.totalScore;
      if (s < 10000) { }
      else if (s < 1000000) { panel.style.background = `radial-gradient(circle at center, #8e44ad 0%, #000000 100%)`; }
      else if (s < 1000000000) { panel.style.background = `radial-gradient(circle at center, #d35400 0%, #2d3436 100%)`; }
      else if (s < 1000000000000) { panel.style.background = `radial-gradient(circle at center, #f1c40f 0%, #2c3e50 100%)`; }
      else { panel.style.background = `radial-gradient(circle at center, #16a085 0%, #000 100%)`; }
    }

    /* --- MATH & CLICK UPGRADES --- */
    function addScore(amount) { game.score += amount; game.totalScore += amount; }

    function getPrestigeMultiplier() {
      return 1 + (game.prestige * 0.05);
    }

    function getBuildingMultiplier(index) {
      let m = 1;
      UPGRADES.forEach(u => { if (u.type === 'build' && u.target === index && game.upgrades.includes(u.id)) m *= u.multi; });
      if (buffs.frenzy.active) m *= buffs.frenzy.multi;
      return m * getPrestigeMultiplier();
    }

    function getBuildingCPS(index) { return BUILDINGS[index].baseCps * getBuildingMultiplier(index); }
    function calculateTotalCPS() { let cps = 0; game.buildings.forEach((count, i) => cps += count * getBuildingCPS(i)); return cps; }

    function getClickPower(lvl = game.clickLevel) {
      let baseDamage = 1 + ((lvl - 1) * 5);
      let cpsPercentage = 0.05 + (lvl * 0.01);
      let cpsPower = calculateTotalCPS() * cpsPercentage;
      let power = baseDamage + cpsPower;

      UPGRADES.forEach(u => { if (u.type === 'click' && game.upgrades.includes(u.id)) power *= u.multi; });
      if (buffs.frenzy.active) power *= buffs.frenzy.multi;

      return power * getPrestigeMultiplier();
    }

    function getClickLevelCost() {
      return Math.floor(500 * Math.pow(1.8, game.clickLevel));
    }

    function buyClickStats() {
      const cost = getClickLevelCost();
      if (game.score >= cost) {
        game.score -= cost;
        game.clickLevel++;
        updateClickUI();

        const btn = document.getElementById('btn-buy-click');
        btn.style.transform = "scale(1.1)";
        setTimeout(() => btn.style.transform = "scale(1)", 100);
      }
    }

    function updateClickUI() {
      const cost = getClickLevelCost();
      const currentPower = getClickPower(game.clickLevel);
      const nextPower = getClickPower(game.clickLevel + 1);

      const currentPercent = Math.round((0.05 + (game.clickLevel * 0.01)) * 100);
      const nextPercent = Math.round((0.05 + ((game.clickLevel + 1) * 0.01)) * 100);

      document.getElementById('click-effect-desc').innerHTML = `${currentPercent}% CPS <span style="font-size:0.8em; color:#777">➜</span> ${nextPercent}% CPS`;

      document.getElementById('click-dmg-display').innerHTML = `${formatNum(currentPower, 1)} <span style="font-size:0.8em; color:#7f8c8d">➜</span> <span style="color:#2ecc71">${formatNum(nextPower, 1)}</span>`;
      document.getElementById('click-cost-display').textContent = formatNum(cost);

      const btn = document.getElementById('btn-buy-click');
      if (game.score >= cost) btn.classList.remove('locked');
      else btn.classList.add('locked');
    }

    /* --- CASINO LOGIC --- */
    let isSpinning = false;
    let currentCasinoMode = 'roulette';

    function openCasino() {
      document.getElementById('casinoModal').style.display = 'flex';
      updateCasinoUI();
      // Reset Roulette
      generateStrip(50, null);
      const s = document.getElementById('rouletteStrip');
      s.style.transition = 'none'; s.style.transform = 'translateX(0px)';
      // Ensure Slot is reset visually
      slotState.auto = false;
      document.getElementById('btnAuto').classList.remove('active');
    }
    function closeCasino() {
      document.getElementById('casinoModal').style.display = 'none';
      slotState.auto = false; // Stop auto on close
    }
    function updateCasinoUI() { document.getElementById('casino-balance').textContent = formatNum(Math.floor(game.score)); }

    /* --- CASINO TAB SWITCHER (UPDATED) --- */
    function switchCasinoTab(mode) {
      currentCasinoMode = mode;

      // Alle Tabs verstecken
      document.getElementById('view-roulette').style.display = 'none';
      document.getElementById('view-slots').style.display = 'none';
      document.getElementById('view-upgrader').style.display = 'none';
      document.getElementById('view-case-money').style.display = 'none';
      document.getElementById('view-crash').style.display = 'none'; 
      document.getElementById('view-mines').style.display = 'none'; 
      document.getElementById('view-blackjack').style.display = 'none'; // <-- HINZUFÜGEN
      document.getElementById('view-crazy').style.display = 'none'; 

      // Alle Buttons zurücksetzen
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

      // Aktiven Tab anzeigen
      if (mode === 'roulette') {
        document.getElementById('view-roulette').style.display = 'block';
        document.getElementById('btn-tab-roulette').classList.add('active');
      }
      else if (mode === 'slots') {
        document.getElementById('view-slots').style.display = 'block';
        document.getElementById('btn-tab-slots').classList.add('active');
      }
      else if (mode === 'upgrader') {
        document.getElementById('view-upgrader').style.display = 'block';
        document.getElementById('btn-tab-upgrader').classList.add('active');
        updateUpgraderCalc();
      }
      else if (mode === 'moneycase') {
        document.getElementById('view-case-money').style.display = 'block';
        document.getElementById('btn-tab-moneycase').classList.add('active');
        updateMoneyCaseUI(); // Preis Text updaten
      }
      // --- CRASH ---
      else if (mode === 'crash') {
        document.getElementById('view-crash').style.display = 'block';
        document.getElementById('btn-tab-crash').classList.add('active');
        // Canvas Größe fixen falls CSS es verzerrt hat
        const c = document.getElementById('crashCanvas');
        c.width = c.parentElement.offsetWidth;
        c.height = c.parentElement.offsetHeight;
        drawCrashGraph(); // Leeren Graph zeichnen
      }
      // --- MINES ---
      else if (mode === 'mines') {
        document.getElementById('view-mines').style.display = 'block';
        document.getElementById('btn-tab-mines').classList.add('active');
        updateMinesUI(); // Grid initialisieren
      }
      // --- BLACKJACK ---
      else if (mode === 'blackjack') {
        document.getElementById('view-blackjack').style.display = 'block';
        document.getElementById('btn-tab-blackjack').classList.add('active');
      }
      // --- CRAZY ---
      else if (mode === 'crazy') {
  document.getElementById('view-crazy').style.display = 'block';
  document.getElementById('btn-tab-crazy').classList.add('active');
}
    }

    /* --- MONEY CASE LOGIC (NEU) --- */
    const MONEY_CASE_ODDS = [
      // chance: Wahrscheinlichkeit für das Ergebnis
      // fillWeight: Wie oft taucht es als "Deko" beim Drehen auf (damit nicht alles Gold ist)
      { id: 'trash', multi: 0,   name: 'NIETE',    style: 'rarity-trash', chance: 0.45, fillWeight: 50 },
      { id: 'loss',  multi: 0.5, name: 'RÜCKGELD', style: 'rarity-loss',  chance: 0.30, fillWeight: 30 },
      { id: 'win',   multi: 2,   name: 'PROFIT',   style: 'rarity-win',   chance: 0.15, fillWeight: 15 },
      { id: 'big',   multi: 10,  name: 'BIG WIN',  style: 'rarity-big',   chance: 0.08, fillWeight: 4  },
      { id: 'jack',  multi: 100, name: 'JACKPOT',  style: 'rarity-jack',  chance: 0.02, fillWeight: 1  }
    ];

    function getRandomFillerItem() {
      let pool = [];
      MONEY_CASE_ODDS.forEach(item => {
        for(let i=0; i < item.fillWeight; i++) pool.push(item);
      });
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function updateMoneyCaseUI() {
      const bet = document.getElementById('betAmount').value || 0;
      const display = document.getElementById('key-price-display');
      if(display) display.textContent = formatNum(parseInt(bet));
    }

    function openMoneyCase() {
      const bet = getBet(); 
      if (!bet) return;
      if (isSpinning) return;

      payBet(bet);
      updateCasinoUI();
      
      disableButtons(true);
      isSpinning = true;

      // 1. Gewinner ermitteln
      let r = Math.random();
      let accumulated = 0;
      let winner = MONEY_CASE_ODDS[0];

      for (let item of MONEY_CASE_ODDS) {
        accumulated += item.chance;
        if (r < accumulated) {
          winner = item;
          break;
        }
      }

      // 2. Streifen bauen
      const strip = document.getElementById('moneyCaseStrip');
      strip.innerHTML = '';
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';

      const TOTAL_ITEMS = 60;
      const WIN_INDEX = 45;

      for (let i = 0; i < TOTAL_ITEMS; i++) {
        let item;
        if (i === WIN_INDEX) {
          item = winner; 
        } else {
          item = getRandomFillerItem();
        }

        const el = document.createElement('div');
        el.className = `mc-item ${item.style}`;
        el.innerHTML = `
          <div class="mc-multi">${item.multi}x</div>
          <div class="mc-label">${item.name}</div>
        `;
        strip.appendChild(el);
      }

      strip.offsetHeight;

      // 3. Animation
      const ITEM_FULL_WIDTH = 106;
      const containerWidth = document.querySelector('.case-spinner').offsetWidth;
      const jitter = Math.floor(Math.random() * 50) - 25; 
      const scrollPos = (WIN_INDEX * ITEM_FULL_WIDTH) - (containerWidth / 2) + (ITEM_FULL_WIDTH / 2) + jitter;

      strip.style.transition = 'transform 6s cubic-bezier(0.15, 0.85, 0.15, 1)';
      strip.style.transform = `translateX(-${scrollPos}px)`;

      // 4. Ende & Auswertung
      setTimeout(() => {
        isSpinning = false;
        disableButtons(false);

        const winAmount = Math.floor(bet * winner.multi);
        
        // Button finden, um Text zu ändern
        const btn = document.querySelector('#view-case-money .open-case-btn');

        if (winAmount > 0) {
          triggerWin(winAmount); 
          const winBox = document.getElementById('winDisplay');
          
          // HIER: Text deutlicher machen (+ Kleinis)
          document.getElementById('winAmountDisplay').textContent = `+${formatNum(winAmount)} Kleinis`;
          document.querySelector('.win-label').textContent = `${winner.multi}x GEWINN`;
          
          winBox.classList.add('show');
          setTimeout(() => winBox.classList.remove('show'), 2000);

          // Auch auf dem Button anzeigen
          btn.innerHTML = `GEWONNEN: ${formatNum(winAmount)}`;
          btn.style.background = "linear-gradient(45deg, #2ecc71, #27ae60)"; // Grün machen
        } else {
          // Bei Niete
          btn.innerHTML = "NIETE (0x)";
          btn.style.background = "#444"; // Grau machen
        }

        // Button nach 2 Sekunden zurücksetzen
        setTimeout(() => {
            btn.innerHTML = "KISTE ÖFFNEN";
            btn.style.background = "linear-gradient(45deg, #f39c12, #d35400)"; // Original Farbe
        }, 2000);

        updateCasinoUI();
        saveGame(); 
      }, 6000);
    }

    function setBetMultiplier(multi) {
  const input = document.getElementById('betAmount');
  
  if (multi === 'max') {
    // HIER IST DER FIX:
    // Wir prüfen, welche Währung gerade an ist
    if (casinoCurrency === 'kleinis') {
       input.value = Math.floor(game.score);
    } else {
       // Wenn Bierchen an sind, nehmen wir game.beers
       input.value = Math.floor(game.beers || 0);
    }
  } 
  else {
    // Das hier bleibt gleich (für x2, /2 Buttons)
    let val = parseInt(input.value) || 0;
    if (val === 0) val = 100;
    input.value = Math.floor(val * multi);
  }
  
  // UI Updates aufrufen
  updateUpgraderCalc();
  updateMoneyCaseUI();
}

    /* --- ROULETTE ENGINE --- */
    function generateStrip(count, winningColor) {
      const strip = document.getElementById('rouletteStrip');
      strip.innerHTML = '';
      for (let i = 0; i < count; i++) {
        let type = 'black';
        const r = Math.random();
        if (winningColor && i === 60) type = winningColor;
        else {
          if (r < 0.06) type = 'green';
          else if (r < 0.53) type = 'red';
          else type = 'black';
        }
        const el = document.createElement('div');
        el.className = `r-card rc-${type}`;
        if (type === 'green') el.innerHTML = `<img src="${DEFAULT_IMG}" class="rc-logo">`;
        else el.textContent = Math.floor(Math.random() * 7) + (type === 'black' ? 8 : 1);
        strip.appendChild(el);
      }
    }

    function spin(choice) {
      if (isSpinning) return;
      const bet = getBet();
      if (!bet) return;

      payBet(bet);
      updateCasinoUI();
      isSpinning = true;
      disableButtons(true);

      const r = Math.random();
      let result = 'black';
      if (r < 0.05) result = 'green';
      else if (r < 0.525) result = 'red';

      generateStrip(80, result);

      const strip = document.getElementById('rouletteStrip');
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';
      strip.offsetHeight;

      const cardSize = 74;
      const targetIndex = 60;
      const centerOfTarget = (targetIndex * cardSize) + 35;
      const jitter = Math.floor(Math.random() * 50) - 25;
      const totalTranslate = centerOfTarget + jitter;

      strip.style.transition = 'transform 4.5s cubic-bezier(0.15, 0.85, 0.15, 1)';
      strip.style.transform = `translateX(-${totalTranslate}px)`;

      const marker = document.querySelector('.roulette-marker');
      marker.style.animation = "shake 0.1s infinite";
      setTimeout(() => marker.style.animation = "none", 4500);

      setTimeout(() => { finishSpin(choice, result, bet); }, 4500);
    }

    function finishSpin(choice, result, bet) {
      isSpinning = false;
      disableButtons(false);
      game.casinoHistory.unshift(result);
      if (game.casinoHistory.length > 10) game.casinoHistory.pop();
      renderHistory();

      let multiplier = 0;
      if (choice === result) {
        if (result === 'green') multiplier = 14;
        else multiplier = 2;
      }

      if (multiplier > 0) triggerWin(bet * multiplier);
      updateCasinoUI();
      saveGame();
    }

    /* --- PRO SLOTS ENGINE (5x3) FIXED --- */
    // MORE SYMBOLS ADDED
    const SLOT_SYMBOLS = ['👑', '💎', '7️⃣', '🎰', '🔔', '🍀', '🍉', '🍇', '🍊', '🍋', '🍒'];
    // Wild: 👑
    // High: 💎, 7️⃣, 🎰

    let slotState = {
      turbo: false,
      auto: false,
      spinning: false
    };

    function initProSlots() {
      const gridEl = document.getElementById('slotGrid');
      gridEl.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        let reelEl = document.createElement('div');
        reelEl.className = 'pro-reel';
        let strip = document.createElement('div');
        strip.className = 'reel-strip';
        strip.id = `pro-reel-${i}`;
        // Start Position set to 0 visually
        strip.style.transform = 'translateY(0px)';

        // Initial Symbols
        for (let j = 0; j < 3; j++) {
          let sym = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
          let div = document.createElement('div');
          div.className = 'slot-symbol';
          div.textContent = sym;
          strip.appendChild(div);
        }
        reelEl.appendChild(strip);
        gridEl.appendChild(reelEl);
      }
    }

    function toggleTurbo() {
      slotState.turbo = !slotState.turbo;
      const btn = document.getElementById('btnTurbo');
      if (slotState.turbo) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function toggleAuto() {
      slotState.auto = !slotState.auto;
      const btn = document.getElementById('btnAuto');
      if (slotState.auto) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function toggleSlotHelp() {
      const el = document.getElementById('slot-help-overlay');
      el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    function spinProSlots() {
      if (slotState.spinning) return;

      // Clear previous win lines and boxes
      document.getElementById('paylineSvg').innerHTML = '';
      document.getElementById('winDisplay').classList.remove('show');

      const bet = getBet();
      if (!bet) {
        slotState.auto = false;
        document.getElementById('btnAuto').classList.remove('active');
        return;
      }

      payBet(bet);
      updateCasinoUI();
      slotState.spinning = true;
      disableButtons(true);
      document.getElementById('btnSpinSlots').disabled = true;

      // 1. Determine Results
      let finalGrid = [];
      for (let i = 0; i < 5; i++) {
        let col = [];
        for (let r = 0; r < 3; r++) {

          // REAL CASINO PROBABILITIES
          let rnd = Math.random();
          let sym = '🍒'; // Fallback

          if (rnd < 0.015) sym = '👑';      // Wild (1.5% statt 0.1%) - Ab und zu sichtbar!
          else if (rnd < 0.04) sym = '💎';  // Diamant (2.5%)
          else if (rnd < 0.09) sym = '7️⃣';  // Seven (5%)
          else if (rnd < 0.15) sym = '🎰';  // Bar (6%)
          else if (rnd < 0.22) sym = '🔔';  // Glocke (7%)
          else if (rnd < 0.32) sym = '🍀';  // Klee (10%)
          else if (rnd < 0.45) sym = '🍉';  // Melone (13%)
          else if (rnd < 0.60) sym = '🍇';  // Traube (15%)
          else if (rnd < 0.75) sym = '🍊';  // Orange (15%)
          else if (rnd < 0.88) sym = '🍋';  // Zitrone (13%)
          else sym = '🍒';                  // Kirsche (Rest ~12%)

          col.push(sym);
        }
        finalGrid.push(col);
      }

      // 2. Animate Reels (Long Strip Method)
      // This ensures precise pixel alignment
      const SYMBOL_HEIGHT = 80;
      const SPINS = 20; // Number of fake symbols before result

      for (let i = 0; i < 5; i++) {
        const strip = document.getElementById(`pro-reel-${i}`);

        // Build a long strip: Current Symbols + Randoms + Final Result
        // We actually just replace the innerHTML with a long list ending in the result
        // To make it seamless, we usually keep the current visible ones at top, but for simplicity/robustness:
        // We just generate a long strip.

        let html = '';
        // Add random filler symbols
        for (let k = 0; k < SPINS; k++) {
          let s = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
          html += `<div class="slot-symbol">${s}</div>`;
        }
        // Add Result Symbols (Result is 3 rows. Row 0 is Top, Row 1 Middle, Row 2 Bottom)
        // The strip renders top-down. 
        html += `<div class="slot-symbol">${finalGrid[i][0]}</div>`;
        html += `<div class="slot-symbol">${finalGrid[i][1]}</div>`;
        html += `<div class="slot-symbol">${finalGrid[i][2]}</div>`;

        strip.innerHTML = html;

        // Reset Position to 0 (top of random strip)
        strip.style.transition = 'none';
        strip.style.transform = 'translateY(0px)';

        // Force Reflow
        strip.offsetHeight;

        // Animate to the bottom (showing the last 3 symbols)
        // Total symbols = SPINS + 3. 
        // We want the viewport (240px) to show the last 3.
        // So we translate up by SPINS * 80px.
        const targetY = -(SPINS * SYMBOL_HEIGHT);

        let duration = slotState.turbo ? 0.5 + (i * 0.1) : 1.5 + (i * 0.3);
        strip.style.transition = `transform ${duration}s cubic-bezier(0.25, 1, 0.5, 1)`;
        strip.style.transform = `translateY(${targetY}px)`;

        // On Finish
        if (i === 4) {
          setTimeout(() => {
            // Cleanup to just the 3 result symbols to save DOM memory
            // and check wins
            checkSlotWins(finalGrid, bet);
          }, duration * 1000);
        }
      }
    }

    function checkSlotWins(grid, bet) {
      slotState.spinning = false;
      disableButtons(false);
      document.getElementById('btnSpinSlots').disabled = false;

      // Clean up DOM (remove the long strip, keep only result)
      for (let i = 0; i < 5; i++) {
        const strip = document.getElementById(`pro-reel-${i}`);
        strip.style.transition = 'none';
        strip.innerHTML = '';
        // Create the 3 result divs
        for (let r = 0; r < 3; r++) {
          let d = document.createElement('div');
          d.className = 'slot-symbol';
          d.textContent = grid[i][r];
          strip.appendChild(d);
        }
        strip.style.transform = 'translateY(0px)';
      }

      // Paylines Definitions (Coordinates [col, row])
      const paylines = [
        [[0, 1], [1, 1], [2, 1], [3, 1], [4, 1]], // Middle
        [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0]], // Top
        [[0, 2], [1, 2], [2, 2], [3, 2], [4, 2]], // Bottom
        [[0, 0], [1, 1], [2, 2], [3, 1], [4, 0]], // V
        [[0, 2], [1, 1], [2, 0], [3, 1], [4, 2]]  // Inverted V
      ];

      let totalWin = 0;

      paylines.forEach((line, index) => {
        // Determine the "target symbol" for this line (first non-wild)
        let firstNonWild = null;
        for (let i = 0; i < 5; i++) {
          let s = grid[line[i][0]][line[i][1]];
          if (s !== '👑') { firstNonWild = s; break; }
        }
        // If all are wilds, treat as highest symbol
        let targetSymbol = firstNonWild || '💎';

        let matchCount = 0;
        for (let i = 0; i < 5; i++) {
          let sym = grid[line[i][0]][line[i][1]];
          if (sym === targetSymbol || sym === '👑') matchCount++;
          else break; // Line broken
        }

        if (matchCount >= 3) {
          // Determine value
          let s = targetSymbol;

          // Base Multipliers (3-of-a-kind)
          let base = 0;

          // LOW TIER (LOSS LEADERS)
          if (s === '🍒') base = 0.5;       // Kleiner Verlust statt fast Totalverlust
          else if (s === '🍋') base = 1;    // Geld zurück (Fairer)
          else if (s === '🍊') base = 1.5;  // Kleiner Gewinn
          else if (s === '🍇') base = 2.5;
          else if (s === '🍉') base = 4;

          // Mittlere Gewinne
          else if (s === '🍀') base = 6;
          else if (s === '🔔') base = 10;
          else if (s === '🎰') base = 15;

          // Jackpots
          else if (s === '7️⃣') base = 40;
          else if (s === '💎') base = 100; // Mega Jackpot

          // Bonus für längere Reihen
          if (matchCount === 4) base *= 2.5; // War vorher x5 (zu extrem, dafür Basis erhöht)
          if (matchCount === 5) base *= 10;  // War vorher x20


          totalWin += bet * base;

          // Calculate colors for line
          let colors = ['#e74c3c', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6'];
          drawPayline(line.slice(0, matchCount), colors[index % colors.length]);
        }
      });

      if (totalWin > 0) {
        triggerWin(totalWin);

        // Show Win Box
        const box = document.getElementById('winDisplay');
        document.getElementById('winAmountDisplay').textContent = formatNum(totalWin);
        box.classList.add('show');
        setTimeout(() => box.classList.remove('show'), 1500);
      }

      updateCasinoUI();
      saveGame();
    }

    function drawPayline(coords, color) {
      // SVG Coord mapping (500x240)
      // Col centers: 50, 150, 250... (20% steps of 500 = 100px width per col)
      // Row centers: 40, 120, 200 (80px height per row)

      const svg = document.getElementById('paylineSvg');
      let points = "";

      coords.forEach((c, i) => {
        let x = (c[0] * 100) + 50;
        let y = (c[1] * 80) + 40;
        points += `${x},${y} `;
      });

      const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
      poly.setAttribute("points", points);
      poly.setAttribute("fill", "none");
      poly.setAttribute("stroke", color);
      poly.setAttribute("stroke-width", "8");
      poly.setAttribute("stroke-linecap", "round");
      poly.setAttribute("stroke-linejoin", "round");
      poly.style.filter = "drop-shadow(0 0 5px " + color + ")";

      svg.appendChild(poly);
    }

    function triggerWin(amount) {
      addScore(amount);
      spawnConfetti();
      document.getElementById('casinoWindow').classList.add('win-pulse');
      setTimeout(() => document.getElementById('casinoWindow').classList.remove('win-pulse'), 500);
    }

    function renderHistory() {
      const con = document.getElementById('history-container'); con.innerHTML = '';
      game.casinoHistory.forEach(h => {
        const d = document.createElement('div'); d.className = `hist-dot hist-${h}`; con.appendChild(d);
      });
    }

    function disableButtons(disable) {
      document.querySelectorAll('.bet-btn, .control-btn, .close-btn, .nav-btn, .open-case-btn').forEach(b => b.disabled = disable);
    }
    function spawnConfetti() {
      const win = document.getElementById('casinoWindow');
      for (let i = 0; i < 30; i++) {
        const p = document.createElement('div'); p.className = 'win-particle';
        p.style.backgroundColor = ['#f1c40f', '#e74c3c', '#2ecc71', '#3498db'][Math.floor(Math.random() * 4)];
        p.style.left = '50%'; p.style.top = '50%';
        p.style.setProperty('--tx', (Math.random() * 400 - 200) + 'px');
        p.style.setProperty('--ty', (Math.random() * 400 - 200) + 'px');
        win.appendChild(p); setTimeout(() => p.remove(), 1000);
      }
    }

    /* --- UPGRADER LOGIC --- */
    function updateUpgraderCalc() {
      const bet = parseInt(document.getElementById('betAmount').value) || 0;
      let multi = parseFloat(document.getElementById('upgraderMulti').value) || 2.0;

      // Begrenzungen
      if (multi < 1.05) multi = 2;
      if (multi > 100) multi = 100;

      // Hausvorteil (5%)
      const houseEdge = 0.95;
      const winChance = (houseEdge / multi) * 100;

      // UI Update
      document.getElementById('upgrader-chance-display').textContent = winChance.toFixed(2) + "%";
      document.getElementById('upgrader-win-preview').textContent = formatNum(Math.floor(bet * multi));

      // Kreis Grafik Update (Wie viel vom Kreis ist grün?)
      const deg = (winChance / 100) * 360;
      const circle = document.getElementById('upgradeCircle');
      // Wir setzen CSS variable direkt
      circle.style.setProperty('--deg', deg + 'deg');
      circle.style.setProperty('--green', '#2ecc71'); // Reset Farbe auf Grün
    }

    // Wenn sich der Einsatz im Hauptfeld ändert, müssen wir auch die Vorschau updaten
    document.getElementById('betAmount').addEventListener('input', updateUpgraderCalc);


    function startUpgrade() {
      // 1. FIX: Verhindert Spammen, wenn bereits eine Drehung läuft
      if (isSpinning) return;

      const bet = getBet();
      if (!bet) return;

      let multi = parseFloat(document.getElementById('upgraderMulti').value);
      if (isNaN(multi) || multi < 2) { alert("Multiplikator ungültig (Min: 2x)"); return; }

      // Geld abziehen
      payBet(bet);
      updateCasinoUI();
      
      // Globaler Status setzen
      disableButtons(true);
      isSpinning = true;

      // 2. FIX: Den Button explizit deaktivieren (für visuelles Feedback)
      const btn = document.getElementById('btnUpgrade');
      btn.disabled = true;

      // Gewinnchance berechnen
      const houseEdge = 0.95;
      const winChance = (houseEdge / multi); // z.B. 0.475 für x2

      // RNG: Zufallszahl zwischen 0 und 1
      const result = Math.random();
      const isWin = result < winChance;

      // ANIMATION
      const circle = document.getElementById('upgradeCircle');

      // 1. Reset Rotation
      circle.style.transition = 'none';
      circle.style.transform = 'rotate(0deg)';

      // Force Reflow
      circle.offsetHeight;

      // 2. Spin!
      const winAngleRange = (winChance) * 360; // Größe des grünen Bereichs in Grad
      let targetRotation;

      if (isWin) {
        // Wir müssen in den grünen Bereich drehen.
        const randomWinDegree = Math.random() * winAngleRange;
        targetRotation = (5 * 360) - randomWinDegree + 360;
      } else {
        // Verlustbereich (der Rest des Kreises)
        const randomLossDegree = winAngleRange + (Math.random() * (360 - winAngleRange));
        targetRotation = (5 * 360) - randomLossDegree + 360;
      }

      circle.style.transition = 'transform 3s cubic-bezier(0.15, 0.9, 0.25, 1)';
      circle.style.transform = `rotate(${targetRotation}deg)`;

      setTimeout(() => {
        disableButtons(false);
        isSpinning = false;
        
        // 3. FIX: Button wieder aktivieren
        btn.disabled = false;

        if (isWin) {
          const winAmount = Math.floor(bet * multi);
          triggerWin(winAmount);
          // Visuelles Feedback: Kreis leuchtet
          circle.style.boxShadow = "0 0 50px #2ecc71";
          document.getElementById('upgrader-chance-display').textContent = "MACHER!";
          document.getElementById('upgrader-chance-display').style.color = "#2ecc71";
        } else {
          // Visuelles Feedback: Grau/Rot
          circle.style.setProperty('--green', '#555'); // Grün wird grau um Verlust zu zeigen
          document.getElementById('upgrader-chance-display').textContent = "NOOB!";
          document.getElementById('upgrader-chance-display').style.color = "#e74c3c";
        }

        updateCasinoUI();
        saveGame();

        // Reset Text nach kurzer Zeit
        setTimeout(() => {
          updateUpgraderCalc();
          document.getElementById('upgrader-chance-display').style.color = "#fff";
          circle.style.boxShadow = "0 0 30px rgba(0,0,0,0.5)";
        }, 2000);

      }, 3000);
    }

    /* --- SKINS SYSTEM (NEW) --- */
    function openSkins() {
      document.getElementById('skinModal').style.display = 'flex';
      renderInventory();
      document.getElementById('case-count').textContent = game.cases;

      renderCaseOddsUI();
      renderCaseContents(); // <--- HIER EINFÜGEN: Inhalt anzeigen

      // ... Rest der Funktion bleibt gleich ...

      // Reset Strip Visual
      const strip = document.getElementById('caseStrip');
      strip.innerHTML = '';
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';

      // Populate placeholder strip
      for (let i = 0; i < 5; i++) {
        const ph = SKINS.find(s => s.id === 'default');
        const el = document.createElement('div');
        el.className = 'case-item rarity-' + ph.rarity;
        el.innerHTML = `<img src="${ph.url}" style="filter:${ph.filter}">`;
        strip.appendChild(el);
      }
    }

    function closeSkins() {
      document.getElementById('skinModal').style.display = 'none';
    }

    function renderInventory() {
      const grid = document.getElementById('inventoryGrid');
      grid.innerHTML = '';

      let inventoryCount = {};
      game.skinsOwned.forEach(id => {
        inventoryCount[id] = (inventoryCount[id] || 0) + 1;
      });

      Object.keys(inventoryCount).forEach(skinId => {
        const skin = SKINS.find(s => s.id === skinId);
        if (!skin) return;

        const el = document.createElement('div');
        el.className = 'inv-slot rarity-' + skin.rarity;
        if (game.equippedSkin === skinId) el.classList.add('equipped');

        el.innerHTML = `
          <img src="${skin.url}" style="filter:${skin.filter}">
          ${inventoryCount[skinId] > 1 ? `<div class="count-badge">x${inventoryCount[skinId]}</div>` : ''}
        `;
        el.onclick = () => equipSkin(skinId);
        grid.appendChild(el);
      });
    }

    function renderCaseOddsUI() {
      const container = document.getElementById('case-odds-list');
      container.innerHTML = '';

      // Mapping für schöne Namen
      const names = {
        common: "Gewöhnlich",
        rare: "Selten",
        epic: "Episch",
        legendary: "Legendär",
        blackmarket: "SCHWARZMARKT" // <--- NEU
      };

      Object.keys(CASE_ODDS).forEach(rarity => {
        // Nur anzeigen, wenn Chance > 0
        if (CASE_ODDS[rarity] > 0) {
          const chance = (CASE_ODDS[rarity] * 100).toFixed(1); // z.B. 2.5
          // Prüfen, ob wir überhaupt Skins dieser Stufe haben (optional)
          const count = SKINS.filter(s => s.rarity === rarity).length;

          if (true) { // Immer anzeigen, damit man sieht was möglich ist
            const div = document.createElement('div');
            div.className = 'ci-row';
            div.innerHTML = `
              <span class="rarity-text-${rarity}" style="font-weight:bold;">${names[rarity] || rarity}</span>
              <span style="color:#fff;">${chance}%</span>
            `;
            container.appendChild(div);
          }
        }
      });
    }

    function renderCaseContents() {
      const container = document.getElementById('case-contents-grid');
      container.innerHTML = '';

      // Sortier-Reihenfolge definieren
      const rarityOrder = { 'common': 1, 'rare': 2, 'epic': 3, 'legendary': 4, 'blackmarket': 5 };

      // Skins kopieren und sortieren (damit Common vorne steht, Legendary hinten)
      const sortedSkins = [...SKINS].sort((a, b) => {
        return (rarityOrder[a.rarity] || 0) - (rarityOrder[b.rarity] || 0);
      });

      sortedSkins.forEach(skin => {
        const el = document.createElement('div');
        // Wir nutzen die existierenden CSS-Klassen für die farbigen Rahmen
        el.className = `cc-icon rarity-${skin.rarity}`;
        // Tooltip Name speichern
        el.setAttribute('data-name', skin.name);
        
        el.innerHTML = `<img src="${skin.url}" style="filter:${skin.filter}">`;
        container.appendChild(el);
      });
    }

    function equipSkin(id, mute = false) {
      const skin = SKINS.find(s => s.id === id);
      if (skin && game.skinsOwned.includes(id)) {
        game.equippedSkin = id;

        const big = document.getElementById('bigKlein');
        big.src = skin.url;
        big.style.filter = `drop-shadow(0 30px 60px rgba(0,0,0,0.5)) ${skin.filter}`;

        if (document.getElementById('skinModal').style.display === 'flex') {
          renderInventory();
        }
        if (!mute) saveGame();
      }
    }

    // Hilfsfunktion für echte Zufallsauswahl nach Gewichtung
    function pickSkinByRarity() {
  const rand = Math.random();
  let cumulative = 0;

  // HIER 'blackmarket' HINZUFÜGEN!
  const tiers = ['common', 'rare', 'epic', 'legendary', 'blackmarket']; 

  let selectedRarity = 'common'; 

  for (let tier of tiers) {
    cumulative += CASE_ODDS[tier] || 0;
    if (rand < cumulative) {
      selectedRarity = tier;
      break;
    }
  }

      // Alle Skins dieser Seltenheit finden
      const pool = SKINS.filter(s => s.rarity === selectedRarity);

      // Wenn es keine Skins dieser Seltenheit gibt, nimm Common
      if (pool.length === 0) return SKINS.find(s => s.rarity === 'common') || SKINS[0];

      // Zufälligen Skin aus dem Pool wählen
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function openCase() {
      if (game.cases <= 0 || isSpinning) return;
      game.cases--;
      document.getElementById('case-count').textContent = game.cases;

      isSpinning = true;
      disableButtons(true);

      // --- NEUE LOGIK HIER: ---
      let wonSkin = pickSkinByRarity();
      // ------------------------

      generateCaseStrip(60, wonSkin);

      const strip = document.getElementById('caseStrip');
      strip.offsetHeight;

      const itemWidth = 94;
      const targetIndex = 45;

      const positionOfWinner = (targetIndex * itemWidth) + 45;
      const jitter = Math.floor(Math.random() * 40) - 20;
      const totalTranslate = positionOfWinner + jitter;

      strip.style.transition = 'transform 5s cubic-bezier(0.12, 0.8, 0.1, 1)';
      strip.style.transform = `translateX(-${totalTranslate}px)`;

      setTimeout(() => {
        isSpinning = false;
        disableButtons(false);

        if (!game.skinsOwned.includes(wonSkin.id)) {
          game.skinsOwned.push(wonSkin.id);
          alert(`GEZOGEN: NEUER SKIN! ${wonSkin.name}`);
        } else {
          alert(`GEZOGEN: ${wonSkin.name} (Du besitzt diesen Skin bereits)`);
        }
        renderInventory();
        saveGame();
      }, 5000);
    }

    function generateCaseStrip(count, winner) {
      const strip = document.getElementById('caseStrip');
      strip.style.transition = 'none';
      strip.style.transform = 'translateX(0px)';
      strip.innerHTML = '';

      for (let i = 0; i < count; i++) {
        let item;
        if (i === 45) {
          item = winner;
        } else if (i === 44 || i === 46) {
          item = SKINS.find(s => s.id === 'default') || SKINS[0];
        } else {
          item = SKINS[Math.floor(Math.random() * SKINS.length)];
        }

        const el = document.createElement('div');
        el.className = `case-item rarity-${item.rarity}`;
        el.innerHTML = `<img src="${item.url}" style="filter:${item.filter}">`;
        strip.appendChild(el);
      }
    }

    /* --- CRASH GAME LOGIC (OPTIMIERT) --- */
let crashState = {
  running: false,
  crashed: false,
  cashedOut: false,
  startTime: 0,
  currentMulti: 1.00,
  crashPoint: 0,
  bet: 0,
  history: [],
  animFrame: null
};

// Canvas Setup
const cCanvas = document.getElementById('crashCanvas');
const ctx = cCanvas.getContext('2d');

function drawCrashGraph() {
  const w = cCanvas.width;
  const h = cCanvas.height;
  
  ctx.clearRect(0, 0, w, h);

  ctx.strokeStyle = "rgba(255,255,255,0.05)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let i=0; i<w; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
  for(let i=0; i<h; i+=50) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
  ctx.stroke();

  if (!crashState.running && !crashState.crashed) return;
  
  const timeElapsed = Date.now() - crashState.startTime;
  const progress = Math.min(timeElapsed / 10000, 1);
  
  ctx.beginPath();
  ctx.moveTo(0, h);
  
  const endX = w * progress;
  let normalizedY = (crashState.currentMulti - 1) / 10; 
  if(normalizedY > 0.9) normalizedY = 0.9;
  
  const endY = h - (normalizedY * h);

  ctx.quadraticCurveTo(endX / 2, h, endX, endY);
  
  ctx.strokeStyle = crashState.crashed ? "#e74c3c" : (crashState.cashedOut ? "#aaa" : "#8e44ad");
  ctx.lineWidth = 4;
  ctx.stroke();

  ctx.font = "30px Arial";
  ctx.fillText(crashState.crashed ? "💥" : "🚀", endX - 15, endY - 10);
  
  ctx.lineTo(endX, h);
  ctx.lineTo(0, h);
  ctx.fillStyle = crashState.crashed ? "rgba(231, 76, 60, 0.2)" : "rgba(142, 68, 173, 0.2)";
  ctx.fill();
}

function crashLoop() {
  if (!crashState.running) return;

  const now = Date.now();
  const timeElapsed = now - crashState.startTime;

  // Formel für Wachstum
  crashState.currentMulti = 1 + 0.00006 * timeElapsed + Math.pow(1.00015, timeElapsed) - 1;
  
  // UI Update (Text)
  const uiMulti = document.getElementById('crash-current-multi');
  if(uiMulti) uiMulti.textContent = crashState.currentMulti.toFixed(2) + "x";

  // WICHTIG: Performance Optimierung für den Button
  // Wir suchen das Span-Element für den Betrag und updaten NUR das.
  // Das verhindert, dass der Button neu gezeichnet wird und Klicks verliert.
  if(!crashState.cashedOut) {
     const currentWin = Math.floor(crashState.bet * crashState.currentMulti);
     const amountSpan = document.getElementById('crash-btn-amount');
     if (amountSpan) {
       amountSpan.textContent = formatNum(currentWin);
     }
  }

  // CRASH CHECK
  if (crashState.currentMulti >= crashState.crashPoint) {
    doCrash();
  } else {
    drawCrashGraph();
    crashState.animFrame = requestAnimationFrame(crashLoop);
  }
}

function crashAction() {
  // Verhindert Doppelklick-Auswahl und Fokus-Probleme
  const btn = document.getElementById('btnCrashAction');
  
  // STARTEN
  if (!crashState.running && !crashState.crashed) {
    const bet = getBet();
    if (!bet) return;
    
    crashState.bet = bet;
    payBet(bet);
    updateCasinoUI();
    disableButtons(true);
    btn.disabled = false;
    
    const r = Math.random();
    crashState.crashPoint = Math.max(1.00, Math.floor((0.96 / (1 - r)) * 100) / 100);
    
    crashState.running = true;
    crashState.crashed = false;
    crashState.cashedOut = false;
    crashState.startTime = Date.now();
    crashState.currentMulti = 1.00;
    
    document.getElementById('crash-current-multi').classList.remove('crashed-anim');
    document.getElementById('crash-current-multi').style.color = "#fff";
    document.getElementById('crash-status-text').textContent = "ROCKET FLYING...";
    
    btn.classList.add('btn-green');
    // HIER: Wir setzen das HTML EINMALIG. Im Loop ändern wir nur noch den Text in 'crash-btn-amount'.
    btn.innerHTML = `CASHOUT: <span id="crash-btn-amount" style="color:#2ecc71; pointer-events:none;">${formatNum(bet)}</span>`;
    
    crashLoop();
  }
  
  // CASHOUT (Sofortige Reaktion + Freigabe der UI)
  else if (crashState.running && !crashState.cashedOut) {
    crashState.cashedOut = true;
    const winAmount = Math.floor(crashState.bet * crashState.currentMulti);
    triggerWin(winAmount);
    
    const uiMulti = document.getElementById('crash-current-multi');
    uiMulti.style.color = "#2ecc71";
    document.getElementById('crash-status-text').textContent = "GEWONNEN!";
    
    btn.innerHTML = `GEWONNEN: ${formatNum(winAmount)}`;
    
    // --- HIER IST DER FIX ---
    
    // 1. Wir geben sofort alles wieder frei (Tabs, Schließen-Button)
    disableButtons(false);
    
    // 2. ABER: Wir sperren den Crash-Button sofort wieder manuell, 
    // damit man nicht in die laufende Runde reinfunken kann.
    btn.disabled = true;
    btn.style.cursor = "not-allowed";

    // ------------------------
    
    saveGame();
  }
}

    /* --- CRASH COOLDOWN LOGIC (FIXED) --- */
function startCrashCooldown() {
  // 1. ZUERST: Alles global freischalten (Tabs, Schließen, etc.)
  disableButtons(false);

  // 2. DANACH: Nur den Crash-Start-Button gezielt wieder sperren
  const btn = document.getElementById('btnCrashAction');
  btn.disabled = true;
  btn.style.background = "#333"; // Grau
  btn.style.cursor = "not-allowed";
  
  let timeLeft = 10;
  
  // Sofort anzeigen, damit man nicht 1 Sekunde warten muss
  btn.innerHTML = `⏳ COOLDOWN (${timeLeft}s)`;

  // Timer Funktion
  const timerInterval = setInterval(() => {
    timeLeft--;
    btn.innerHTML = `⏳ COOLDOWN (${timeLeft}s)`;

    // Wenn der User zwischendurch den Tab wechselt (z.B. zu Roulette), 
    // läuft der Timer im Hintergrund weiter.
    // Wenn er zurückkommt und der Timer < 0 ist, wird der Button grün.

    if (timeLeft < 0) {
      clearInterval(timerInterval);
      
      // Prüfen, ob wir noch im Crash Tab sind (nur Kosmetik)
      if(document.getElementById('view-crash').style.display !== 'none') {
         btn.disabled = false;
         btn.innerHTML = "STARTEN";
         btn.style.background = "linear-gradient(45deg, #8e44ad, #9b59b6)"; 
         btn.style.cursor = "pointer";
      } else {
         // Falls wir woanders sind, setzen wir den Status zurück, 
         // damit er beim nächsten Tab-Wechsel bereit ist.
         btn.disabled = false;
         btn.innerHTML = "STARTEN";
         btn.style.background = "linear-gradient(45deg, #8e44ad, #9b59b6)"; 
      }
      
      // State sicherstellen
      crashState.crashed = false; 
      updateCasinoUI();
    }
  }, 1000);
}

    function doCrash() {
  crashState.running = false;
  crashState.crashed = true;
  cancelAnimationFrame(crashState.animFrame);
  
  crashState.currentMulti = crashState.crashPoint;
  const uiMulti = document.getElementById('crash-current-multi');
  uiMulti.textContent = crashState.crashPoint.toFixed(2) + "x";
  uiMulti.classList.add('crashed-anim');
  
  document.getElementById('crash-status-text').textContent = "CRASHED!";
  drawCrashGraph();
  
  addCrashHistory(crashState.crashPoint);
  
  // HIER IST DIE ÄNDERUNG:
  setTimeout(() => {
    startCrashCooldown(); 
  }, 2000);
}

    function addCrashHistory(val) {
      crashState.history.unshift(val);
      if (crashState.history.length > 5) crashState.history.pop();
      
      const container = document.getElementById('crashHistory');
      container.innerHTML = '';
      crashState.history.forEach(v => {
        const div = document.createElement('div');
        const isHigh = v >= 2;
        div.className = `crash-hist-badge ${isHigh ? 'crash-hist-win' : 'crash-hist-loss'}`;
        div.textContent = v.toFixed(2) + "x";
        container.appendChild(div);
      });
    }
    
    /* --- MINES GAME LOGIC --- */
    let minesState = {
      active: false,
      mines: [],       // Array mit Indizes der Minen (0-24)
      revealed: [],    // Array mit Indizes der aufgedeckten Felder
      count: 3,        // Anzahl Minen
      bet: 0,
      currentMulti: 1.0
    };

    // Berechnet den Multiplikator basierend auf Wahrscheinlichkeit
function getMinesMultiplier(minesCount, revealedCount) {
  // HIER ÄNDERN:
  // 0.99 = Sehr fair (Casino gewinnt langfristig 1%)
  // 0.90 = Strenger (Casino gewinnt 10%) -> Multiplikatoren sinken deutlich
  // 0.85 = Sehr streng
  const houseEdge = 0.85; 
  
  // Wahrscheinlichkeitsrechnung
  let prob = 1;
  for (let i = 0; i < revealedCount + 1; i++) {
    prob *= (25 - minesCount - i) / (25 - i);
  }
  
  return (houseEdge / prob);
}

    function updateMinesUI() {
      const grid = document.getElementById('mines-grid');
      grid.innerHTML = '';
      
      for(let i=0; i<25; i++) {
        const tile = document.createElement('div');
        tile.className = 'mines-tile';
        
        // Wenn das Spiel läuft und Tile schon aufgedeckt ist
        if (minesState.revealed.includes(i)) {
          tile.classList.add('revealed-gem');
          tile.innerHTML = '💎'; 
        } 
        // Wenn Spiel vorbei ist und hier eine Mine war
        else if (!minesState.active && minesState.mines.includes(i)) {
           tile.classList.add('revealed-mine');
           tile.innerHTML = '💣';
           if(minesState.revealed.includes(i)) tile.style.backgroundColor = '#500'; 
        }
        else {
          tile.onclick = () => clickMineTile(i);
        }
        
        if(!minesState.active) tile.classList.add('disabled');
        grid.appendChild(tile);
      }

      // Buttons und Anzeigen holen
      const btn = document.getElementById('btnMinesAction');
      const nextMultiDisplay = document.getElementById('mines-next-multi');
      const currentMultiDisplay = document.getElementById('mines-current-multi');

      // --- ÄNDERUNG HIER START ---
      // Wir zeigen den Wert nur an, wenn das Spiel läuft UND mindestens 1 Feld aufgedeckt ist.
      // Ansonsten (am Start oder wenn noch nicht geklickt wurde) zeigen wir "/"
      if (minesState.active && minesState.revealed.length > 0) {
          currentMultiDisplay.textContent = minesState.currentMulti.toFixed(2) + "x";
          currentMultiDisplay.style.color = "#2ecc71"; // Grün bei aktivem Gewinn
      } else {
          currentMultiDisplay.textContent = "/";
          currentMultiDisplay.style.color = "#555"; // Ausgegraut / Neutral
      }
      // --- ÄNDERUNG HIER ENDE ---

      if (!minesState.active) {
        // --- STARTBILDSCHIRM ---
        btn.textContent = "SPIELEN";
        btn.classList.remove('btn-green'); 
        btn.style.background = "linear-gradient(45deg, #2ecc71, #27ae60)";
        
        // Vorschau auf den ersten Klick
        let nextM = getMinesMultiplier(minesState.count, 0);
        nextMultiDisplay.textContent = nextM.toFixed(2) + "x";
        
        document.getElementById('minesCountInput').disabled = false;
      } else {
        // --- SPIEL LÄUFT ---
        const currentWin = Math.floor(minesState.bet * minesState.currentMulti);
        
        // Wenn noch nichts aufgedeckt wurde, ist der Cashout einfach der Einsatz
        if (minesState.revealed.length === 0) {
             btn.textContent = "CASHOUT (Start)";
        } else {
             btn.textContent = `CASHOUT: ${formatNum(currentWin)}`;
        }
        
        btn.style.background = "linear-gradient(45deg, #f1c40f, #d35400)"; // Gold
        
        // Vorschau auf den NÄCHSTEN Klick
        let nextM = getMinesMultiplier(minesState.count, minesState.revealed.length);
        nextMultiDisplay.textContent = nextM.toFixed(2) + "x";
        
        document.getElementById('minesCountInput').disabled = true;
      }
    }

    function minesAction() {
      // STARTEN
      if (!minesState.active) {
        const bet = getBet();
        if (!bet) return;
        
        let count = parseInt(document.getElementById('minesCountInput').value);
        if(count < 1) count = 1; if(count > 24) count = 24;
        
        payBet(bet);
        updateCasinoUI();
        
        minesState.bet = bet;
        minesState.count = count;
        minesState.active = true;
        minesState.revealed = [];
        minesState.currentMulti = 1.0;
        
        // Minen platzieren
        minesState.mines = [];
        while(minesState.mines.length < count) {
          let r = Math.floor(Math.random() * 25);
          if(!minesState.mines.includes(r)) minesState.mines.push(r);
        }
        
        document.getElementById('mines-overlay').style.display = 'none';
        updateMinesUI();
      } 
      // CASHOUT
      else {
        // Nur auszahlen, wenn mindestens 1 Feld aufgedeckt wurde (optional, manche erlauben 0)
        if(minesState.revealed.length === 0) {
           // Sofort Cashout = Geld zurück (minus Hausvorteil, hier einfach 1:1)
           minesState.currentMulti = 1.0; 
        }
        
        const win = Math.floor(minesState.bet * minesState.currentMulti);
        triggerWin(win);
        
        minesState.active = false;
        
        const overlay = document.getElementById('mines-overlay');
        const txt = document.getElementById('mines-result-text');
        txt.textContent = `GEWONNEN: ${formatNum(win)}`;
        txt.style.color = "#2ecc71";
        overlay.style.display = 'flex';
        setTimeout(() => overlay.style.display = 'none', 2000);
        
        updateMinesUI();
        saveGame();
      }
    }

    function clickMineTile(index) {
      if (!minesState.active || minesState.revealed.includes(index)) return;

      // MINE GETROFFEN?
      if (minesState.mines.includes(index)) {
        // GAME OVER
        minesState.active = false;
        // Alles aufdecken
        minesState.revealed = []; // Reset für Anzeige damit alle Minen gezeigt werden
        
        const overlay = document.getElementById('mines-overlay');
        const txt = document.getElementById('mines-result-text');
        txt.textContent = "BOOM! VERLOREN";
        txt.style.color = "#e74c3c";
        overlay.style.display = 'flex';
        setTimeout(() => overlay.style.display = 'none', 2000);
        
        updateMinesUI(); // Zeigt jetzt alle Bomben
      } 
      // DIAMANT GETROFFEN
      else {
        minesState.revealed.push(index);
        
        // Multiplikator berechnen (basiert auf Anzahl aufgedeckter Felder)
        // Wir nehmen revealed.length - 1, weil die Formel den NÄCHSTEN berechnet
        let newMulti = getMinesMultiplier(minesState.count, minesState.revealed.length - 1);
        minesState.currentMulti = newMulti;
        
        // Check ob alle Diamanten gefunden (Auto-Win)
        if (minesState.revealed.length === (25 - minesState.count)) {
           minesAction(); // Auto Cashout
           return;
        }
        
        updateMinesUI();
      }
    }

    /* --- BLACKJACK LOGIC --- */
    const SUITS = ['♠', '♥', '♦', '♣'];
    const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

    let bjState = {
      active: false,
      deck: [],
      playerHand: [],
      dealerHand: [],
      bet: 0,
      turn: 'player' // 'player' or 'dealer'
    };

    function createDeck() {
      let deck = [];
      for(let s of SUITS) {
        for(let r of RANKS) {
          let val = parseInt(r);
          if(r === 'J' || r === 'Q' || r === 'K') val = 10;
          if(r === 'A') val = 11;
          deck.push({ rank: r, suit: s, val: val, color: (s === '♥' || s === '♦') ? 'red' : 'black' });
        }
      }
      // Fisher-Yates Shuffle
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function getHandValue(hand) {
      let val = 0;
      let aces = 0;
      hand.forEach(c => {
        val += c.val;
        if(c.rank === 'A') aces++;
      });
      while(val > 21 && aces > 0) {
        val -= 10;
        aces--;
      }
      return val;
    }

    function renderCard(card, hidden = false) {
      if(hidden) return `<div class="bj-card bj-card-hidden"></div>`;
      return `
        <div class="bj-card ${card.color}">
          <div class="bj-card-top">${card.rank}<br>${card.suit}</div>
          <div class="bj-card-mid">${card.suit}</div>
          <div class="bj-card-bot">${card.rank}<br>${card.suit}</div>
        </div>
      `;
    }

    function updateBjUI(revealDealer = false) {
      const pDiv = document.getElementById('player-hand');
      const dDiv = document.getElementById('dealer-hand');
      
      // Render Player
      pDiv.innerHTML = bjState.playerHand.map(c => renderCard(c)).join('');
      document.getElementById('player-score').textContent = getHandValue(bjState.playerHand);
      
      // Render Dealer
      dDiv.innerHTML = '';
      bjState.dealerHand.forEach((c, i) => {
        if(i === 0 && !revealDealer) dDiv.innerHTML += renderCard(c, true); // Erste Karte verdeckt
        else dDiv.innerHTML += renderCard(c);
      });
      
      if(revealDealer) {
        document.getElementById('dealer-score').textContent = getHandValue(bjState.dealerHand);
      } else {
        // Zeige nur Wert der offenen Karte(n)
        // Bei Start hat Dealer 2 Karten, Index 1 ist offen.
        let visibleVal = 0;
        for(let i=1; i<bjState.dealerHand.length; i++) {
            // Achtung: Ass logic hier vereinfacht für Vorschau
            visibleVal += bjState.dealerHand[i].val; 
            if(bjState.dealerHand[i].rank === 'A' && visibleVal > 21) visibleVal -= 10; // grob
        }
        document.getElementById('dealer-score').textContent = "?";
      }
    }

    function startBlackjack() {
      document.getElementById('bj-message').classList.remove('show');
      if(bjState.active) return;
      const bet = getBet();
      if(!bet) return;
      
      payBet(bet);
      updateCasinoUI();
      
      bjState.bet = bet;
      bjState.active = true;
      bjState.deck = createDeck();
      bjState.playerHand = [bjState.deck.pop(), bjState.deck.pop()];
      bjState.dealerHand = [bjState.deck.pop(), bjState.deck.pop()]; // Index 0 is hidden
      bjState.turn = 'player';
      
      document.getElementById('bj-message').textContent = "";
      document.getElementById('btn-bj-start').style.display = 'none';
      document.getElementById('bj-actions').style.display = 'flex';
      
      updateBjUI(false);
      
      // Instant Blackjack Check
      const pVal = getHandValue(bjState.playerHand);
      if(pVal === 21) {
        bjEndRound();
      }
    }

    function bjAction(action) {
      if(!bjState.active) return;
      
      if(action === 'hit') {
        bjState.playerHand.push(bjState.deck.pop());
        updateBjUI(false);
        if(getHandValue(bjState.playerHand) > 21) {
          bjEndRound(); // Bust
        }
      } 
      else if(action === 'stand') {
        bjState.turn = 'dealer';
        dealerPlay();
      }
      else if(action === 'double') {
        // HIER WAR DER FEHLER: Wir müssen prüfen, ob wir uns den Einsatz leisten können
        // Wir nutzen dafür einfach nochmal getBet(), aber tricksen etwas, 
        // indem wir den Wert im Input temporär ignorieren, oder wir prüfen manuell:
        
        let canAfford = false;
        if(casinoCurrency === 'kleinis' && game.score >= bjState.bet) canAfford = true;
        if(casinoCurrency === 'beers' && game.beers >= bjState.bet) canAfford = true;

        if(canAfford) {
          payBet(bjState.bet); // Abbuchen
          bjState.bet *= 2;
          updateCasinoUI();
          
          // Draw exactly one card
          bjState.playerHand.push(bjState.deck.pop());
          updateBjUI(false);
          
          if(getHandValue(bjState.playerHand) > 21) bjEndRound();
          else {
            bjState.turn = 'dealer';
            setTimeout(dealerPlay, 500);
          }
        } else {
          alert("Nicht genug Guthaben zum Doppeln!");
        }
      }
    }

    function dealerPlay() {
      updateBjUI(true); // Reveal hole card
      
      let dVal = getHandValue(bjState.dealerHand);
      
      // Dealer draws until 17
      const loop = () => {
        if(dVal < 17) {
          bjState.dealerHand.push(bjState.deck.pop());
          dVal = getHandValue(bjState.dealerHand);
          updateBjUI(true);
          setTimeout(loop, 800); // Verzögerung für Spannung
        } else {
          bjEndRound();
        }
      };
      
      setTimeout(loop, 800);
    }

    function bjEndRound() {
      bjState.active = false;
      updateBjUI(true); // Alles zeigen
      
      const pVal = getHandValue(bjState.playerHand);
      const dVal = getHandValue(bjState.dealerHand);
      const msg = document.getElementById('bj-message');
      
      let winMult = 0;
      let outcomeText = "";
      let outcomeColor = "#fff";
      
      // 1. Player Bust
      if(pVal > 21) {
        outcomeText = "BUST! VERLOREN";
        outcomeColor = "#e74c3c";
      }
      // 2. Blackjack (Natural)
      else if(pVal === 21 && bjState.playerHand.length === 2) {
         if(dVal === 21 && bjState.dealerHand.length === 2) {
           outcomeText = "PUSH (Unentschieden)";
           outcomeColor = "#ccc";
           winMult = 1; // Geld zurück
         } else {
           outcomeText = "BLACKJACK! (x2.5)";
           outcomeColor = "#f1c40f"; // Gold
           winMult = 2.5;
         }
      }
      // 3. Dealer Bust or Player High
      else if(dVal > 21 || pVal > dVal) {
        outcomeText = "GEWONNEN!";
        outcomeColor = "#2ecc71";
        winMult = 2;
      }
      // 4. Tie
      else if(dVal === pVal) {
        outcomeText = "PUSH (Geld zurück)";
        outcomeColor = "#ccc";
        winMult = 1;
      }
      // 5. Dealer Wins
      else {
        outcomeText = "DEALER GEWINNT";
        outcomeColor = "#e74c3c";
      }
      
      // Basis-Text setzen
      msg.textContent = outcomeText;
      msg.style.color = outcomeColor;

      // Gewinn berechnen und anzeigen
      if(winMult > 0) {
        const winAmount = Math.floor(bjState.bet * winMult);
        triggerWin(winAmount); 
        
        // HIER IST DER NEUE TEIL: Betrag unter den Text schreiben
        // Wir nutzen innerHTML += um eine neue Zeile anzuhängen
        msg.innerHTML += `<div style="font-size:0.6em; margin-top:8px; color:#fff;">+${formatNum(winAmount)}</div>`;

        // Konfetti bei echtem Gewinn (mehr als Geld zurück)
        if(winMult > 1) {
            spawnConfetti(); 
            document.getElementById('casinoWindow').classList.add('win-pulse');
            setTimeout(() => document.getElementById('casinoWindow').classList.remove('win-pulse'), 500);
        }
      }
      
      // Nachricht sichtbar machen (.show Klasse muss im CSS existieren, wie vorhin besprochen)
      msg.classList.add('show');
      
      updateCasinoUI();
      saveGame();
      
      // Reset UI Controls
      document.getElementById('bj-actions').style.display = 'none';
      document.getElementById('btn-bj-start').style.display = 'block';
    }

    /* --- INTERACTIONS --- */
    const bigKlein = document.getElementById('bigKlein');
    bigKlein.addEventListener('mousedown', (e) => handleInteraction(e.clientX, e.clientY));
    bigKlein.addEventListener('touchstart', (e) => { e.preventDefault(); for (let i = 0; i < e.touches.length; i++) handleInteraction(e.touches[i].clientX, e.touches[i].clientY); });
    function handleInteraction(x, y) {
      // --- NEU: HIER BLOCKIEREN WIR ZU SCHNELLE KLICKS ---
      clickCountSec++;
      // Wenn mehr als 25 Klicks pro Sekunde -> Abbruch (Ignorieren)
      if (clickCountSec > 25) return; 
      // ---------------------------------------------------

      const power = getClickPower(); addScore(power); game.clicks++;
      
      // ... (hier geht der alte Code weiter: clickHistory.push, etc.)
      clickHistory.push({ time: performance.now(), val: power });

      spawnFloatingText(x, y, `+${formatNum(power)} Kleini${power != 1 ? 's' : ''}`); spawnFallingFace(x, y);

      bigKlein.style.transform = "scale(0.94)"; setTimeout(() => bigKlein.style.transform = "scale(1)", 50);
    }
    function spawnFloatingText(x, y, text) {
      const el = document.createElement('div'); el.className = 'click-text'; el.textContent = text;
      el.style.left = (x - 20 + Math.random() * 40) + 'px'; el.style.top = y + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 800);
    }
    function spawnFallingFace(x, y) {
      const currentSkin = SKINS.find(s => s.id === game.equippedSkin) || SKINS[0];
      const img = document.createElement('img');
      img.src = currentSkin.url;
      img.className = 'falling-face';
      img.style.filter = currentSkin.filter;
      img.style.left = (x - 17) + 'px'; img.style.top = (y - 17) + 'px'; document.getElementById('clickPanel').appendChild(img); setTimeout(() => img.remove(), 1200);
    }

    // UPDATED FORMAT NUM (Handles up to Sextillions)
    // UPDATED FORMAT NUM (Fix für wackelnde Zahlen)
function formatNum(num, decimals = 0) {
  // Wenn die Zahl klein ist (unter 1 Million)
  if (num < 1000000) {
    return num.toLocaleString('de-DE', { 
      maximumFractionDigits: decimals,
      minimumFractionDigits: decimals // Erzwingt Nullen auch bei kleinen Zahlen, falls gewünscht
    });
  }

  const units = [
    { val: 1e36, suffix: " Sext" },
    { val: 1e33, suffix: " Quintd" },
    { val: 1e30, suffix: " Quint" },
    { val: 1e27, suffix: " Quard" },
    { val: 1e24, suffix: " Quad" },
    { val: 1e21, suffix: " Trd" },
    { val: 1e18, suffix: " Trio" },
    { val: 1e15, suffix: " Brd" },
    { val: 1e12, suffix: " Bio" },
    { val: 1e9, suffix: " Mrd" },
    { val: 1e6, suffix: " Mio" }
  ];

  for (const unit of units) {
    if (num >= unit.val) {
      // HIER IST DER FIX:
      // Wir setzen 'minimumFractionDigits' auf 2.
      // Das macht aus "80,1" -> "80,10" und das Wackeln hört auf.
      return (num / unit.val).toLocaleString('de-DE', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }) + unit.suffix;
    }
  }
  return num.toExponential(2);
}

    /* --- SHOP --- */
    function getBuildingCost(i) { return Math.floor(BUILDINGS[i].baseCost * Math.pow(1.15, game.buildings[i])); }
    function buyBuilding(i) {
      const cost = getBuildingCost(i);
      if (game.score >= cost) {
        game.score -= cost;
        game.buildings[i]++;
        updateSingleBuildingUI(i);
        renderUpgrades();
        if (visualElements.length < MAX_VISUALS) spawnVisualIcon(BUILDINGS[i].icon);
      }
    }
    function buildBuildingUI() {
      const list = document.getElementById('buildingList'); list.innerHTML = '';
      BUILDINGS.forEach((b, i) => {
        const el = document.createElement('div'); el.className = 'building-row'; el.id = `build-row-${i}`; el.onclick = () => buyBuilding(i);
        el.innerHTML = `<div class="b-icon">${b.icon}</div><div class="b-info"><div class="b-name">${b.name}</div><div class="b-cps" id="b-cps-${i}">Prod: ...</div><div class="b-cost"><span id="cost-${i}">0 Kleinis</span> <span id="gain-${i}" style="color:#2ecc71; font-size:0.8rem; margin-left:6px; font-weight:normal;"></span></div></div><div class="b-count" id="count-${i}">0</div>`;
        list.appendChild(el); updateSingleBuildingUI(i);
      });
    }
    function updateSingleBuildingUI(i) {
      document.getElementById(`count-${i}`).textContent = game.buildings[i];
      document.getElementById(`cost-${i}`).textContent = formatNum(getBuildingCost(i)) + " Kleinis";

      const realCps = getBuildingCPS(i);
      document.getElementById(`b-cps-${i}`).textContent = `Prod: ${formatNum(realCps, 1)}/s`;
      document.getElementById(`gain-${i}`).textContent = `(+${formatNum(realCps, 1)} CPS)`;
    }
    function updateBuildingStates() {
      BUILDINGS.forEach((b, i) => {
        const row = document.getElementById(`build-row-${i}`);
        const costDiv = row.querySelector('.b-cost');

        if (game.score >= getBuildingCost(i)) {
          row.classList.add('can-afford');
          costDiv.classList.add('affordable');
        } else {
          row.classList.remove('can-afford');
          costDiv.classList.remove('affordable');
        }
      });
    }

    /* --- UPGRADES --- */
    function buyUpgrade(uId) {
      const u = UPGRADES.find(x => x.id === uId);
      if (game.score >= u.cost) { game.score -= u.cost; game.upgrades.push(uId); renderUpgrades(); hideTooltip(); }
    }
    function showTooltip(u) {
      ttName.textContent = u.name; ttPrice.textContent = formatNum(u.cost) + " Kleinis";
      ttPrice.className = game.score >= u.cost ? 'tt-price affordable' : 'tt-price expensive';
      ttEffect.textContent = "Effekt: " + u.text; ttDesc.textContent = u.desc;
      let statsHTML = '';
      if (u.type === 'build') {
        const bIdx = u.target; const count = game.buildings[bIdx];
        const currentMulti = getBuildingMultiplier(bIdx);
        const base = BUILDINGS[bIdx].baseCps;
        const currentSingleCPS = base * currentMulti;
        const newSingleCPS = currentSingleCPS * u.multi;
        const totalGain = (newSingleCPS - currentSingleCPS) * count;
        statsHTML = `<div class="stat-line"><span>Einzeln:</span><span>${formatNum(currentSingleCPS, 1)} ➜ <span style="color:#2ecc71">${formatNum(newSingleCPS, 1)}</span></span></div><div class="stat-highlight">+${formatNum(totalGain, 1)} CPS Gesamt</div>`;
      } else { statsHTML = `<div class="stat-highlight">Klickstärke wird verdoppelt!</div>`; }
      ttStats.innerHTML = statsHTML; tooltipEl.style.display = 'block';
    }
    function hideTooltip() { tooltipEl.style.display = 'none'; }
    function renderUpgrades() {
      const container = document.getElementById('upgradeGrid'); container.innerHTML = '';
      const available = UPGRADES.filter(u => {
        if (game.upgrades.includes(u.id)) return false;
        if (u.trigger.type === 'clicks' && game.clicks >= u.trigger.val) return true;
        if (u.trigger.type === 'build' && game.buildings[u.trigger.id] >= u.trigger.val) return true;
        return false;
      });
      available.forEach(u => {
        const div = document.createElement('div'); div.className = 'upgrade-crate'; div.innerHTML = u.icon;
        div.onmouseenter = () => showTooltip(u); div.onmouseleave = () => hideTooltip();
        if (game.score >= u.cost) { div.onclick = () => buyUpgrade(u.id); }
        else { div.style.opacity = 0.5; div.style.filter = "grayscale(1)"; }
        container.appendChild(div);
      });
    }

    /* --- GOLDEN --- */
    function updateBuffs(dt) { if (buffs.frenzy.active) { buffs.frenzy.time -= dt; if (buffs.frenzy.time <= 0) { buffs.frenzy.active = false; renderBuffs(); } } }
    function renderBuffs() { document.getElementById('buffArea').innerHTML = buffs.frenzy.active ? `<div class="buff-icon">🔥</div>` : ''; }
    function scheduleGolden() { const delay = (Math.random() * 600000) + 600000; setTimeout(spawnGolden, delay); }
    function spawnGolden() {
      const g = document.getElementById('goldenKlein');
      const maxX = document.getElementById('clickPanel').offsetWidth - 80; const maxY = document.getElementById('clickPanel').offsetHeight - 80;
      g.style.left = Math.random() * maxX + 'px'; g.style.top = Math.random() * maxY + 'px'; g.style.display = 'block';
      setTimeout(() => { if (g.style.display === 'block') { g.style.display = 'none'; scheduleGolden(); } }, 10000);
    }
    document.getElementById('goldenKlein').onmousedown = function (e) {
      e.stopPropagation(); this.style.display = 'none'; buffs.frenzy.active = true; buffs.frenzy.time = 30; renderBuffs();
      spawnFloatingText(parseInt(this.style.left), parseInt(this.style.top), "FRENZY! (x7 CPS)"); scheduleGolden();
    };

    /* --- SAVE --- */
    function saveGame() {
  game.lastLogin = Date.now(); 
  
  // Sicherheitscheck vor dem Speichern
  if (typeof game.beers === 'undefined') game.beers = 0;
  if (typeof game.lastDailyBonus === 'undefined') game.lastDailyBonus = 0;

  const data = {
    score: game.score,
    totalScore: game.totalScore,
    clicks: game.clicks,
    clickLevel: game.clickLevel,
    buildings: game.buildings,
    upgrades: game.upgrades,
    casinoHistory: game.casinoHistory,
    playerName: game.playerName,
    prestige: game.prestige || 0,
    cases: game.cases,
    skinsOwned: game.skinsOwned,
    equippedSkin: game.equippedSkin,
    lastLogin: game.lastLogin,
    
    // WICHTIG: Diese beiden müssen explizit hier stehen!
    beers: game.beers,
    lastDailyBonus: game.lastDailyBonus,
    hasClaimedRetroBeers: game.hasClaimedRetroBeers,
  };
  
  // Speichern als Base64 String
  localStorage.setItem(SAVE_KEY, btoa(JSON.stringify(data)));
}
    
    function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    var saved;
    
    // Prüfen ob Daten da sind
    if (raw) {
        if (raw.startsWith("{")) {
           saved = JSON.parse(raw);
        } else {
           saved = JSON.parse(atob(raw));
        }
    }

    if (saved) {
      // 1. Lädt AUTOMATISCH alle gespeicherten Werte (Score, Clicks, etc.)
      Object.keys(saved).forEach(key => {
        game[key] = saved[key];
      });
      
      // 2. Sicherheits-Check für neue Währung (falls es ein alter Spielstand ist)
      if (typeof game.beers === 'undefined') game.beers = 0;
      if (typeof game.lastDailyBonus === 'undefined') game.lastDailyBonus = 0;
      
      // 3. Fix für Gebäude, falls du neue hinzugefügt hast
      if (game.buildings.length < BUILDINGS.length) {
          const diff = BUILDINGS.length - game.buildings.length;
          for (let i = 0; i < diff; i++) game.buildings.push(0);
      }
    }
  } catch(e) { 
    console.log("Save error or new game", e); 
  }
      // --- NACHZAHLUNG FÜR BEREITS ERREICHTE PRESTIGE LEVEL ---
    // Wir prüfen: Hat er Prestige > 0? Hat er die Nachzahlung noch NICHT bekommen?
    if (game.prestige > 0 && !game.hasClaimedRetroBeers) {
      
      // Hier legen wir fest, wie viel man rückwirkend pro Level kriegt (z.B. 50)
      const retroRate = 25; 
      const retroAmount = game.prestige * retroRate;
      
      if (!game.beers) game.beers = 0;
      game.beers += retroAmount;
      
      // Markieren, dass wir bezahlt haben (damit man es nicht bei jedem Neuladen kriegt)
      game.hasClaimedRetroBeers = true;
      
      saveGame();
      
      // Kurze Info an den Spieler
      setTimeout(() => {
        alert(`🍻 TREUE-BONUS! 🍻\n\nDa du schon Prestige-Level ${game.prestige} bist, erhältst du nachträglich:\n+${retroAmount} Bierchen gutgeschrieben!`);
        updateCasinoUI(); // Anzeige aktualisieren
      }, 1000);
    }
}

    /* --- PRESTIGE LOGIK --- */
    function calculatePotentialPrestige() {
      if (game.totalScore < 100000000) return 0;
      return Math.floor(Math.pow(game.totalScore / 100000000, 0.25));
    }

    function openPrestige() {
      const current = game.prestige;
      const potentialTotal = calculatePotentialPrestige();
      const gain = potentialTotal - current;

      if (gain <= 0 && current === 0) return;

      document.getElementById('modal-current-prestige').textContent = formatNum(current);
      document.getElementById('modal-new-prestige').textContent = formatNum(potentialTotal);
      document.getElementById('modal-gain-prestige').textContent = formatNum(gain);
      document.getElementById('modal-gain-cases').textContent = formatNum(gain);

      const btn = document.getElementById('confirmPrestigeBtn');
      if (gain > 0) {
        btn.disabled = false;
        btn.innerHTML = `RESET & +${formatNum(gain)} LEVEL`;
        btn.style.opacity = "1";
      } else {
        btn.disabled = true;
        btn.innerHTML = "Du brauchst mehr Score!";
        btn.style.opacity = "0.5";
      }

      document.getElementById('prestigeModal').style.display = 'flex';
    }

    function closePrestige() {
      document.getElementById('prestigeModal').style.display = 'none';
    }


    function checkPrestigeUnlock() {
      const potential = calculatePotentialPrestige();
      const gain = potential - game.prestige;
      const btn = document.getElementById('prestigeBtn');

      if (gain > 0) {
        btn.style.display = 'block';
        btn.classList.add('win-pulse');
        btn.innerHTML = `🚀 AUFSTEIGEN (+${gain} Level)`;
      } else {
        btn.style.display = 'none';
      }

      const badge = document.getElementById('prestige-badge');
      if (game.prestige > 0 || game.totalScore > 10000) {
        badge.style.display = 'block';
        const currentProgressRank = Math.max(game.prestige, potential);
        const nextTargetRank = currentProgressRank + 1;

        const scoreNeededForNext = Math.pow(nextTargetRank, 4) * 100000000;
        const scoreForCurrent = Math.pow(currentProgressRank, 4) * 100000000;

        const remaining = scoreNeededForNext - game.totalScore;
        const totalDistance = scoreNeededForNext - scoreForCurrent;
        const coveredDistance = game.totalScore - scoreForCurrent;
        let percent = (coveredDistance / totalDistance) * 100;
        if (percent < 0) percent = 0;
        if (percent > 100) percent = 100;

        document.getElementById('prestige-level-display').textContent = formatNum(game.prestige);
        document.getElementById('prestige-bonus-display').textContent = formatNum(game.prestige * 5);
        document.getElementById('prestige-progress-bar').style.width = percent + "%";

        if (remaining > 0) {
          document.getElementById('prestige-next-req').textContent = formatNum(remaining) + " Kleinis";
        } else {
          document.getElementById('prestige-next-req').textContent = "Bereit zum Aufstieg!";
        }
      }
    }

    /* --- LEADERBOARD LOGIC --- */
    function openLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'flex';
      fetchLeaderboard();
    }

    function closeLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'none';
    }

    function fetchLeaderboard() {
      const list = document.getElementById('lb-list');
      if (!dbRef) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Firebase nicht konfiguriert!<br><span style="font-size:0.8rem; color:#aaa;">Öffne index.html und füge deine Keys ein.</span></div>';
        return;
      }

      list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Lade...</div>';

      dbRef.orderByChild('beers').limitToLast(20).once('value').then(snapshot => {
        const scores = [];
        snapshot.forEach(child => {
          scores.push(child.val());
        });
        renderLeaderboard(scores.reverse());
      }).catch(err => {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Fehler beim Laden :(</div>';
      });
    }

    function renderLeaderboard(scores) {
      const list = document.getElementById('lb-list');
      list.innerHTML = '';

      if (scores.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px;">Noch keine Spieler. Sei der Erste!</div>';
        return;
      }

      scores.forEach((s, index) => {
        const rank = index + 1;
        let rankClass = 'lb-rank';
        if (rank === 1) rankClass += ' top-1';
        if (rank === 2) rankClass += ' top-2';
        if (rank === 3) rankClass += ' top-3';

        const el = document.createElement('div');
        el.className = 'lb-entry';
        el.innerHTML = `
      <div class="${rankClass}">#${rank}</div>
      <div class="lb-name">${s.name}</div>
      <div class="lb-score" style="color:#f1c40f;">${formatNum(s.beers || 0)} 🍺</div>
    `;
        list.appendChild(el);
      });
    }
    init();
  /* --- TOP PLAYER DISPLAY LOGIC --- */
function updateTopPlayer() {
  if (!dbRef) return;

  // Wir holen uns den EINEN höchsten Eintrag (sortiert nach Prestige)
  dbRef.orderByChild('beers').limitToLast(1).once('value')
    .then(snapshot => {
      const val = snapshot.val();
      if (val) {
        const keys = Object.keys(val);
        const topKey = keys[0];
        const topData = val[topKey];
        
        const el = document.getElementById('top-player-display');
        
        // Text setzen: Name + Prestige Level
        el.innerHTML = `👑 Platz 1: ${topData.name} <span style="font-size:0.8em; color:#f1c40f;">(${formatNum(topData.beers || 0)} 🍺)</span>`;
      }
    })
    .catch(err => console.log("Top Player fetch error", err));
}

// Startet die Abfrage
setTimeout(() => {
  updateTopPlayer(); // Einmal sofort nach Start (verzögert)
  setInterval(updateTopPlayer, 10000); // Dann alle 10 Sekunden aktualisieren
}, 2000);
  
    // --- MINES PREVIEW LISTENER ---
    // Aktualisiert den Multiplikator sofort bei Eingabe
    const minesInput = document.getElementById('minesCountInput');
    
    if (minesInput) {
      minesInput.addEventListener('input', function() {
        let val = parseInt(this.value);
        
        // Begrenzung einhalten (1 bis 24)
        if (isNaN(val) || val < 1) val = 1;
        if (val > 24) val = 24;
  
        // Sofortige Berechnung des nächsten Multis (0 Felder aufgedeckt)
        // Wir nutzen deine getMinesMultiplier Funktion
        let nextM = getMinesMultiplier(val, 0);
        
        document.getElementById('mines-next-multi').textContent = nextM.toFixed(2) + "x";
      });
    }
  /* --- CRAZY WHEEL LOGIC --- */

// Segmente (54 Stück)
const CT_SEGMENTS = [
  'crazy', '1', '2', '5', '1', '2', '1', 'cash', '1', '2', '5', '1', '2', 'coin', 
  '1', '2', '1', 'pachinko', '1', '2', '5', '1', '2', 'coin', '1', '2', '1', 
  'cash', '1', '2', '5', '1', '2', 'coin', '1', '2', '1', 'pachinko', '1', '2', 
  '5', '1', '2', 'coin', '1', '2', '1', '10', '1', '2', '5', '1', '2', '10', '1'
];

// Farben angepasst an das echte Crazy Time Bild
const CT_COLORS = {
  '1': '#2980b9',      // Blau
  '2': '#f1c40f',      // Gelb
  '5': '#e91e63',      // Pink
  '10': '#8e44ad',     // Lila
  'coin': '#1c2833',   // Dunkelblau (Coinflip)
  'pachinko': '#9b59b6', // Magenta
  'cash': '#27ae60',   // Grün
  'crazy': '#c0392b'   // Rot
};

let ctState = {
  bets: { '1':0, '2':0, '5':0, '10':0, 'coin':0, 'pachinko':0, 'cash':0, 'crazy':0 },
  totalBet: 0,
  spinning: false,
  rotation: 0,
  topSlot: { target: null, multi: 1 }
};

function initCrazyWheel() {
  const wheel = document.getElementById('crazy-wheel');
  if(!wheel) return;
  wheel.innerHTML = ''; 

  // Logo in die Mitte
  const logo = document.createElement('div');
  logo.className = 'wheel-center-logo';
  logo.innerHTML = '🤪'; 
  wheel.appendChild(logo);

  let gradientParts = [];
  const count = 54;
  const degPerSeg = 360 / count; // Exakt 6.66666... Grad
  
  // Wir erstellen alles in EINER Schleife, damit es synchron ist
  for (let i = 0; i < count; i++) {
    const segType = CT_SEGMENTS[i];
    
    // 1. Winkel berechnen
    const startDeg = i * degPerSeg;
    const endDeg = (i + 1) * degPerSeg;
    const centerDeg = startDeg + (degPerSeg / 2);

    // 2. Hintergrund-Teil für CSS Gradient speichern
    // WICHTIG: Harte Kanten definieren! "Farbe StartGrad EndGrad"
    gradientParts.push(`${CT_COLORS[segType]} ${startDeg}deg ${endDeg}deg`);

    // 3. Trennlinie (Rechts vom Segment)
    // Die Linie muss genau am Ende des Segments sitzen
    const separator = document.createElement('div');
    separator.className = 'wheel-separator';
    separator.style.transform = `rotate(${endDeg}deg)`; 
    wheel.appendChild(separator);

    // 4. Text (Mitte des Segments)
    const textEl = document.createElement('div');
    textEl.className = 'wheel-text';
    
    let label = segType;
    let specialClass = '';
    
    if(segType === 'coin') { label = 'COIN<br>FLIP'; specialClass = 'wt-coin'; }
    else if(segType === 'pachinko') { label = 'PACH<br>INKO'; specialClass = 'wt-pachinko'; }
    else if(segType === 'cash') { label = 'CASH<br>HUNT'; specialClass = 'wt-cash'; }
    else if(segType === 'crazy') { label = 'CRAZY<br>TIME'; specialClass = 'wt-crazy'; }
    
    textEl.innerHTML = label;
    if(specialClass) textEl.classList.add(specialClass);
    
    if(!specialClass) {
        textEl.style.color = "#fff";
        if(segType === '2') textEl.style.color = "#000"; 
        textEl.style.fontSize = "1rem";
    }

    textEl.style.transform = `rotate(${centerDeg}deg)`;
    wheel.appendChild(textEl);
  }
  
  // 5. Den perfekten Gradient setzen
  const gradientString = "conic-gradient(" + gradientParts.join(", ") + ")";
  wheel.style.background = gradientString;
  
  // Initialen Reset sicherstellen
  wheel.style.transform = 'rotate(0deg)';
}

function ctBet(type) {
  if(ctState.spinning) return;
  const baseBet = getBet(); 
  if(!baseBet) return;
  
    payBet(baseBet);
    ctState.bets[type] += baseBet;
    ctState.totalBet += baseBet;
    updateCasinoUI();
    updateCtUI();
  
}

function ctClearBets() {
  if(ctState.spinning) return;
  for(let key in ctState.bets) {
    if(casinoCurrency === 'kleinis') game.score += ctState.bets[key]; else game.beers += ctState.bets[key];
    ctState.bets[key] = 0;
  }
  ctState.totalBet = 0;
  updateCasinoUI();
  updateCtUI();
}

function updateCtUI() {
  for(let key in ctState.bets) {
    const el = document.getElementById(`ct-bet-${key}`);
    if(el) el.textContent = formatNum(ctState.bets[key]);
  }
  const total = document.getElementById('ct-total-bet');
  if(total) total.textContent = formatNum(ctState.totalBet);
}

function spinCrazyWheel() {
  if(ctState.spinning || ctState.totalBet === 0) {
    if(ctState.totalBet === 0) alert("Bitte erst wetten!");
    return;
  }

  ctState.spinning = true;
  disableButtons(true);
  
  runTopSlot().then(() => {
    setTimeout(startWheelPhysics, 500);
  });
}

function runTopSlot() {
  return new Promise(resolve => {
    const slotTarget = document.getElementById('ct-slot-target');
    const slotMulti = document.getElementById('ct-slot-multi');
    
    let spins = 0;
    let interval = setInterval(() => {
      const types = ['1','2','5','10','coin','pachinko','cash','crazy'];
      const rndType = types[Math.floor(Math.random() * types.length)];
      const rndMulti = [2, 3, 4, 5, 10, 20, 50][Math.floor(Math.random() * 7)];
      
      slotTarget.textContent = getCtIcon(rndType);
      slotMulti.textContent = rndMulti + "x";
      spins++;
      
      if(spins > 20) {
        clearInterval(interval);
        const finalType = types[Math.floor(Math.random() * types.length)];
        const finalMulti = [2, 3, 4, 5, 10, 15, 20, 25, 50][Math.floor(Math.random() * 9)];
        
        ctState.topSlot = { target: finalType, multi: finalMulti };
        slotTarget.textContent = getCtIcon(finalType);
        slotMulti.textContent = finalMulti + "x";
        
        const btn = document.querySelector(`.btn-${finalType}`);
        if(btn) btn.classList.add('active-slot-boost');
        
        resolve();
      }
    }, 100);
  });
}

function getCtIcon(type) {
  if(type === '1') return '1️⃣'; // Blau
  if(type === '2') return '2️⃣'; // Gelb
  if(type === '5') return '5️⃣'; // Pink
  if(type === '10') return '🔟'; // Lila
  if(type === 'coin') return '🪙';
  if(type === 'pachinko') return '🟣';
  if(type === 'cash') return '🎯';
  if(type === 'crazy') return '🤪';
  return type;
}

/* --- ERSETZE DIE ALTE startWheelPhysics FUNKTION DAMIT: --- */

function startWheelPhysics() {
  const wheel = document.getElementById('crazy-wheel');

  // 1. State Check
  if (typeof ctState.rotation === 'undefined') {
    ctState.rotation = 0;
  }

  // 2. HARD RESET (Animation aus, zeichnen, Animation an)
  wheel.style.transition = 'none';
  wheel.style.transform = `rotate(${ctState.rotation}deg)`;
  void wheel.offsetWidth; // Force Reflow

  // 3. Ziel-Berechnung
  const segmentIndex = Math.floor(Math.random() * 54);
  const winningSegment = CT_SEGMENTS[segmentIndex];
  
  const count = 54;
  const degPerSeg = 360 / count;
  
  // Wo fängt das Feld an, wo hört es auf?
  const segStart = segmentIndex * degPerSeg;
  const segEnd = (segmentIndex + 1) * degPerSeg;
  
  // SICHERHEITS-ZONE: Wir halten 1 Grad Abstand zu den Linien
  const safeStart = segStart + 1.0;
  const safeEnd = segEnd - 1.0;
  
  // Zufälliger Punkt IM sicheren Bereich
  const randomAngleInSegment = safeStart + Math.random() * (safeEnd - safeStart);
  
  // Ziel-Rotation für das Rad (Rad dreht sich, Pfeil ist oben bei 0/360)
  const targetRotationSingle = 360 - randomAngleInSegment;

  // 4. Runden addieren
  let currentTotalRotation = ctState.rotation;
  let nextMinimumRotation = currentTotalRotation + (360 * 5); // 5 volle Runden
  
  const currentMod = nextMinimumRotation % 360;
  let adjustment = targetRotationSingle - currentMod;
  
  // Immer vorwärts
  if (adjustment < 0) {
    adjustment += 360;
  }
  
  let finalRotation = nextMinimumRotation + adjustment;
  
  // Speichern
  ctState.rotation = finalRotation;

  // 5. Starten
  setTimeout(() => {
    wheel.style.transition = 'transform 5s cubic-bezier(0.15, 0.85, 0.15, 1)';
    wheel.style.transform = `rotate(${ctState.rotation}deg)`;
  }, 50);
  
  // 6. Auswerten
  setTimeout(() => {
    evaluateCtResult(winningSegment);
  }, 5050);
}
function evaluateCtResult(result) {
  let multiplier = 1;
  let isBonus = ['coin','pachinko','cash','crazy'].includes(result);
  
  // Prüfen, ob der Top Slot (der Kasten oben) passt
  let slotMatch = (ctState.topSlot.target === result);
  if(slotMatch) multiplier = ctState.topSlot.multi;
  
  const playerBet = ctState.bets[result];
  let totalWin = 0;
  
  // --- BONUS RUNDE ---
  if(playerBet > 0 && isBonus) {
    // Wenn Bonus getroffen, startet das Minigame (Anzeige kommt danach)
    playCtBonus(result, multiplier, playerBet);
    return; 
  }

  // --- NORMALE ZAHLEN ---
  let winText = "";
  let isWin = false;

  if (playerBet > 0) {
    // GEWONNEN
    const numVal = parseInt(result);
    // Formel: Einsatz + (Einsatz * Multiplikator)
    // Beispiel: 10 gesetzt auf 2. Gewinn = 10 + (10*2) = 30.
    // Wenn Slot-Multiplikator 5x ist: 10 + (10 * 2 * 5) = 110.
    const odds = numVal * multiplier;
    totalWin = playerBet + (playerBet * odds);
    
    triggerWin(totalWin);
    isWin = true;
    winText = `+${formatNum(totalWin)} Kleinis`;
  } else {
    // NICHT GEWETTET
    winText = "Kein Einsatz";
  }

  // --- ANZEIGE AUFRUFEN ---
  showCtResultPopup(result, winText, isWin);
  
  // Spiel zurücksetzen
  resetCtGame();
}

// 3. Neue Hilfsfunktion für das Popup (muss auch ins Script)
function showCtResultPopup(result, subText, isWin) {
  // Wir erzeugen das Popup dynamisch, damit du nichts am HTML ändern musst
  let popup = document.getElementById('ct-result-popup-dynamic');
  
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'ct-result-popup-dynamic';
    popup.className = 'ct-result-popup';
    // In den Container einfügen
    document.querySelector('.crazy-container').appendChild(popup);
  }

  const icon = getCtIcon(result);
  const subClass = isWin ? 'ct-res-win' : 'ct-res-loss';

  popup.innerHTML = `
    <span class="ct-res-icon">${icon}</span>
    <div class="ct-res-text">${result.toUpperCase()}</div>
    <div class="${subClass}">${subText}</div>
  `;

  // Anzeigen
  setTimeout(() => popup.classList.add('show'), 10);

  // Nach 3 Sekunden ausblenden
  setTimeout(() => {
    popup.classList.remove('show');
  }, 3000);
}

function playCtBonus(gameType, slotMulti, bet) {
  const overlay = document.getElementById('ct-bonus-overlay');
  const title = document.getElementById('ct-bonus-title');
  const anim = document.getElementById('ct-bonus-anim');
  const resDiv = document.getElementById('ct-bonus-result');
  
  overlay.style.display = 'flex';
  title.textContent = gameType.toUpperCase() + " BONUS!";
  resDiv.textContent = "";
  
  let finalMulti = 0;
  
  if(gameType === 'coin') {
    anim.textContent = "Münze wird geworfen...";
    setTimeout(() => {
      let roll = [5, 10, 15, 20, 50][Math.floor(Math.random()*5)];
      finalMulti = roll * slotMulti; 
      anim.textContent = `🔴 ${roll}x  vs  🔵 ${roll*2}x`;
      setTimeout(() => {
        let winColor = Math.random() > 0.5 ? "🔴" : "🔵";
        let winM = (winColor === "🔵") ? roll*2 : roll;
        finalMulti = winM * slotMulti;
        anim.textContent = `${winColor} GEWINNT!`;
        finishBonus(finalMulti, bet);
      }, 1500);
    }, 1000);
    
  } else if(gameType === 'pachinko') {
    anim.textContent = "Puck fällt...";
    setTimeout(() => {
      let drops = [10, 20, 50, 100, 200, "DOUBLE"];
      let hit = drops[Math.floor(Math.random()*drops.length)];
      if(hit === "DOUBLE") {
        anim.textContent = "✨ DOUBLE! ✨";
        let reHit = [20, 40, 100, 200, 500][Math.floor(Math.random()*5)];
        finalMulti = reHit * slotMulti;
        setTimeout(() => finishBonus(finalMulti, bet), 1000);
      } else {
        finalMulti = hit * slotMulti;
        finishBonus(finalMulti, bet);
      }
    }, 2000);
    
  } else if(gameType === 'cash') {
    anim.textContent = "Ziel auswählen! (Auto-Pick)";
    setTimeout(() => {
      let hit = Math.floor(Math.random() * 50) + 10; 
      finalMulti = hit * slotMulti;
      finishBonus(finalMulti, bet);
    }, 1500);
    
  } else if(gameType === 'crazy') {
    title.style.color = "#e74c3c";
    anim.textContent = "🚪 WELT WIRD GEÖFFNET...";
    setTimeout(() => {
      let wheelRes = [20, 50, 100, 200, "DOUBLE", "TRIPLE"];
      let hit = wheelRes[Math.floor(Math.random()*wheelRes.length)];
      
      if(hit === "DOUBLE" || hit === "TRIPLE") {
         anim.textContent = `✨ ${hit} ✨`;
         let reHit = Math.floor(Math.random() * 500) + 200;
         finalMulti = reHit * slotMulti;
         setTimeout(() => finishBonus(finalMulti, bet), 1500);
      } else {
         finalMulti = hit * slotMulti;
         finishBonus(finalMulti, bet);
      }
    }, 2500);
  }
}

function finishBonus(multi, bet) {
  const resDiv = document.getElementById('ct-bonus-result');
  resDiv.textContent = `${multi}x MULTIPLIKATOR!`;
  
  const win = bet * multi; 
  addScore(win);
  triggerWin(win);
  
  setTimeout(() => {
    document.getElementById('ct-bonus-overlay').style.display = 'none';
    resetCtGame();
  }, 3000);
}

function resetCtGame() {
  ctState.spinning = false;
  ctState.bets = { '1':0, '2':0, '5':0, '10':0, 'coin':0, 'pachinko':0, 'cash':0, 'crazy':0 };
  ctState.totalBet = 0;
  disableButtons(false);
  updateCasinoUI();
  updateCtUI();
  document.querySelectorAll('.ct-bet-btn').forEach(b => b.classList.remove('active-slot-boost'));
}

// Initialisieren beim Laden
initCrazyWheel();
    init();
  
  function toggleCtHelp() {
  const el = document.getElementById('ct-help-overlay');
  if (el.style.display === 'none' || el.style.display === '') {
    el.style.display = 'flex';
  } else {
    el.style.display = 'none';
  }
}
  
  /* --- BIERCHEN SYSTEM --- */

function checkDailyBonus() {
  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000; // 24 Stunden in Millisekunden
  
  // Sicherheits-Check: Falls Variable fehlt, auf 0 setzen (damit man den Bonus sofort kriegt)
  if (!game.lastDailyBonus) game.lastDailyBonus = 0;
  
  // Prüfen, ob 24 Stunden vergangen sind
  if (now - game.lastDailyBonus > oneDay) {
    
    // 1. Bonus berechnen und hinzufügen
    const bonusAmount = 50; 
    if (!game.beers) game.beers = 0;
    game.beers += bonusAmount;
    
    // 2. WICHTIG: Zeitstempel JETZT aktualisieren
    game.lastDailyBonus = now;

    // 3. WICHTIG: SOFORT SPEICHERN!
    // Wir speichern, BEVOR wir das Alert zeigen oder die UI updaten.
    // Selbst wenn danach etwas abstürzt, weiß das Spiel beim nächsten Mal: "Bonus schon erhalten".
    saveGame();
    
    // 4. Jetzt erst dem Spieler Bescheid sagen
    alert(`🍻 PROST! TÄGLICHER BONUS! 🍻\n\nDu hast einen frischen Kasten mit ${bonusAmount} Bierchen erhalten!\nVerzocke sie weise im Casino.`);
    
    // 5. UI aktualisieren (mit Sicherheitsabfrage)
    if (typeof updateCasinoUI === "function") {
        updateCasinoUI(); 
    }
  }
}

// Suche deine doPrestige Funktion und ändere den Gewinn-Teil:
function doPrestige() {
  const potentialTotal = calculatePotentialPrestige();
  if (potentialTotal <= game.prestige) return;

  const gain = potentialTotal - game.prestige;

  // --- 10 Bierchen pro Level ---
  const beersGained = gain * 25; 
  
  game.prestige = potentialTotal;
  game.cases += gain;
  game.beers += beersGained; // BIERCHEN DAZU

  game.score = 0;
  game.clicks = 0;
  game.clickLevel = 1;
  game.buildings = new Array(BUILDINGS.length).fill(0);
  game.upgrades = [];

  saveGame();
  
  alert(`ZEITREISE ERFOLGREICH! 🚀\n\nDu erhältst:\n+${gain} Prestige Level\n+${gain} Kisten\n+${beersGained} Bierchen 🍺`);
  
  location.reload();
}

function setCasinoCurrency(type) {
  casinoCurrency = type;
  
  // Buttons stylen
  document.getElementById('btn-curr-kleinis').className = type === 'kleinis' ? 'curr-btn active' : 'curr-btn';
  document.getElementById('btn-curr-beers').className = type === 'beers' ? 'curr-btn active' : 'curr-btn';
  
  updateCasinoUI();
}

// Suche diese Funktion ganz unten und korrigiere die Zeile mit dem Bild:
function updateCasinoUI() {
  const balanceEl = document.getElementById('casino-balance');
  const iconEl = document.getElementById('balance-icon');
  
  // Sicherheitscheck, falls Elemente fehlen
  if (!balanceEl) return;

  if (casinoCurrency === 'kleinis') {
    balanceEl.textContent = formatNum(Math.floor(game.score));
    balanceEl.style.color = "#fff";
    if(iconEl) iconEl.style.display = 'none'; 
  } else {
    // Hier stürzte es ab, wenn game.beers undefined war
    const beers = game.beers || 0; 
    balanceEl.textContent = formatNum(Math.floor(beers));
    balanceEl.style.color = "#f1c40f"; 
    
    if(iconEl) {
      iconEl.src = BEER_ICON_SRC; // Jetzt stimmt der Name!
      iconEl.style.display = 'inline-block';
    }
  }
}

// GANZ WICHTIG: BEZAHLEN
function payBet(amount) {
  if (casinoCurrency === 'kleinis') {
    game.score -= amount;
  } else {
    game.beers -= amount;
  }
  updateCasinoUI();
}

// GEWINNEN (Überschreibt alte Logik teilweise)
function triggerWin(amount) {
  if (casinoCurrency === 'kleinis') {
    addScore(amount);
  } else {
    game.beers += amount;
  }
  
  spawnConfetti();
  document.getElementById('casinoWindow').classList.add('win-pulse');
  setTimeout(() => document.getElementById('casinoWindow').classList.remove('win-pulse'), 500);
  updateCasinoUI();
}

// WETTEN PRÜFEN (Überschreibt alte getBet)
function getBet() {
  const betInput = document.getElementById('betAmount');
  let bet = parseInt(betInput.value);
  
  if (isNaN(bet) || bet <= 0) { alert("Wie viel willst du setzen?"); return null; }
  
  if (casinoCurrency === 'kleinis') {
    if (bet > game.score) { bet = Math.floor(game.score); betInput.value = bet; }
  } else {
    if (bet > game.beers) { bet = Math.floor(game.beers); betInput.value = bet; }
  }
  
  if (bet <= 0) {
      if(casinoCurrency === 'beers') alert("Keine Bierchen mehr! Warte auf den täglichen Bonus.");
      return null;
  }
  return bet;
}
  
  /* --- BIERCHEN MODAL LOGIC --- */
let beerTimerInterval;

function openBeerModal() {
  document.getElementById('beerModal').style.display = 'flex';
  
  // Aktuellen Stand im Modal anzeigen
  document.getElementById('modal-beer-amount').textContent = formatNum(Math.floor(game.beers || 0));
  
  // Timer sofort starten
  updateBeerTimer();
  // Timer jede Sekunde aktualisieren
  beerTimerInterval = setInterval(updateBeerTimer, 1000);
}

function closeBeerModal() {
  document.getElementById('beerModal').style.display = 'none';
  // Performance: Timer stoppen wenn Fenster zu ist
  if(beerTimerInterval) clearInterval(beerTimerInterval);
}

function updateBeerTimer() {
  const el = document.getElementById('beer-timer-display');
  if(!el) return;

  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000;
  
  // Wann war der letzte Bonus? (Fallback auf 0)
  const last = game.lastDailyBonus || 0;
  
  // Wann ist der nächste fällig?
  const nextBonusTime = last + oneDay;
  const diff = nextBonusTime - now;

  if (diff <= 0) {
    el.innerHTML = "<span style='color:#2ecc71'>JETZT VERFÜGBAR!</span>";
  } else {
    // Zeit umrechnen
    const h = Math.floor(diff / (1000 * 60 * 60));
    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((diff % (1000 * 60)) / 1000);

    // Formatierung mit führenden Nullen (z.B. 04:05:01)
    const hStr = h < 10 ? "0" + h : h;
    const mStr = m < 10 ? "0" + m : m;
    const sStr = s < 10 ? "0" + s : s;

    el.textContent = `${hStr}:${mStr}:${sStr}`;
    el.style.color = "#f1c40f"; // Gold
  }
}
  
 /* --- JACKPOT / LOTTERY SYSTEM (NEU & ANIMIERT) --- */

let lotteryData = {
  bets: {},
  total: 0,
  status: 'waiting', // waiting, countdown, spinning
  drawTime: 0,       // Zeitstempel wann der Countdown endet
  winner: null       // Name des Gewinners für die Animation
};

let lotteryTimerInterval;
let lotteryAnimFrame;
let wheelRotation = 0; // Aktuelle Rotation des Rades

function openLottery() {
  document.getElementById('lotteryModal').style.display = 'flex';
  syncLottery(); // Daten laden
  
  if(lotteryTimerInterval) clearInterval(lotteryTimerInterval);
  lotteryTimerInterval = setInterval(updateLotteryLoop, 100); // Schnellerer Loop für flüssige UI
  updateLotteryLoop();
}

function closeLottery() {
  document.getElementById('lotteryModal').style.display = 'none';
  if(lotteryAnimFrame) cancelAnimationFrame(lotteryAnimFrame);
}

// 1. Daten aus Firebase laden & UI updaten
function syncLottery() {
  if(!db) return;
  const ref = db.ref('lottery');
  
  ref.on('value', (snapshot) => {
    const val = snapshot.val();
    if(val) {
      // Wenn sich der Status ändert, z.B. auf Spinning
      const oldStatus = lotteryData.status;
      lotteryData = val;
      if(!lotteryData.bets) lotteryData.bets = {};
      
      // UI Update
      document.getElementById('lottery-pot-display').textContent = formatNum(lotteryData.total || 0);
      renderLotteryList();
      
      // Wenn Status "waiting" oder "countdown" ist, zeichnen wir das statische Rad
      if (lotteryData.status !== 'spinning') {
          drawLotteryWheel(0); 
      }

      // Wenn der Status frisch auf "spinning" gewechselt ist -> Animation starten
      if (oldStatus !== 'spinning' && lotteryData.status === 'spinning') {
          startLotteryAnimation(lotteryData.winner);
      }
    } else {
      // Initiale Datenstruktur falls leer
      lotteryData = { bets: {}, total: 0, status: 'waiting', drawTime: 0 };
    }
  });
}

// 2. Einsatz tätigen (Startet Countdown bei 2. Spieler)
function enterLottery() {
  const input = document.getElementById('lotteryInput');
  const amount = parseInt(input.value);
  
  if(isNaN(amount) || amount <= 0) return;
  
  // Status Check: Niemand darf wetten, wenn es schon dreht
  if (lotteryData.status === 'spinning') {
      alert("Zu spät! Das Rad dreht sich bereits.");
      return;
  }

  if(game.beers < amount) {
    alert("Nicht genug Bierchen!");
    return;
  }

  // Bezahlen
  game.beers -= amount;
  updateCasinoUI(); 
  saveGame();

  // Firebase Update
  const ref = db.ref('lottery');
  ref.transaction((current) => {
    if (!current) current = { bets: {}, total: 0, status: 'waiting', drawTime: 0 };
    if (!current.bets) current.bets = {};
    
    // Geld hinzufügen
    const oldBet = current.bets[game.playerName] || 0;
    current.bets[game.playerName] = oldBet + amount;
    current.total = (current.total || 0) + amount;
    
    // PRÜFUNG: Starten wir den Countdown?
    const uniquePlayers = Object.keys(current.bets).length;
    
    // Wenn min. 2 Spieler und Status noch "waiting" -> Countdown Start (60 Sekunden)
    if (uniquePlayers >= 2 && current.status === 'waiting') {
        current.status = 'countdown';
        current.drawTime = Date.now() + 60000; // 60 Sekunden ab jetzt
    }
    
    return current;
  }, (error, committed, snapshot) => {
    if (error) {
      alert('Fehler! Geld zurück.');
      game.beers += amount;
      saveGame();
    } else {
      input.value = '';
    }
  });
}

// 3. Liste rendern
function renderLotteryList() {
  const list = document.getElementById('lottery-list');
  list.innerHTML = '';
  
  if(!lotteryData.bets || Object.keys(lotteryData.bets).length === 0) {
    list.innerHTML = '<div style="color:#555; text-align:center;">Warte auf Spieler...</div>';
    return;
  }

  const players = Object.keys(lotteryData.bets).sort((a,b) => lotteryData.bets[b] - lotteryData.bets[a]);
  
  players.forEach(p => {
    const amt = lotteryData.bets[p];
    const chance = ((amt / lotteryData.total) * 100).toFixed(1);
    const row = document.createElement('div');
    row.style.display = 'flex'; row.style.justifyContent = 'space-between';
    row.style.borderBottom = '1px solid #333'; row.style.padding = '4px'; row.style.fontSize = '0.8rem';
    
    const color = (p === game.playerName) ? '#e67e22' : '#ccc';
    
    row.innerHTML = `
      <span style="color:${color}; font-weight:bold;">${p}</span>
      <span>${formatNum(amt)} 🍺 <span style="color:#555">(${chance}%)</span></span>
    `;
    list.appendChild(row);
  });
}

// 4. Timer Loop & Logik
function updateLotteryLoop() {
  const timerEl = document.getElementById('lottery-timer');
  const uniquePlayers = lotteryData.bets ? Object.keys(lotteryData.bets).length : 0;

  if (lotteryData.status === 'waiting') {
      timerEl.textContent = `Warte auf Spieler (${uniquePlayers}/2)`;
      timerEl.style.color = "#aaa";
  } 
  else if (lotteryData.status === 'countdown') {
      const now = Date.now();
      const left = lotteryData.drawTime - now;
      
      if (left <= 0) {
          timerEl.textContent = "ZIEHUNG STARTET...";
          // Trigger Draw (Nur einer muss es tun, wir nehmen einfach Zufall > 0.9 um Last zu verteilen oder jeder versucht es, Transaction regelt)
          if (left < -2000) { // 2 Sekunden Puffer
              performLotteryDraw(); 
          }
      } else {
          // Sekunden formatieren
          const secs = (left / 1000).toFixed(1);
          timerEl.textContent = `START IN: ${secs}s`;
          timerEl.style.color = "#f1c40f";
      }
  } 
  else if (lotteryData.status === 'spinning') {
      timerEl.textContent = "VIEL GLÜCK! 🍀";
      timerEl.style.color = "#2ecc71";
  }
}

// 5. Ziehung durchführen (Wird aufgerufen wenn Timer abläuft)
function performLotteryDraw() {
  // Wahrscheinlichkeit reduzieren, dass alle Clients gleichzeitig feuern
  if (Math.random() > 0.1) return; 

  const ref = db.ref('lottery');
  ref.transaction((data) => {
    if (!data || data.status !== 'countdown') return; // Schon erledigt oder falsch

    // Gewinner ermitteln (Gewichtet)
    let r = Math.random() * data.total;
    let winner = null;
    let accum = 0;
    
    // Sortieren für Konsistenz
    const players = Object.keys(data.bets).sort();
    
    for (let p of players) {
        accum += data.bets[p];
        if (r <= accum) {
            winner = p;
            break;
        }
    }
    if(!winner) winner = players[0];

    // Status auf Spinning setzen, Gewinner eintragen
    // WICHTIG: Wetten noch NICHT löschen, wir brauchen sie für die Grafik!
    data.status = 'spinning';
    data.winner = winner;
    
    return data;
  });
}

// 6. Das Rad zeichnen
function drawLotteryWheel(rotationOffset) {
  const canvas = document.getElementById('lotteryCanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  const cx = w/2; const cy = h/2; const r = w/2 - 5;
  
  ctx.clearRect(0,0,w,h);
  
  // Rahmen
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rotationOffset); // Das ganze Rad drehen
  
  if(!lotteryData.bets || lotteryData.total === 0) {
    // Leeres Rad
    ctx.beginPath(); ctx.arc(0, 0, r, 0, 2*Math.PI);
    ctx.fillStyle = "#222"; ctx.fill(); ctx.stroke();
    ctx.restore();
    return;
  }

  // Alphabetisch sortieren für konsistente Farben/Positionen auf allen Clients
  const players = Object.keys(lotteryData.bets).sort();
  
  let startAngle = 0;
  
  // Helper für Farben
  const stringToColor = (str) => {
    let hash = 0; for(let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    let c = '#'; for(let i=0; i<3; i++) { let val = (hash >> (i*8)) & 0xFF; c += ('00' + val.toString(16)).substr(-2); }
    return c;
  }

  players.forEach(p => {
    const amt = lotteryData.bets[p];
    const sliceAngle = (amt / lotteryData.total) * 2 * Math.PI;
    
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, r, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    
    ctx.fillStyle = stringToColor(p);
    ctx.fill();
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.stroke();
    
    startAngle += sliceAngle;
  });
  
  ctx.restore();
}

// 7. Animations-Logik
function startLotteryAnimation(winnerName) {
    if(lotteryAnimFrame) cancelAnimationFrame(lotteryAnimFrame);

    // Wir müssen berechnen, wo der Gewinner auf dem Rad liegt.
    // Der Zeiger ist OBEN (-PI/2 oder 270 Grad).
    
    const players = Object.keys(lotteryData.bets).sort();
    let winnerStartAngle = 0;
    let winnerEndAngle = 0;
    let currentAngle = 0;
    
    // Winkel des Gewinners finden
    for(let p of players) {
        const slice = (lotteryData.bets[p] / lotteryData.total) * 2 * Math.PI;
        if(p === winnerName) {
            winnerStartAngle = currentAngle;
            winnerEndAngle = currentAngle + slice;
            break;
        }
        currentAngle += slice;
    }
    
    // Zufälliger Punkt im Gewinner-Segment
    const targetInSlice = winnerStartAngle + (Math.random() * (winnerEndAngle - winnerStartAngle));
    
    // Ziel: Dieser Punkt soll OBEN sein (-PI/2).
    // Canvas dreht im Uhrzeigersinn.
    // Wir addieren viele Umdrehungen (z.B. 10)
    const spins = 10 * 2 * Math.PI;
    
    // Ziel-Rotation berechnen:
    // Wir wollen, dass (targetInSlice + finalRotation) % 2PI = -PI/2 (oder 3PI/2)
    // Einfacher: finalRotation = -targetInSlice - PI/2 + spins
    const targetRotation = -targetInSlice - (Math.PI / 2) + spins;

    let startTime = null;
    const duration = 8000; // 8 Sekunden drehen

    function animate(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        
        // Easing (cubic-out)
        const ease = 1 - Math.pow(1 - progress, 3);
        
        const currentRot = targetRotation * ease;
        drawLotteryWheel(currentRot);
        
        if (progress < 1) {
            lotteryAnimFrame = requestAnimationFrame(animate);
        } else {
            // Fertig!
            finishLottery(winnerName);
        }
    }
    
    lotteryAnimFrame = requestAnimationFrame(animate);
}

// 8. Abschluss & Auszahlung
function finishLottery(winnerName) {
    // Nur der Client des Gewinners löst die Auszahlung aus (oder wer auch immer zuerst ist)
    // Wir nutzen pendingPayout Logic wie beim alten System
    
    // Alert anzeigen
    const winAmt = lotteryData.total;
    
    // Nachricht im Modal
    const msgBox = document.getElementById('lottery-winner-msg');
    msgBox.style.display = 'block';
    document.getElementById('last-winner-name').textContent = winnerName;
    document.getElementById('last-winner-amt').textContent = formatNum(winAmt);
    
    if (winnerName === game.playerName) {
        spawnConfetti();
        alert(`🎉 JACKPOT! DU HAST GEWONNEN! 🎉\n+${formatNum(winAmt)} Bierchen`);
    }

    // Nach kurzer Pause Reset durchführen
    if (Math.random() > 0.5) { // Nur ein paar Clients versuchen den Reset
        setTimeout(() => {
            const ref = db.ref('lottery');
            ref.transaction((data) => {
                // Wenn Status immer noch spinning ist, resetten wir
                if (data && data.status === 'spinning') {
                    // Auszahlung vormerken
                    return {
                        bets: {},
                        total: 0,
                        status: 'waiting',
                        drawTime: 0,
                        lastWinnerName: winnerName,
                        lastWinnerAmt: winAmt,
                        pendingPayout: { user: winnerName, amount: winAmt }
                    };
                }
                return data;
            });
        }, 3000);
    }
}

// 9. Gewinn-Check (läuft beim Start in init())
function checkLotteryWins() {
  if(!db || !game.playerName) return;
  const ref = db.ref('lottery/pendingPayout');
  ref.once('value', (snapshot) => {
    const pay = snapshot.val();
    if(pay && pay.user === game.playerName) {
        // ICH HABE GEWONNEN!
        ref.remove().then(() => {
            game.beers += pay.amount;
            saveGame();
            updateCasinoUI();
            // Optional: Alert hier, falls er offline war
        });
    }
  });
}
  
  </script>

  
  <div id="ct-help-overlay" style="display:none;" onclick="toggleCtHelp()">
  <div class="ct-help-box" onclick="event.stopPropagation()">
    <div class="ct-help-header">
      <span>🤪 SPIELANLEITUNG</span>
      <button class="close-btn" onclick="toggleCtHelp()" style="position:static; font-size:1.5rem;">×</button>
    </div>
    
    <div class="ct-help-body">
      <div class="ct-help-section">
        <h3>🎰 Der Top Slot (Oben)</h3>
        <p>Vor jeder Runde dreht sich der Slot über dem Rad. Wenn das Symbol links und der Multiplikator rechts matchen (eine Linie bilden), wird der Gewinn für dieses Symbol vervielfacht!</p>
      </div>

      <div class="ct-help-grid">
        <!-- ZAHLEN -->
        <div class="ct-help-item">
          <div class="ct-help-icon" style="color:#2980b9">1️⃣</div>
          <div class="ct-help-desc">
            <strong>Die Eins</strong><br>
            Häufigster Treffer.<br>
            Zahlt <strong>1:1</strong>
          </div>
        </div>
        <div class="ct-help-item">
          <div class="ct-help-icon" style="color:#f1c40f">2️⃣</div>
          <div class="ct-help-desc">
            <strong>Die Zwei</strong><br>
            Solider Gewinn.<br>
            Zahlt <strong>2:1</strong>
          </div>
        </div>
        <div class="ct-help-item">
          <div class="ct-help-icon" style="color:#e91e63">5️⃣</div>
          <div class="ct-help-desc">
            <strong>Die Fünf</strong><br>
            Gute Auszahlung.<br>
            Zahlt <strong>5:1</strong>
          </div>
        </div>
        <div class="ct-help-item">
          <div class="ct-help-icon" style="color:#8e44ad">🔟</div>
          <div class="ct-help-desc">
            <strong>Die Zehn</strong><br>
            Selten, aber stark.<br>
            Zahlt <strong>10:1</strong>
          </div>
        </div>

        <!-- BONI -->
        <div class="ct-help-item bonus">
          <div class="ct-help-icon">🪙</div>
          <div class="ct-help-desc">
            <strong>Coin Flip</strong><br>
            Rot oder Blau wird geworfen.<br>
            Gewinn: <strong>5x bis 50x</strong>
          </div>
        </div>
        <div class="ct-help-item bonus">
          <div class="ct-help-icon">🟣</div>
          <div class="ct-help-desc">
            <strong>Pachinko</strong><br>
            Puck fällt durch die Wand.<br>
            Gewinn: <strong>10x bis 200x</strong>
          </div>
        </div>
        <div class="ct-help-item bonus">
          <div class="ct-help-icon">🎯</div>
          <div class="ct-help-desc">
            <strong>Cash Hunt</strong><br>
            Schießbude mit 108 Zielen.<br>
            Gewinn: <strong>10x bis 100x</strong>
          </div>
        </div>
        <div class="ct-help-item bonus" style="border-color:#e74c3c; background:rgba(231, 76, 60, 0.1);">
          <div class="ct-help-icon">🤪</div>
          <div class="ct-help-desc">
            <strong style="color:#e74c3c">CRAZY TIME</strong><br>
            Der Jackpot! Rote Tür.<br>
            Gewinn: <strong>20x bis 500x+</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


</body>

</html>
