<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KleinClicker Ultimate</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #ff6b6b;
      --secondary: #4ecdc4;
      --gold: #ffeaa7;
      --dark-overlay: rgba(0, 0, 0, 0.85);
      --bg-gradient: radial-gradient(circle at center, #2b32b2 0%, #1e3c72 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --text-color: #ffffff;
      --level-bar-height: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
    
    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      height: 100vh;
      overflow: hidden; 
      display: grid;
      grid-template-rows: auto 1fr auto;
      position: relative;
    }

    /* --- Animations --- */
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(2deg); }
    }
    
    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }

    @keyframes shine {
      0% { filter: brightness(100%) drop-shadow(0 0 0px gold); transform: scale(1); }
      50% { filter: brightness(130%) drop-shadow(0 0 20px gold); transform: scale(1.1); }
      100% { filter: brightness(100%) drop-shadow(0 0 0px gold); transform: scale(1); }
    }

    @keyframes barStripe {
      0% { background-position: 40px 0; }
      100% { background-position: 0 0; }
    }

    @keyframes pulseText {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); color: var(--gold); }
      100% { transform: scale(1); }
    }

    @keyframes levelUpPop {
      0% { transform: scale(0.5); opacity: 0; }
      60% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* --- UI Elements --- */
    header {
      text-align: center;
      padding: 10px 15px;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      z-index: 100;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    /* --- NEW LEVEL SYSTEM STYLES --- */
    .level-container {
      width: 100%;
      max-width: 400px;
      background: rgba(0, 0, 0, 0.4);
      padding: 8px 15px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      position: relative;
      margin-top: 5px;
    }

    .level-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .level-badge {
      background: var(--secondary);
      color: #1e3c72;
      font-weight: 800;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-right: 5px;
    }

    .rank-name {
      color: var(--gold);
      font-weight: bold;
      font-family: 'Fredoka', sans-serif;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    .level-bar-bg {
      width: 100%;
      height: var(--level-bar-height);
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }

    .level-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(45deg, 
        var(--primary) 25%, 
        #ff8787 25%, 
        #ff8787 50%, 
        var(--primary) 50%, 
        var(--primary) 75%, 
        #ff8787 75%, 
        #ff8787 100%
      );
      background-size: 20px 20px;
      animation: barStripe 1s linear infinite;
      transition: width 0.3s ease-out;
      border-radius: 10px;
      box-shadow: 0 0 10px var(--primary);
    }

    h1 {
      font-family: 'Fredoka', sans-serif;
      font-size: 1.5rem;
      letter-spacing: 1px;
      text-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .scoreboard { display: flex; flex-direction: column; align-items: center; width: 100%; }

    #score {
      font-family: 'Fredoka', sans-serif;
      font-size: 2.8rem;
      font-weight: 700;
      background: linear-gradient(to bottom, #fff, #dfe6e9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4));
      margin-top: 5px;
    }

    #cps {
      font-size: 0.9rem;
      color: #b2bec3;
      background: rgba(0,0,0,0.3);
      padding: 2px 10px;
      border-radius: 12px;
    }

    /* --- Game Area --- */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .click-zone {
      position: relative;
      cursor: pointer;
      z-index: 10;
      transition: transform 0.1s;
    }
    
    .click-zone:active { transform: scale(0.95); }

    #klein {
      width: 260px;
      height: 260px;
      object-fit: contain;
      filter: drop-shadow(0 15px 35px rgba(0,0,0,0.6));
      animation: float 6s ease-in-out infinite;
    }

    /* --- Golden Klein Event --- */
    #goldenKlein {
      position: absolute;
      width: 80px;
      height: 80px;
      cursor: pointer;
      display: none; 
      z-index: 999;
      animation: shine 1.5s infinite;
    }

    /* --- Particles --- */
    .falling-head {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      z-index: 5;
      animation: fall 2s linear forwards;
      opacity: 0.7;
    }

    .click-text {
      position: absolute;
      font-family: 'Fredoka', sans-serif;
      font-weight: bold;
      color: #fff;
      font-size: 1.5rem;
      pointer-events: none;
      z-index: 20;
      animation: flyUp 1s ease-out forwards;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    @keyframes flyUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
    }

    /* --- Shop & Tabs --- */
    .bottom-panel {
      height: 40vh;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(15px);
      border-top: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .tabs {
      display: flex;
      justify-content: center;
      padding: 10px;
      gap: 15px;
      background: rgba(0,0,0,0.2);
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Fredoka', sans-serif;
      font-size: 1rem;
      padding: 5px 15px;
      opacity: 0.5;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn.active { opacity: 1; border-bottom: 2px solid var(--primary); transform: translateY(-2px); }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
      padding-bottom: 20px;
    }

    .shop-item {
      display: flex;
      align-items: center;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 10px;
      transition: all 0.2s;
    }
    .shop-item:hover { background: rgba(255,255,255,0.15); transform: translateX(2px); }

    .item-icon { font-size: 2rem; margin-right: 15px; }
    .item-details { flex: 1; }
    .item-name { font-weight: 700; font-size: 1rem; display: block; }
    .item-cost { color: #ffeaa7; font-size: 0.9rem; }
    .item-count { font-size: 1.5rem; font-weight: bold; opacity: 0.3; margin-left: 10px; }

    .item-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .item-btn:active { transform: scale(0.95); }
    .item-btn:disabled { background: #555; opacity: 0.5; cursor: not-allowed; }

    /* --- LEVEL UP MODAL --- */
    #levelUpModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: var(--dark-overlay);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: none; /* Flex when active */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }
    
    .levelup-card {
      background: linear-gradient(135deg, #2b32b2, #1e3c72);
      border: 2px solid var(--gold);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 50px rgba(255, 234, 167, 0.3);
      animation: levelUpPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 90%;
    }

    .levelup-title {
      font-family: 'Fredoka', sans-serif;
      font-size: 2.5rem;
      color: var(--gold);
      margin-bottom: 10px;
      text-shadow: 0 4px 0 #d63031;
    }

    .levelup-stat { font-size: 1.2rem; margin: 10px 0; color: #fff; }
    .levelup-bonus { font-size: 1.4rem; font-weight: bold; color: #4cd137; margin-bottom: 20px; }

    .levelup-btn {
      background: var(--gold);
      color: #d63031;
      font-family: 'Fredoka', sans-serif;
      font-size: 1.2rem;
      border: none;
      padding: 10px 30px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 0 #b33939;
      transition: transform 0.1s;
    }
    .levelup-btn:active { transform: translateY(4px); box-shadow: none; }

    /* --- Notification / Toast --- */
    .toast-container {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
      pointer-events: none; /* Klicks gehen durch */
    }

    .toast {
      background: rgba(40, 40, 40, 0.95);
      border-left: 4px solid var(--secondary);
      padding: 12px 15px;
      border-radius: 4px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out forwards;
      min-width: 200px;
    }
    .toast h4 { color: var(--secondary); margin-bottom: 2px; font-family: 'Fredoka', sans-serif; font-size: 0.9rem; }
    .toast p { font-size: 0.8rem; opacity: 0.9; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* --- Mobile Tweak --- */
    @media (max-width: 600px) {
      #klein { width: 200px; height: 200px; }
      h1 { font-size: 1.2rem; }
      .bottom-panel { height: 45vh; }
      .shop-grid { grid-template-columns: 1fr; }
      #score { font-size: 2.2rem; }
      .level-container { width: 90%; }
    }
  </style>
</head>
<body>

  <!-- Level Up Modal -->
  <div id="levelUpModal">
    <div class="levelup-card">
      <div class="levelup-title">LEVEL UP!</div>
      <div class="levelup-stat">Du bist jetzt Level <span id="modalLevel">2</span></div>
      <div class="levelup-stat" style="font-size: 1rem; opacity:0.8;">Neuer Rang: <span id="modalRank">Anf√§nger</span></div>
      <div class="levelup-bonus">Globaler Bonus: +5% Produktion! üöÄ</div>
      <button class="levelup-btn" onclick="closeLevelModal()">Weiter klicken!</button>
    </div>
  </div>

  <!-- Golden Klein Event (Hidden by default) -->
  <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="goldenKlein" alt="GOLDEN" onmousedown="clickGolden()">

  <div class="toast-container" id="toastArea"></div>

  <header>
    <h1>KleinClicker Ultimate</h1>
    
    <!-- ADVANCED LEVEL SYSTEM -->
    <div class="level-container">
      <div class="level-info">
        <div>
          <span class="level-badge" id="lvlBadge">Lvl 1</span>
          <span class="rank-name" id="rankName">Zivilist</span>
        </div>
        <div style="font-size: 0.8rem; opacity: 0.7;">
          <span id="currentXP">0</span> / <span id="nextXP">500</span> XP
        </div>
      </div>
      <div class="level-bar-bg">
        <div class="level-bar-fill" id="levelBar"></div>
      </div>
    </div>

    <div class="scoreboard">
      <div id="score">0</div>
      <div id="cps">0 / Sekunde</div>
    </div>
  </header>

  <main>
    <div class="click-zone" id="clickArea">
      <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" alt="Das Gesicht" id="klein">
    </div>
  </main>

  <div class="bottom-panel">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('shop')">Shop</button>
      <button class="tab-btn" onclick="switchTab('achievements')">Erfolge</button>
      <button class="tab-btn" onclick="resetGame()" style="color:#ff6b6b">Reset</button>
    </div>

    <div class="panel-content" id="panelShop">
      <div class="shop-grid" id="shopGrid"></div>
    </div>

    <div class="panel-content" id="panelAchievements" style="display:none;">
      <div class="shop-grid" id="achievementsGrid"></div>
    </div>
  </div>

  <script>
    /* --- Settings & Config --- */
    const SAVE_KEY = 'kleinClickerUltimate_v2_LevelOverhaul';
    const IMG_URL = "https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png";

    // Level Ranks (Titel)
    const RANKS = [
      "Zivilist", "Maus-Schubser", "Klick-Lehrling", "Anf√§nger", 
      "Fortgeschrittener", "Dauer-Klicker", "Profi", "Elite", 
      "Meister", "Gro√ümeister", "Legende", "Klick-Gott", 
      "Klein-Imperator", "Transzendent", "Das Universum"
    ];

    /* --- Game State --- */
    let state = {
      score: 0,
      totalScore: 0, // Dient als XP
      clickCount: 0,
      displayedLevel: 1, // Zum Tracken von Level-Ups
      upgrades: [
        { id: 'cursor',  name: 'Maus-Fan',    baseCost: 15,    cps: 1,    count: 0, icon: 'üëÜ' },
        { id: 'grandma', name: 'Nette Oma',   baseCost: 100,   cps: 8,    count: 0, icon: 'üëµ' },
        { id: 'farm',    name: 'Kleini-Farm', baseCost: 1100,  cps: 47,   count: 0, icon: 'üöú' },
        { id: 'mine',    name: 'Meme-Mine',   baseCost: 12000, cps: 260,  count: 0, icon: '‚õèÔ∏è' },
        { id: 'lab',     name: 'Klon-Labor',  baseCost: 130000,cps: 1400, count: 0, icon: 'üß™' },
        { id: 'portal',  name: 'Klein-Portal',baseCost: 1000000,cps: 7800, count: 0, icon: 'üåÄ' }
      ],
      achievements: [
        { id: 'start', name: 'Der Anfang', desc: 'Klicke 1 mal', condition: s => s.clickCount >= 1, unlocked: false },
        { id: 'lvl5', name: 'Aufsteiger', desc: 'Erreiche Level 5', condition: s => getLevelData(s.totalScore).level >= 5, unlocked: false },
        { id: 'rich', name: 'Taschengeld', desc: 'Besitze 1.000 Kleinis', condition: s => s.score >= 1000, unlocked: false },
        { id: 'farmer', name: 'Landwirt', desc: 'Besitze 5 Farmen', condition: s => s.upgrades[2].count >= 5, unlocked: false },
        { id: 'million', name: 'Million√§r', desc: 'Erreiche 1 Million Lifetime Score', condition: s => s.totalScore >= 1000000, unlocked: false }
      ]
    };

    let lastTime = 0;
    let goldenTimer = 0;

    /* --- Elements --- */
    const els = {
      score: document.getElementById('score'),
      cps: document.getElementById('cps'),
      shopGrid: document.getElementById('shopGrid'),
      achieveGrid: document.getElementById('achievementsGrid'),
      clickArea: document.getElementById('clickArea'),
      klein: document.getElementById('klein'),
      golden: document.getElementById('goldenKlein'),
      // New Level Elements
      lvlBadge: document.getElementById('lvlBadge'),
      rankName: document.getElementById('rankName'),
      currentXP: document.getElementById('currentXP'),
      nextXP: document.getElementById('nextXP'),
      levelBar: document.getElementById('levelBar'),
      modal: document.getElementById('levelUpModal'),
      modalLevel: document.getElementById('modalLevel'),
      modalRank: document.getElementById('modalRank')
    };

    /* --- Init --- */
    function init() {
      loadGame();
      // Verhindere Level Up Popup direkt beim Laden
      const realLevel = getLevelData(state.totalScore).level;
      if (realLevel > state.displayedLevel) state.displayedLevel = realLevel;
      
      renderShop();
      renderAchievements();
      updateLevelUI(); // Einmal initial
      
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
      
      setInterval(saveGame, 10000); // Auto-save
      scheduleGoldenKlein();
    }

    /* --- Core Loop --- */
    function gameLoop(currentTime) {
      const dt = (currentTime - lastTime) / 1000;
      lastTime = currentTime;

      if (dt > 0 && dt < 2) { 
        const cps = calculateCPS();
        const earned = cps * dt;
        
        if (earned > 0) {
          state.score += earned;
          state.totalScore += earned;
          checkLevelUp(); // Check ob genug passives Einkommen f√ºr Level Up
        }
        
        checkAchievements();
        updateUI();
      }
      
      requestAnimationFrame(gameLoop);
    }

    /* --- Level System Logic (The new "High Effort" Part) --- */
    // Formel: Base * Level^2. Level 1 -> 500 XP n√∂tig. Level 2 -> 2000 XP total n√∂tig...
    // Das skaliert st√§rker, damit man sp√§ter nicht jede Sekunde aufsteigt.
    function getLevelData(totalScore) {
      const baseXP = 200; // XP needed for lvl 1
      // Level = Wurzel(Score / Base)
      // Wir addieren 1, damit man bei 0 Punkten Level 1 ist.
      let level = Math.floor(Math.sqrt(totalScore / baseXP)) + 1;
      
      // Berechne Grenzen f√ºr das aktuelle Level
      // XP n√∂tig f√ºr dieses Level (Startpunkt des Balkens)
      let startXP = baseXP * Math.pow(level - 1, 2);
      // XP n√∂tig f√ºr n√§chstes Level (Endpunkt des Balkens)
      let nextLevelXP = baseXP * Math.pow(level, 2);

      return {
        level: level,
        startXP: startXP,
        nextLevelXP: nextLevelXP,
        currentInLevel: totalScore - startXP,
        neededInLevel: nextLevelXP - startXP
      };
    }

    function checkLevelUp() {
      const data = getLevelData(state.totalScore);
      if (data.level > state.displayedLevel) {
        state.displayedLevel = data.level;
        triggerLevelUp(data.level);
      }
    }

    function triggerLevelUp(newLevel) {
      // 1. Sound abspielen (optional, hier visuell)
      // 2. Modal anzeigen
      els.modalLevel.textContent = newLevel;
      els.modalRank.textContent = getRankName(newLevel);
      els.modal.style.display = 'flex';
      
      // 3. Konfetti Partikel im Hintergrund (Simpel)
      for(let i=0; i<20; i++) {
        setTimeout(() => {
            spawnFallingHead(window.innerWidth/2, window.innerHeight/2);
        }, i * 50);
      }
    }

    function getRankName(lvl) {
      // Alle 5 Level ein neuer Rang
      const index = Math.min(Math.floor((lvl - 1) / 5), RANKS.length - 1);
      return RANKS[index];
    }

    function getLevelMultiplier() {
      // Pro Level +5% Bonus (Level 1 = 1.05x, Level 10 = 1.50x)
      // Das macht Leveln extrem wertvoll!
      return 1 + (state.displayedLevel * 0.05);
    }

    window.closeLevelModal = function() {
      els.modal.style.display = 'none';
      renderShop(); // Preise/CPS aktualisieren wegen neuem Multiplikator
    };

    /* --- Mechanics --- */
    function calculateCPS() {
      const baseCPS = state.upgrades.reduce((total, u) => total + (u.count * u.cps), 0);
      return baseCPS * getLevelMultiplier();
    }

    function calculateClickPower() {
      const baseClick = 1 + (calculateCPS() * 0.02); // 1 + 2% von CPS
      return baseClick * getLevelMultiplier(); // Auch Klicks profitieren vom Level!
    }

    function getCost(upgrade) {
      return Math.round(upgrade.baseCost * Math.pow(1.15, upgrade.count));
    }

    /* --- Interaction --- */
    els.clickArea.addEventListener('mousedown', (e) => handleUserClick(e.clientX, e.clientY));
    els.clickArea.addEventListener('touchstart', (e) => {
      e.preventDefault(); 
      for (let i = 0; i < e.touches.length; i++) {
        handleUserClick(e.touches[i].clientX, e.touches[i].clientY);
      }
    }, { passive: false });

    function handleUserClick(x, y) {
      const power = calculateClickPower();
      state.score += power;
      state.totalScore += power;
      state.clickCount++;
      
      checkLevelUp();

      // Visuals
      spawnFloatingText(x, y, `+${Math.floor(power)}`);
      spawnFallingHead(x, y);
      
      els.klein.style.transform = 'scale(0.95)';
      setTimeout(() => els.klein.style.transform = '', 50);
      // NO SCREEN SHAKE here as requested
    }

    /* --- Golden Klein Event --- */
    function scheduleGoldenKlein() {
      const delay = (Math.random() * 60000) + 30000; // 30-90s
      setTimeout(showGoldenKlein, delay);
    }

    function showGoldenKlein() {
      const g = els.golden;
      const x = Math.random() * (window.innerWidth - 100);
      const y = Math.random() * (window.innerHeight - 200);
      
      g.style.left = x + 'px';
      g.style.top = y + 'px';
      g.style.display = 'block';

      goldenTimer = setTimeout(() => {
        g.style.display = 'none';
        scheduleGoldenKlein();
      }, 10000);
    }

    window.clickGolden = function() {
      clearTimeout(goldenTimer);
      els.golden.style.display = 'none';
      
      const bonus = Math.max(500, calculateCPS() * 300);
      state.score += bonus;
      state.totalScore += bonus;
      checkLevelUp(); // Auch Goldener Klein gibt XP!
      
      showToast("GOLDENER KLEIN!", `+${Math.floor(bonus).toLocaleString()} Punkte!`);
      scheduleGoldenKlein();
    };

    /* --- Shop System --- */
    window.buyUpgrade = function(index) {
      const u = state.upgrades[index];
      const cost = getCost(u);
      
      if (state.score >= cost) {
        state.score -= cost;
        u.count++;
        renderShop(); 
        
        const btn = document.getElementById(`btn-${index}`);
        if(btn) btn.style.transform = "scale(0.9)";
        setTimeout(() => btn ? btn.style.transform = "" : null, 100);
      }
    };

    function renderShop() {
      els.shopGrid.innerHTML = '';
      const levelMult = getLevelMultiplier(); // Zeige die geboosteten Werte an

      state.upgrades.forEach((u, index) => {
        const cost = getCost(u);
        const canBuy = state.score >= cost;
        const realCPS = u.cps * levelMult;
        
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `
          <div class="item-icon">${u.icon}</div>
          <div class="item-details">
            <span class="item-name">${u.name}</span>
            <span class="item-cost" style="color: ${canBuy ? '#ffeaa7' : '#ff6b6b'}">
              üíé ${cost.toLocaleString()}
            </span>
            <div style="font-size:0.75rem; color:#aaa">
              +${realCPS.toLocaleString(undefined, {maximumFractionDigits:1})} CPS 
              ${levelMult > 1 ? '<span style="color:#4cd137">(Boost!)</span>' : ''}
            </div>
          </div>
          <div class="item-count">${u.count}</div>
          <button id="btn-${index}" class="item-btn" 
            onclick="buyUpgrade(${index})" 
            ${!canBuy ? 'disabled' : ''}>Kaufen</button>
        `;
        els.shopGrid.appendChild(div);
      });
    }

    /* --- Achievements --- */
    function checkAchievements() {
      let changed = false;
      state.achievements.forEach(a => {
        if (!a.unlocked && a.condition(state)) {
          a.unlocked = true;
          showToast("Erfolg freigeschaltet!", a.name);
          changed = true;
        }
      });
      if (changed) renderAchievements();
    }

    function renderAchievements() {
      els.achieveGrid.innerHTML = '';
      state.achievements.forEach(a => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.style.opacity = a.unlocked ? '1' : '0.5';
        div.style.borderColor = a.unlocked ? '#4ecdc4' : 'transparent';
        div.innerHTML = `
          <div class="item-icon">${a.unlocked ? 'üèÜ' : 'üîí'}</div>
          <div class="item-details">
            <span class="item-name">${a.name}</span>
            <span style="font-size:0.8rem; color:#ccc">${a.desc}</span>
          </div>
        `;
        els.achieveGrid.appendChild(div);
      });
    }

    /* --- Visual FX --- */
    function spawnFloatingText(x, y, text) {
      const el = document.createElement('div');
      el.className = 'click-text';
      el.textContent = text;
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    function spawnFallingHead(x, y) {
      const img = document.createElement('img');
      img.src = IMG_URL;
      img.className = 'falling-head';
      img.style.left = (x - 20) + 'px';
      img.style.top = (y - 20) + 'px';
      
      const rot = Math.random() > 0.5 ? 1 : -1;
      img.style.transform = `rotate(${Math.random() * 360}deg)`;
      
      document.body.appendChild(img);
      setTimeout(() => img.remove(), 2000);
    }

    function showToast(title, msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `<h4>${title}</h4><p>${msg}</p>`;
      document.getElementById('toastArea').appendChild(t);
      setTimeout(() => {
        t.style.animation = 'slideIn 0.3s reverse forwards';
        setTimeout(() => t.remove(), 300);
      }, 3000);
    }

    /* --- UI Updates --- */
    function updateLevelUI() {
      const data = getLevelData(state.totalScore);
      
      els.lvlBadge.textContent = "Lvl " + data.level;
      els.rankName.textContent = getRankName(data.level);
      
      // Calculate smooth percentage
      let percent = (data.currentInLevel / data.neededInLevel) * 100;
      percent = Math.min(100, Math.max(0, percent)); // Clamp
      
      els.levelBar.style.width = percent + "%";
      els.currentXP.textContent = Math.floor(data.currentInLevel).toLocaleString();
      els.nextXP.textContent = Math.floor(data.neededInLevel).toLocaleString();
    }

    function updateUI() {
      els.score.textContent = Math.floor(state.score).toLocaleString();
      els.cps.textContent = calculateCPS().toLocaleString(undefined, {maximumFractionDigits: 1}) + " / Sek";
      
      updateLevelUI();

      // Button Update Logic
      state.upgrades.forEach((u, index) => {
        const btn = document.getElementById(`btn-${index}`);
        if (btn) {
          const cost = getCost(u);
          if (state.score >= cost && btn.disabled) {
            btn.disabled = false;
            const costLabel = btn.previousElementSibling.previousElementSibling.querySelector('.item-cost');
            if(costLabel) costLabel.style.color = '#ffeaa7';
          } else if (state.score < cost && !btn.disabled) {
            btn.disabled = true;
            const costLabel = btn.previousElementSibling.previousElementSibling.querySelector('.item-cost');
            if(costLabel) costLabel.style.color = '#ff6b6b';
          }
        }
      });
    }

    /* --- Tabs --- */
    window.switchTab = function(tabName) {
      document.getElementById('panelShop').style.display = 'none';
      document.getElementById('panelAchievements').style.display = 'none';
      
      if(tabName === 'shop') document.getElementById('panelShop').style.display = 'block';
      if(tabName === 'achievements') document.getElementById('panelAchievements').style.display = 'block';
      
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    };

    /* --- Save/Load --- */
    function saveGame() {
      const data = {
        score: state.score,
        totalScore: state.totalScore || state.score,
        clickCount: state.clickCount,
        upgrades: state.upgrades.map(u => ({ id: u.id, count: u.count })),
        achievements: state.achievements.map(a => ({ id: a.id, unlocked: a.unlocked }))
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }

    function loadGame() {
      const saved = localStorage.getItem(SAVE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          state.score = parsed.score || 0;
          state.totalScore = parsed.totalScore || parsed.score;
          state.clickCount = parsed.clickCount || 0;
          
          if (parsed.upgrades) {
            parsed.upgrades.forEach(savedU => {
              const match = state.upgrades.find(u => u.id === savedU.id);
              if (match) match.count = savedU.count;
            });
          }
          if (parsed.achievements) {
            parsed.achievements.forEach(savedA => {
              const match = state.achievements.find(a => a.id === savedA.id);
              if (match) match.unlocked = savedA.unlocked;
            });
          }
        } catch (e) { console.error("Savegame Error", e); }
      }
    }

    window.resetGame = function() {
      if(confirm("Wirklich ALLES l√∂schen?")) {
        localStorage.removeItem(SAVE_KEY);
        location.reload();
      }
    };

    init();
  </script>
</body>
</html>
