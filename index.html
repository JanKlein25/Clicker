<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KleinClicker: Ascension Edition</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
    rel="stylesheet">
  <!-- FIREBASE SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-core: #0f0f12;
      --bg-panel: #18181b;
      --bg-accent: #222226;
      --gold: #f1c40f;
      --gold-dim: #b8960b;
      --green: #2ecc71;
      --red: #e74c3c;
      --blue: #3498db;
      --purple: #9b59b6;
      --text-main: #ecf0f1;
      --text-muted: #95a5a6;
      --glass: rgba(20, 20, 25, 0.95);
      --border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* --- RESET & BASE --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-core);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 400px;
    }

    /* --- ANIMATIONS --- */
    @keyframes clickPulse {
      0% {
        transform: scale(0.95);
      }

      50% {
        transform: scale(1.02);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-80px) scale(0.8);
        opacity: 0;
      }
    }

    @keyframes wobble {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-5deg);
      }

      75% {
        transform: rotate(5deg);
      }
    }

    @keyframes shine {
      0% {
        background-position: -100px;
      }

      100% {
        background-position: 300px;
      }
    }

    @keyframes modalPop {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* --- LAYOUT --- */
    .panel-left {
      position: relative;
      background: radial-gradient(circle at center, #2c3e50 0%, #000 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 1;
    }

    .panel-right {
      background: var(--bg-panel);
      border-left: var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
    }

    /* --- CLICK AREA --- */
    .score-display {
      text-align: center;
      z-index: 20;
      margin-bottom: 2rem;
      pointer-events: none;
    }

    .score-val {
      font-family: 'Merriweather', serif;
      font-size: 3.5rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      line-height: 1;
    }

    .score-label {
      color: var(--gold);
      font-weight: 700;
      letter-spacing: 2px;
      margin-top: 5px;
      text-transform: uppercase;
    }

    .cps-display {
      background: rgba(0, 0, 0, 0.4);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 10px;
      display: inline-block;
      border: var(--border);
    }

    #main-clicker {
      width: 320px;
      height: 320px;
      object-fit: contain;
      cursor: pointer;
      filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.6));
      transition: transform 0.05s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 20;
    }

    #main-clicker:active {
      transform: scale(0.94);
      filter: brightness(0.9);
    }

    /* --- PARTICLES --- */
    #particle-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      font-weight: 900;
      font-size: 1.5rem;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      will-change: transform, opacity;
    }

    /* --- RIGHT PANEL TABS --- */
    .tab-header {
      display: flex;
      background: #111;
      border-bottom: var(--border);
    }

    .tab-btn {
      flex: 1;
      padding: 15px;
      background: transparent;
      border: none;
      color: #666;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
      transition: 0.2s;
    }

    .tab-btn.active {
      color: var(--gold);
      background: var(--bg-accent);
      box-shadow: inset 0 -2px 0 var(--gold);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* --- ITEMS & BUILDINGS --- */
    .item-card {
      display: flex;
      align-items: center;
      background: var(--bg-accent);
      border: var(--border);
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
      overflow: hidden;
    }

    .item-card:hover {
      background: #2a2a2e;
      transform: translateX(2px);
    }

    .item-card.locked {
      opacity: 0.5;
      filter: grayscale(1);
      pointer-events: none;
    }

    .item-card.affordable .cost-val {
      color: var(--green);
    }

    .item-card.expensive .cost-val {
      color: var(--red);
    }

    .item-icon {
      font-size: 2rem;
      width: 50px;
      text-align: center;
      margin-right: 10px;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 700;
      color: #fff;
      font-size: 0.95rem;
    }

    .item-bonus {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .item-cost {
      font-weight: bold;
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .item-count {
      font-size: 1.5rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      position: absolute;
      right: 10px;
    }

    /* --- UPGRADE GRID --- */
    .upgrade-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
    }

    .upgrade-btn {
      aspect-ratio: 1;
      background: #222;
      border: var(--border);
      border-radius: 6px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
    }

    .upgrade-btn:hover {
      border-color: var(--gold);
    }

    .upgrade-btn.bought {
      display: none;
    }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-window {
      background: var(--bg-panel);
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      border: var(--border);
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      overflow: hidden;
      animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-header {
      background: #111;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: var(--border);
    }

    .modal-title {
      font-family: 'Merriweather', serif;
      color: var(--gold);
      font-weight: 900;
      letter-spacing: 1px;
    }

    .close-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    /* --- CONTROLS BAR (Bottom Left) --- */
    .controls-bar {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      z-index: 30;
      pointer-events: none;
    }

    .ctrl-btn {
      pointer-events: auto;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.8rem;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ctrl-btn:hover {
      background: #fff;
      color: #000;
    }

    .btn-casino {
      background: linear-gradient(45deg, #e67e22, #d35400);
      border: none;
      box-shadow: 0 0 15px rgba(230, 126, 34, 0.4);
    }

    .btn-prestige {
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: none;
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
    }

    /* --- TOOLTIP --- */
    #tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(15, 15, 20, 0.98);
      border: 1px solid #444;
      padding: 12px;
      border-radius: 6px;
      z-index: 5000;
      width: 250px;
      display: none;
      box-shadow: 0 10px 30px #000;
    }

    .tt-name {
      color: var(--gold);
      font-weight: bold;
      font-family: 'Merriweather', serif;
      margin-bottom: 5px;
    }

    .tt-desc {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .tt-cost {
      font-size: 0.85rem;
      font-weight: bold;
    }

    /* --- MOBILE RESPONSIVE --- */
    @media (max-width: 800px) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }

      .panel-right {
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
      }

      .score-val {
        font-size: 2.5rem;
      }

      #main-clicker {
        width: 200px;
        height: 200px;
      }
    }
  </style>
</head>

<body>

  <!-- TOOLTIP -->
  <div id="tooltip">
    <div class="tt-name" id="tt-name">Name</div>
    <div class="tt-desc" id="tt-desc">Description</div>
    <div class="tt-cost" id="tt-cost">100</div>
  </div>

  <!-- LEFT PANEL: GAMEPLAY -->
  <div class="panel-left" id="panel-game">
    <div id="particle-layer"></div>
    <div class="score-display">
      <div class="score-val" id="display-score">0</div>
      <div class="score-label">Kleinis</div>
      <div class="cps-display" id="display-cps">0.0 / Sekunde</div>
    </div>

    <img src="https://raw.githubusercontent.com/Janklein25/clicker/main/Kleinclicker.png" id="main-clicker"
      alt="Click Me">

    <div class="controls-bar">
      <button class="ctrl-btn" onclick="UI.openModal('stats')">üìä Stats</button>
      <button class="ctrl-btn" onclick="UI.openModal('settings')">‚öôÔ∏è</button>
      <button class="ctrl-btn btn-casino" id="btn-casino" onclick="UI.openModal('casino')" style="display:none">üé∞
        Casino</button>
      <button class="ctrl-btn btn-prestige" id="btn-prestige" onclick="UI.openModal('prestige')" style="display:none">üöÄ
        Ascension</button>
    </div>
  </div>

  <!-- RIGHT PANEL: SHOP -->
  <div class="panel-right">
    <div class="tab-header">
      <button class="tab-btn active" onclick="UI.switchTab('buildings')">Markt</button>
      <button class="tab-btn" onclick="UI.switchTab('upgrades')">Upgrades</button>
    </div>

    <div id="tab-buildings" class="tab-content active">
      <div id="buildings-list"></div>
    </div>
    <div id="tab-upgrades" class="tab-content">
      <div id="upgrades-list" class="upgrade-grid"></div>
    </div>
  </div>

  <!-- MODALS -->

  <!-- CASINO MODAL -->
  <div id="modal-casino" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <span class="modal-title">CASINO ROYALE</span>
        <button class="close-btn" onclick="UI.closeModals()">√ó</button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div
          style="background:#000; padding:20px; border-radius:8px; border:2px solid #333; margin-bottom:20px; overflow:hidden; position:relative;">
          <div id="roulette-wheel" style="display:flex; transition: transform 0s;">
            <!-- JS generated strip -->
          </div>
          <div
            style="position:absolute; top:0; bottom:0; left:50%; width:2px; background:var(--gold); transform:translateX(-50%); z-index:10;">
          </div>
        </div>
        <div style="display:flex; gap:10px; justify-content: center; margin-bottom:15px;">
          <input type="number" id="bet-input" placeholder="Einsatz"
            style="background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:4px; width:100px;">
          <button class="ctrl-btn" onclick="Casino.setMax()">MAX</button>
        </div>
        <div style="display:flex; gap:10px; justify-content: center;">
          <button class="ctrl-btn" style="background:var(--red); width:80px;" onclick="Casino.spin('red')">ROT
            (x2)</button>
          <button class="ctrl-btn" style="background:var(--green); color:#000; width:80px;"
            onclick="Casino.spin('green')">GR√úN (x14)</button>
          <button class="ctrl-btn" style="background:#333; width:80px;" onclick="Casino.spin('black')">SCHWARZ
            (x2)</button>
        </div>
        <div id="casino-status" style="margin-top:15px; font-weight:bold; height:20px;"></div>
      </div>
    </div>
  </div>

  <!-- PRESTIGE MODAL -->
  <div id="modal-prestige" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <span class="modal-title">ASCENSION</span>
        <button class="close-btn" onclick="UI.closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div
          style="text-align:center; margin-bottom:20px; background:linear-gradient(135deg, #3498db, #2c3e50); padding:20px; border-radius:8px;">
          <div style="font-size:0.9rem; color:#ccc;">Aktueller Level</div>
          <div style="font-size:2rem; font-weight:900;" id="prestige-lvl-current">0</div>
          <div style="margin:10px 0;">‚¨áÔ∏è</div>
          <div style="font-size:0.9rem; color:#aaffaa;">M√∂glicher neuer Level</div>
          <div style="font-size:2.5rem; font-weight:900; color:#fff;" id="prestige-lvl-new">0</div>
          <button id="btn-do-prestige" class="ctrl-btn"
            style="background:var(--red); margin:15px auto; font-size:1.1rem; padding:12px 30px;"
            onclick="Game.doPrestige()">RESET & AUFSTEIGEN</button>
        </div>
        <div style="border-top:1px solid #333; padding-top:15px;">
          <h4 style="color:var(--gold); margin-bottom:10px;">Ascension Upgrades (Permanente Boni)</h4>
          <div id="prestige-upgrades-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS MODAL -->
  <div id="modal-stats" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <span class="modal-title">STATISTIK</span>
        <button class="close-btn" onclick="UI.closeModals()">√ó</button>
      </div>
      <div class="modal-body" id="stats-body"></div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="modal-settings" class="modal-overlay">
    <div class="modal-window">
      <div class="modal-header">
        <span class="modal-title">EINSTELLUNGEN</span>
        <button class="close-btn" onclick="UI.closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:20px;">
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="chk-audio" onchange="AudioMgr.toggle(this.checked)"> Soundeffekte
          </label>
        </div>
        <button class="ctrl-btn" style="background:var(--red); width:100%;" onclick="SaveMgr.wipe()">Hard Reset
          (Spielstand l√∂schen)</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#666; text-align:center;">KleinClicker v7.0 - Engine
          Rewrite</div>
      </div>
    </div>
  </div>

  <script>
    /**
     * KONFIGURATION & DATEN
     */
    const CONFIG = {
      buildings: [
        { id: 'cursor', name: 'Maxis Zeigefinger', baseCost: 15, baseCps: 0.1, icon: 'üëÜ' },
        { id: 'grandma', name: 'Magdas Oma', baseCost: 100, baseCps: 1, icon: 'üëµ' },
        { id: 'farm', name: 'Cedrics Acker', baseCost: 1100, baseCps: 8, icon: 'üåæ' },
        { id: 'mine', name: 'Maltes Meme Mine', baseCost: 12000, baseCps: 47, icon: '‚õèÔ∏è' },
        { id: 'factory', name: 'Jans Strandkorbfabrik', baseCost: 130000, baseCps: 260, icon: 'üè≠' },
        { id: 'bank', name: 'Tills Tresor', baseCost: 1400000, baseCps: 1400, icon: 'üè¶' },
        { id: 'temple', name: 'Nicos Sekten-Tempel', baseCost: 20000000, baseCps: 7800, icon: 'üèõÔ∏è' },
        { id: 'lab', name: 'Maxis Klon-Labor', baseCost: 330000000, baseCps: 45000, icon: 'üß¨' },
        { id: 'rocket', name: 'Magdas Mars-Rakete', baseCost: 5100000000, baseCps: 280000, icon: 'üöÄ' },
        { id: 'portal', name: 'Cedrics Dimensionstor', baseCost: 75000000000, baseCps: 1600000, icon: 'üåÄ' },
        { id: 'time', name: 'Maltes Zeitmaschine', baseCost: 900000000000, baseCps: 12000000, icon: '‚è≥' },
        { id: 'universe', name: 'Franjas Universum', baseCost: 15000000000000, baseCps: 150000000, icon: 'üåå' }
      ],
      upgrades: [
        { id: 'click_1', name: 'Plastik Maus', cost: 500, trigger: 100, type: 'click', multi: 2, icon: 'üñ±Ô∏è', desc: 'Klickst√§rke x2' },
        { id: 'click_2', name: 'Gamer Maus', cost: 50000, trigger: 1000, type: 'click', multi: 2, icon: 'üéÆ', desc: 'Klickst√§rke x2' },
        { id: 'b_0_1', name: 'Carpaltunnel', cost: 1000, trigger: 10, building: 0, multi: 2, icon: 'ü©π', desc: 'Finger doppelt so effizient' },
        { id: 'b_1_1', name: 'Nudelholz', cost: 5000, trigger: 10, building: 1, multi: 2, icon: 'ü•ñ', desc: 'Omas arbeiten h√§rter' },
        { id: 'b_2_1', name: 'D√ºnger', cost: 150000, trigger: 10, building: 2, multi: 2, icon: 'üí©', desc: 'Ernteertrag verdoppelt' },
        // ... more upgrades can be added easily
      ],
      prestige: [
        { id: 'p_keep', name: 'Architekt', cost: 5, desc: 'Behalte 1 Geb√§ude von jedem Typ nach Reset' },
        { id: 'p_luck', name: 'Gl√ºcksspiel', cost: 10, desc: 'Casino Gewinne +10%' },
        { id: 'p_int', name: 'Zinseszins', cost: 25, desc: '+5% CPS pro Prestige Level (statt 1%)' }
      ]
    };

    /**
     * UTILITY
     */
    const Utils = {
      format: (num) => {
        if (num < 1000) return Math.floor(num);
        const suffixes = ["", "k", " Mio", " Mrd", " Bio", " Brd", " Tri"];
        const suffixNum = Math.floor(("" + Math.floor(num)).length / 3);
        let shortValue = parseFloat((suffixNum !== 0 ? (num / Math.pow(1000, suffixNum)) : num).toPrecision(3));
        if (shortValue % 1 !== 0) shortValue = shortValue.toFixed(2);
        return shortValue + suffixes[suffixNum];
      }
    };

    /**
     * AUDIO MANAGER (Synthesizer to avoid loading files)
     */
    class AudioSystem {
      constructor() {
        this.enabled = false;
        this.ctx = null;
      }
      init() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      }
      toggle(state) {
        this.enabled = state;
        if (state && !this.ctx) this.init();
      }
      playTone(freq, type, duration) {
        if (!this.enabled || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
      }
      click() { this.playTone(600 + Math.random() * 200, 'sine', 0.1); }
      buy() { this.playTone(400, 'square', 0.15); this.playTone(600, 'square', 0.15); }
      win() { this.playTone(800, 'triangle', 0.3); }
    }
    const AudioMgr = new AudioSystem();

    /**
     * SAVE MANAGER (Security)
     */
    class SaveSystem {
      constructor() {
        this.key = 'KleinClicker_V7';
        this.salt = 'KleinSalt_9283';
      }
      save(data) {
        const json = JSON.stringify(data);
        const hash = this.hash(json);
        const packet = btoa(JSON.stringify({ d: json, h: hash }));
        localStorage.setItem(this.key, packet);
      }
      load() {
        const raw = localStorage.getItem(this.key);
        if (!raw) return null;
        try {
          const packet = JSON.parse(atob(raw));
          if (this.hash(packet.d) !== packet.h) {
            console.warn("Save file corrupted or tampered.");
            return null;
          }
          return JSON.parse(packet.d);
        } catch (e) { console.error(e); return null; }
      }
      hash(str) {
        let hash = 0;
        const s = str + this.salt;
        for (let i = 0; i < s.length; i++) {
          hash = ((hash << 5) - hash) + s.charCodeAt(i);
          hash |= 0;
        }
        return hash.toString(16);
      }
      wipe() {
        if (confirm("Wirklich alles l√∂schen?")) {
          localStorage.removeItem(this.key);
          location.reload();
        }
      }
    }
    const SaveMgr = new SaveSystem();

    /**
     * PARTICLE SYSTEM (Object Pooling)
     */
    class ParticleSystem {
      constructor() {
        this.pool = [];
        this.active = [];
        this.container = document.getElementById('particle-layer');
        // Create pool of 30 particles
        for (let i = 0; i < 30; i++) {
          const el = document.createElement('div');
          el.className = 'particle';
          el.style.display = 'none';
          this.container.appendChild(el);
          this.pool.push(el);
        }
      }
      spawn(x, y, text) {
        if (this.pool.length === 0) return; // limit reached
        const el = this.pool.pop();
        el.textContent = text;
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 20) + 'px';
        el.style.display = 'block';
        el.style.animation = 'none';
        el.offsetHeight; /* trigger reflow */
        el.style.animation = 'floatUp 0.8s ease-out forwards';

        setTimeout(() => {
          el.style.display = 'none';
          this.pool.push(el);
        }, 750);
      }
    }
    const Particles = new ParticleSystem();

    /**
     * GAME ENGINE
     */
    class GameEngine {
      constructor() {
        this.state = {
          score: 0,
          totalScore: 0,
          clicks: 0,
          startTime: Date.now(),
          buildings: new Array(CONFIG.buildings.length).fill(0),
          upgrades: [], // IDs
          prestige: { level: 0, upgrades: [] }
        };
        this.lastTick = performance.now();
        this.autoSaveTimer = 0;
        this.prestigePending = 0;
      }

      init() {
        const saved = SaveMgr.load();
        if (saved) {
          // Merge save with defaults (handle updates)
          this.state = { ...this.state, ...saved };
          // Fix array lengths if updates added buildings
          if (this.state.buildings.length < CONFIG.buildings.length) {
            const diff = CONFIG.buildings.length - this.state.buildings.length;
            this.state.buildings.push(...new Array(diff).fill(0));
          }
        }

        // Setup initial UI
        UI.init();
        requestAnimationFrame((t) => this.loop(t));
      }

      loop(now) {
        const dt = (now - this.lastTick) / 1000;
        this.lastTick = now;

        // CPS Logic
        const cps = this.calcCPS();
        if (cps > 0) {
          this.addScore(cps * dt);
        }

        // Auto Save (every 10s)
        this.autoSaveTimer += dt;
        if (this.autoSaveTimer > 10) {
          SaveMgr.save(this.state);
          this.autoSaveTimer = 0;
        }

        // Logic Updates
        this.checkUnlocks();
        this.prestigePending = this.calcPrestigeGain();

        // UI Updates
        UI.render(dt, cps, this.prestigePending);

        requestAnimationFrame((t) => this.loop(t));
      }

      addScore(amt) {
        this.state.score += amt;
        this.state.totalScore += amt;
      }

      handleClick(x, y) {
        const power = this.calcClickPower();
        this.addScore(power);
        this.state.clicks++;
        Particles.spawn(x, y, "+" + Utils.format(power));
        AudioMgr.click();
      }

      calcCPS() {
        let cps = 0;
        this.state.buildings.forEach((count, i) => {
          if (count > 0) {
            let multi = 1;
            // Check Upgrades
            CONFIG.upgrades.forEach(u => {
              if (u.type !== 'click' && u.building === i && this.state.upgrades.includes(u.id)) {
                multi *= u.multi;
              }
            });
            cps += (CONFIG.buildings[i].baseCps * count * multi);
          }
        });

        // Prestige Multiplier
        let prestigeMulti = 1 + (this.state.prestige.level * 0.1); // Default 10%
        if (this.state.prestige.upgrades.includes('p_int')) prestigeMulti = 1 + (this.state.prestige.level * 0.15); // Bonus

        return cps * prestigeMulti;
      }

      calcClickPower() {
        let power = 1;
        // 5% of CPS added to click
        power += this.calcCPS() * 0.05;

        CONFIG.upgrades.forEach(u => {
          if (u.type === 'click' && this.state.upgrades.includes(u.id)) power *= u.multi;
        });

        let prestigeMulti = 1 + (this.state.prestige.level * 0.1);
        return power * prestigeMulti;
      }

      buyBuilding(idx) {
        const cost = this.getBuildingCost(idx);
        if (this.state.score >= cost) {
          this.state.score -= cost;
          this.state.buildings[idx]++;
          AudioMgr.buy();
          UI.updateBuilding(idx);
        }
      }

      getBuildingCost(idx) {
        return Math.floor(CONFIG.buildings[idx].baseCost * Math.pow(1.15, this.state.buildings[idx]));
      }

      buyUpgrade(id) {
        const u = CONFIG.upgrades.find(x => x.id === id);
        if (u && this.state.score >= u.cost && !this.state.upgrades.includes(id)) {
          this.state.score -= u.cost;
          this.state.upgrades.push(id);
          AudioMgr.buy();
          UI.renderUpgrades(); // Re-render to hide bought
        }
      }

      checkUnlocks() {
        // Unlock Casino at 1000 score
        if (this.state.totalScore >= 1000) document.getElementById('btn-casino').style.display = 'block';
        // Unlock Prestige at 1M score or previous prestige
        if (this.state.totalScore >= 1000000 || this.state.prestige.level > 0) document.getElementById('btn-prestige').style.display = 'block';
      }

      calcPrestigeGain() {
        if (this.state.totalScore < 1000000) return 0;
        return Math.floor(Math.cbrt(this.state.totalScore / 1000000));
      }

      doPrestige() {
        const gain = this.calcPrestigeGain();
        if (gain <= this.state.prestige.level) return;

        if (!confirm("Reset f√ºr Level " + gain + "? Alle Geb√§ude & Upgrades gehen verloren!")) return;

        // Keep logic
        const keepBuilding = this.state.prestige.upgrades.includes('p_keep');

        // Reset
        this.state.score = 0;
        this.state.totalScore = 0; // Soft reset logic, usually resets total or keeps for achievements. Simple here.
        this.state.clicks = 0;
        this.state.upgrades = [];

        if (keepBuilding) {
          this.state.buildings = this.state.buildings.map(b => b > 0 ? 1 : 0);
        } else {
          this.state.buildings.fill(0);
        }

        this.state.prestige.level = gain;
        SaveMgr.save(this.state);
        location.reload();
      }
    }
    const Game = new GameEngine();

    /**
     * UI MANAGER
     */
    class UIManager {
      constructor() {
        this.els = {
          score: document.getElementById('display-score'),
          cps: document.getElementById('display-cps'),
          bList: document.getElementById('buildings-list'),
          uList: document.getElementById('upgrades-list'),
          tooltip: document.getElementById('tooltip')
        };
      }

      init() {
        // Generate Building List
        CONFIG.buildings.forEach((b, i) => {
          const el = document.createElement('div');
          el.className = 'item-card locked'; // Start locked
          el.id = `build-row-${i}`;
          el.innerHTML = `
                <div class="item-icon">${b.icon}</div>
                <div class="item-details">
                    <div class="item-name">${b.name}</div>
                    <div class="item-bonus">Prod: ${b.baseCps}/s</div>
                    <div class="item-cost"><span id="cost-${i}" class="cost-val">0</span> Kleinis</div>
                </div>
                <div class="item-count" id="count-${i}">0</div>
            `;
          el.onclick = () => Game.buyBuilding(i);
          this.els.bList.appendChild(el);
        });

        // Click Handler
        const main = document.getElementById('main-clicker');
        main.addEventListener('mousedown', (e) => Game.handleClick(e.clientX, e.clientY));
        // Prevent double fire on touch
        main.addEventListener('touchstart', (e) => {
          e.preventDefault();
          for (let i = 0; i < e.touches.length; i++) {
            Game.handleClick(e.touches[i].clientX, e.touches[i].clientY);
          }
        }, { passive: false });

        // Tooltip tracking
        document.addEventListener('mousemove', (e) => {
          if (this.els.tooltip.style.display === 'block') {
            this.els.tooltip.style.left = (e.clientX + 15) + 'px';
            this.els.tooltip.style.top = (e.clientY + 15) + 'px';
          }
        });

        this.renderUpgrades();
        this.refreshBuildings(); // Set initial costs
      }

      render(dt, cps, prestigePotential) {
        this.els.score.textContent = Utils.format(Game.state.score);
        this.els.cps.textContent = `${Utils.format(cps)} / Sek`;

        // Efficiently update building states (Affordable/Locked)
        Game.state.buildings.forEach((_, i) => {
          const row = document.getElementById(`build-row-${i}`);
          const cost = Game.getBuildingCost(i);

          // Unlock visibility logic (Show if affordable or previous owned)
          if (i === 0 || Game.state.buildings[i - 1] > 0 || Game.state.score >= cost * 0.5) {
            row.classList.remove('locked');
          }

          // Affordability Color
          if (Game.state.score >= cost) {
            row.classList.add('affordable');
            row.classList.remove('expensive');
          } else {
            row.classList.remove('affordable');
            row.classList.add('expensive');
          }
        });

        // Update Prestige Modal Live
        if (document.getElementById('modal-prestige').style.display === 'flex') {
          document.getElementById('prestige-lvl-current').textContent = Game.state.prestige.level;
          document.getElementById('prestige-lvl-new').textContent = prestigePotential;
          const btn = document.getElementById('btn-do-prestige');
          if (prestigePotential > Game.state.prestige.level) {
            btn.disabled = false;
            btn.style.opacity = 1;
            btn.textContent = `RESET F√úR LVL ${prestigePotential} (+${prestigePotential - Game.state.prestige.level})`;
          } else {
            btn.disabled = true;
            btn.style.opacity = 0.5;
            btn.textContent = "Brauche mehr Score";
          }
        }
      }

      refreshBuildings() {
        Game.state.buildings.forEach((count, i) => {
          document.getElementById(`count-${i}`).textContent = count;
          document.getElementById(`cost-${i}`).textContent = Utils.format(Game.getBuildingCost(i));
        });
      }

      updateBuilding(idx) {
        document.getElementById(`count-${idx}`).textContent = Game.state.buildings[idx];
        document.getElementById(`cost-${idx}`).textContent = Utils.format(Game.getBuildingCost(idx));
      }

      renderUpgrades() {
        this.els.uList.innerHTML = '';
        CONFIG.upgrades.forEach(u => {
          if (Game.state.upgrades.includes(u.id)) return; // Already bought

          // Check visibility
          let visible = false;
          if (u.type === 'click' && Game.state.clicks >= u.trigger) visible = true;
          if (u.type !== 'click' && Game.state.buildings[u.building] >= u.trigger) visible = true;

          if (visible) {
            const btn = document.createElement('div');
            btn.className = 'upgrade-btn';
            btn.innerHTML = u.icon;
            btn.onclick = () => Game.buyUpgrade(u.id);
            btn.onmouseenter = () => this.showTooltip(u);
            btn.onmouseleave = () => this.hideTooltip();

            // Opacity check in render loop would be better, but this suffices for now
            if (Game.state.score < u.cost) btn.style.opacity = 0.5;

            this.els.uList.appendChild(btn);
          }
        });
      }

      showTooltip(u) {
        this.els.tooltip.style.display = 'block';
        document.getElementById('tt-name').textContent = u.name;
        document.getElementById('tt-desc').textContent = u.desc;
        document.getElementById('tt-cost').textContent = Utils.format(u.cost) + " Kleinis";
      }
      hideTooltip() { this.els.tooltip.style.display = 'none'; }

      switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      }

      openModal(id) {
        document.getElementById(`modal-${id}`).style.display = 'flex';
        if (id === 'stats') {
          const t = (Date.now() - Game.state.startTime) / 1000;
          const hrs = Math.floor(t / 3600);
          const mins = Math.floor((t % 3600) / 60);
          document.getElementById('stats-body').innerHTML = `
                <p>Spielzeit: ${hrs}h ${mins}m</p>
                <p>Klicks: ${Game.state.clicks}</p>
                <p>Totaler Score: ${Utils.format(Game.state.totalScore)}</p>
                <p>Prestige Multiplier: x${(1 + Game.state.prestige.level * 0.1).toFixed(1)}</p>
            `;
        }
      }
      closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
      }
    }
    const UI = new UIManager();

    /**
     * CASINO LOGIC (Secure)
     */
    const Casino = {
      spinning: false,
      spin: function (color) {
        if (this.spinning) return;
        const input = document.getElementById('bet-input');
        let bet = parseInt(input.value);
        if (!bet || bet <= 0) return;
        if (bet > Game.state.score) bet = Game.state.score;

        Game.state.score -= bet;
        Game.state.totalScore -= bet; // Prevent score inflation via gambling
        this.spinning = true;

        // Determine result immediately (Anti-Cheat)
        const roll = Math.random();
        let result = 'black';
        let multi = 0;
        if (roll < 0.05) result = 'green';
        else if (roll < 0.525) result = 'red';

        if (color === result) {
          multi = (result === 'green') ? 14 : 2;
        }

        // Save immediately so refreshing tab loses the bet if mid-spin
        SaveMgr.save(Game.state);

        // Visuals
        const strip = document.getElementById('roulette-wheel');
        strip.innerHTML = '';

        // Generate strip: 50 items, result at 40
        for (let i = 0; i < 50; i++) {
          let c = 'black';
          if (i === 40) c = result;
          else {
            const r = Math.random();
            if (r < 0.05) c = 'green'; else if (r < 0.5) c = 'red';
          }

          const div = document.createElement('div');
          div.style.width = '60px'; div.style.height = '60px'; div.style.flexShrink = '0';
          div.style.margin = '0 2px'; div.style.borderRadius = '4px';
          div.style.background = c === 'red' ? '#e74c3c' : (c === 'green' ? '#2ecc71' : '#333');
          strip.appendChild(div);
        }

        const cardWidth = 64; // 60 + 4 margin
        const targetPos = (40 * cardWidth) - (strip.parentElement.offsetWidth / 2) + 30;
        const randomOffset = Math.floor(Math.random() * 40) - 20;

        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0px)';

        // Force reflow
        strip.offsetHeight;

        strip.style.transition = 'transform 3s cubic-bezier(0.1, 0.8, 0.1, 1)';
        strip.style.transform = `translateX(-${targetPos + randomOffset}px)`;

        document.getElementById('casino-status').textContent = "Spinning...";

        setTimeout(() => {
          this.spinning = false;
          if (multi > 0) {
            const win = bet * multi;
            Game.addScore(win);
            AudioMgr.win();
            document.getElementById('casino-status').textContent = `GEWONNEN: ${Utils.format(win)}!`;
            document.getElementById('casino-status').style.color = 'var(--green)';
          } else {
            document.getElementById('casino-status').textContent = "VERLOREN!";
            document.getElementById('casino-status').style.color = 'var(--red)';
          }
          SaveMgr.save(Game.state);
        }, 3100);
      },
      setMax: function () {
        document.getElementById('bet-input').value = Math.floor(Game.state.score);
      }
    };

    window.onload = () => Game.init();

  </script>
</body>

</html>